begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * eXist Open Source Native XML Database  * Copyright (C) 2001-2015 The eXist Project  * http://exist-db.org  *  * This program is free software; you can redistribute it and/or  * modify it under the terms of the GNU Lesser General Public License  * as published by the Free Software Foundation; either version 2  * of the License, or (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU Lesser General Public License for more details.  *  * You should have received a copy of the GNU Lesser General Public License  * along with this program; if not, write to the Free Software Foundation  * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.  */
end_comment

begin_package
package|package
name|org
operator|.
name|exist
operator|.
name|xmlrpc
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|xmlrpc
operator|.
name|XmlRpcException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|xmlrpc
operator|.
name|client
operator|.
name|XmlRpcClient
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|xmlrpc
operator|.
name|client
operator|.
name|XmlRpcClientConfigImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|MessageDigester
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|serializers
operator|.
name|EXistOutputKeys
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|test
operator|.
name|ExistWebServer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|test
operator|.
name|TestConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|Compressor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|MimeType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|io
operator|.
name|FastByteArrayInputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|io
operator|.
name|FastByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|XmldbURI
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|RemoteCollection
operator|.
name|MAX_UPLOAD_CHUNK
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|exist
operator|.
name|xmlrpc
operator|.
name|RpcConnection
operator|.
name|MAX_DOWNLOAD_CHUNK_SIZE
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|ClassRule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|OutputKeys
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|Source
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|MalformedURLException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|charset
operator|.
name|StandardCharsets
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|Permission
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|nio
operator|.
name|charset
operator|.
name|StandardCharsets
operator|.
name|UTF_8
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|Assert
operator|.
name|*
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|After
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|SAXException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xmlunit
operator|.
name|builder
operator|.
name|DiffBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xmlunit
operator|.
name|builder
operator|.
name|Input
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xmlunit
operator|.
name|diff
operator|.
name|Diff
import|;
end_import

begin_comment
comment|/**  * JUnit test for XMLRPC interface methods.  *  * @author<a href="mailto:wolfgangmm@exist-db.org">Wolfgang Meier</a>  * @author<a href="mailto:pierrick.brihaye@free.fr">Pierrick Brihaye</a>  * @author ljo  */
end_comment

begin_class
specifier|public
class|class
name|XmlRpcTest
block|{
annotation|@
name|ClassRule
specifier|public
specifier|final
specifier|static
name|ExistWebServer
name|existWebServer
init|=
operator|new
name|ExistWebServer
argument_list|(
literal|true
argument_list|,
literal|false
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|)
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|XmldbURI
name|TARGET_COLLECTION
init|=
name|XmldbURI
operator|.
name|ROOT_COLLECTION_URI
operator|.
name|append
argument_list|(
literal|"xmlrpc"
argument_list|)
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|XmldbURI
name|TARGET_RESOURCE
init|=
name|TARGET_COLLECTION
operator|.
name|append
argument_list|(
name|TestConstants
operator|.
name|TEST_XML_URI
argument_list|)
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|XmldbURI
name|MODULE_RESOURCE
init|=
name|TARGET_COLLECTION
operator|.
name|append
argument_list|(
name|TestConstants
operator|.
name|TEST_MODULE_URI
argument_list|)
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|XmldbURI
name|SPECIAL_COLLECTION
init|=
name|TARGET_COLLECTION
operator|.
name|append
argument_list|(
name|TestConstants
operator|.
name|SPECIAL_NAME
argument_list|)
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|XmldbURI
name|SPECIAL_RESOURCE
init|=
name|SPECIAL_COLLECTION
operator|.
name|append
argument_list|(
name|TestConstants
operator|.
name|SPECIAL_XML_URI
argument_list|)
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|XML_DATA
init|=
literal|"<test>"
operator|+
literal|"<para>\u00E4\u00E4\u00F6\u00F6\u00FC\u00FC\u00C4\u00C4\u00D6\u00D6\u00DC\u00DC\u00DF\u00DF</para>"
operator|+
literal|"<para>\uC5F4\uB2E8\uACC4</para>"
operator|+
literal|"</test>"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|XSL_DATA
init|=
literal|"<xsl:stylesheet xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" version=\"2.0\">"
operator|+
literal|"<xsl:output omit-xml-declaration=\"no\"/>"
operator|+
literal|"<xsl:param name=\"testparam\"/>"
operator|+
literal|"<xsl:template match=\"test\"><test><xsl:apply-templates/></test></xsl:template>"
operator|+
literal|"<xsl:template match=\"para\">"
operator|+
literal|"<p><xsl:value-of select=\"$testparam\"/>:<xsl:apply-templates/></p></xsl:template>"
operator|+
literal|"</xsl:stylesheet>"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|MODULE_DATA
init|=
literal|"module namespace tm = \"http://exist-db.org/test/module\"; "
operator|+
literal|"declare variable $tm:imported-external-string as xs:string external;"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|QUERY_MODULE_DATA
init|=
literal|"xquery version \"1.0\";"
operator|+
literal|"declare namespace tm-query = \"http://exist-db.org/test/module/query\";"
operator|+
literal|"import module namespace tm = \"http://exist-db.org/test/module\" "
operator|+
literal|"at \"xmldb:exist://"
operator|+
name|MODULE_RESOURCE
operator|.
name|toString
argument_list|()
operator|+
literal|"\"; "
operator|+
literal|"declare variable $tm-query:local-external-string as xs:string external;"
operator|+
literal|"($tm:imported-external-string, $tm-query:local-external-string)"
decl_stmt|;
specifier|private
specifier|static
name|String
name|getUri
parameter_list|()
block|{
return|return
literal|"http://localhost:"
operator|+
name|existWebServer
operator|.
name|getPort
argument_list|()
operator|+
literal|"/xmlrpc"
return|;
block|}
annotation|@
name|After
specifier|public
name|void
name|tearDown
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_COLLECTION
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unused"
argument_list|)
name|Boolean
name|b
init|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"removeCollection"
argument_list|,
name|params
argument_list|)
decl_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testStoreAndRetrieve
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|IOException
block|{
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_COLLECTION
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Boolean
name|result
init|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"createCollection"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|XML_DATA
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"parse"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|options
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|byte
index|[]
name|data
init|=
operator|(
name|byte
index|[]
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocument"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|StandardCharsets
operator|.
name|UTF_8
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|byte
index|[]
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocument"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertNotNull
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|String
name|sdata
init|=
operator|(
name|String
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocumentAsString"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|Map
name|table
init|=
operator|(
name|Map
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocumentData"
argument_list|,
name|params
argument_list|)
decl_stmt|;
try|try
init|(
specifier|final
name|FastByteArrayOutputStream
name|os
init|=
operator|new
name|FastByteArrayOutputStream
argument_list|()
init|)
block|{
name|int
name|offset
init|=
operator|(
name|int
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"offset"
argument_list|)
decl_stmt|;
name|data
operator|=
operator|(
name|byte
index|[]
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|os
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
while|while
condition|(
name|offset
operator|>
literal|0
condition|)
block|{
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|table
operator|.
name|get
argument_list|(
literal|"handle"
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|table
operator|=
operator|(
name|Map
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getNextChunk"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|offset
operator|=
operator|(
name|int
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"offset"
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|byte
index|[]
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|os
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
name|data
operator|=
name|os
operator|.
name|toByteArray
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
name|data
operator|.
name|length
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Boolean
name|b
init|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"hasDocument"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|storeData
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_COLLECTION
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Boolean
name|result
init|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"createCollection"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|XML_DATA
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"parse"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|params
operator|.
name|set
argument_list|(
literal|0
argument_list|,
name|XSL_DATA
argument_list|)
expr_stmt|;
name|params
operator|.
name|set
argument_list|(
literal|1
argument_list|,
name|TARGET_COLLECTION
operator|.
name|append
argument_list|(
literal|"test.xsl"
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"parse"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|params
operator|.
name|set
argument_list|(
literal|0
argument_list|,
name|MODULE_DATA
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|set
argument_list|(
literal|1
argument_list|,
name|MODULE_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|set
argument_list|(
literal|2
argument_list|,
name|MimeType
operator|.
name|XQUERY_TYPE
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|Boolean
operator|.
name|TRUE
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"storeBinary"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|getDocumentDataChunked_nextChunk
parameter_list|()
throws|throws
name|IOException
throws|,
name|XmlRpcException
block|{
specifier|final
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_COLLECTION
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Boolean
name|result
init|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"createCollection"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
specifier|final
name|String
name|generatedXml
init|=
name|generateXml
argument_list|(
operator|(
name|int
operator|)
operator|(
name|MAX_DOWNLOAD_CHUNK_SIZE
operator|*
literal|1.5
operator|)
argument_list|)
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|generatedXml
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"parse"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|parameters
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|parameters
operator|.
name|put
argument_list|(
name|OutputKeys
operator|.
name|OMIT_XML_DECLARATION
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
name|parameters
operator|.
name|put
argument_list|(
name|OutputKeys
operator|.
name|INDENT
argument_list|,
literal|"no"
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|parameters
argument_list|)
expr_stmt|;
name|Map
name|table
init|=
operator|(
name|Map
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocumentData"
argument_list|,
name|params
argument_list|)
decl_stmt|;
try|try
init|(
specifier|final
name|FastByteArrayOutputStream
name|os
init|=
operator|new
name|FastByteArrayOutputStream
argument_list|()
init|)
block|{
name|int
name|offset
init|=
operator|(
name|int
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"offset"
argument_list|)
decl_stmt|;
name|byte
index|[]
name|data
init|=
operator|(
name|byte
index|[]
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"data"
argument_list|)
decl_stmt|;
name|os
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
while|while
condition|(
name|offset
operator|>
literal|0
condition|)
block|{
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|table
operator|.
name|get
argument_list|(
literal|"handle"
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|table
operator|=
operator|(
name|Map
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getNextChunk"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|offset
operator|=
operator|(
name|int
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"offset"
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|byte
index|[]
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|os
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
name|data
operator|=
name|os
operator|.
name|toByteArray
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|generatedXml
argument_list|,
operator|new
name|String
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|getDocumentDataChunked_nextExtendedChunk
parameter_list|()
throws|throws
name|IOException
throws|,
name|XmlRpcException
block|{
specifier|final
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_COLLECTION
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Boolean
name|result
init|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"createCollection"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
specifier|final
name|String
name|generatedXml
init|=
name|generateXml
argument_list|(
operator|(
name|int
operator|)
operator|(
name|MAX_DOWNLOAD_CHUNK_SIZE
operator|*
literal|1.75
operator|)
argument_list|)
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|generatedXml
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"parse"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|parameters
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|parameters
operator|.
name|put
argument_list|(
name|OutputKeys
operator|.
name|OMIT_XML_DECLARATION
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
name|parameters
operator|.
name|put
argument_list|(
name|OutputKeys
operator|.
name|INDENT
argument_list|,
literal|"no"
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|parameters
argument_list|)
expr_stmt|;
name|Map
name|table
init|=
operator|(
name|Map
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocumentData"
argument_list|,
name|params
argument_list|)
decl_stmt|;
try|try
init|(
specifier|final
name|FastByteArrayOutputStream
name|os
init|=
operator|new
name|FastByteArrayOutputStream
argument_list|()
init|)
block|{
name|long
name|offset
init|=
operator|(
name|int
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"offset"
argument_list|)
decl_stmt|;
name|byte
index|[]
name|data
init|=
operator|(
name|byte
index|[]
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"data"
argument_list|)
decl_stmt|;
name|os
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
while|while
condition|(
name|offset
operator|>
literal|0
condition|)
block|{
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|table
operator|.
name|get
argument_list|(
literal|"handle"
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|offset
argument_list|)
argument_list|)
expr_stmt|;
name|table
operator|=
operator|(
name|Map
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getNextExtendedChunk"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|offset
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
operator|(
name|String
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"offset"
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|byte
index|[]
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|os
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
name|data
operator|=
name|os
operator|.
name|toByteArray
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|generatedXml
argument_list|,
operator|new
name|String
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|uploadCompressedAndDownload
parameter_list|()
throws|throws
name|IOException
throws|,
name|XmlRpcException
block|{
specifier|final
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
specifier|final
name|String
name|resURI
init|=
name|XmldbURI
operator|.
name|ROOT_COLLECTION_URI
operator|.
name|append
argument_list|(
literal|"test.bin"
argument_list|)
operator|.
name|toString
argument_list|()
decl_stmt|;
specifier|final
name|Date
name|now
init|=
operator|new
name|Date
argument_list|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|byte
index|[]
name|binary
init|=
name|generateBinary
argument_list|(
operator|(
name|int
operator|)
operator|(
name|MAX_UPLOAD_CHUNK
operator|*
literal|1.5
operator|)
argument_list|)
decl_stmt|;
comment|// 1) upload
name|String
name|uploadedFileName
init|=
literal|null
decl_stmt|;
try|try
init|(
specifier|final
name|InputStream
name|is
init|=
operator|new
name|FastByteArrayInputStream
argument_list|(
name|binary
argument_list|)
init|)
block|{
specifier|final
name|byte
index|[]
name|chunk
init|=
operator|new
name|byte
index|[
name|MAX_UPLOAD_CHUNK
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
while|while
condition|(
operator|(
name|len
operator|=
name|is
operator|.
name|read
argument_list|(
name|chunk
argument_list|)
operator|)
operator|>
operator|-
literal|1
condition|)
block|{
specifier|final
name|byte
index|[]
name|compressed
init|=
name|Compressor
operator|.
name|compress
argument_list|(
name|chunk
argument_list|,
name|len
argument_list|)
decl_stmt|;
specifier|final
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
if|if
condition|(
name|uploadedFileName
operator|!=
literal|null
condition|)
block|{
name|params
operator|.
name|add
argument_list|(
name|uploadedFileName
argument_list|)
expr_stmt|;
block|}
name|params
operator|.
name|add
argument_list|(
name|compressed
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|uploadedFileName
operator|=
operator|(
name|String
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"uploadCompressed"
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
block|}
comment|// set the properties of the uploaded file
specifier|final
name|List
argument_list|<
name|Object
argument_list|>
name|paramsEx
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|paramsEx
operator|.
name|add
argument_list|(
name|uploadedFileName
argument_list|)
expr_stmt|;
name|paramsEx
operator|.
name|add
argument_list|(
name|resURI
argument_list|)
expr_stmt|;
name|paramsEx
operator|.
name|add
argument_list|(
name|Boolean
operator|.
name|TRUE
argument_list|)
expr_stmt|;
name|paramsEx
operator|.
name|add
argument_list|(
literal|"application/octet-stream"
argument_list|)
expr_stmt|;
name|paramsEx
operator|.
name|add
argument_list|(
name|Boolean
operator|.
name|FALSE
argument_list|)
expr_stmt|;
name|paramsEx
operator|.
name|add
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|paramsEx
operator|.
name|add
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"parseLocalExt"
argument_list|,
name|paramsEx
argument_list|)
expr_stmt|;
comment|// 2) download
specifier|final
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|resURI
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|Collections
operator|.
name|emptyMap
argument_list|()
argument_list|)
expr_stmt|;
name|Map
name|table
init|=
operator|(
name|Map
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocumentData"
argument_list|,
name|params
argument_list|)
decl_stmt|;
try|try
init|(
specifier|final
name|FastByteArrayOutputStream
name|os
init|=
operator|new
name|FastByteArrayOutputStream
argument_list|()
init|)
block|{
name|long
name|offset
init|=
operator|(
name|int
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"offset"
argument_list|)
decl_stmt|;
name|byte
index|[]
name|data
init|=
operator|(
name|byte
index|[]
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"data"
argument_list|)
decl_stmt|;
name|os
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
while|while
condition|(
name|offset
operator|>
literal|0
condition|)
block|{
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|table
operator|.
name|get
argument_list|(
literal|"handle"
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|offset
argument_list|)
argument_list|)
expr_stmt|;
name|table
operator|=
operator|(
name|Map
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getNextExtendedChunk"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|offset
operator|=
name|Long
operator|.
name|valueOf
argument_list|(
operator|(
name|String
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"offset"
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|byte
index|[]
operator|)
name|table
operator|.
name|get
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|os
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
name|data
operator|=
name|os
operator|.
name|toByteArray
argument_list|()
expr_stmt|;
name|assertArrayEquals
argument_list|(
name|binary
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|testRemoveCollection
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|List
name|params
init|=
operator|new
name|ArrayList
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_COLLECTION
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Boolean
name|b
init|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"hasCollection"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"removeCollection"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"hasCollection"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testRemoveDoc
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|List
name|params
init|=
operator|new
name|ArrayList
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|Boolean
name|b
init|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"hasDocument"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"remove"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"hasDocument"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testRetrieveDoc
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|options
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|options
operator|.
name|put
argument_list|(
literal|"indent"
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
name|options
operator|.
name|put
argument_list|(
literal|"encoding"
argument_list|,
name|StandardCharsets
operator|.
name|UTF_8
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|options
operator|.
name|put
argument_list|(
literal|"expand-xincludes"
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
name|options
operator|.
name|put
argument_list|(
literal|"process-xsl-pi"
argument_list|,
literal|"no"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|TARGET_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|options
argument_list|)
expr_stmt|;
comment|// execute the call
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|byte
index|[]
name|data
init|=
operator|(
name|byte
index|[]
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocument"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|options
operator|.
name|put
argument_list|(
literal|"stylesheet"
argument_list|,
literal|"test.xsl"
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|byte
index|[]
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocument"
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testCharEncoding
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|String
name|query
init|=
literal|"distinct-values(//para)"
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|query
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|HashMap
argument_list|<>
argument_list|()
argument_list|)
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|HashMap
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
name|result
init|=
operator|(
name|HashMap
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"queryP"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|Object
index|[]
name|resources
init|=
operator|(
name|Object
index|[]
operator|)
name|result
operator|.
name|get
argument_list|(
literal|"results"
argument_list|)
decl_stmt|;
comment|//TODO : check the number of resources before !
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|resources
operator|.
name|length
argument_list|)
expr_stmt|;
name|String
name|value
init|=
operator|(
name|String
operator|)
name|resources
index|[
literal|0
index|]
decl_stmt|;
name|assertEquals
argument_list|(
literal|"\u00E4\u00E4\u00F6\u00F6\u00FC\u00FC\u00C4\u00C4\u00D6\u00D6\u00DC\u00DC\u00DF\u00DF"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
operator|(
name|String
operator|)
name|resources
index|[
literal|1
index|]
expr_stmt|;
name|assertEquals
argument_list|(
literal|"\uC5F4\uB2E8\uACC4"
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testQuery
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|String
name|query
init|=
literal|"(::pragma exist:serialize indent=no::) //para"
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|query
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|HashMap
argument_list|()
argument_list|)
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|byte
index|[]
name|result
init|=
operator|(
name|byte
index|[]
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"query"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|result
operator|.
name|length
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testQueryWithStylesheet
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
throws|,
name|SAXException
throws|,
name|IOException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|options
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|options
operator|.
name|put
argument_list|(
name|EXistOutputKeys
operator|.
name|STYLESHEET
argument_list|,
literal|"test.xsl"
argument_list|)
expr_stmt|;
name|options
operator|.
name|put
argument_list|(
name|EXistOutputKeys
operator|.
name|STYLESHEET_PARAM
operator|+
literal|".testparam"
argument_list|,
literal|"Test"
argument_list|)
expr_stmt|;
name|options
operator|.
name|put
argument_list|(
name|OutputKeys
operator|.
name|OMIT_XML_DECLARATION
argument_list|,
literal|"no"
argument_list|)
expr_stmt|;
comment|//TODO : check the number of resources before !
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|String
name|query
init|=
literal|"//para[1]"
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|query
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|Integer
name|handle
init|=
operator|(
name|Integer
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"executeQuery"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|byte
index|[]
name|item
init|=
operator|(
name|byte
index|[]
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"retrieve"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|item
operator|.
name|length
operator|>
literal|0
argument_list|)
expr_stmt|;
name|String
name|out
init|=
operator|new
name|String
argument_list|(
name|item
argument_list|,
name|UTF_8
argument_list|)
decl_stmt|;
specifier|final
name|Source
name|expected
init|=
name|Input
operator|.
name|fromString
argument_list|(
literal|"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<p>Test: \u00E4\u00E4\u00F6\u00F6\u00FC\u00FC\u00C4\u00C4\u00D6\u00D6\u00DC\u00DC\u00DF\u00DF</p>"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
specifier|final
name|Source
name|actual
init|=
name|Input
operator|.
name|fromString
argument_list|(
name|out
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
specifier|final
name|Diff
name|diff
init|=
name|DiffBuilder
operator|.
name|compare
argument_list|(
name|expected
argument_list|)
operator|.
name|withTest
argument_list|(
name|actual
argument_list|)
operator|.
name|checkForSimilar
argument_list|()
operator|.
name|build
argument_list|()
decl_stmt|;
name|assertFalse
argument_list|(
name|diff
operator|.
name|toString
argument_list|()
argument_list|,
name|diff
operator|.
name|hasDifferences
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testCompile
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|String
name|query
init|=
literal|"<a>Invalid<a>"
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|query
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|HashMap
argument_list|<>
argument_list|()
argument_list|)
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|Map
name|stats
init|=
operator|(
name|Map
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"compile"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|stats
argument_list|)
expr_stmt|;
name|assertNotNull
argument_list|(
name|stats
operator|.
name|get
argument_list|(
literal|"error"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testAddAccount
parameter_list|()
throws|throws
name|MalformedURLException
throws|,
name|XmlRpcException
block|{
name|String
name|user
init|=
literal|"rudi"
decl_stmt|;
name|String
name|passwd
init|=
literal|"pass"
decl_stmt|;
name|String
name|simpleMd5
init|=
name|MessageDigester
operator|.
name|md5
argument_list|(
name|passwd
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|String
name|digest
init|=
name|MessageDigester
operator|.
name|md5
argument_list|(
name|user
operator|+
literal|":exist:"
operator|+
name|passwd
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
literal|12
argument_list|)
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|"rudi"
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|simpleMd5
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|String
index|[]
block|{
literal|"guest"
block|}
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|Permission
operator|.
name|DEFAULT_UMASK
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|HashMap
argument_list|<>
argument_list|()
argument_list|)
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"addAccount"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|XmlRpcClientConfigImpl
name|config
init|=
operator|(
name|XmlRpcClientConfigImpl
operator|)
name|xmlrpc
operator|.
name|getClientConfig
argument_list|()
decl_stmt|;
name|config
operator|.
name|setBasicUserName
argument_list|(
literal|"admin"
argument_list|)
expr_stmt|;
name|config
operator|.
name|setBasicPassword
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"sync"
argument_list|,
name|Collections
operator|.
name|EMPTY_LIST
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testExecuteQuery
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|String
name|query
init|=
literal|"distinct-values(//para)"
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|query
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|HashMap
argument_list|<>
argument_list|()
argument_list|)
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|Integer
name|handle
init|=
operator|(
name|Integer
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"executeQuery"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|Integer
name|hits
init|=
operator|(
name|Integer
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getHits"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|hits
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|hits
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|HashMap
argument_list|()
argument_list|)
expr_stmt|;
name|byte
index|[]
name|item
init|=
operator|(
name|byte
index|[]
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"retrieve"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
operator|new
name|HashMap
argument_list|()
argument_list|)
expr_stmt|;
name|item
operator|=
operator|(
name|byte
index|[]
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"retrieve"
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testQueryModuleExternalVar
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|QUERY_MODULE_DATA
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|qp
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|namespaceDecls
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|namespaceDecls
operator|.
name|put
argument_list|(
literal|"tm"
argument_list|,
literal|"http://exist-db.org/test/module"
argument_list|)
expr_stmt|;
name|namespaceDecls
operator|.
name|put
argument_list|(
literal|"tm-query"
argument_list|,
literal|"http://exist-db.org/test/module/query"
argument_list|)
expr_stmt|;
name|qp
operator|.
name|put
argument_list|(
name|RpcAPI
operator|.
name|NAMESPACES
argument_list|,
name|namespaceDecls
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|variableDecls
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|variableDecls
operator|.
name|put
argument_list|(
literal|"tm:imported-external-string"
argument_list|,
literal|"imported-string-value"
argument_list|)
expr_stmt|;
name|variableDecls
operator|.
name|put
argument_list|(
literal|"tm-query:local-external-string"
argument_list|,
literal|"local-string-value"
argument_list|)
expr_stmt|;
name|qp
operator|.
name|put
argument_list|(
name|RpcAPI
operator|.
name|VARIABLES
argument_list|,
name|variableDecls
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
index|[]
argument_list|>
name|result
init|=
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
index|[]
argument_list|>
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"queryP"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|Object
index|[]
name|resources
init|=
operator|(
name|Object
index|[]
operator|)
name|result
operator|.
name|get
argument_list|(
literal|"results"
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|resources
operator|.
name|length
argument_list|)
expr_stmt|;
name|String
name|value
init|=
operator|(
name|String
operator|)
name|resources
index|[
literal|0
index|]
decl_stmt|;
name|assertEquals
argument_list|(
literal|"imported-string-value"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
operator|(
name|String
operator|)
name|resources
index|[
literal|1
index|]
expr_stmt|;
name|assertEquals
argument_list|(
literal|"local-string-value"
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testCollectionWithAccentsAndSpaces
parameter_list|()
throws|throws
name|XmlRpcException
throws|,
name|MalformedURLException
block|{
name|storeData
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|Object
argument_list|>
name|params
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|params
operator|.
name|add
argument_list|(
name|SPECIAL_COLLECTION
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|XmlRpcClient
name|xmlrpc
init|=
name|getClient
argument_list|()
decl_stmt|;
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"createCollection"
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|XML_DATA
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|SPECIAL_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|Boolean
name|result
init|=
operator|(
name|Boolean
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"parse"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|SPECIAL_COLLECTION
operator|.
name|removeLastSegment
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|HashMap
name|collection
init|=
operator|(
name|HashMap
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"describeCollection"
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|Object
index|[]
name|collections
init|=
operator|(
name|Object
index|[]
operator|)
name|collection
operator|.
name|get
argument_list|(
literal|"collections"
argument_list|)
decl_stmt|;
name|boolean
name|foundMatch
init|=
literal|false
decl_stmt|;
name|String
name|targetCollectionName
init|=
name|SPECIAL_COLLECTION
operator|.
name|lastSegment
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|collections
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|String
name|childName
init|=
operator|(
name|String
operator|)
name|collections
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|childName
operator|.
name|equals
argument_list|(
name|targetCollectionName
argument_list|)
condition|)
block|{
name|foundMatch
operator|=
literal|true
expr_stmt|;
break|break;
block|}
block|}
name|assertTrue
argument_list|(
literal|"added collection not found"
argument_list|,
name|foundMatch
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|options
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|options
operator|.
name|put
argument_list|(
literal|"indent"
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
name|options
operator|.
name|put
argument_list|(
literal|"encoding"
argument_list|,
name|StandardCharsets
operator|.
name|UTF_8
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|options
operator|.
name|put
argument_list|(
literal|"expand-xincludes"
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
name|options
operator|.
name|put
argument_list|(
literal|"process-xsl-pi"
argument_list|,
literal|"no"
argument_list|)
expr_stmt|;
name|params
operator|.
name|clear
argument_list|()
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|SPECIAL_RESOURCE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|add
argument_list|(
name|options
argument_list|)
expr_stmt|;
comment|// execute the call
name|byte
index|[]
name|data
init|=
operator|(
name|byte
index|[]
operator|)
name|xmlrpc
operator|.
name|execute
argument_list|(
literal|"getDocument"
argument_list|,
name|params
argument_list|)
decl_stmt|;
block|}
specifier|private
name|String
name|generateXml
parameter_list|(
specifier|final
name|int
name|minBytes
parameter_list|)
block|{
name|int
name|bytes
init|=
literal|0
decl_stmt|;
specifier|final
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|(
literal|"<container>"
argument_list|)
decl_stmt|;
name|bytes
operator|+=
literal|11
expr_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|bytes
operator|<
name|minBytes
condition|)
block|{
name|builder
operator|.
name|append
argument_list|(
literal|"<num>"
argument_list|)
expr_stmt|;
name|bytes
operator|+=
literal|5
expr_stmt|;
specifier|final
name|String
name|n
init|=
name|String
operator|.
name|valueOf
argument_list|(
operator|++
name|i
argument_list|)
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|bytes
operator|+=
name|n
operator|.
name|length
argument_list|()
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"</num>"
argument_list|)
expr_stmt|;
name|bytes
operator|+=
literal|6
expr_stmt|;
block|}
name|builder
operator|.
name|append
argument_list|(
literal|"</container>"
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
specifier|private
name|byte
index|[]
name|generateBinary
parameter_list|(
specifier|final
name|int
name|minBytes
parameter_list|)
block|{
specifier|final
name|byte
index|[]
name|buf
init|=
operator|new
name|byte
index|[
name|minBytes
index|]
decl_stmt|;
operator|new
name|Random
argument_list|()
operator|.
name|nextBytes
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
specifier|protected
name|XmlRpcClient
name|getClient
parameter_list|()
throws|throws
name|MalformedURLException
block|{
name|XmlRpcClient
name|client
init|=
operator|new
name|XmlRpcClient
argument_list|()
decl_stmt|;
name|XmlRpcClientConfigImpl
name|config
init|=
operator|new
name|XmlRpcClientConfigImpl
argument_list|()
decl_stmt|;
name|config
operator|.
name|setEnabledForExtensions
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|config
operator|.
name|setServerURL
argument_list|(
operator|new
name|URL
argument_list|(
name|getUri
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|config
operator|.
name|setBasicUserName
argument_list|(
literal|"admin"
argument_list|)
expr_stmt|;
name|config
operator|.
name|setBasicPassword
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|client
operator|.
name|setConfig
argument_list|(
name|config
argument_list|)
expr_stmt|;
return|return
name|client
return|;
block|}
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|args
parameter_list|)
block|{
name|org
operator|.
name|junit
operator|.
name|runner
operator|.
name|JUnitCore
operator|.
name|main
argument_list|(
name|XmlRpcTest
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
comment|//Explicit shutdownDB for the shutdownDB hook
name|System
operator|.
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

