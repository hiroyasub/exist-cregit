begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * eXist Open Source Native XML Database  * Copyright (C) 2001 The eXist-db Authors  * http://exist-db.org  *  * This program is free software; you can redistribute it and/or  * modify it under the terms of the GNU Lesser General Public License  * as published by the Free Software Foundation; either version 2  * of the License, or (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU Lesser General Public License for more details.  *  * You should have received a copy of the GNU Lesser General Public License  * along with this program; if not, write to the Free Software Foundation  * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.  */
end_comment

begin_package
package|package
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|functions
operator|.
name|util
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|math
operator|.
name|BigInteger
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|function
operator|.
name|Function
import|;
end_import

begin_import
import|import
name|com
operator|.
name|evolvedbinary
operator|.
name|j8fu
operator|.
name|tuple
operator|.
name|Tuple3
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|persistent
operator|.
name|BinaryDocument
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|persistent
operator|.
name|DocumentImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|persistent
operator|.
name|LockedDocument
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|persistent
operator|.
name|NodeProxy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|PermissionDeniedException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|lock
operator|.
name|Lock
operator|.
name|LockMode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|lock
operator|.
name|ManagedDocumentLock
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|LockException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|XmldbURI
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|BasicFunction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|FunctionSignature
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|XPathException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|XQueryContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|*
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|annotation
operator|.
name|Nullable
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|evolvedbinary
operator|.
name|j8fu
operator|.
name|tuple
operator|.
name|Tuple
operator|.
name|Tuple
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|FunctionDSL
operator|.
name|param
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|FunctionDSL
operator|.
name|returnsOpt
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|functions
operator|.
name|util
operator|.
name|UtilModule
operator|.
name|functionSignature
import|;
end_import

begin_comment
comment|/**  * @author<a href="mailto:wolfgang@exist-db.org">Wolfgang Meier</a>  * @author<a href="mailto:adam@evolvedbinary.com">Adam Retter</a>  */
end_comment

begin_class
specifier|public
class|class
name|DocumentNameOrId
extends|extends
name|BasicFunction
block|{
specifier|private
specifier|static
specifier|final
name|FunctionParameterSequenceType
name|PRAM_NODE_OR_PATH
init|=
name|param
argument_list|(
literal|"node-or-path"
argument_list|,
name|Type
operator|.
name|ITEM
argument_list|,
literal|"The node or a string path pointing to a resource in the database."
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|FSN_DOCUMENT_NAME
init|=
literal|"document-name"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|FunctionSignature
name|FS_DOCUMENT_NAME
init|=
name|functionSignature
argument_list|(
name|FSN_DOCUMENT_NAME
argument_list|,
literal|"Returns the name of a document (excluding the collection path). The argument can either be "
operator|+
literal|"a node or a string path pointing to a resource in the database. If the resource does not exist or the node "
operator|+
literal|"does not belong to a stored document, the empty sequence is returned."
argument_list|,
name|returnsOpt
argument_list|(
name|Type
operator|.
name|STRING
argument_list|,
literal|"the name of the document"
argument_list|)
argument_list|,
name|PRAM_NODE_OR_PATH
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|FSN_DOCUMENT_ID
init|=
literal|"document-id"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|FunctionSignature
name|FS_DOCUMENT_ID
init|=
name|functionSignature
argument_list|(
name|FSN_DOCUMENT_ID
argument_list|,
literal|"Returns the internal integer id of a document. The argument can either be "
operator|+
literal|"a node or a string path pointing to a resource in the database. If the resource does not exist or the node "
operator|+
literal|"does not belong to a stored document, the empty sequence is returned."
argument_list|,
name|returnsOpt
argument_list|(
name|Type
operator|.
name|INT
argument_list|,
literal|"the ID of the document"
argument_list|)
argument_list|,
name|PRAM_NODE_OR_PATH
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|FSN_ABSOLUTE_RESOURCE_ID
init|=
literal|"absolute-resource-id"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|FunctionSignature
name|FS_ABSOLUTE_RESOURCE_ID
init|=
name|functionSignature
argument_list|(
name|FSN_ABSOLUTE_RESOURCE_ID
argument_list|,
literal|"Returns the absolute internal id of a resource as a 65 bit number. The first 32 bits are the collection id, the next 32 bits are the document id, the last bit is the document type. The argument can either be "
operator|+
literal|"a node or a string path pointing to a resource in the database. If the resource does not exist or the node "
operator|+
literal|"does not belong to a stored document, the empty sequence is returned."
argument_list|,
name|returnsOpt
argument_list|(
name|Type
operator|.
name|INTEGER
argument_list|,
literal|"the absolute ID of the resource"
argument_list|)
argument_list|,
name|PRAM_NODE_OR_PATH
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|FSN_GET_RESOURCE_BY_ABSOLUTE_ID
init|=
literal|"get-resource-by-absolute-id"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|FunctionSignature
name|FS_GET_RESOURCE_BY_ABSOLUTE_ID
init|=
name|functionSignature
argument_list|(
name|FSN_GET_RESOURCE_BY_ABSOLUTE_ID
argument_list|,
literal|"Returns the resource indicated by its absolute internal id. The first 32 bits are the collection id, the next 32 bits are the document id, the last bit is the document type. If the resource does not exist, the empty sequence is returned."
argument_list|,
name|returnsOpt
argument_list|(
name|Type
operator|.
name|ITEM
argument_list|,
literal|"The resource from the database. A document() if its an XML resource, or an xs:base64binary otherwise"
argument_list|)
argument_list|,
name|param
argument_list|(
literal|"absolute-id"
argument_list|,
name|Type
operator|.
name|INTEGER
argument_list|,
literal|"The absolute id of a resource in the database."
argument_list|)
argument_list|)
decl_stmt|;
specifier|public
name|DocumentNameOrId
parameter_list|(
specifier|final
name|XQueryContext
name|context
parameter_list|,
specifier|final
name|FunctionSignature
name|signature
parameter_list|)
block|{
name|super
argument_list|(
name|context
argument_list|,
name|signature
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|Sequence
name|eval
parameter_list|(
specifier|final
name|Sequence
index|[]
name|args
parameter_list|,
specifier|final
name|Sequence
name|contextSequence
parameter_list|)
throws|throws
name|XPathException
block|{
specifier|final
name|Item
name|arg
init|=
name|args
index|[
literal|0
index|]
operator|.
name|itemAt
argument_list|(
literal|0
argument_list|)
decl_stmt|;
try|try
block|{
switch|switch
condition|(
name|getSignature
argument_list|()
operator|.
name|getName
argument_list|()
operator|.
name|getLocalPart
argument_list|()
condition|)
block|{
case|case
name|FSN_DOCUMENT_NAME
case|:
if|if
condition|(
name|arg
operator|.
name|getType
argument_list|()
operator|==
name|Type
operator|.
name|STRING
operator|||
name|arg
operator|.
name|getType
argument_list|()
operator|==
name|Type
operator|.
name|ANY_URI
condition|)
block|{
return|return
name|Sequence
operator|.
name|of
argument_list|(
name|getFromDocument
argument_list|(
name|XmldbURI
operator|.
name|create
argument_list|(
name|arg
operator|.
name|getStringValue
argument_list|()
argument_list|)
argument_list|,
name|DocumentImpl
operator|::
name|getFileURI
argument_list|)
argument_list|)
return|;
block|}
if|else if
condition|(
name|arg
operator|instanceof
name|NodeProxy
condition|)
block|{
return|return
name|Sequence
operator|.
name|of
argument_list|(
name|getFromDocument
argument_list|(
operator|(
operator|(
name|NodeProxy
operator|)
name|arg
operator|)
operator|.
name|getOwnerDocument
argument_list|()
operator|.
name|getURI
argument_list|()
argument_list|,
name|DocumentImpl
operator|::
name|getFileURI
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|Sequence
operator|.
name|EMPTY_SEQUENCE
return|;
block|}
case|case
name|FSN_DOCUMENT_ID
case|:
if|if
condition|(
name|arg
operator|.
name|getType
argument_list|()
operator|==
name|Type
operator|.
name|STRING
operator|||
name|arg
operator|.
name|getType
argument_list|()
operator|==
name|Type
operator|.
name|ANY_URI
condition|)
block|{
return|return
name|Sequence
operator|.
name|of
argument_list|(
name|getFromDocument
argument_list|(
name|XmldbURI
operator|.
name|create
argument_list|(
name|arg
operator|.
name|getStringValue
argument_list|()
argument_list|)
argument_list|,
name|DocumentImpl
operator|::
name|getDocId
argument_list|)
argument_list|)
return|;
block|}
if|else if
condition|(
name|arg
operator|instanceof
name|NodeProxy
condition|)
block|{
return|return
name|Sequence
operator|.
name|of
argument_list|(
name|getFromDocument
argument_list|(
operator|(
operator|(
name|NodeProxy
operator|)
name|arg
operator|)
operator|.
name|getOwnerDocument
argument_list|()
operator|.
name|getURI
argument_list|()
argument_list|,
name|DocumentImpl
operator|::
name|getDocId
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|Sequence
operator|.
name|EMPTY_SEQUENCE
return|;
block|}
case|case
name|FSN_ABSOLUTE_RESOURCE_ID
case|:
if|if
condition|(
name|arg
operator|.
name|getType
argument_list|()
operator|==
name|Type
operator|.
name|STRING
operator|||
name|arg
operator|.
name|getType
argument_list|()
operator|==
name|Type
operator|.
name|ANY_URI
condition|)
block|{
return|return
name|Sequence
operator|.
name|of
argument_list|(
name|getFromDocument
argument_list|(
name|XmldbURI
operator|.
name|create
argument_list|(
name|arg
operator|.
name|getStringValue
argument_list|()
argument_list|)
argument_list|,
name|DocumentNameOrId
operator|::
name|getAbsoluteResourceId
argument_list|)
argument_list|)
return|;
block|}
if|else if
condition|(
name|arg
operator|instanceof
name|NodeProxy
condition|)
block|{
return|return
name|Sequence
operator|.
name|of
argument_list|(
name|getFromDocument
argument_list|(
operator|(
operator|(
name|NodeProxy
operator|)
name|arg
operator|)
operator|.
name|getOwnerDocument
argument_list|()
operator|.
name|getURI
argument_list|()
argument_list|,
name|DocumentNameOrId
operator|::
name|getAbsoluteResourceId
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|Sequence
operator|.
name|EMPTY_SEQUENCE
return|;
block|}
case|case
name|FSN_GET_RESOURCE_BY_ABSOLUTE_ID
case|:
return|return
name|getResourceByAbsoluteId
argument_list|(
operator|(
name|IntegerValue
operator|)
name|arg
argument_list|)
return|;
default|default:
throw|throw
operator|new
name|XPathException
argument_list|(
name|this
argument_list|,
literal|"No function: "
operator|+
name|getName
argument_list|()
operator|+
literal|"#"
operator|+
name|getSignature
argument_list|()
operator|.
name|getArgumentCount
argument_list|()
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
specifier|final
name|PermissionDeniedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|XPathException
argument_list|(
name|this
argument_list|,
name|arg
operator|.
name|getStringValue
argument_list|()
operator|+
literal|": permission denied to read resource"
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
specifier|final
name|LockException
name|le
parameter_list|)
block|{
throw|throw
operator|new
name|XPathException
argument_list|(
name|this
argument_list|,
literal|"Unable to lock resource"
argument_list|,
name|le
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
specifier|final
name|IOException
name|ioe
parameter_list|)
block|{
throw|throw
operator|new
name|XPathException
argument_list|(
name|this
argument_list|,
literal|"Unable to read binary resource"
argument_list|,
name|ioe
argument_list|)
throw|;
block|}
block|}
specifier|private
annotation|@
name|Nullable
argument_list|<
name|T
argument_list|>
name|T
name|getFromDocument
parameter_list|(
specifier|final
name|XmldbURI
name|docUri
parameter_list|,
specifier|final
name|Function
argument_list|<
name|DocumentImpl
argument_list|,
name|T
argument_list|>
name|docFn
parameter_list|)
throws|throws
name|PermissionDeniedException
block|{
try|try
init|(
specifier|final
name|LockedDocument
name|lockedDoc
init|=
name|context
operator|.
name|getBroker
argument_list|()
operator|.
name|getXMLResource
argument_list|(
name|docUri
argument_list|,
name|LockMode
operator|.
name|READ_LOCK
argument_list|)
init|)
block|{
if|if
condition|(
name|lockedDoc
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
else|else
block|{
return|return
name|docFn
operator|.
name|apply
argument_list|(
name|lockedDoc
operator|.
name|getDocument
argument_list|()
argument_list|)
return|;
block|}
block|}
block|}
specifier|private
specifier|static
name|BigInteger
name|getAbsoluteResourceId
parameter_list|(
specifier|final
name|DocumentImpl
name|doc
parameter_list|)
block|{
return|return
name|encodeAbsoluteResourceId
argument_list|(
name|doc
operator|.
name|getCollection
argument_list|()
operator|.
name|getId
argument_list|()
argument_list|,
name|doc
operator|.
name|getDocId
argument_list|()
argument_list|,
name|doc
operator|.
name|getResourceType
argument_list|()
argument_list|)
return|;
block|}
specifier|private
name|Sequence
name|getResourceByAbsoluteId
parameter_list|(
specifier|final
name|IntegerValue
name|ivAbsoluteId
parameter_list|)
throws|throws
name|XPathException
throws|,
name|PermissionDeniedException
throws|,
name|LockException
throws|,
name|IOException
block|{
specifier|final
name|BigInteger
name|absoluteId
init|=
name|ivAbsoluteId
operator|.
name|toJavaObject
argument_list|(
name|BigInteger
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|final
name|Tuple3
argument_list|<
name|Integer
argument_list|,
name|Integer
argument_list|,
name|Byte
argument_list|>
name|decoded
init|=
name|decodeAbsoluteResourceId
argument_list|(
name|absoluteId
argument_list|)
decl_stmt|;
specifier|final
name|DocumentImpl
name|doc
init|=
name|context
operator|.
name|getBroker
argument_list|()
operator|.
name|getResourceById
argument_list|(
name|decoded
operator|.
name|_1
argument_list|,
name|decoded
operator|.
name|_3
argument_list|,
name|decoded
operator|.
name|_2
argument_list|)
decl_stmt|;
if|if
condition|(
name|doc
operator|!=
literal|null
condition|)
block|{
try|try
init|(
specifier|final
name|ManagedDocumentLock
name|docLock
init|=
name|context
operator|.
name|getBroker
argument_list|()
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getLockManager
argument_list|()
operator|.
name|acquireDocumentReadLock
argument_list|(
name|doc
operator|.
name|getURI
argument_list|()
argument_list|)
init|)
block|{
if|if
condition|(
name|doc
operator|instanceof
name|BinaryDocument
condition|)
block|{
specifier|final
name|BinaryDocument
name|bin
init|=
operator|(
name|BinaryDocument
operator|)
name|doc
decl_stmt|;
specifier|final
name|InputStream
name|is
init|=
name|context
operator|.
name|getBroker
argument_list|()
operator|.
name|getBinaryResource
argument_list|(
name|bin
argument_list|)
decl_stmt|;
return|return
name|Base64BinaryDocument
operator|.
name|getInstance
argument_list|(
name|context
argument_list|,
name|is
argument_list|)
return|;
block|}
else|else
block|{
return|return
operator|new
name|NodeProxy
argument_list|(
name|doc
argument_list|)
return|;
block|}
block|}
block|}
return|return
name|Sequence
operator|.
name|EMPTY_SEQUENCE
return|;
block|}
specifier|private
specifier|static
name|BigInteger
name|encodeAbsoluteResourceId
parameter_list|(
specifier|final
name|int
name|collectionId
parameter_list|,
specifier|final
name|int
name|documentId
parameter_list|,
specifier|final
name|byte
name|resourceType
parameter_list|)
block|{
name|BigInteger
name|absoluteId
init|=
name|BigInteger
operator|.
name|valueOf
argument_list|(
name|collectionId
argument_list|)
decl_stmt|;
name|absoluteId
operator|=
name|absoluteId
operator|.
name|shiftLeft
argument_list|(
literal|32
argument_list|)
expr_stmt|;
name|absoluteId
operator|=
name|absoluteId
operator|.
name|or
argument_list|(
name|BigInteger
operator|.
name|valueOf
argument_list|(
name|documentId
argument_list|)
argument_list|)
expr_stmt|;
name|absoluteId
operator|=
name|absoluteId
operator|.
name|shiftLeft
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|absoluteId
operator|=
name|absoluteId
operator|.
name|or
argument_list|(
name|BigInteger
operator|.
name|valueOf
argument_list|(
name|resourceType
operator|&
literal|1
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|absoluteId
return|;
block|}
specifier|private
specifier|static
name|Tuple3
argument_list|<
name|Integer
argument_list|,
name|Integer
argument_list|,
name|Byte
argument_list|>
name|decodeAbsoluteResourceId
parameter_list|(
name|BigInteger
name|absoluteId
parameter_list|)
block|{
specifier|final
name|byte
name|resourceType
init|=
name|absoluteId
operator|.
name|testBit
argument_list|(
literal|0
argument_list|)
condition|?
name|DocumentImpl
operator|.
name|BINARY_FILE
else|:
name|DocumentImpl
operator|.
name|XML_FILE
decl_stmt|;
name|absoluteId
operator|=
name|absoluteId
operator|.
name|shiftRight
argument_list|(
literal|1
argument_list|)
expr_stmt|;
specifier|final
name|int
name|documentId
init|=
name|absoluteId
operator|.
name|and
argument_list|(
name|BigInteger
operator|.
name|valueOf
argument_list|(
literal|0xFFFFFFFF
argument_list|)
argument_list|)
operator|.
name|intValue
argument_list|()
decl_stmt|;
name|absoluteId
operator|=
name|absoluteId
operator|.
name|shiftRight
argument_list|(
literal|32
argument_list|)
expr_stmt|;
specifier|final
name|int
name|collectionId
init|=
name|absoluteId
operator|.
name|and
argument_list|(
name|BigInteger
operator|.
name|valueOf
argument_list|(
literal|0xFFFFFFFF
argument_list|)
argument_list|)
operator|.
name|intValue
argument_list|()
decl_stmt|;
return|return
name|Tuple
argument_list|(
name|collectionId
argument_list|,
name|documentId
argument_list|,
name|resourceType
argument_list|)
return|;
block|}
block|}
end_class

end_unit

