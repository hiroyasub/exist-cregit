begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  *  eXist Open Source Native XML Database  *  Copyright (C) 2001 Wolfgang M. Meier  *  meier@ifs.tu-darmstadt.de  *  http://exist.sourceforge.net  *  *  This program is free software; you can redistribute it and/or  *  modify it under the terms of the GNU Lesser General Public License  *  as published by the Free Software Foundation; either version 2  *  of the License, or (at your option) any later version.  *  *  This program is distributed in the hope that it will be useful,  *  but WITHOUT ANY WARRANTY; without even the implied warranty of  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  *  GNU Lesser General Public License for more details.  *  *  You should have received a copy of the GNU Lesser General Public License  *  along with this program; if not, write to the Free Software  *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  *   *  $Id:  */
end_comment

begin_package
package|package
name|org
operator|.
name|exist
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|EOFException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileFilter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileNotFoundException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|LineNumberReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|PushbackInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|StringReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Properties
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Random
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|StringTokenizer
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TreeSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Observer
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Observable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|oro
operator|.
name|io
operator|.
name|GlobFilenameFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|Permission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|User
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|Occurrences
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|XMLFilenameFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|DirectoryScanner
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|CollectionScanner
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|ProgressBar
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|ProgressIndicator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|XMLUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|DatabaseInstanceManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|IndexQueryService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|UserManagementService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|gnu
operator|.
name|readline
operator|.
name|Readline
import|;
end_import

begin_import
import|import
name|org
operator|.
name|gnu
operator|.
name|readline
operator|.
name|ReadlineCompleter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|gnu
operator|.
name|readline
operator|.
name|ReadlineLibrary
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xmldb
operator|.
name|api
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xmldb
operator|.
name|api
operator|.
name|base
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xmldb
operator|.
name|api
operator|.
name|modules
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|avalon
operator|.
name|excalibur
operator|.
name|cli
operator|.
name|*
import|;
end_import

begin_comment
comment|/**  *  Command-line client based on the XML:DB API.  *  *@author     wolf  *@created    April 2, 2002  */
end_comment

begin_class
specifier|public
class|class
name|InteractiveClient
block|{
specifier|private
specifier|final
specifier|static
name|int
name|HELP_OPT
init|=
literal|'h'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|QUIET_OPT
init|=
literal|'q'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|USER_OPT
init|=
literal|'u'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|PASS_OPT
init|=
literal|'P'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|LOCAL_OPT
init|=
literal|'l'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|CONFIG_OPT
init|=
literal|'C'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|PARSE_OPT
init|=
literal|'p'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|COLLECTION_OPT
init|=
literal|'c'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|RESOURCE_OPT
init|=
literal|'f'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|REMOVE_OPT
init|=
literal|'r'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|GET_OPT
init|=
literal|'g'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|MKCOL_OPT
init|=
literal|'m'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|RMCOL_OPT
init|=
literal|'R'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|OPTION_OPT
init|=
literal|'o'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|FIND_OPT
init|=
literal|'x'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|RESULTS_OPT
init|=
literal|'n'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|VERBOSE_OPT
init|=
literal|'v'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|QUERY_FILE_OPT
init|=
literal|'F'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|XUPDATE_OPT
init|=
literal|'X'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|THREADS_OPT
init|=
literal|'t'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|int
name|RECURSE_DIRS_OPT
init|=
literal|'d'
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|CLOptionDescriptor
name|OPTIONS
index|[]
init|=
operator|new
name|CLOptionDescriptor
index|[]
block|{
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"help"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_DISALLOWED
argument_list|,
name|HELP_OPT
argument_list|,
literal|"print help on command line options and exit."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"quiet"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_DISALLOWED
argument_list|,
name|QUIET_OPT
argument_list|,
literal|"be quiet. Just print errors."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"verbose"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_DISALLOWED
argument_list|,
name|VERBOSE_OPT
argument_list|,
literal|"be verbose. Display progress information on put."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"user"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|USER_OPT
argument_list|,
literal|"set username."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"password"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|PASS_OPT
argument_list|,
literal|"specify password."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"local"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_DISALLOWED
argument_list|,
name|LOCAL_OPT
argument_list|,
literal|"launch a local database instance. Otherwise client will connect to "
operator|+
literal|"URI specified in client.properties."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"config"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|CONFIG_OPT
argument_list|,
literal|"specify alternate configuration file. Implies -l."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"parse"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_OPTIONAL
argument_list|,
name|PARSE_OPT
argument_list|,
literal|"store files or directories given as extra args on command line."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"remove"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|REMOVE_OPT
argument_list|,
literal|"remove a document."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"collection"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|COLLECTION_OPT
argument_list|,
literal|"set target collection."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"resource"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|RESOURCE_OPT
argument_list|,
literal|"specify a resource contained in the current collection. "
operator|+
literal|"Use in conjunction with -u to specify the resource to "
operator|+
literal|"update."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"get"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|GET_OPT
argument_list|,
literal|"retrieve a document."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"mkcol"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|MKCOL_OPT
argument_list|,
literal|"create a collection (and any missing parent collection). Implies -c."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"rmcol"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|RMCOL_OPT
argument_list|,
literal|"remove entire collection"
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"xpath"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_OPTIONAL
argument_list|,
name|FIND_OPT
argument_list|,
literal|"execute XPath query given as argument. Without argument reads query from stdin."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"howmany"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|RESULTS_OPT
argument_list|,
literal|"max. number of query results to be displayed."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"option"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENTS_REQUIRED_2
operator||
name|CLOptionDescriptor
operator|.
name|DUPLICATES_ALLOWED
argument_list|,
name|OPTION_OPT
argument_list|,
literal|"specify extra options: property=value. For available properties see "
operator|+
literal|"client.properties."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"file"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|QUERY_FILE_OPT
argument_list|,
literal|"load queries from file and execute in random order."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"threads"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|THREADS_OPT
argument_list|,
literal|"number of parallel threads to test with (use with -f)."
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"recurse-dirs"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_DISALLOWED
argument_list|,
name|RECURSE_DIRS_OPT
argument_list|,
literal|"recurse into subdirectories during index?"
argument_list|)
block|,
operator|new
name|CLOptionDescriptor
argument_list|(
literal|"xupdate"
argument_list|,
name|CLOptionDescriptor
operator|.
name|ARGUMENT_REQUIRED
argument_list|,
name|XUPDATE_OPT
argument_list|,
literal|"process xupdate commands. Commands are read from the "
operator|+
literal|"file specified in the argument."
argument_list|)
block|}
decl_stmt|;
comment|// ANSI colors for ls display
specifier|private
specifier|final
specifier|static
name|String
name|ANSI_BLUE
init|=
literal|"\033[0;34m"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|ANSI_CYAN
init|=
literal|"\033[0;36m"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|ANSI_WHITE
init|=
literal|"\033[0;37m"
decl_stmt|;
comment|// properties
specifier|protected
specifier|static
name|String
name|EDIT_CMD
init|=
literal|"xemacs $file"
decl_stmt|;
specifier|protected
specifier|static
name|String
name|ENCODING
init|=
literal|"ISO-8859-1"
decl_stmt|;
specifier|protected
specifier|static
name|String
name|PASS
init|=
literal|null
decl_stmt|;
specifier|protected
specifier|static
name|String
name|URI
init|=
literal|"xmldb:exist://localhost:8080/exist/xmlrpc"
decl_stmt|;
specifier|protected
specifier|static
name|String
name|USER
init|=
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|SecurityManager
operator|.
name|DBA_USER
decl_stmt|;
specifier|protected
specifier|static
name|int
name|PARALLEL_THREADS
init|=
literal|5
decl_stmt|;
specifier|protected
specifier|static
name|Properties
name|defaultProps
init|=
operator|new
name|Properties
argument_list|()
decl_stmt|;
block|{
name|defaultProps
operator|.
name|setProperty
argument_list|(
literal|"driver"
argument_list|,
name|driver
argument_list|)
expr_stmt|;
name|defaultProps
operator|.
name|setProperty
argument_list|(
literal|"uri"
argument_list|,
name|URI
argument_list|)
expr_stmt|;
name|defaultProps
operator|.
name|setProperty
argument_list|(
literal|"editor"
argument_list|,
name|EDIT_CMD
argument_list|)
expr_stmt|;
name|defaultProps
operator|.
name|setProperty
argument_list|(
literal|"indent"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
name|defaultProps
operator|.
name|setProperty
argument_list|(
literal|"encoding"
argument_list|,
name|ENCODING
argument_list|)
expr_stmt|;
name|defaultProps
operator|.
name|setProperty
argument_list|(
literal|"user"
argument_list|,
name|USER
argument_list|)
expr_stmt|;
name|defaultProps
operator|.
name|setProperty
argument_list|(
literal|"colors"
argument_list|,
literal|"false"
argument_list|)
expr_stmt|;
name|defaultProps
operator|.
name|setProperty
argument_list|(
literal|"permissions"
argument_list|,
literal|"false"
argument_list|)
expr_stmt|;
name|defaultProps
operator|.
name|setProperty
argument_list|(
literal|"expand-xincludes"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
block|}
specifier|protected
specifier|static
name|String
name|driver
init|=
literal|"org.exist.xmldb.DatabaseImpl"
decl_stmt|;
specifier|protected
specifier|static
name|String
name|configuration
init|=
literal|null
decl_stmt|;
specifier|protected
name|TreeSet
name|completitions
init|=
operator|new
name|TreeSet
argument_list|()
decl_stmt|;
specifier|protected
name|Collection
name|current
init|=
literal|null
decl_stmt|;
specifier|protected
name|int
name|nextInSet
init|=
literal|1
decl_stmt|;
specifier|protected
name|int
name|maxResults
init|=
literal|10
decl_stmt|;
specifier|protected
name|String
name|path
init|=
literal|"/db"
decl_stmt|;
specifier|protected
name|Properties
name|properties
decl_stmt|;
specifier|protected
name|String
index|[]
name|resources
init|=
literal|null
decl_stmt|;
specifier|protected
name|ResourceSet
name|result
init|=
literal|null
decl_stmt|;
specifier|protected
name|int
name|filesCount
init|=
literal|0
decl_stmt|;
specifier|protected
name|long
name|bytesCount
init|=
literal|0
decl_stmt|;
specifier|protected
name|boolean
name|quiet
init|=
literal|false
decl_stmt|;
specifier|protected
name|boolean
name|verbose
init|=
literal|false
decl_stmt|;
specifier|protected
name|boolean
name|recurseDirs
init|=
literal|false
decl_stmt|;
specifier|public
name|InteractiveClient
parameter_list|()
block|{
block|}
comment|/**  Display help on commands */
specifier|protected
specifier|static
name|void
name|displayHelp
parameter_list|()
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"--- general commands ---"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"ls                   list collection contents"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"cd [collection|..]   change current collection"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"put [file pattern] upload file or directory"
operator|+
literal|" to the database"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"mkcol collection     create new sub-collection in "
operator|+
literal|"current collection"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"rm document          remove document from current "
operator|+
literal|"collection"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"rmcol collection     remove collection"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"set [key=value]      set property. Calling set without "
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"                     argument shows current settings."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"\n--- search commands ---"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"find xpath-expr      execute the given XPath expression."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"show [position]      display query result value at position."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"\n--- user management (may require dba rights) ---"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"users                list existing users."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"adduser username     create a new user."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"passwd username      change password for user. "
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"chown user group [resource]"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"                     change resource ownership. chown without"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"                     resource changes ownership of the current"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"                     collection."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"chmod [resource] permissions"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"                     change resource permissions. Format:"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"                     [user|group|other]=[+|-][read|write|update]."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"                     chmod without resource changes permissions for"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"                     the current collection."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"quit                 quit the program"
argument_list|)
expr_stmt|;
block|}
comment|/** 	 *  The main program for the InteractiveClient class. 	 * 	 *@param  args  The command line arguments 	 */
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|args
parameter_list|)
block|{
try|try
block|{
name|InteractiveClient
name|client
init|=
operator|new
name|InteractiveClient
argument_list|()
decl_stmt|;
name|client
operator|.
name|run
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
block|}
comment|/** 	 *  Register XML:DB driver and retrieve root collection. 	 * 	 *@exception  Exception  Description of the Exception 	 */
specifier|private
name|void
name|connect
parameter_list|()
throws|throws
name|Exception
block|{
name|Class
name|cl
init|=
name|Class
operator|.
name|forName
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"driver"
argument_list|)
argument_list|)
decl_stmt|;
name|Database
name|database
init|=
operator|(
name|Database
operator|)
name|cl
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|database
operator|.
name|setProperty
argument_list|(
literal|"create-database"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
if|if
condition|(
name|properties
operator|.
name|containsKey
argument_list|(
literal|"configuration"
argument_list|)
condition|)
name|database
operator|.
name|setProperty
argument_list|(
literal|"configuration"
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"configuration"
argument_list|)
argument_list|)
expr_stmt|;
name|DatabaseManager
operator|.
name|registerDatabase
argument_list|(
name|database
argument_list|)
expr_stmt|;
name|current
operator|=
name|DatabaseManager
operator|.
name|getCollection
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"uri"
argument_list|)
operator|+
name|path
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"user"
argument_list|)
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"password"
argument_list|)
argument_list|)
expr_stmt|;
name|getResources
argument_list|()
expr_stmt|;
block|}
comment|/** 	 *  Get list of resources contained in collection. 	 * 	 *@exception  XMLDBException  Description of the Exception 	 */
specifier|private
name|void
name|getResources
parameter_list|()
throws|throws
name|XMLDBException
block|{
if|if
condition|(
name|current
operator|==
literal|null
condition|)
return|return;
name|UserManagementService
name|mgtService
init|=
operator|(
name|UserManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"UserManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|String
name|childCollections
index|[]
init|=
name|current
operator|.
name|listChildCollections
argument_list|()
decl_stmt|;
name|String
name|childResources
index|[]
init|=
name|current
operator|.
name|listResources
argument_list|()
decl_stmt|;
name|Permission
name|perms
index|[]
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"permissions"
argument_list|)
operator|.
name|equals
argument_list|(
literal|"true"
argument_list|)
condition|)
name|perms
operator|=
name|mgtService
operator|.
name|listCollectionPermissions
argument_list|()
expr_stmt|;
name|resources
operator|=
operator|new
name|String
index|[
name|childCollections
operator|.
name|length
operator|+
name|childResources
operator|.
name|length
index|]
expr_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|Collection
name|child
decl_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|childCollections
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|child
operator|=
name|current
operator|.
name|getChildCollection
argument_list|(
name|childCollections
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"permissions"
argument_list|)
operator|.
name|equals
argument_list|(
literal|"true"
argument_list|)
condition|)
block|{
if|if
condition|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"colors"
argument_list|)
operator|.
name|equals
argument_list|(
literal|"true"
argument_list|)
condition|)
name|resources
index|[
name|i
index|]
operator|=
literal|'d'
operator|+
name|perms
index|[
name|i
index|]
operator|.
name|toString
argument_list|()
operator|+
literal|'\t'
operator|+
name|ANSI_BLUE
operator|+
name|childCollections
index|[
name|i
index|]
operator|+
name|ANSI_WHITE
expr_stmt|;
else|else
name|resources
index|[
name|i
index|]
operator|=
literal|'d'
operator|+
name|perms
index|[
name|i
index|]
operator|.
name|toString
argument_list|()
operator|+
literal|'\t'
operator|+
name|childCollections
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
name|resources
index|[
name|i
index|]
operator|=
name|childCollections
index|[
name|i
index|]
expr_stmt|;
name|completitions
operator|.
name|add
argument_list|(
name|childCollections
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"permissions"
argument_list|)
operator|.
name|equals
argument_list|(
literal|"true"
argument_list|)
condition|)
name|perms
operator|=
name|mgtService
operator|.
name|listResourcePermissions
argument_list|()
expr_stmt|;
name|Resource
name|res
decl_stmt|;
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|j
operator|<
name|childResources
operator|.
name|length
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
name|res
operator|=
name|current
operator|.
name|getResource
argument_list|(
name|childResources
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"permissions"
argument_list|)
operator|.
name|equals
argument_list|(
literal|"true"
argument_list|)
operator|&&
name|j
operator|<
name|perms
operator|.
name|length
condition|)
block|{
name|resources
index|[
name|i
index|]
operator|=
literal|'-'
operator|+
name|perms
index|[
name|j
index|]
operator|.
name|toString
argument_list|()
operator|+
literal|'\t'
operator|+
name|childResources
index|[
name|j
index|]
expr_stmt|;
block|}
else|else
name|resources
index|[
name|i
index|]
operator|=
name|childResources
index|[
name|j
index|]
expr_stmt|;
name|completitions
operator|.
name|add
argument_list|(
name|childResources
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
block|}
comment|/** 	 *  Display document on screen. 	 * 	 *@param  str  Description of the Parameter 	 */
specifier|protected
name|void
name|more
parameter_list|(
name|String
name|str
parameter_list|)
block|{
name|LineNumberReader
name|reader
init|=
operator|new
name|LineNumberReader
argument_list|(
operator|new
name|StringReader
argument_list|(
name|str
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|line
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|int
name|ch
decl_stmt|;
try|try
block|{
while|while
condition|(
name|System
operator|.
name|in
operator|.
name|available
argument_list|()
operator|>
literal|0
condition|)
name|System
operator|.
name|in
operator|.
name|read
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|line
operator|=
name|reader
operator|.
name|readLine
argument_list|()
operator|)
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|reader
operator|.
name|getLineNumber
argument_list|()
operator|%
literal|24
operator|==
literal|0
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|print
argument_list|(
literal|"line: "
operator|+
name|reader
operator|.
name|getLineNumber
argument_list|()
operator|+
literal|"; press [return] for more or [q] for quit."
argument_list|)
expr_stmt|;
name|ch
operator|=
name|System
operator|.
name|in
operator|.
name|read
argument_list|()
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'q'
operator|||
name|ch
operator|==
literal|'Q'
condition|)
return|return;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|line
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"IOException: "
operator|+
name|ioe
argument_list|)
expr_stmt|;
block|}
block|}
comment|/** 	 *  In interactive mode, process a line entered by the user. 	 * 	 *@param  line  the line entered 	 *@return       true if command != quit 	 */
specifier|private
name|boolean
name|process
parameter_list|(
name|String
name|line
parameter_list|)
block|{
name|String
name|args
index|[]
decl_stmt|;
if|if
condition|(
name|line
operator|.
name|startsWith
argument_list|(
literal|"find"
argument_list|)
condition|)
block|{
name|args
operator|=
operator|new
name|String
index|[
literal|2
index|]
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
literal|"find"
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
name|line
operator|.
name|substring
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|StringTokenizer
name|tok
init|=
operator|new
name|StringTokenizer
argument_list|(
name|line
argument_list|,
literal|" "
argument_list|)
decl_stmt|;
name|args
operator|=
operator|new
name|String
index|[
name|tok
operator|.
name|countTokens
argument_list|()
index|]
expr_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|tok
operator|.
name|hasMoreTokens
argument_list|()
condition|)
name|args
index|[
name|i
operator|++
index|]
operator|=
name|tok
operator|.
name|nextToken
argument_list|()
expr_stmt|;
block|}
name|String
name|newPath
init|=
name|path
decl_stmt|;
try|try
block|{
if|if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"ls"
argument_list|)
condition|)
block|{
comment|// list collection contents
if|if
condition|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"permissions"
argument_list|)
operator|.
name|equals
argument_list|(
literal|"true"
argument_list|)
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|resources
operator|.
name|length
condition|;
name|i
operator|++
control|)
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|resources
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|StringBuffer
name|buf
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|resources
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|buf
operator|=
operator|new
name|StringBuffer
argument_list|()
expr_stmt|;
name|int
name|k
init|=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|i
operator|<
name|resources
operator|.
name|length
operator|&&
name|j
operator|<
literal|5
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
name|buf
operator|.
name|append
argument_list|(
name|resources
index|[
name|i
index|]
operator|+
literal|'\t'
argument_list|)
expr_stmt|;
name|k
operator|=
name|j
expr_stmt|;
block|}
if|if
condition|(
name|k
operator|==
literal|4
operator|&&
name|i
operator|<
name|resources
operator|.
name|length
condition|)
name|i
operator|--
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|buf
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"cd"
argument_list|)
condition|)
block|{
comment|// change current collection
name|completitions
operator|.
name|clear
argument_list|()
expr_stmt|;
name|String
name|tempPath
init|=
name|newPath
decl_stmt|;
name|Collection
name|temp
decl_stmt|;
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
operator|||
name|args
index|[
literal|1
index|]
operator|==
literal|null
condition|)
block|{
name|tempPath
operator|=
literal|"/db"
expr_stmt|;
name|temp
operator|=
name|DatabaseManager
operator|.
name|getCollection
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"uri"
argument_list|)
operator|+
literal|"/db"
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"user"
argument_list|)
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"password"
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
operator|.
name|equals
argument_list|(
literal|".."
argument_list|)
condition|)
block|{
name|tempPath
operator|=
name|newPath
operator|.
name|equals
argument_list|(
literal|"/db"
argument_list|)
condition|?
literal|"/db"
else|:
name|tempPath
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|newPath
operator|.
name|lastIndexOf
argument_list|(
literal|"/"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempPath
operator|.
name|length
argument_list|()
operator|==
literal|0
condition|)
name|tempPath
operator|=
literal|"/db"
expr_stmt|;
block|}
if|else if
condition|(
name|args
index|[
literal|1
index|]
operator|.
name|startsWith
argument_list|(
literal|"/"
argument_list|)
condition|)
name|tempPath
operator|=
name|args
index|[
literal|1
index|]
expr_stmt|;
else|else
name|tempPath
operator|=
name|tempPath
operator|+
literal|'/'
operator|+
name|args
index|[
literal|1
index|]
expr_stmt|;
name|temp
operator|=
name|DatabaseManager
operator|.
name|getCollection
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"uri"
argument_list|)
operator|+
name|tempPath
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"user"
argument_list|)
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"password"
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|temp
operator|!=
literal|null
condition|)
block|{
name|current
operator|=
name|temp
expr_stmt|;
name|newPath
operator|=
name|tempPath
expr_stmt|;
block|}
else|else
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"no such collection."
argument_list|)
expr_stmt|;
block|}
name|getResources
argument_list|()
expr_stmt|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"get"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"wrong number of arguments."
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
comment|// display document
name|String
name|content
init|=
name|retrieve
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|content
operator|!=
literal|null
condition|)
name|more
argument_list|(
name|content
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"find"
argument_list|)
condition|)
block|{
comment|// search
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"no query argument found."
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|result
operator|=
name|find
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
literal|null
condition|)
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"nothing found"
argument_list|)
expr_stmt|;
else|else
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"found "
operator|+
name|result
operator|.
name|getSize
argument_list|()
operator|+
literal|" hits in "
operator|+
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
operator|+
literal|"ms."
argument_list|)
expr_stmt|;
name|nextInSet
operator|=
literal|1
expr_stmt|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"show"
argument_list|)
condition|)
block|{
comment|// show search results
if|if
condition|(
name|result
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"no result set."
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
try|try
block|{
name|int
name|start
init|=
name|nextInSet
decl_stmt|;
name|int
name|count
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|args
operator|.
name|length
operator|>
literal|1
condition|)
name|start
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|.
name|length
operator|>
literal|2
condition|)
name|count
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|args
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|<
literal|1
operator|||
name|start
operator|>
name|result
operator|.
name|getSize
argument_list|()
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"start offset out of range"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
operator|--
name|start
expr_stmt|;
if|if
condition|(
name|start
operator|+
name|count
operator|>
name|result
operator|.
name|getSize
argument_list|()
condition|)
name|count
operator|=
operator|(
name|int
operator|)
name|result
operator|.
name|getSize
argument_list|()
operator|-
name|start
expr_stmt|;
name|nextInSet
operator|=
name|start
operator|+
name|count
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
name|start
init|;
name|i
operator|<
name|start
operator|+
name|count
condition|;
name|i
operator|++
control|)
block|{
name|Resource
name|r
init|=
name|result
operator|.
name|getResource
argument_list|(
operator|(
name|long
operator|)
name|i
argument_list|)
decl_stmt|;
name|more
argument_list|(
operator|(
name|String
operator|)
name|r
operator|.
name|getContent
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"displayed items "
operator|+
operator|(
name|start
operator|+
literal|1
operator|)
operator|+
literal|" to "
operator|+
operator|(
name|start
operator|+
name|count
operator|)
operator|+
literal|" of "
operator|+
name|result
operator|.
name|getSize
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|nfe
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"wrong argument"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"mkcol"
argument_list|)
condition|)
block|{
comment|// create collection
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"missing argument."
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|CollectionManagementService
name|mgtService
init|=
operator|(
name|CollectionManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"CollectionManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|Collection
name|newCollection
init|=
name|mgtService
operator|.
name|createCollection
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|newCollection
operator|==
literal|null
condition|)
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"could not create collection."
argument_list|)
expr_stmt|;
else|else
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"created collection."
argument_list|)
expr_stmt|;
comment|// re-read current collection
name|current
operator|=
name|DatabaseManager
operator|.
name|getCollection
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"uri"
argument_list|)
operator|+
name|path
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"user"
argument_list|)
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"password"
argument_list|)
argument_list|)
expr_stmt|;
name|getResources
argument_list|()
expr_stmt|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"put"
argument_list|)
condition|)
block|{
comment|// put a document or directory into the database
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"missing argument."
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|boolean
name|r
init|=
name|parse
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
name|getResources
argument_list|()
expr_stmt|;
return|return
name|r
return|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"rm"
argument_list|)
condition|)
block|{
comment|// remove document
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"missing argument."
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|remove
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|// re-read current collection
name|current
operator|=
name|DatabaseManager
operator|.
name|getCollection
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"uri"
argument_list|)
operator|+
name|path
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"user"
argument_list|)
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"password"
argument_list|)
argument_list|)
expr_stmt|;
name|getResources
argument_list|()
expr_stmt|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"rmcol"
argument_list|)
condition|)
block|{
comment|// remove collection
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"wrong argument count."
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|rmcol
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|// re-read current collection
name|current
operator|=
name|DatabaseManager
operator|.
name|getCollection
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"uri"
argument_list|)
operator|+
name|path
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"user"
argument_list|)
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"password"
argument_list|)
argument_list|)
expr_stmt|;
name|getResources
argument_list|()
expr_stmt|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"adduser"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Usage: adduser name"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
try|try
block|{
name|UserManagementService
name|mgtService
init|=
operator|(
name|UserManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"UserManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|String
name|p1
decl_stmt|;
name|String
name|p2
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
name|p1
operator|=
name|Readline
operator|.
name|readline
argument_list|(
literal|"password: "
argument_list|)
expr_stmt|;
name|p2
operator|=
name|Readline
operator|.
name|readline
argument_list|(
literal|"re-enter password: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|p1
operator|.
name|equals
argument_list|(
name|p2
argument_list|)
condition|)
break|break;
else|else
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"\nentered passwords differ. Try again..."
argument_list|)
expr_stmt|;
block|}
name|User
name|user
init|=
operator|new
name|User
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|,
name|p1
argument_list|)
decl_stmt|;
name|String
name|groups
init|=
name|Readline
operator|.
name|readline
argument_list|(
literal|"enter groups: "
argument_list|)
decl_stmt|;
name|StringTokenizer
name|tok
init|=
operator|new
name|StringTokenizer
argument_list|(
name|groups
argument_list|,
literal|" ,"
argument_list|)
decl_stmt|;
name|String
name|group
decl_stmt|;
while|while
condition|(
name|tok
operator|.
name|hasMoreTokens
argument_list|()
condition|)
block|{
name|group
operator|=
name|tok
operator|.
name|nextToken
argument_list|()
expr_stmt|;
if|if
condition|(
name|group
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
name|user
operator|.
name|addGroup
argument_list|(
name|group
argument_list|)
expr_stmt|;
block|}
name|mgtService
operator|.
name|addUser
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"user "
operator|+
name|user
operator|+
literal|" created."
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"ERROR: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"users"
argument_list|)
condition|)
block|{
name|UserManagementService
name|mgtService
init|=
operator|(
name|UserManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"UserManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|User
name|users
index|[]
init|=
name|mgtService
operator|.
name|getUsers
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"User\t\tGroups"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"-----------------------------------------"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|users
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|System
operator|.
name|out
operator|.
name|print
argument_list|(
name|users
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
operator|+
literal|"\t\t"
argument_list|)
expr_stmt|;
for|for
control|(
name|Iterator
name|j
init|=
name|users
index|[
name|i
index|]
operator|.
name|getGroups
argument_list|()
init|;
name|j
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|System
operator|.
name|out
operator|.
name|print
argument_list|(
name|j
operator|.
name|next
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|.
name|hasNext
argument_list|()
condition|)
name|System
operator|.
name|out
operator|.
name|print
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"passwd"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Usage: passwd username"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
try|try
block|{
name|UserManagementService
name|mgtService
init|=
operator|(
name|UserManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"UserManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|User
name|user
init|=
name|mgtService
operator|.
name|getUser
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|user
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"no such user."
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|String
name|p1
decl_stmt|;
name|String
name|p2
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
name|p1
operator|=
name|Readline
operator|.
name|readline
argument_list|(
literal|"password: "
argument_list|)
expr_stmt|;
name|p2
operator|=
name|Readline
operator|.
name|readline
argument_list|(
literal|"re-enter password: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|p1
operator|.
name|equals
argument_list|(
name|p2
argument_list|)
condition|)
break|break;
else|else
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"\nentered passwords differ. Try again..."
argument_list|)
expr_stmt|;
block|}
name|user
operator|.
name|setPassword
argument_list|(
name|p1
argument_list|)
expr_stmt|;
name|mgtService
operator|.
name|updateUser
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|properties
operator|.
name|setProperty
argument_list|(
literal|"password"
argument_list|,
name|p1
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"ERROR: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"chmod"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Usage: chmod [resource] mode"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|Collection
name|temp
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|args
operator|.
name|length
operator|==
literal|3
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"trying collection: "
operator|+
name|args
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|temp
operator|=
name|current
operator|.
name|getChildCollection
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"\ntrying resource: "
operator|+
name|args
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|Resource
name|r
init|=
name|current
operator|.
name|getResource
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|!=
literal|null
condition|)
block|{
name|UserManagementService
name|mgtService
init|=
operator|(
name|UserManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"UserManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|mgtService
operator|.
name|chmod
argument_list|(
name|r
argument_list|,
name|args
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
else|else
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Resource "
operator|+
name|args
index|[
literal|1
index|]
operator|+
literal|" not found."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|UserManagementService
name|mgtService
init|=
operator|(
name|UserManagementService
operator|)
name|temp
operator|.
name|getService
argument_list|(
literal|"UserManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|mgtService
operator|.
name|chmod
argument_list|(
name|args
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|UserManagementService
name|mgtService
init|=
operator|(
name|UserManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"UserManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|mgtService
operator|.
name|chmod
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
comment|// re-read current collection
name|current
operator|=
name|DatabaseManager
operator|.
name|getCollection
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"uri"
argument_list|)
operator|+
name|path
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"user"
argument_list|)
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"password"
argument_list|)
argument_list|)
expr_stmt|;
name|getResources
argument_list|()
expr_stmt|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"chown"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|3
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Usage: chown username group [resource]"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|Collection
name|temp
decl_stmt|;
if|if
condition|(
name|args
operator|.
name|length
operator|==
literal|4
condition|)
name|temp
operator|=
name|current
operator|.
name|getChildCollection
argument_list|(
name|args
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
else|else
name|temp
operator|=
name|current
expr_stmt|;
if|if
condition|(
name|temp
operator|!=
literal|null
condition|)
block|{
name|UserManagementService
name|mgtService
init|=
operator|(
name|UserManagementService
operator|)
name|temp
operator|.
name|getService
argument_list|(
literal|"UserManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|User
name|u
init|=
name|mgtService
operator|.
name|getUser
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|u
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"unknown user"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|mgtService
operator|.
name|chown
argument_list|(
name|u
argument_list|,
name|args
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"owner changed."
argument_list|)
expr_stmt|;
name|getResources
argument_list|()
expr_stmt|;
return|return
literal|true
return|;
block|}
name|Resource
name|res
init|=
name|current
operator|.
name|getResource
argument_list|(
name|args
index|[
literal|3
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
operator|!=
literal|null
condition|)
block|{
name|UserManagementService
name|mgtService
init|=
operator|(
name|UserManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"UserManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|User
name|u
init|=
name|mgtService
operator|.
name|getUser
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|u
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"unknown user"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|mgtService
operator|.
name|chown
argument_list|(
name|res
argument_list|,
name|u
argument_list|,
name|args
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|getResources
argument_list|()
expr_stmt|;
return|return
literal|true
return|;
block|}
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Resource "
operator|+
name|args
index|[
literal|3
index|]
operator|+
literal|" not found."
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"elements"
argument_list|)
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Element occurrences in collection "
operator|+
name|current
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"--------------------------------------------"
operator|+
literal|"-----------"
argument_list|)
expr_stmt|;
name|IndexQueryService
name|service
init|=
operator|(
name|IndexQueryService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"IndexQueryService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|Occurrences
index|[]
name|elements
init|=
name|service
operator|.
name|getIndexedElements
argument_list|(
literal|true
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|elements
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|formatString
argument_list|(
name|elements
index|[
name|i
index|]
operator|.
name|getTerm
argument_list|()
argument_list|,
name|Integer
operator|.
name|toString
argument_list|(
name|elements
index|[
name|i
index|]
operator|.
name|getOccurrences
argument_list|()
argument_list|)
argument_list|,
literal|50
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|true
return|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"terms"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
operator|.
name|length
operator|<
literal|3
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Usage: terms sequence-start sequence-end"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|IndexQueryService
name|service
init|=
operator|(
name|IndexQueryService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"IndexQueryService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|Occurrences
index|[]
name|terms
init|=
name|service
operator|.
name|scanIndexTerms
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|,
name|args
index|[
literal|2
index|]
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Element occurrences in collection "
operator|+
name|current
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"--------------------------------------------"
operator|+
literal|"-----------"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|terms
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|formatString
argument_list|(
name|terms
index|[
name|i
index|]
operator|.
name|getTerm
argument_list|()
argument_list|,
name|Integer
operator|.
name|toString
argument_list|(
name|terms
index|[
name|i
index|]
operator|.
name|getOccurrences
argument_list|()
argument_list|)
argument_list|,
literal|50
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"set"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
operator|.
name|length
operator|==
literal|1
condition|)
name|properties
operator|.
name|list
argument_list|(
name|System
operator|.
name|out
argument_list|)
expr_stmt|;
else|else
try|try
block|{
name|StringTokenizer
name|tok
init|=
operator|new
name|StringTokenizer
argument_list|(
name|args
index|[
literal|1
index|]
argument_list|,
literal|"= "
argument_list|)
decl_stmt|;
if|if
condition|(
name|tok
operator|.
name|countTokens
argument_list|()
operator|<
literal|2
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"please specify a key=value pair"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|String
name|key
init|=
name|tok
operator|.
name|nextToken
argument_list|()
decl_stmt|;
name|String
name|val
init|=
name|tok
operator|.
name|nextToken
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|key
operator|+
literal|" = "
operator|+
name|val
argument_list|)
expr_stmt|;
name|properties
operator|.
name|setProperty
argument_list|(
name|key
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|getResources
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Exception: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"shutdown"
argument_list|)
condition|)
block|{
name|DatabaseInstanceManager
name|mgr
init|=
operator|(
name|DatabaseInstanceManager
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"DatabaseInstanceManager"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
if|if
condition|(
name|mgr
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"service is not available"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|mgr
operator|.
name|shutdown
argument_list|()
expr_stmt|;
return|return
literal|true
return|;
block|}
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"help"
argument_list|)
operator|||
name|args
index|[
literal|0
index|]
operator|.
name|equals
argument_list|(
literal|"?"
argument_list|)
condition|)
name|displayHelp
argument_list|()
expr_stmt|;
if|else if
condition|(
name|args
index|[
literal|0
index|]
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"quit"
argument_list|)
condition|)
return|return
literal|false
return|;
else|else
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"unknown command"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
name|path
operator|=
name|newPath
expr_stmt|;
return|return
literal|true
return|;
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|xde
parameter_list|)
block|{
name|xde
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"XMLDBException: "
operator|+
name|xde
operator|.
name|getMessage
argument_list|()
operator|+
literal|" ["
operator|+
name|xde
operator|.
name|errorCode
operator|+
literal|"]"
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
block|}
specifier|private
specifier|final
name|ResourceSet
name|find
parameter_list|(
name|String
name|xpath
parameter_list|)
throws|throws
name|XMLDBException
block|{
name|XPathQueryService
name|service
init|=
operator|(
name|XPathQueryService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"XPathQueryService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|service
operator|.
name|setProperty
argument_list|(
literal|"pretty"
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"indent"
argument_list|)
argument_list|)
expr_stmt|;
name|service
operator|.
name|setProperty
argument_list|(
literal|"encoding"
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"encoding"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|service
operator|.
name|query
argument_list|(
name|xpath
argument_list|)
return|;
block|}
specifier|private
specifier|final
name|void
name|testQuery
parameter_list|(
name|String
name|queryFile
parameter_list|)
block|{
try|try
block|{
name|File
name|f
init|=
operator|new
name|File
argument_list|(
name|queryFile
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|f
operator|.
name|canRead
argument_list|()
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"can't read query file: "
operator|+
name|queryFile
argument_list|)
expr_stmt|;
return|return;
block|}
name|BufferedReader
name|reader
init|=
operator|new
name|BufferedReader
argument_list|(
operator|new
name|FileReader
argument_list|(
name|f
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|line
decl_stmt|;
name|ArrayList
name|queries
init|=
operator|new
name|ArrayList
argument_list|(
literal|10
argument_list|)
decl_stmt|;
name|QueryThread
name|thread
init|=
literal|null
decl_stmt|;
while|while
condition|(
operator|(
name|line
operator|=
name|reader
operator|.
name|readLine
argument_list|()
operator|)
operator|!=
literal|null
condition|)
name|queries
operator|.
name|add
argument_list|(
name|line
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|PARALLEL_THREADS
condition|;
name|i
operator|++
control|)
block|{
name|thread
operator|=
operator|new
name|QueryThread
argument_list|(
name|queries
argument_list|)
expr_stmt|;
name|thread
operator|.
name|setName
argument_list|(
literal|"QueryThread"
operator|+
name|i
argument_list|)
expr_stmt|;
name|thread
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
try|try
block|{
name|thread
operator|.
name|join
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
block|}
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"ERROR: "
operator|+
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"ERROR: "
operator|+
name|e
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
class|class
name|QueryThread
extends|extends
name|Thread
block|{
name|ArrayList
name|queries
decl_stmt|;
specifier|public
name|QueryThread
parameter_list|(
name|ArrayList
name|queries
parameter_list|)
block|{
name|this
operator|.
name|queries
operator|=
name|queries
expr_stmt|;
block|}
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|Collection
name|collection
init|=
name|DatabaseManager
operator|.
name|getCollection
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"uri"
argument_list|)
operator|+
name|path
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"user"
argument_list|)
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"password"
argument_list|)
argument_list|)
decl_stmt|;
name|XPathQueryService
name|service
init|=
operator|(
name|XPathQueryService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"XPathQueryService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|service
operator|.
name|setProperty
argument_list|(
literal|"pretty"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
name|service
operator|.
name|setProperty
argument_list|(
literal|"encoding"
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"encoding"
argument_list|)
argument_list|)
expr_stmt|;
name|Random
name|r
init|=
operator|new
name|Random
argument_list|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|query
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|query
operator|=
operator|(
name|String
operator|)
name|queries
operator|.
name|get
argument_list|(
name|r
operator|.
name|nextInt
argument_list|(
name|queries
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|getName
argument_list|()
operator|+
literal|" query: "
operator|+
name|query
argument_list|)
expr_stmt|;
name|ResourceSet
name|result
init|=
name|service
operator|.
name|query
argument_list|(
name|query
argument_list|)
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|getName
argument_list|()
operator|+
literal|" found: "
operator|+
name|result
operator|.
name|getSize
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"ERROR: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|getName
argument_list|()
operator|+
literal|" finished."
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
specifier|final
name|String
name|retrieve
parameter_list|(
name|String
name|resource
parameter_list|)
throws|throws
name|XMLDBException
block|{
name|current
operator|.
name|setProperty
argument_list|(
literal|"pretty"
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"indent"
argument_list|)
argument_list|)
expr_stmt|;
name|current
operator|.
name|setProperty
argument_list|(
literal|"encoding"
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"encoding"
argument_list|)
argument_list|)
expr_stmt|;
name|current
operator|.
name|setProperty
argument_list|(
literal|"expand-xincludes"
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"expand-xincludes"
argument_list|)
argument_list|)
expr_stmt|;
name|XMLResource
name|res
init|=
operator|(
name|XMLResource
operator|)
name|current
operator|.
name|getResource
argument_list|(
name|resource
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"document not found."
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
else|else
return|return
operator|(
name|String
operator|)
name|res
operator|.
name|getContent
argument_list|()
return|;
block|}
specifier|private
specifier|final
name|void
name|remove
parameter_list|(
name|String
name|pattern
parameter_list|)
throws|throws
name|XMLDBException
block|{
name|Collection
name|collection
init|=
name|current
decl_stmt|;
if|if
condition|(
name|pattern
operator|.
name|startsWith
argument_list|(
literal|"/"
argument_list|)
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"path pattern should be relative to current collection"
argument_list|)
expr_stmt|;
return|return;
block|}
name|Resource
name|resources
index|[]
decl_stmt|;
name|XMLResource
name|res
init|=
operator|(
name|XMLResource
operator|)
name|collection
operator|.
name|getResource
argument_list|(
name|pattern
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
operator|==
literal|null
condition|)
name|resources
operator|=
name|CollectionScanner
operator|.
name|scan
argument_list|(
name|collection
argument_list|,
literal|""
argument_list|,
name|pattern
argument_list|)
expr_stmt|;
else|else
block|{
name|resources
operator|=
operator|new
name|Resource
index|[
literal|1
index|]
expr_stmt|;
name|resources
index|[
literal|0
index|]
operator|=
name|res
expr_stmt|;
block|}
name|Collection
name|parent
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|resources
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|message
argument_list|(
literal|"removing document "
operator|+
operator|(
operator|(
name|XMLResource
operator|)
name|resources
index|[
name|i
index|]
operator|)
operator|.
name|getDocumentId
argument_list|()
operator|+
literal|" ..."
argument_list|)
expr_stmt|;
name|parent
operator|=
name|resources
index|[
name|i
index|]
operator|.
name|getParentCollection
argument_list|()
expr_stmt|;
name|parent
operator|.
name|removeResource
argument_list|(
name|resources
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|messageln
argument_list|(
literal|"done."
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
specifier|final
name|void
name|xupdate
parameter_list|(
name|String
name|resource
parameter_list|,
name|String
name|filename
parameter_list|)
throws|throws
name|XMLDBException
throws|,
name|IOException
block|{
name|File
name|file
init|=
operator|new
name|File
argument_list|(
name|filename
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|file
operator|.
name|exists
argument_list|()
operator|&&
name|file
operator|.
name|canRead
argument_list|()
operator|)
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"cannot read file "
operator|+
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
name|String
name|commands
init|=
name|XMLUtil
operator|.
name|readFile
argument_list|(
name|file
argument_list|,
literal|"UTF-8"
argument_list|)
decl_stmt|;
name|XUpdateQueryService
name|service
init|=
operator|(
name|XUpdateQueryService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"XUpdateQueryService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|long
name|modifications
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|resource
operator|!=
literal|null
condition|)
name|modifications
operator|=
name|service
operator|.
name|update
argument_list|(
name|commands
argument_list|)
expr_stmt|;
else|else
name|modifications
operator|=
name|service
operator|.
name|updateResource
argument_list|(
name|resource
argument_list|,
name|commands
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|modifications
operator|+
literal|" modifications processed "
operator|+
literal|"successfully."
argument_list|)
expr_stmt|;
block|}
specifier|private
specifier|final
name|void
name|rmcol
parameter_list|(
name|String
name|collection
parameter_list|)
throws|throws
name|XMLDBException
block|{
name|CollectionManagementService
name|mgtService
init|=
operator|(
name|CollectionManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"CollectionManagementService"
argument_list|,
literal|"1.0"
argument_list|)
decl_stmt|;
name|message
argument_list|(
literal|"removing collection "
operator|+
name|collection
operator|+
literal|" ..."
argument_list|)
expr_stmt|;
name|mgtService
operator|.
name|removeCollection
argument_list|(
name|collection
argument_list|)
expr_stmt|;
name|messageln
argument_list|(
literal|"done."
argument_list|)
expr_stmt|;
block|}
specifier|private
specifier|final
name|File
index|[]
name|findFiles
parameter_list|(
name|String
name|pattern
parameter_list|)
block|{
name|String
name|pathSep
init|=
name|System
operator|.
name|getProperty
argument_list|(
literal|"file.separator"
argument_list|,
literal|"/"
argument_list|)
decl_stmt|;
name|String
name|baseDir
init|=
literal|"."
decl_stmt|,
name|globExpr
init|=
name|pattern
decl_stmt|;
name|int
name|p
init|=
name|pattern
operator|.
name|lastIndexOf
argument_list|(
name|pathSep
argument_list|)
decl_stmt|;
if|if
condition|(
operator|-
literal|1
operator|<
name|p
condition|)
block|{
name|baseDir
operator|=
name|pattern
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|globExpr
operator|=
name|pattern
operator|.
name|substring
argument_list|(
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|messageln
argument_list|(
literal|"base = "
operator|+
name|baseDir
operator|+
literal|"; glob = "
operator|+
name|globExpr
argument_list|)
expr_stmt|;
name|File
name|dir
init|=
operator|new
name|File
argument_list|(
name|baseDir
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|dir
operator|.
name|isDirectory
argument_list|()
operator|&&
name|dir
operator|.
name|canRead
argument_list|()
operator|)
condition|)
return|return
literal|null
return|;
return|return
name|dir
operator|.
name|listFiles
argument_list|(
operator|(
name|FileFilter
operator|)
operator|new
name|GlobFilenameFilter
argument_list|(
name|globExpr
argument_list|)
argument_list|)
return|;
block|}
specifier|private
specifier|final
name|boolean
name|findRecursive
parameter_list|(
name|Collection
name|collection
parameter_list|,
name|File
name|dir
parameter_list|,
name|String
name|base
parameter_list|)
block|{
name|File
name|temp
index|[]
init|=
name|dir
operator|.
name|listFiles
argument_list|()
decl_stmt|;
if|if
condition|(
name|collection
operator|instanceof
name|Observable
operator|&&
name|verbose
condition|)
block|{
name|ProgressObserver
name|observer
init|=
operator|new
name|ProgressObserver
argument_list|()
decl_stmt|;
operator|(
operator|(
name|Observable
operator|)
name|collection
operator|)
operator|.
name|addObserver
argument_list|(
name|observer
argument_list|)
expr_stmt|;
block|}
name|Collection
name|c
decl_stmt|;
name|XMLResource
name|document
decl_stmt|;
name|CollectionManagementService
name|mgtService
decl_stmt|;
name|String
name|next
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|temp
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|next
operator|=
name|base
operator|+
literal|'/'
operator|+
name|temp
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
expr_stmt|;
try|try
block|{
if|if
condition|(
name|temp
index|[
name|i
index|]
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"entering directory "
operator|+
name|temp
index|[
name|i
index|]
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|c
operator|=
name|collection
operator|.
name|getChildCollection
argument_list|(
name|temp
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|null
condition|)
block|{
name|mgtService
operator|=
operator|(
name|CollectionManagementService
operator|)
name|collection
operator|.
name|getService
argument_list|(
literal|"CollectionManagementService"
argument_list|,
literal|"1.0"
argument_list|)
expr_stmt|;
name|c
operator|=
name|mgtService
operator|.
name|createCollection
argument_list|(
name|temp
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|findRecursive
argument_list|(
name|c
argument_list|,
name|temp
index|[
name|i
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|long
name|start1
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|message
argument_list|(
literal|"storing document "
operator|+
name|temp
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
operator|+
literal|" ("
operator|+
name|i
operator|+
literal|" of "
operator|+
name|temp
operator|.
name|length
operator|+
literal|") "
operator|+
literal|" to "
operator|+
name|next
operator|+
literal|"..."
argument_list|)
expr_stmt|;
name|document
operator|=
operator|(
name|XMLResource
operator|)
name|collection
operator|.
name|createResource
argument_list|(
name|temp
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
argument_list|,
literal|"XMLResource"
argument_list|)
expr_stmt|;
name|document
operator|.
name|setContent
argument_list|(
name|temp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|collection
operator|.
name|storeResource
argument_list|(
name|document
argument_list|)
expr_stmt|;
name|bytesCount
operator|+=
name|temp
index|[
name|i
index|]
operator|.
name|length
argument_list|()
expr_stmt|;
operator|++
name|filesCount
expr_stmt|;
name|messageln
argument_list|(
literal|"stored "
operator|+
name|temp
index|[
name|i
index|]
operator|.
name|length
argument_list|()
operator|+
literal|" bytes in "
operator|+
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start1
operator|)
operator|+
literal|"ms."
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"could not parse file "
operator|+
name|temp
index|[
name|i
index|]
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|true
return|;
block|}
specifier|private
specifier|final
name|boolean
name|parse
parameter_list|(
name|String
name|fileName
parameter_list|)
throws|throws
name|XMLDBException
block|{
name|fileName
operator|=
name|fileName
operator|.
name|replace
argument_list|(
literal|'/'
argument_list|,
name|File
operator|.
name|separatorChar
argument_list|)
operator|.
name|replace
argument_list|(
literal|'\\'
argument_list|,
name|File
operator|.
name|separatorChar
argument_list|)
expr_stmt|;
name|File
name|file
init|=
operator|new
name|File
argument_list|(
name|fileName
argument_list|)
decl_stmt|;
name|XMLResource
name|document
decl_stmt|;
name|String
name|xml
decl_stmt|;
name|File
name|files
index|[]
decl_stmt|;
if|if
condition|(
name|file
operator|.
name|canRead
argument_list|()
condition|)
block|{
if|if
condition|(
name|file
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
if|if
condition|(
name|recurseDirs
condition|)
block|{
name|bytesCount
operator|=
literal|0
expr_stmt|;
name|filesCount
operator|=
literal|0
expr_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|boolean
name|result
init|=
name|findRecursive
argument_list|(
name|current
argument_list|,
name|file
argument_list|,
name|path
argument_list|)
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"storing "
operator|+
name|filesCount
operator|+
literal|" files ("
operator|+
operator|(
name|bytesCount
operator|/
literal|1024
operator|)
operator|+
literal|"K) took "
operator|+
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
operator|+
literal|"ms."
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
else|else
name|files
operator|=
name|file
operator|.
name|listFiles
argument_list|(
operator|new
name|XMLFilenameFilter
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|files
operator|=
operator|new
name|File
index|[
literal|1
index|]
expr_stmt|;
name|files
index|[
literal|0
index|]
operator|=
name|file
expr_stmt|;
block|}
block|}
else|else
name|files
operator|=
name|DirectoryScanner
operator|.
name|scanDir
argument_list|(
name|fileName
argument_list|)
expr_stmt|;
if|if
condition|(
name|current
operator|instanceof
name|Observable
operator|&&
name|verbose
condition|)
block|{
name|ProgressObserver
name|observer
init|=
operator|new
name|ProgressObserver
argument_list|()
decl_stmt|;
operator|(
operator|(
name|Observable
operator|)
name|current
operator|)
operator|.
name|addObserver
argument_list|(
name|observer
argument_list|)
expr_stmt|;
block|}
name|long
name|start
decl_stmt|;
name|long
name|start0
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|long
name|bytes
init|=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|files
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|start
operator|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
expr_stmt|;
name|document
operator|=
operator|(
name|XMLResource
operator|)
name|current
operator|.
name|createResource
argument_list|(
name|files
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
argument_list|,
literal|"XMLResource"
argument_list|)
expr_stmt|;
name|message
argument_list|(
literal|"storing document "
operator|+
name|files
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
operator|+
literal|" ("
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
operator|+
literal|" of "
operator|+
name|files
operator|.
name|length
operator|+
literal|") ..."
argument_list|)
expr_stmt|;
name|document
operator|.
name|setContent
argument_list|(
name|files
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|current
operator|.
name|storeResource
argument_list|(
name|document
argument_list|)
expr_stmt|;
name|messageln
argument_list|(
literal|"done."
argument_list|)
expr_stmt|;
name|messageln
argument_list|(
literal|"parsing "
operator|+
name|files
index|[
name|i
index|]
operator|.
name|length
argument_list|()
operator|+
literal|" bytes took "
operator|+
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
operator|+
literal|"ms.\n"
argument_list|)
expr_stmt|;
name|bytes
operator|+=
name|files
index|[
name|i
index|]
operator|.
name|length
argument_list|()
expr_stmt|;
block|}
name|messageln
argument_list|(
literal|"parsed "
operator|+
name|bytes
operator|+
literal|" bytes in "
operator|+
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start0
operator|)
operator|+
literal|"ms."
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
specifier|private
specifier|final
name|void
name|mkcol
parameter_list|(
name|String
name|collPath
parameter_list|)
throws|throws
name|XMLDBException
block|{
if|if
condition|(
name|collPath
operator|.
name|startsWith
argument_list|(
literal|"/db"
argument_list|)
condition|)
name|collPath
operator|=
name|collPath
operator|.
name|substring
argument_list|(
literal|"/db"
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|CollectionManagementService
name|mgtService
decl_stmt|;
name|Collection
name|c
decl_stmt|;
name|String
name|p
init|=
literal|"/db"
decl_stmt|,
name|token
decl_stmt|;
name|StringTokenizer
name|tok
init|=
operator|new
name|StringTokenizer
argument_list|(
name|collPath
argument_list|,
literal|"/"
argument_list|)
decl_stmt|;
while|while
condition|(
name|tok
operator|.
name|hasMoreTokens
argument_list|()
condition|)
block|{
name|token
operator|=
name|tok
operator|.
name|nextToken
argument_list|()
expr_stmt|;
name|p
operator|=
name|p
operator|+
literal|'/'
operator|+
name|token
expr_stmt|;
name|c
operator|=
name|DatabaseManager
operator|.
name|getCollection
argument_list|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"uri"
argument_list|)
operator|+
name|p
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"user"
argument_list|)
argument_list|,
name|properties
operator|.
name|getProperty
argument_list|(
literal|"password"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|null
condition|)
block|{
name|mgtService
operator|=
operator|(
name|CollectionManagementService
operator|)
name|current
operator|.
name|getService
argument_list|(
literal|"CollectionManagementService"
argument_list|,
literal|"1.0"
argument_list|)
expr_stmt|;
name|current
operator|=
name|mgtService
operator|.
name|createCollection
argument_list|(
name|token
argument_list|)
expr_stmt|;
block|}
else|else
name|current
operator|=
name|c
expr_stmt|;
block|}
name|path
operator|=
name|p
expr_stmt|;
block|}
comment|// Reads user password from given input stream.
specifier|private
name|char
index|[]
name|readPassword
parameter_list|(
name|InputStream
name|in
parameter_list|)
throws|throws
name|IOException
block|{
name|char
index|[]
name|lineBuffer
decl_stmt|;
name|char
index|[]
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|buf
operator|=
name|lineBuffer
operator|=
operator|new
name|char
index|[
literal|128
index|]
expr_stmt|;
name|int
name|room
init|=
name|buf
operator|.
name|length
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|;
name|loop
label|:
while|while
condition|(
literal|true
condition|)
switch|switch
condition|(
name|c
operator|=
name|in
operator|.
name|read
argument_list|()
condition|)
block|{
case|case
operator|-
literal|1
case|:
case|case
literal|'\n'
case|:
break|break
name|loop
break|;
case|case
literal|'\r'
case|:
name|int
name|c2
init|=
name|in
operator|.
name|read
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|c2
operator|!=
literal|'\n'
operator|)
operator|&&
operator|(
name|c2
operator|!=
operator|-
literal|1
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|in
operator|instanceof
name|PushbackInputStream
operator|)
condition|)
name|in
operator|=
operator|new
name|PushbackInputStream
argument_list|(
name|in
argument_list|)
expr_stmt|;
operator|(
operator|(
name|PushbackInputStream
operator|)
name|in
operator|)
operator|.
name|unread
argument_list|(
name|c2
argument_list|)
expr_stmt|;
block|}
else|else
break|break
name|loop
break|;
default|default :
if|if
condition|(
operator|--
name|room
operator|<
literal|0
condition|)
block|{
name|buf
operator|=
operator|new
name|char
index|[
name|offset
operator|+
literal|128
index|]
expr_stmt|;
name|room
operator|=
name|buf
operator|.
name|length
operator|-
name|offset
operator|-
literal|1
expr_stmt|;
name|System
operator|.
name|arraycopy
argument_list|(
name|lineBuffer
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|Arrays
operator|.
name|fill
argument_list|(
name|lineBuffer
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|lineBuffer
operator|=
name|buf
expr_stmt|;
block|}
name|buf
index|[
name|offset
operator|++
index|]
operator|=
operator|(
name|char
operator|)
name|c
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|==
literal|0
condition|)
return|return
literal|null
return|;
name|char
index|[]
name|ret
init|=
operator|new
name|char
index|[
name|offset
index|]
decl_stmt|;
name|System
operator|.
name|arraycopy
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|0
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|Arrays
operator|.
name|fill
argument_list|(
name|buf
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/** 	 *  Main processing method for the InteractiveClient object 	 * 	 *@param  args  Description of the Parameter 	 */
specifier|public
name|void
name|run
parameter_list|(
name|String
name|args
index|[]
parameter_list|)
block|{
comment|// read properties
name|properties
operator|=
operator|new
name|Properties
argument_list|(
name|defaultProps
argument_list|)
expr_stmt|;
try|try
block|{
name|String
name|home
init|=
name|System
operator|.
name|getProperty
argument_list|(
literal|"exist.home"
argument_list|)
decl_stmt|;
name|File
name|propFile
decl_stmt|;
if|if
condition|(
name|home
operator|==
literal|null
condition|)
name|propFile
operator|=
operator|new
name|File
argument_list|(
literal|"client.properties"
argument_list|)
expr_stmt|;
else|else
name|propFile
operator|=
operator|new
name|File
argument_list|(
name|home
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"file.separator"
argument_list|,
literal|"/"
argument_list|)
operator|+
literal|"client.properties"
argument_list|)
expr_stmt|;
name|InputStream
name|pin
decl_stmt|;
if|if
condition|(
name|propFile
operator|.
name|canRead
argument_list|()
condition|)
name|pin
operator|=
operator|new
name|FileInputStream
argument_list|(
name|propFile
argument_list|)
expr_stmt|;
else|else
name|pin
operator|=
name|InteractiveClient
operator|.
name|class
operator|.
name|getResourceAsStream
argument_list|(
literal|"client.properties"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|!=
literal|null
condition|)
name|properties
operator|.
name|load
argument_list|(
name|pin
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
block|}
comment|// parse command-line options
name|CLArgsParser
name|optParser
init|=
operator|new
name|CLArgsParser
argument_list|(
name|args
argument_list|,
name|OPTIONS
argument_list|)
decl_stmt|;
if|if
condition|(
name|optParser
operator|.
name|getErrorString
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"ERROR: "
operator|+
name|optParser
operator|.
name|getErrorString
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
name|List
name|opt
init|=
name|optParser
operator|.
name|getArguments
argument_list|()
decl_stmt|;
name|int
name|size
init|=
name|opt
operator|.
name|size
argument_list|()
decl_stmt|;
name|CLOption
name|option
decl_stmt|;
name|boolean
name|needPasswd
init|=
literal|false
decl_stmt|;
name|boolean
name|interactive
init|=
literal|true
decl_stmt|;
name|boolean
name|foundCollection
init|=
literal|false
decl_stmt|;
name|boolean
name|doParse
init|=
literal|false
decl_stmt|;
name|String
name|optionRemove
init|=
literal|null
decl_stmt|;
name|String
name|optionGet
init|=
literal|null
decl_stmt|;
name|String
name|optionMkcol
init|=
literal|null
decl_stmt|;
name|String
name|optionRmcol
init|=
literal|null
decl_stmt|;
name|String
name|optionXpath
init|=
literal|null
decl_stmt|;
name|String
name|optionQueryFile
init|=
literal|null
decl_stmt|;
name|String
name|optionXUpdate
init|=
literal|null
decl_stmt|;
name|String
name|optionResource
init|=
literal|null
decl_stmt|;
name|List
name|optionalArgs
init|=
operator|new
name|ArrayList
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
name|option
operator|=
operator|(
name|CLOption
operator|)
name|opt
operator|.
name|get
argument_list|(
name|i
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|option
operator|.
name|getId
argument_list|()
condition|)
block|{
case|case
name|HELP_OPT
case|:
name|printUsage
argument_list|()
expr_stmt|;
return|return;
case|case
name|QUIET_OPT
case|:
name|quiet
operator|=
literal|true
expr_stmt|;
break|break;
case|case
name|VERBOSE_OPT
case|:
name|verbose
operator|=
literal|true
expr_stmt|;
break|break;
case|case
name|LOCAL_OPT
case|:
name|properties
operator|.
name|setProperty
argument_list|(
literal|"uri"
argument_list|,
literal|"xmldb:exist://"
argument_list|)
expr_stmt|;
break|break;
case|case
name|USER_OPT
case|:
name|properties
operator|.
name|setProperty
argument_list|(
literal|"user"
argument_list|,
name|option
operator|.
name|getArgument
argument_list|()
argument_list|)
expr_stmt|;
name|needPasswd
operator|=
literal|true
expr_stmt|;
break|break;
case|case
name|PASS_OPT
case|:
name|properties
operator|.
name|setProperty
argument_list|(
literal|"password"
argument_list|,
name|option
operator|.
name|getArgument
argument_list|()
argument_list|)
expr_stmt|;
name|needPasswd
operator|=
literal|false
expr_stmt|;
break|break;
case|case
name|CONFIG_OPT
case|:
name|properties
operator|.
name|setProperty
argument_list|(
literal|"configuration"
argument_list|,
name|option
operator|.
name|getArgument
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|COLLECTION_OPT
case|:
name|path
operator|=
name|option
operator|.
name|getArgument
argument_list|()
expr_stmt|;
name|foundCollection
operator|=
literal|true
expr_stmt|;
break|break;
case|case
name|RESOURCE_OPT
case|:
name|optionResource
operator|=
name|option
operator|.
name|getArgument
argument_list|()
expr_stmt|;
break|break;
case|case
name|PARSE_OPT
case|:
name|doParse
operator|=
literal|true
expr_stmt|;
if|if
condition|(
name|option
operator|.
name|getArgumentCount
argument_list|()
operator|==
literal|1
condition|)
name|optionalArgs
operator|.
name|add
argument_list|(
name|option
operator|.
name|getArgument
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECURSE_DIRS_OPT
case|:
name|recurseDirs
operator|=
literal|true
expr_stmt|;
break|break;
case|case
name|REMOVE_OPT
case|:
name|optionRemove
operator|=
name|option
operator|.
name|getArgument
argument_list|()
expr_stmt|;
break|break;
case|case
name|GET_OPT
case|:
name|optionGet
operator|=
name|option
operator|.
name|getArgument
argument_list|()
expr_stmt|;
break|break;
case|case
name|MKCOL_OPT
case|:
name|optionMkcol
operator|=
name|option
operator|.
name|getArgument
argument_list|()
expr_stmt|;
name|foundCollection
operator|=
literal|true
expr_stmt|;
break|break;
case|case
name|RMCOL_OPT
case|:
name|optionRmcol
operator|=
name|option
operator|.
name|getArgument
argument_list|()
expr_stmt|;
name|foundCollection
operator|=
literal|true
expr_stmt|;
break|break;
case|case
name|FIND_OPT
case|:
name|optionXpath
operator|=
operator|(
name|option
operator|.
name|getArgumentCount
argument_list|()
operator|==
literal|1
condition|?
name|option
operator|.
name|getArgument
argument_list|()
else|:
literal|"stdin"
operator|)
expr_stmt|;
break|break;
case|case
name|RESULTS_OPT
case|:
try|try
block|{
name|maxResults
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|option
operator|.
name|getArgument
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"parameter -n needs a valid number"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|OPTION_OPT
case|:
name|properties
operator|.
name|setProperty
argument_list|(
name|option
operator|.
name|getArgument
argument_list|(
literal|0
argument_list|)
argument_list|,
name|option
operator|.
name|getArgument
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|QUERY_FILE_OPT
case|:
name|optionQueryFile
operator|=
name|option
operator|.
name|getArgument
argument_list|()
expr_stmt|;
break|break;
case|case
name|THREADS_OPT
case|:
try|try
block|{
name|PARALLEL_THREADS
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|option
operator|.
name|getArgument
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"parameter -t needs a valid number"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|XUPDATE_OPT
case|:
name|optionXUpdate
operator|=
name|option
operator|.
name|getArgument
argument_list|()
expr_stmt|;
break|break;
case|case
name|CLOption
operator|.
name|TEXT_ARGUMENT
case|:
name|optionalArgs
operator|.
name|add
argument_list|(
name|option
operator|.
name|getArgument
argument_list|()
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|// prompt for password if needed
if|if
condition|(
name|needPasswd
condition|)
try|try
block|{
name|properties
operator|.
name|setProperty
argument_list|(
literal|"password"
argument_list|,
name|Readline
operator|.
name|readline
argument_list|(
literal|"password: "
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
block|}
if|if
condition|(
operator|!
name|quiet
condition|)
name|printNotice
argument_list|()
expr_stmt|;
comment|// initialize Readline library
try|try
block|{
name|Readline
operator|.
name|load
argument_list|(
name|ReadlineLibrary
operator|.
name|GnuReadline
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UnsatisfiedLinkError
name|ule
parameter_list|)
block|{
if|if
condition|(
operator|!
name|quiet
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"GNU Readline not found. Using System.in."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"If GNU Readline is available on your system,"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"add directory ./lib to your LD_LIBRARY_PATH"
argument_list|)
expr_stmt|;
block|}
block|}
name|Readline
operator|.
name|initReadline
argument_list|(
literal|"exist"
argument_list|)
expr_stmt|;
name|Readline
operator|.
name|setCompleter
argument_list|(
operator|new
name|CollectionCompleter
argument_list|()
argument_list|)
expr_stmt|;
comment|// read history file
name|String
name|pathSep
init|=
name|System
operator|.
name|getProperty
argument_list|(
literal|"file.separator"
argument_list|,
literal|"/"
argument_list|)
decl_stmt|;
name|String
name|home
init|=
name|System
operator|.
name|getProperty
argument_list|(
literal|"exist.home"
argument_list|)
decl_stmt|;
if|if
condition|(
name|home
operator|==
literal|null
condition|)
name|home
operator|=
name|System
operator|.
name|getProperty
argument_list|(
literal|"user.dir"
argument_list|)
expr_stmt|;
name|File
name|history
init|=
operator|new
name|File
argument_list|(
name|home
operator|+
name|pathSep
operator|+
literal|".exist_history"
argument_list|)
decl_stmt|;
if|if
condition|(
name|history
operator|.
name|canRead
argument_list|()
condition|)
try|try
block|{
name|Readline
operator|.
name|readHistoryFile
argument_list|(
name|history
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
block|}
comment|// connect to the db
try|try
block|{
name|connect
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|xde
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"XMLDBException: "
operator|+
name|xde
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|xde
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
return|return;
block|}
catch|catch
parameter_list|(
name|Exception
name|cnf
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Cannot connect to database"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|current
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Could not retrieve collection "
operator|+
name|path
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// process command-line actions
if|if
condition|(
name|optionRmcol
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
operator|!
name|foundCollection
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Please specify target collection with --collection"
argument_list|)
expr_stmt|;
return|return;
block|}
try|try
block|{
name|rmcol
argument_list|(
name|optionRmcol
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"XMLDBException while removing collection: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
name|interactive
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
name|optionMkcol
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|mkcol
argument_list|(
name|optionMkcol
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"XMLDBException during mkcol: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
name|interactive
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
name|optionGet
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|retrieve
argument_list|(
name|optionGet
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"XMLDBException while trying to retrieve document: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
return|return;
block|}
if|else if
condition|(
name|optionRemove
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
operator|!
name|foundCollection
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Please specify target collection with --collection"
argument_list|)
expr_stmt|;
return|return;
block|}
try|try
block|{
name|remove
argument_list|(
name|optionRemove
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"XMLDBException during parse: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
return|return;
block|}
if|else if
condition|(
name|doParse
condition|)
block|{
if|if
condition|(
operator|!
name|foundCollection
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Please specify target collection with --collection"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|Iterator
name|i
init|=
name|optionalArgs
operator|.
name|iterator
argument_list|()
init|;
name|i
operator|.
name|hasNext
argument_list|()
condition|;
control|)
try|try
block|{
name|parse
argument_list|(
operator|(
name|String
operator|)
name|i
operator|.
name|next
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"XMLDBException during parse: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
return|return;
block|}
if|else if
condition|(
name|optionXpath
operator|!=
literal|null
condition|)
block|{
comment|// if no argument has been found, read query from stdin
if|if
condition|(
name|optionXpath
operator|.
name|equals
argument_list|(
literal|"stdin"
argument_list|)
condition|)
block|{
try|try
block|{
name|BufferedReader
name|stdin
init|=
operator|new
name|BufferedReader
argument_list|(
operator|new
name|InputStreamReader
argument_list|(
name|System
operator|.
name|in
argument_list|)
argument_list|)
decl_stmt|;
name|optionXpath
operator|=
name|stdin
operator|.
name|readLine
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"failed to read query from stdin"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
try|try
block|{
name|ResourceSet
name|result
init|=
name|find
argument_list|(
name|optionXpath
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|maxResults
operator|&&
name|i
operator|<
name|result
operator|.
name|getSize
argument_list|()
condition|;
name|i
operator|++
control|)
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
operator|(
operator|(
name|Resource
operator|)
name|result
operator|.
name|getResource
argument_list|(
operator|(
name|long
operator|)
name|i
argument_list|)
operator|)
operator|.
name|getContent
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"XMLDBException during query: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
return|return;
block|}
if|else if
condition|(
name|optionQueryFile
operator|!=
literal|null
condition|)
block|{
name|testQuery
argument_list|(
name|optionQueryFile
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|optionXUpdate
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|xupdate
argument_list|(
name|optionResource
argument_list|,
name|optionXUpdate
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XMLDBException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"XMLDBException during xupdate: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"IOException during xupdate: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|//if (!interactive)
comment|//	return;
comment|// enter interactive mode
name|messageln
argument_list|(
literal|"\ntype help or ? for help."
argument_list|)
expr_stmt|;
name|String
name|line
decl_stmt|;
name|boolean
name|cont
init|=
literal|true
decl_stmt|;
while|while
condition|(
name|cont
condition|)
try|try
block|{
if|if
condition|(
name|properties
operator|.
name|getProperty
argument_list|(
literal|"colors"
argument_list|)
operator|.
name|equals
argument_list|(
literal|"true"
argument_list|)
condition|)
name|line
operator|=
name|Readline
operator|.
name|readline
argument_list|(
name|ANSI_CYAN
operator|+
literal|"exist:"
operator|+
name|path
operator|+
literal|">"
operator|+
name|ANSI_WHITE
argument_list|)
expr_stmt|;
else|else
name|line
operator|=
name|Readline
operator|.
name|readline
argument_list|(
literal|"exist:"
operator|+
name|path
operator|+
literal|">"
argument_list|)
expr_stmt|;
if|if
condition|(
name|line
operator|!=
literal|null
condition|)
name|cont
operator|=
name|process
argument_list|(
name|line
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|EOFException
name|e
parameter_list|)
block|{
break|break;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
name|ioe
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|Readline
operator|.
name|writeHistoryFile
argument_list|(
name|history
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
block|}
name|Readline
operator|.
name|cleanup
argument_list|()
expr_stmt|;
name|messageln
argument_list|(
literal|"quit."
argument_list|)
expr_stmt|;
block|}
specifier|private
specifier|final
name|void
name|printUsage
parameter_list|()
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Usage: java "
operator|+
name|InteractiveClient
operator|.
name|class
operator|.
name|getName
argument_list|()
operator|+
literal|" [options]"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|CLUtil
operator|.
name|describeOptions
argument_list|(
name|OPTIONS
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
specifier|static
specifier|final
name|void
name|printNotice
parameter_list|()
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"eXist version 0.9, Copyright (C) 2003 Wolfgang Meier"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"eXist comes with ABSOLUTELY NO WARRANTY."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"This is free software, and you are welcome to "
operator|+
literal|"redistribute it\nunder certain conditions; "
operator|+
literal|"for details read the license file.\n"
argument_list|)
expr_stmt|;
block|}
specifier|private
specifier|final
name|void
name|message
parameter_list|(
name|String
name|msg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|quiet
condition|)
name|System
operator|.
name|out
operator|.
name|print
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
specifier|private
specifier|final
name|void
name|messageln
parameter_list|(
name|String
name|msg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|quiet
condition|)
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
comment|/** 	 *  Description of the Class 	 * 	 *@author     wolf 	 *@created    April 2, 2002 	 */
specifier|private
class|class
name|CollectionCompleter
implements|implements
name|ReadlineCompleter
block|{
name|Iterator
name|possibleValues
decl_stmt|;
comment|/** 		 *  Description of the Method 		 * 		 *@param  text   Description of the Parameter 		 *@param  state  Description of the Parameter 		 *@return        Description of the Return Value 		 */
specifier|public
name|String
name|completer
parameter_list|(
name|String
name|text
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
operator|==
literal|0
condition|)
name|possibleValues
operator|=
name|completitions
operator|.
name|tailSet
argument_list|(
name|text
argument_list|)
operator|.
name|iterator
argument_list|()
expr_stmt|;
if|if
condition|(
name|possibleValues
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|String
name|nextKey
init|=
operator|(
name|String
operator|)
name|possibleValues
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|nextKey
operator|.
name|startsWith
argument_list|(
name|text
argument_list|)
condition|)
return|return
name|nextKey
return|;
block|}
return|return
literal|null
return|;
comment|// we reached the last choice.
block|}
block|}
specifier|public
specifier|static
class|class
name|ProgressObserver
implements|implements
name|Observer
block|{
name|ProgressBar
name|elementsProgress
init|=
operator|new
name|ProgressBar
argument_list|(
literal|"storing elements"
argument_list|)
decl_stmt|;
name|Observable
name|lastObservable
init|=
literal|null
decl_stmt|;
name|ProgressBar
name|parseProgress
init|=
operator|new
name|ProgressBar
argument_list|(
literal|"storing nodes   "
argument_list|)
decl_stmt|;
name|ProgressBar
name|wordsProgress
init|=
operator|new
name|ProgressBar
argument_list|(
literal|"storing words   "
argument_list|)
decl_stmt|;
specifier|public
name|void
name|update
parameter_list|(
name|Observable
name|o
parameter_list|,
name|Object
name|obj
parameter_list|)
block|{
name|ProgressIndicator
name|ind
init|=
operator|(
name|ProgressIndicator
operator|)
name|obj
decl_stmt|;
if|if
condition|(
name|lastObservable
operator|==
literal|null
operator|||
name|o
operator|!=
name|lastObservable
condition|)
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
if|if
condition|(
name|o
operator|instanceof
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|ElementIndex
condition|)
name|elementsProgress
operator|.
name|set
argument_list|(
name|ind
operator|.
name|getValue
argument_list|()
argument_list|,
name|ind
operator|.
name|getMax
argument_list|()
argument_list|)
expr_stmt|;
if|else if
condition|(
name|o
operator|instanceof
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|TextSearchEngine
condition|)
name|wordsProgress
operator|.
name|set
argument_list|(
name|ind
operator|.
name|getValue
argument_list|()
argument_list|,
name|ind
operator|.
name|getMax
argument_list|()
argument_list|)
expr_stmt|;
else|else
name|parseProgress
operator|.
name|set
argument_list|(
name|ind
operator|.
name|getValue
argument_list|()
argument_list|,
name|ind
operator|.
name|getMax
argument_list|()
argument_list|)
expr_stmt|;
name|lastObservable
operator|=
name|o
expr_stmt|;
block|}
block|}
specifier|private
specifier|static
name|String
name|formatString
parameter_list|(
name|String
name|s1
parameter_list|,
name|String
name|s2
parameter_list|,
name|int
name|width
parameter_list|)
block|{
name|StringBuffer
name|buf
init|=
operator|new
name|StringBuffer
argument_list|(
name|width
argument_list|)
decl_stmt|;
if|if
condition|(
name|s1
operator|.
name|length
argument_list|()
operator|>
name|width
condition|)
name|s1
operator|=
name|s1
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|width
operator|-
literal|1
argument_list|)
expr_stmt|;
name|buf
operator|.
name|append
argument_list|(
name|s1
argument_list|)
expr_stmt|;
name|int
name|fill
init|=
name|width
operator|-
operator|(
name|s1
operator|.
name|length
argument_list|()
operator|+
name|s2
operator|.
name|length
argument_list|()
operator|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|fill
condition|;
name|i
operator|++
control|)
name|buf
operator|.
name|append
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|buf
operator|.
name|append
argument_list|(
name|s2
argument_list|)
expr_stmt|;
return|return
name|buf
operator|.
name|toString
argument_list|()
return|;
block|}
block|}
end_class

end_unit

