begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  *  eXist Open Source Native XML Database  *  Copyright (C) 2001-06 Wolfgang M. Meier  *  wolfgang@exist-db.org  *  http://exist-db.org  *  *  This program is free software; you can redistribute it and/or  *  modify it under the terms of the GNU Lesser General Public License  *  as published by the Free Software Foundation; either version 2  *  of the License, or (at your option) any later version.  *  *  This program is distributed in the hope that it will be useful,  *  but WITHOUT ANY WARRANTY; without even the implied warranty of  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  *  GNU Lesser General Public License for more details.  *  *  You should have received a copy of the GNU Lesser General Public License  *  along with this program; if not, write to the Free Software  *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  *  *  $Id: RESTServer.java 3567 2006-05-19 13:37:34 +0000 (Fri, 19 May 2006) wolfgang_m $  */
end_comment

begin_package
package|package
name|org
operator|.
name|exist
operator|.
name|http
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|StringWriter
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|http
operator|.
name|HttpServletRequest
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|http
operator|.
name|HttpServletResponse
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|TransformerConfigurationException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|sax
operator|.
name|SAXTransformerFactory
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|sax
operator|.
name|TemplatesHandler
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|sax
operator|.
name|TransformerHandler
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|stream
operator|.
name|StreamResult
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|BinaryDocument
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|DocumentImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|QName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|http
operator|.
name|servlets
operator|.
name|HttpRequestWrapper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|http
operator|.
name|servlets
operator|.
name|HttpResponseWrapper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|http
operator|.
name|servlets
operator|.
name|RequestWrapper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|http
operator|.
name|servlets
operator|.
name|ResponseWrapper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|memtree
operator|.
name|MemTreeBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|PermissionDeniedException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|xacml
operator|.
name|AccessContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|source
operator|.
name|Source
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|source
operator|.
name|StringSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|DBBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|XQueryPool
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|lock
operator|.
name|Lock
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|serializers
operator|.
name|Serializer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|serializers
operator|.
name|WSDLFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|XmldbURI
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|CompiledXQuery
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|Constants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|FunctionSignature
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|Module
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|XPathException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|XQuery
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|XQueryContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|functions
operator|.
name|request
operator|.
name|RequestModule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|functions
operator|.
name|response
operator|.
name|ResponseModule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|functions
operator|.
name|session
operator|.
name|SessionModule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|SequenceType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Type
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Node
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|NodeList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|SAXException
import|;
end_import

begin_comment
comment|/**  *  * @author Adam Retter (adam.retter@devon.gov.uk)  */
end_comment

begin_class
specifier|public
class|class
name|SOAPServer
block|{
specifier|private
name|String
name|formEncoding
decl_stmt|;
comment|//TODO: we may be able to remove this eventually, in favour of HttpServletRequestWrapper being setup in EXistServlet, currently used for doPost() but perhaps could be used for other Request Methods? - deliriumsky
specifier|private
name|String
name|containerEncoding
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|ENCODING
init|=
literal|"UTF-8"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|SEPERATOR
init|=
name|System
operator|.
name|getProperty
argument_list|(
literal|"line.separator"
argument_list|)
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|XSLT_WEBSERVICE_WSDL
init|=
literal|"/db/system/webservice/wsdl.xslt"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|XSLT_WEBSERVICE_DESCRIPTION
init|=
literal|"/db/system/webservice/description.xslt"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|XSLT_WEBSERVICE_FUNCTION
init|=
literal|"/db/system/webservice/function.xslt"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|WEBSERVICE_MODULE_EXTENSION
init|=
literal|".xqws"
decl_stmt|;
comment|//TODO: SHARE THIS FUNCTION WITH RESTServer (copied at the moment)
specifier|private
specifier|final
specifier|static
name|String
name|QUERY_ERROR_HEAD
init|=
literal|"<html>"
operator|+
literal|"<head>"
operator|+
literal|"<title>Query Error</title>"
operator|+
literal|"<style type=\"text/css\">"
operator|+
literal|".errmsg {"
operator|+
literal|"  border: 1px solid black;"
operator|+
literal|"  padding: 15px;"
operator|+
literal|"  margin-left: 20px;"
operator|+
literal|"  margin-right: 20px;"
operator|+
literal|"}"
operator|+
literal|"h1 { color: #C0C0C0; }"
operator|+
literal|".path {"
operator|+
literal|"  padding-bottom: 10px;"
operator|+
literal|"}"
operator|+
literal|".high { "
operator|+
literal|"  color: #666699; "
operator|+
literal|"  font-weight: bold;"
operator|+
literal|"}"
operator|+
literal|"</style>"
operator|+
literal|"</head>"
operator|+
literal|"<body>"
operator|+
literal|"<h1>XQuery Error</h1>"
decl_stmt|;
comment|//Constructor
specifier|public
name|SOAPServer
parameter_list|(
name|String
name|formEncoding
parameter_list|,
name|String
name|containerEncoding
parameter_list|)
block|{
name|this
operator|.
name|formEncoding
operator|=
name|formEncoding
expr_stmt|;
name|this
operator|.
name|containerEncoding
operator|=
name|containerEncoding
expr_stmt|;
block|}
comment|//proceses requests for description documents (WSDL, human readable, human readable specific function)
specifier|public
name|void
name|doGet
parameter_list|(
name|DBBroker
name|broker
parameter_list|,
name|HttpServletRequest
name|request
parameter_list|,
name|HttpServletResponse
name|response
parameter_list|,
name|String
name|path
parameter_list|)
throws|throws
name|BadRequestException
throws|,
name|PermissionDeniedException
throws|,
name|NotFoundException
throws|,
name|IOException
block|{
comment|//set the encoding
if|if
condition|(
name|request
operator|.
name|getCharacterEncoding
argument_list|()
operator|==
literal|null
condition|)
name|request
operator|.
name|setCharacterEncoding
argument_list|(
name|formEncoding
argument_list|)
expr_stmt|;
comment|/* Process the request */
comment|/* 		 * TODO: I think simple webservices can also be called using GET, so we may need to cater for that as well 		 * but first it would be best to write the doPost() method, split the code out into functions and also use it for this. 		 */
comment|// 1) Get the xqws
name|DocumentImpl
name|docXQWS
init|=
literal|null
decl_stmt|;
name|XmldbURI
name|pathUri
init|=
name|XmldbURI
operator|.
name|create
argument_list|(
name|path
argument_list|)
decl_stmt|;
name|docXQWS
operator|=
operator|(
name|DocumentImpl
operator|)
name|broker
operator|.
name|getXMLResource
argument_list|(
name|pathUri
argument_list|,
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
name|BinaryDocument
name|bin
init|=
operator|(
name|BinaryDocument
operator|)
name|docXQWS
decl_stmt|;
name|byte
index|[]
name|xqwsData
init|=
name|broker
operator|.
name|getBinaryResource
argument_list|(
name|bin
argument_list|)
decl_stmt|;
comment|// 2) move through the xqws char by char checking if a line contains the module namespace declaration
name|StringBuffer
name|sbNamespace
init|=
operator|new
name|StringBuffer
argument_list|()
decl_stmt|;
name|ByteArrayInputStream
name|bis
init|=
operator|new
name|ByteArrayInputStream
argument_list|(
name|xqwsData
argument_list|)
decl_stmt|;
while|while
condition|(
name|bis
operator|.
name|available
argument_list|()
operator|>
literal|0
condition|)
block|{
name|char
name|c
init|=
operator|(
name|char
operator|)
name|bis
operator|.
name|read
argument_list|()
decl_stmt|;
comment|//TODO: do we need encoding here?
name|sbNamespace
operator|.
name|append
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|SEPERATOR
operator|.
name|charAt
argument_list|(
name|SEPERATOR
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
condition|)
block|{
if|if
condition|(
name|sbNamespace
operator|.
name|toString
argument_list|()
operator|.
name|startsWith
argument_list|(
literal|"module namespace"
argument_list|)
condition|)
block|{
comment|//break out of the while loop, sbNamespace should now contain our namespace
break|break;
block|}
else|else
block|{
comment|//empty the namespace buffer
name|sbNamespace
operator|.
name|delete
argument_list|(
literal|0
argument_list|,
name|sbNamespace
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|//close the XQWS Document and release the read lock
name|docXQWS
operator|.
name|getUpdateLock
argument_list|()
operator|.
name|release
argument_list|()
expr_stmt|;
comment|// 3): create an XQuery wrapper to access the module
name|String
name|query
init|=
literal|"xquery version \"1.0\";"
operator|+
name|SEPERATOR
decl_stmt|;
name|query
operator|+=
name|SEPERATOR
expr_stmt|;
name|query
operator|+=
literal|"import "
operator|+
name|sbNamespace
operator|.
name|toString
argument_list|()
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|sbNamespace
operator|.
name|length
argument_list|()
operator|-
literal|2
argument_list|)
operator|+
literal|" at \""
operator|+
name|docXQWS
operator|.
name|getFileURI
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|"\";"
operator|+
name|SEPERATOR
expr_stmt|;
name|query
operator|+=
name|SEPERATOR
expr_stmt|;
name|query
operator|+=
literal|"()"
expr_stmt|;
name|Source
name|source
init|=
operator|new
name|StringSource
argument_list|(
name|query
argument_list|)
decl_stmt|;
comment|// 4) Compile the XQuery
name|XQuery
name|xquery
init|=
name|broker
operator|.
name|getXQueryService
argument_list|()
decl_stmt|;
name|XQueryPool
name|pool
init|=
name|xquery
operator|.
name|getXQueryPool
argument_list|()
decl_stmt|;
name|XQueryContext
name|context
decl_stmt|;
comment|//try and get pre-compiled XQuery
name|CompiledXQuery
name|compiled
init|=
name|pool
operator|.
name|borrowCompiledXQuery
argument_list|(
name|broker
argument_list|,
name|source
argument_list|)
decl_stmt|;
comment|//Create the context and set a header to indicate cache status
if|if
condition|(
name|compiled
operator|==
literal|null
condition|)
block|{
name|context
operator|=
name|xquery
operator|.
name|newContext
argument_list|(
name|AccessContext
operator|.
name|REST
argument_list|)
expr_stmt|;
name|response
operator|.
name|setHeader
argument_list|(
literal|"X-XQuery-Cached"
argument_list|,
literal|"false"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|context
operator|=
name|compiled
operator|.
name|getContext
argument_list|()
expr_stmt|;
name|response
operator|.
name|setHeader
argument_list|(
literal|"X-XQuery-Cached"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
block|}
try|try
block|{
comment|//Setup the context
name|declareVariables
argument_list|(
name|context
argument_list|,
name|request
argument_list|,
name|response
argument_list|)
expr_stmt|;
name|context
operator|.
name|setModuleLoadPath
argument_list|(
name|XmldbURI
operator|.
name|EMBEDDED_SERVER_URI
operator|.
name|append
argument_list|(
name|docXQWS
operator|.
name|getCollection
argument_list|()
operator|.
name|getURI
argument_list|()
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|context
operator|.
name|setStaticallyKnownDocuments
argument_list|(
operator|new
name|XmldbURI
index|[]
block|{
name|docXQWS
operator|.
name|getCollection
argument_list|()
operator|.
name|getURI
argument_list|()
block|}
argument_list|)
expr_stmt|;
comment|//no pre-compiled XQuery so compile, it
if|if
condition|(
name|compiled
operator|==
literal|null
condition|)
block|{
try|try
block|{
name|compiled
operator|=
name|xquery
operator|.
name|compile
argument_list|(
name|context
argument_list|,
name|source
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|BadRequestException
argument_list|(
literal|"Failed to read query from "
operator|+
name|docXQWS
operator|.
name|getURI
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|XPathException
name|e
parameter_list|)
block|{
name|response
operator|.
name|setStatus
argument_list|(
name|HttpServletResponse
operator|.
name|SC_BAD_REQUEST
argument_list|)
expr_stmt|;
name|writeResponse
argument_list|(
name|response
argument_list|,
name|formatXPathException
argument_list|(
literal|null
argument_list|,
name|path
argument_list|,
name|e
argument_list|)
argument_list|,
literal|"text/html"
argument_list|,
name|ENCODING
argument_list|)
expr_stmt|;
block|}
comment|//store the compiled xqws for use later
name|pool
operator|.
name|returnCompiledXQuery
argument_list|(
name|source
argument_list|,
name|compiled
argument_list|)
expr_stmt|;
comment|// 5) Inspect the xqws function signatures and create a small xml doc to represent them
name|Module
name|xqws
init|=
name|compiled
operator|.
name|getContext
argument_list|()
operator|.
name|getModule
argument_list|(
name|sbNamespace
operator|.
name|substring
argument_list|(
name|sbNamespace
operator|.
name|indexOf
argument_list|(
literal|"\""
argument_list|)
operator|+
literal|1
argument_list|,
name|sbNamespace
operator|.
name|lastIndexOf
argument_list|(
literal|"\""
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|FunctionSignature
index|[]
name|xqwsFunctions
init|=
name|xqws
operator|.
name|listFunctions
argument_list|()
decl_stmt|;
name|MemTreeBuilder
name|builderWebserviceDoc
init|=
operator|new
name|MemTreeBuilder
argument_list|()
decl_stmt|;
name|builderWebserviceDoc
operator|.
name|startDocument
argument_list|()
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"webservice"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"name"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|characters
argument_list|(
name|docXQWS
operator|.
name|getFileURI
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|docXQWS
operator|.
name|getFileURI
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|indexOf
argument_list|(
name|WEBSERVICE_MODULE_EXTENSION
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"description"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|characters
argument_list|(
name|xqws
operator|.
name|getDescription
argument_list|()
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"host"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|characters
argument_list|(
name|request
operator|.
name|getServerName
argument_list|()
operator|+
literal|":"
operator|+
name|request
operator|.
name|getServerPort
argument_list|()
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"path"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|characters
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"URL"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|characters
argument_list|(
name|request
operator|.
name|getRequestURL
argument_list|()
argument_list|)
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"functions"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|f
init|=
literal|0
init|;
name|f
operator|<
name|xqwsFunctions
operator|.
name|length
condition|;
name|f
operator|++
control|)
block|{
if|if
condition|(
name|request
operator|.
name|getParameter
argument_list|(
literal|"function"
argument_list|)
operator|!=
literal|null
condition|)
block|{
comment|//Specific Function Description
if|if
condition|(
name|xqwsFunctions
index|[
name|f
index|]
operator|.
name|getName
argument_list|()
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
name|request
operator|.
name|getParameter
argument_list|(
literal|"function"
argument_list|)
argument_list|)
condition|)
block|{
name|ConstructFunctionNode
argument_list|(
name|xqwsFunctions
index|[
name|f
index|]
argument_list|,
name|builderWebserviceDoc
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
comment|//All Function Descriptions
name|ConstructFunctionNode
argument_list|(
name|xqwsFunctions
index|[
name|f
index|]
argument_list|,
name|builderWebserviceDoc
argument_list|)
expr_stmt|;
block|}
block|}
name|builderWebserviceDoc
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderWebserviceDoc
operator|.
name|endDocument
argument_list|()
expr_stmt|;
name|org
operator|.
name|exist
operator|.
name|memtree
operator|.
name|DocumentImpl
name|docWebservice
init|=
name|builderWebserviceDoc
operator|.
name|getDocument
argument_list|()
decl_stmt|;
comment|// 6) Transform the XML document to either a human readable description, description of a specific function or WSDL
name|DocumentImpl
name|docStylesheet
init|=
literal|null
decl_stmt|;
comment|//get the appropraite stylesheet
if|if
condition|(
name|request
operator|.
name|getParameter
argument_list|(
literal|"WSDL"
argument_list|)
operator|!=
literal|null
operator|||
name|request
operator|.
name|getParameter
argument_list|(
literal|"wsdl"
argument_list|)
operator|!=
literal|null
condition|)
block|{
comment|//WSDL
name|docStylesheet
operator|=
name|broker
operator|.
name|getXMLResource
argument_list|(
name|XmldbURI
operator|.
name|create
argument_list|(
name|XSLT_WEBSERVICE_WSDL
argument_list|)
argument_list|,
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
comment|//set output content type for wsdl
name|response
operator|.
name|setContentType
argument_list|(
literal|"text/xml"
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|request
operator|.
name|getParameter
argument_list|(
literal|"function"
argument_list|)
operator|!=
literal|null
condition|)
block|{
comment|//Specific Function Description
name|docStylesheet
operator|=
name|broker
operator|.
name|getXMLResource
argument_list|(
name|XmldbURI
operator|.
name|create
argument_list|(
name|XSLT_WEBSERVICE_FUNCTION
argument_list|)
argument_list|,
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|//Human Readable Description
name|docStylesheet
operator|=
name|broker
operator|.
name|getXMLResource
argument_list|(
name|XmldbURI
operator|.
name|create
argument_list|(
name|XSLT_WEBSERVICE_DESCRIPTION
argument_list|)
argument_list|,
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
block|}
comment|//Transform docWebservice with the stylesheet
name|MemTreeBuilder
name|outputBuilder
init|=
operator|new
name|MemTreeBuilder
argument_list|()
decl_stmt|;
name|outputBuilder
operator|.
name|startDocument
argument_list|()
expr_stmt|;
try|try
block|{
comment|/*         	 * TODO: the code in this try statement (apart from the WSDLFilter use) was mostly extracted from         	 * transform:stream-transform(), it would be better to be able to share that code somehow         	 */
name|SAXTransformerFactory
name|factory
init|=
operator|(
name|SAXTransformerFactory
operator|)
name|SAXTransformerFactory
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|TemplatesHandler
name|templatesHandler
init|=
name|factory
operator|.
name|newTemplatesHandler
argument_list|()
decl_stmt|;
name|templatesHandler
operator|.
name|startDocument
argument_list|()
expr_stmt|;
name|Serializer
name|serializer
init|=
name|broker
operator|.
name|getSerializer
argument_list|()
decl_stmt|;
name|serializer
operator|.
name|reset
argument_list|()
expr_stmt|;
name|WSDLFilter
name|wsdlfilter
init|=
operator|new
name|WSDLFilter
argument_list|(
name|templatesHandler
argument_list|,
name|request
operator|.
name|getRequestURL
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|serializer
operator|.
name|setSAXHandlers
argument_list|(
name|wsdlfilter
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|serializer
operator|.
name|toSAX
argument_list|(
name|docStylesheet
argument_list|)
expr_stmt|;
name|templatesHandler
operator|.
name|endDocument
argument_list|()
expr_stmt|;
name|TransformerHandler
name|handler
init|=
name|factory
operator|.
name|newTransformerHandler
argument_list|(
name|templatesHandler
operator|.
name|getTemplates
argument_list|()
argument_list|)
decl_stmt|;
comment|//START send result of transformation directly to response
name|OutputStream
name|os
init|=
operator|new
name|BufferedOutputStream
argument_list|(
name|response
operator|.
name|getOutputStream
argument_list|()
argument_list|)
decl_stmt|;
name|StreamResult
name|result
init|=
operator|new
name|StreamResult
argument_list|(
name|os
argument_list|)
decl_stmt|;
name|handler
operator|.
name|setResult
argument_list|(
name|result
argument_list|)
expr_stmt|;
comment|//END
comment|/**              * TODO: Validation should be done before WSDL is sent to the client. org.exist.validation.Validator              * will need to make use of org.exist.validation.internal.BlockingOutputStream to connect to the Validator.              *               */
name|handler
operator|.
name|startDocument
argument_list|()
expr_stmt|;
name|docWebservice
operator|.
name|toSAX
argument_list|(
name|broker
argument_list|,
name|handler
argument_list|)
expr_stmt|;
name|handler
operator|.
name|endDocument
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|TransformerConfigurationException
name|tce
parameter_list|)
block|{
name|response
operator|.
name|setStatus
argument_list|(
name|HttpServletResponse
operator|.
name|SC_BAD_REQUEST
argument_list|)
expr_stmt|;
name|writeResponse
argument_list|(
name|response
argument_list|,
name|formatXPathException
argument_list|(
literal|null
argument_list|,
name|path
argument_list|,
operator|new
name|XPathException
argument_list|(
literal|null
argument_list|,
literal|"SAX exception while transforming node: "
operator|+
name|tce
operator|.
name|getMessage
argument_list|()
argument_list|,
name|tce
argument_list|)
argument_list|)
argument_list|,
literal|"text/html"
argument_list|,
name|ENCODING
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SAXException
name|e
parameter_list|)
block|{
name|response
operator|.
name|setStatus
argument_list|(
name|HttpServletResponse
operator|.
name|SC_BAD_REQUEST
argument_list|)
expr_stmt|;
name|writeResponse
argument_list|(
name|response
argument_list|,
name|formatXPathException
argument_list|(
literal|null
argument_list|,
name|path
argument_list|,
operator|new
name|XPathException
argument_list|(
literal|null
argument_list|,
literal|"SAX exception while transforming node: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
argument_list|)
argument_list|,
literal|"text/html"
argument_list|,
name|ENCODING
argument_list|)
expr_stmt|;
block|}
comment|//close the Stylesheet Document and release the read lock
name|docStylesheet
operator|.
name|getUpdateLock
argument_list|()
operator|.
name|release
argument_list|()
expr_stmt|;
block|}
comment|//returns the node with the name "definitions" from the NodeList or its children (recursively)
specifier|public
name|Node
name|getDefinitionsNode
parameter_list|(
name|NodeList
name|nl
parameter_list|)
block|{
name|Node
name|result
init|=
literal|null
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|nl
operator|.
name|getLength
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|Node
name|n
init|=
name|nl
operator|.
name|item
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|n
operator|.
name|getNodeType
argument_list|()
operator|==
name|Type
operator|.
name|ELEMENT
condition|)
block|{
if|if
condition|(
name|n
operator|.
name|getNodeName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"definitions"
argument_list|)
condition|)
block|{
comment|//found node
name|result
operator|=
name|n
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|n
operator|.
name|hasChildNodes
argument_list|()
condition|)
block|{
name|result
operator|=
name|getDefinitionsNode
argument_list|(
name|n
operator|.
name|getChildNodes
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|result
return|;
block|}
comment|//TODO: process incomoing SOAP documents
specifier|public
name|void
name|doPost
parameter_list|(
name|DBBroker
name|broker
parameter_list|,
name|HttpServletRequest
name|request
parameter_list|,
name|HttpServletResponse
name|response
parameter_list|,
name|String
name|path
parameter_list|)
throws|throws
name|BadRequestException
throws|,
name|PermissionDeniedException
throws|,
name|IOException
block|{
block|}
comment|//builds an XML node called function
comment|/* 	 *<function> 	 *<name/> 	 *<description/> 	 *<parameters> 	 *<parameter> 	 *<name/> 	 *<type/> 	 *<cardinality/> 	 *</parameter> 	 *</parameters> 	 *<return> 	 *<type/> 	 *<cardinality/> 	 *</return> 	 *</function> 	 */
specifier|private
name|void
name|ConstructFunctionNode
parameter_list|(
name|FunctionSignature
name|signature
parameter_list|,
name|MemTreeBuilder
name|builderFunction
parameter_list|)
block|{
comment|//Generate an XML snippet for each function
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"function"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"name"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|characters
argument_list|(
name|signature
operator|.
name|getName
argument_list|()
operator|.
name|getLocalName
argument_list|()
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
if|if
condition|(
name|signature
operator|.
name|getDescription
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"description"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|characters
argument_list|(
name|signature
operator|.
name|getDescription
argument_list|()
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
block|}
name|SequenceType
index|[]
name|xqwsArguments
init|=
name|signature
operator|.
name|getArgumentTypes
argument_list|()
decl_stmt|;
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"parameters"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|a
init|=
literal|0
init|;
name|a
operator|<
name|xqwsArguments
operator|.
name|length
condition|;
name|a
operator|++
control|)
block|{
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"parameter"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"name"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
comment|//builderFunction.characters(xqwsArguments[a].getNodeName().getLocalName()); //TODO: how to get parameter name?
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"type"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|characters
argument_list|(
name|Type
operator|.
name|getTypeName
argument_list|(
name|xqwsArguments
index|[
name|a
index|]
operator|.
name|getPrimaryType
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"cardinality"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|characters
argument_list|(
name|Integer
operator|.
name|toString
argument_list|(
name|xqwsArguments
index|[
name|a
index|]
operator|.
name|getCardinality
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
block|}
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"return"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"type"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|characters
argument_list|(
name|Type
operator|.
name|getTypeName
argument_list|(
name|signature
operator|.
name|getReturnType
argument_list|()
operator|.
name|getPrimaryType
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderFunction
operator|.
name|startElement
argument_list|(
operator|new
name|QName
argument_list|(
literal|"cardinality"
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|characters
argument_list|(
name|Integer
operator|.
name|toString
argument_list|(
name|signature
operator|.
name|getReturnType
argument_list|()
operator|.
name|getCardinality
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
name|builderFunction
operator|.
name|endElement
argument_list|()
expr_stmt|;
block|}
comment|//TODO: SHARE THIS FUNCTION WITH RESTServer (copied at the moment)
comment|/**      * Pass the request, response and session objects to the XQuery      * context.      *      * @param context      * @param request      * @param response      * @throws XPathException      */
specifier|private
name|void
name|declareVariables
parameter_list|(
name|XQueryContext
name|context
parameter_list|,
name|HttpServletRequest
name|request
parameter_list|,
name|HttpServletResponse
name|response
parameter_list|)
throws|throws
name|XPathException
block|{
name|RequestWrapper
name|reqw
init|=
operator|new
name|HttpRequestWrapper
argument_list|(
name|request
argument_list|,
name|formEncoding
argument_list|,
name|containerEncoding
argument_list|)
decl_stmt|;
name|ResponseWrapper
name|respw
init|=
operator|new
name|HttpResponseWrapper
argument_list|(
name|response
argument_list|)
decl_stmt|;
comment|//context.declareNamespace(RequestModule.PREFIX, RequestModule.NAMESPACE_URI);
name|context
operator|.
name|declareVariable
argument_list|(
name|RequestModule
operator|.
name|PREFIX
operator|+
literal|":request"
argument_list|,
name|reqw
argument_list|)
expr_stmt|;
name|context
operator|.
name|declareVariable
argument_list|(
name|ResponseModule
operator|.
name|PREFIX
operator|+
literal|":response"
argument_list|,
name|respw
argument_list|)
expr_stmt|;
name|context
operator|.
name|declareVariable
argument_list|(
name|SessionModule
operator|.
name|PREFIX
operator|+
literal|":session"
argument_list|,
name|reqw
operator|.
name|getSession
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|//TODO: SHARE THIS FUNCTION WITH RESTServer (copied at the moment)
comment|/**      * @param query      * @param e      */
specifier|private
name|String
name|formatXPathException
parameter_list|(
name|String
name|query
parameter_list|,
name|String
name|path
parameter_list|,
name|XPathException
name|e
parameter_list|)
block|{
name|StringWriter
name|writer
init|=
operator|new
name|StringWriter
argument_list|()
decl_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|QUERY_ERROR_HEAD
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"<p class=\"path\"><span class=\"high\">Path</span>: "
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"<a href=\""
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"\">"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"</a></p>"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"<p class=\"errmsg\">"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"</p>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
operator|!=
literal|null
condition|)
block|{
name|writer
operator|.
name|write
argument_list|(
literal|"<p><span class=\"high\">Query</span>:</p><pre>"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"</pre>"
argument_list|)
expr_stmt|;
block|}
name|writer
operator|.
name|write
argument_list|(
literal|"</body></html>"
argument_list|)
expr_stmt|;
return|return
name|writer
operator|.
name|toString
argument_list|()
return|;
block|}
comment|//TODO: SHARE THIS FUNCTION WITH RESTServer (copied at the moment)
specifier|private
name|void
name|writeResponse
parameter_list|(
name|HttpServletResponse
name|response
parameter_list|,
name|String
name|data
parameter_list|,
name|String
name|contentType
parameter_list|,
name|String
name|encoding
parameter_list|)
throws|throws
name|IOException
block|{
comment|//        response.setCharacterEncoding(encoding);
comment|// possible format contentType: text/xml; charset=UTF-8
if|if
condition|(
name|contentType
operator|!=
literal|null
operator|&&
operator|!
name|response
operator|.
name|isCommitted
argument_list|()
condition|)
block|{
name|int
name|semicolon
init|=
name|contentType
operator|.
name|indexOf
argument_list|(
literal|';'
argument_list|)
decl_stmt|;
if|if
condition|(
name|semicolon
operator|!=
name|Constants
operator|.
name|STRING_NOT_FOUND
condition|)
block|{
name|contentType
operator|=
name|contentType
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|semicolon
argument_list|)
expr_stmt|;
block|}
name|response
operator|.
name|setContentType
argument_list|(
name|contentType
operator|+
literal|"; charset="
operator|+
name|encoding
argument_list|)
expr_stmt|;
block|}
name|OutputStream
name|is
init|=
name|response
operator|.
name|getOutputStream
argument_list|()
decl_stmt|;
name|is
operator|.
name|write
argument_list|(
literal|"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n"
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|is
operator|.
name|write
argument_list|(
name|data
operator|.
name|getBytes
argument_list|(
name|encoding
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

