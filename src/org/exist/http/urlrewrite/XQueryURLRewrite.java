begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  *  eXist Open Source Native XML Database  *  Copyright (C) 2001-08 Wolfgang M. Meier  *  wolfgang@exist-db.org  *  http://exist-db.org  *  *  This program is free software; you can redistribute it and/or  *  modify it under the terms of the GNU Lesser General Public License  *  as published by the Free Software Foundation; either version 2  *  of the License, or (at your option) any later version.  *  *  This program is distributed in the hope that it will be useful,  *  but WITHOUT ANY WARRANTY; without even the implied warranty of  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  *  GNU Lesser General Public License for more details.  *  *  You should have received a copy of the GNU Lesser General Public License  *  along with this program; if not, write to the Free Software  *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  *  *  $Id$  */
end_comment

begin_package
package|package
name|org
operator|.
name|exist
operator|.
name|http
operator|.
name|urlrewrite
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStreamWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|PrintWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|source
operator|.
name|Source
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|source
operator|.
name|DBSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|source
operator|.
name|SourceFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|source
operator|.
name|FileSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|functions
operator|.
name|request
operator|.
name|RequestModule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|functions
operator|.
name|response
operator|.
name|ResponseModule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|functions
operator|.
name|session
operator|.
name|SessionModule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Sequence
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Item
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Type
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|NodeValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|Namespaces
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|EXistException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|collections
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|DocumentImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|BinaryDocument
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|XmldbURI
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|internal
operator|.
name|AccountImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|xacml
operator|.
name|AccessContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|BrokerPool
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|DBBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|XQueryPool
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|lock
operator|.
name|Lock
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|serializers
operator|.
name|EXistOutputKeys
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|serializers
operator|.
name|Serializer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|MimeType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|serializer
operator|.
name|SAXSerializer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|serializer
operator|.
name|SerializerPool
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|http
operator|.
name|servlets
operator|.
name|HttpRequestWrapper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|http
operator|.
name|servlets
operator|.
name|HttpResponseWrapper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|http
operator|.
name|Descriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|external
operator|.
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|output
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Node
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Document
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Element
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|NodeList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|SAXException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xmldb
operator|.
name|api
operator|.
name|base
operator|.
name|Database
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xmldb
operator|.
name|api
operator|.
name|DatabaseManager
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|Filter
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|FilterConfig
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|ServletException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|ServletRequest
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|ServletResponse
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|FilterChain
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|ServletOutputStream
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|ServletInputStream
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|http
operator|.
name|HttpServletResponse
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|http
operator|.
name|HttpServletRequest
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|http
operator|.
name|HttpServletResponseWrapper
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|OutputKeys
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URISyntaxException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Enumeration
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
operator|.
name|Entry
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Properties
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Matcher
import|;
end_import

begin_comment
comment|/**  * A filter to redirect HTTP requests. Similar to the popular UrlRewriteFilter, but  * based on XQuery.  *  * The request is passed to an XQuery whose return value determines where the request will be  * redirected to. An empty return value means the request will be passed through the filter  * untouched. Otherwise, the query should return a single XML element, which will instruct the filter  * how to further process the request. Details about the format can be found in the main documentation.  *  * The request is forwarded via {@link javax.servlet.RequestDispatcher#forward(javax.servlet.ServletRequest, javax.servlet.ServletResponse)}.  * Contrary to HTTP forwarding, there is no additional roundtrip to the client. It all happens on  * the server. The client will not notice the redirect.  *  * Please read the<a href="http://exist-db.org/urlrewrite.html">documentation</a> for further information.   */
end_comment

begin_class
specifier|public
class|class
name|XQueryURLRewrite
implements|implements
name|Filter
block|{
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|Logger
operator|.
name|getLogger
argument_list|(
name|XQueryURLRewrite
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|DEFAULT_USER
init|=
literal|"guest"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|DEFAULT_PASS
init|=
literal|"guest"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|RQ_ATTR
init|=
literal|"org.exist.forward"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|RQ_ATTR_REQUEST_URI
init|=
literal|"org.exist.forward.request-uri"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|RQ_ATTR_SERVLET_PATH
init|=
literal|"org.exist.forward.servlet-path"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|RQ_ATTR_RESULT
init|=
literal|"org.exist.forward.result"
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|String
name|DRIVER
init|=
literal|"org.exist.xmldb.DatabaseImpl"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|Pattern
name|NAME_REGEX
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"^.*/([^/]+)$"
argument_list|,
literal|0
argument_list|)
decl_stmt|;
specifier|private
name|FilterConfig
name|config
decl_stmt|;
specifier|private
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|ModelAndView
argument_list|>
name|urlCache
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|ModelAndView
argument_list|>
argument_list|()
decl_stmt|;
specifier|protected
name|Subject
name|defaultUser
init|=
literal|null
decl_stmt|;
specifier|protected
name|BrokerPool
name|pool
decl_stmt|;
comment|// path to the query
specifier|private
name|String
name|query
init|=
literal|null
decl_stmt|;
specifier|private
specifier|final
name|Map
argument_list|<
name|Object
argument_list|,
name|Source
argument_list|>
name|sources
init|=
operator|new
name|HashMap
argument_list|<
name|Object
argument_list|,
name|Source
argument_list|>
argument_list|()
decl_stmt|;
specifier|private
name|boolean
name|checkModified
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|compiledCache
init|=
literal|true
decl_stmt|;
specifier|private
name|RewriteConfig
name|rewriteConfig
decl_stmt|;
annotation|@
name|Override
specifier|public
name|void
name|init
parameter_list|(
name|FilterConfig
name|filterConfig
parameter_list|)
throws|throws
name|ServletException
block|{
comment|// save FilterConfig for later use
name|this
operator|.
name|config
operator|=
name|filterConfig
expr_stmt|;
name|query
operator|=
name|filterConfig
operator|.
name|getInitParameter
argument_list|(
literal|"xquery"
argument_list|)
expr_stmt|;
name|String
name|opt
init|=
name|filterConfig
operator|.
name|getInitParameter
argument_list|(
literal|"check-modified"
argument_list|)
decl_stmt|;
if|if
condition|(
name|opt
operator|!=
literal|null
condition|)
name|checkModified
operator|=
name|opt
operator|!=
literal|null
operator|&&
name|opt
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"true"
argument_list|)
expr_stmt|;
name|opt
operator|=
name|filterConfig
operator|.
name|getInitParameter
argument_list|(
literal|"compiled-cache"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|!=
literal|null
condition|)
name|compiledCache
operator|=
name|opt
operator|!=
literal|null
operator|&&
name|opt
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"true"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|doFilter
parameter_list|(
name|ServletRequest
name|servletRequest
parameter_list|,
name|ServletResponse
name|servletResponse
parameter_list|,
name|FilterChain
name|filterChain
parameter_list|)
throws|throws
name|IOException
throws|,
name|ServletException
block|{
if|if
condition|(
name|rewriteConfig
operator|==
literal|null
condition|)
block|{
name|configure
argument_list|()
expr_stmt|;
name|rewriteConfig
operator|=
operator|new
name|RewriteConfig
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|HttpServletRequest
name|request
init|=
operator|(
name|HttpServletRequest
operator|)
name|servletRequest
decl_stmt|;
name|HttpServletResponse
name|response
init|=
operator|(
name|HttpServletResponse
operator|)
name|servletResponse
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|trace
argument_list|(
name|request
operator|.
name|getRequestURI
argument_list|()
argument_list|)
expr_stmt|;
name|Descriptor
name|descriptor
init|=
name|Descriptor
operator|.
name|getDescriptorSingleton
argument_list|()
decl_stmt|;
if|if
condition|(
name|descriptor
operator|!=
literal|null
operator|&&
name|descriptor
operator|.
name|requestsFiltered
argument_list|()
condition|)
block|{
name|String
name|attr
init|=
operator|(
name|String
operator|)
name|request
operator|.
name|getAttribute
argument_list|(
literal|"XQueryURLRewrite.forwarded"
argument_list|)
decl_stmt|;
if|if
condition|(
name|attr
operator|==
literal|null
condition|)
block|{
comment|//                request = new HttpServletRequestWrapper(request, /*formEncoding*/ "utf-8" );
comment|//logs the request if specified in the descriptor
name|descriptor
operator|.
name|doLogRequestInReplayLog
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|request
operator|.
name|setAttribute
argument_list|(
literal|"XQueryURLRewrite.forwarded"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
block|}
block|}
name|Subject
name|user
init|=
name|defaultUser
decl_stmt|;
name|Subject
name|requestUser
init|=
name|AccountImpl
operator|.
name|getUserFromServletRequest
argument_list|(
name|request
argument_list|)
decl_stmt|;
if|if
condition|(
name|requestUser
operator|!=
literal|null
condition|)
name|user
operator|=
name|requestUser
expr_stmt|;
try|try
block|{
name|configure
argument_list|()
expr_stmt|;
name|checkCache
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|RequestWrapper
name|modifiedRequest
init|=
operator|new
name|RequestWrapper
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|URLRewrite
name|staticRewrite
init|=
name|rewriteConfig
operator|.
name|lookup
argument_list|(
name|modifiedRequest
argument_list|)
decl_stmt|;
if|if
condition|(
name|staticRewrite
operator|!=
literal|null
operator|&&
operator|!
name|staticRewrite
operator|.
name|isControllerForward
argument_list|()
condition|)
block|{
name|modifiedRequest
operator|.
name|setPaths
argument_list|(
name|staticRewrite
operator|.
name|resolve
argument_list|(
name|modifiedRequest
argument_list|)
argument_list|,
name|staticRewrite
operator|.
name|getPrefix
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|trace
argument_list|(
literal|"Forwarding to target: "
operator|+
name|staticRewrite
operator|.
name|getTarget
argument_list|()
argument_list|)
expr_stmt|;
name|staticRewrite
operator|.
name|doRewrite
argument_list|(
name|modifiedRequest
argument_list|,
name|response
argument_list|,
name|filterChain
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|trace
argument_list|(
literal|"Processing request URI: "
operator|+
name|request
operator|.
name|getRequestURI
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|staticRewrite
operator|!=
literal|null
condition|)
block|{
comment|// fix the request URI
name|staticRewrite
operator|.
name|updateRequest
argument_list|(
name|modifiedRequest
argument_list|)
expr_stmt|;
block|}
comment|// check if the request URI is already in the url cache
name|ModelAndView
name|modelView
decl_stmt|;
synchronized|synchronized
init|(
name|urlCache
init|)
block|{
name|modelView
operator|=
name|urlCache
operator|.
name|get
argument_list|(
name|modifiedRequest
operator|.
name|getHeader
argument_list|(
literal|"Host"
argument_list|)
operator|+
name|modifiedRequest
operator|.
name|getRequestURI
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// no: create a new model and view configuration
if|if
condition|(
name|modelView
operator|==
literal|null
condition|)
block|{
name|modelView
operator|=
operator|new
name|ModelAndView
argument_list|()
expr_stmt|;
comment|// Execute the query
name|Sequence
name|result
init|=
name|Sequence
operator|.
name|EMPTY_SEQUENCE
decl_stmt|;
name|DBBroker
name|broker
init|=
literal|null
decl_stmt|;
try|try
block|{
name|broker
operator|=
name|pool
operator|.
name|get
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|modifiedRequest
operator|.
name|setAttribute
argument_list|(
name|RQ_ATTR_REQUEST_URI
argument_list|,
name|request
operator|.
name|getRequestURI
argument_list|()
argument_list|)
expr_stmt|;
name|Properties
name|outputProperties
init|=
operator|new
name|Properties
argument_list|()
decl_stmt|;
name|outputProperties
operator|.
name|setProperty
argument_list|(
name|OutputKeys
operator|.
name|INDENT
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
name|outputProperties
operator|.
name|setProperty
argument_list|(
name|OutputKeys
operator|.
name|ENCODING
argument_list|,
literal|"UTF-8"
argument_list|)
expr_stmt|;
name|outputProperties
operator|.
name|setProperty
argument_list|(
name|OutputKeys
operator|.
name|MEDIA_TYPE
argument_list|,
name|MimeType
operator|.
name|XML_TYPE
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|result
operator|=
name|runQuery
argument_list|(
name|broker
argument_list|,
name|modifiedRequest
argument_list|,
name|response
argument_list|,
name|staticRewrite
argument_list|,
name|outputProperties
argument_list|)
expr_stmt|;
name|logResult
argument_list|(
name|broker
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
operator|.
name|isCommitted
argument_list|()
condition|)
block|{
return|return;
block|}
comment|// process the query result
if|if
condition|(
name|result
operator|.
name|getItemCount
argument_list|()
operator|==
literal|1
condition|)
block|{
name|Item
name|resource
init|=
name|result
operator|.
name|itemAt
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|Type
operator|.
name|subTypeOf
argument_list|(
name|resource
operator|.
name|getType
argument_list|()
argument_list|,
name|Type
operator|.
name|NODE
argument_list|)
condition|)
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"XQueryURLRewrite: urlrewrite query should return an element!"
argument_list|)
throw|;
name|Node
name|node
init|=
operator|(
operator|(
name|NodeValue
operator|)
name|resource
operator|)
operator|.
name|getNode
argument_list|()
decl_stmt|;
if|if
condition|(
name|node
operator|.
name|getNodeType
argument_list|()
operator|==
name|Node
operator|.
name|DOCUMENT_NODE
condition|)
name|node
operator|=
operator|(
operator|(
name|Document
operator|)
name|node
operator|)
operator|.
name|getDocumentElement
argument_list|()
expr_stmt|;
if|if
condition|(
name|node
operator|.
name|getNodeType
argument_list|()
operator|!=
name|Node
operator|.
name|ELEMENT_NODE
condition|)
block|{
comment|//throw new ServletException("Redirect XQuery should return an XML element!");
name|response
argument_list|(
name|broker
argument_list|,
name|response
argument_list|,
name|outputProperties
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return;
block|}
name|Element
name|elem
init|=
operator|(
name|Element
operator|)
name|node
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|Namespaces
operator|.
name|EXIST_NS
operator|.
name|equals
argument_list|(
name|elem
operator|.
name|getNamespaceURI
argument_list|()
argument_list|)
operator|)
condition|)
block|{
name|response
argument_list|(
name|broker
argument_list|,
name|response
argument_list|,
name|outputProperties
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return;
comment|//                            throw new ServletException("Redirect XQuery should return an element in namespace " + Namespaces.EXIST_NS);
block|}
if|if
condition|(
name|Namespaces
operator|.
name|EXIST_NS
operator|.
name|equals
argument_list|(
name|elem
operator|.
name|getNamespaceURI
argument_list|()
argument_list|)
operator|&&
literal|"dispatch"
operator|.
name|equals
argument_list|(
name|elem
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|node
operator|=
name|elem
operator|.
name|getFirstChild
argument_list|()
expr_stmt|;
while|while
condition|(
name|node
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|node
operator|.
name|getNodeType
argument_list|()
operator|==
name|Node
operator|.
name|ELEMENT_NODE
operator|&&
name|Namespaces
operator|.
name|EXIST_NS
operator|.
name|equals
argument_list|(
name|node
operator|.
name|getNamespaceURI
argument_list|()
argument_list|)
condition|)
block|{
name|Element
name|action
init|=
operator|(
name|Element
operator|)
name|node
decl_stmt|;
if|if
condition|(
literal|"view"
operator|.
name|equals
argument_list|(
name|action
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|parseViews
argument_list|(
name|modifiedRequest
argument_list|,
name|action
argument_list|,
name|modelView
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
literal|"error-handler"
operator|.
name|equals
argument_list|(
name|action
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|parseErrorHandlers
argument_list|(
name|modifiedRequest
argument_list|,
name|action
argument_list|,
name|modelView
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
literal|"cache-control"
operator|.
name|equals
argument_list|(
name|action
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|String
name|option
init|=
name|action
operator|.
name|getAttribute
argument_list|(
literal|"cache"
argument_list|)
decl_stmt|;
name|modelView
operator|.
name|setUseCache
argument_list|(
literal|"yes"
operator|.
name|equals
argument_list|(
name|option
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|URLRewrite
name|urw
init|=
name|parseAction
argument_list|(
name|modifiedRequest
argument_list|,
name|action
argument_list|)
decl_stmt|;
if|if
condition|(
name|urw
operator|!=
literal|null
condition|)
name|modelView
operator|.
name|setModel
argument_list|(
name|urw
argument_list|)
expr_stmt|;
block|}
block|}
name|node
operator|=
name|node
operator|.
name|getNextSibling
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|modelView
operator|.
name|getModel
argument_list|()
operator|==
literal|null
condition|)
name|modelView
operator|.
name|setModel
argument_list|(
operator|new
name|PassThrough
argument_list|(
name|elem
argument_list|,
name|modifiedRequest
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|Namespaces
operator|.
name|EXIST_NS
operator|.
name|equals
argument_list|(
name|elem
operator|.
name|getNamespaceURI
argument_list|()
argument_list|)
operator|&&
literal|"ignore"
operator|.
name|equals
argument_list|(
name|elem
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|modelView
operator|.
name|setModel
argument_list|(
operator|new
name|PassThrough
argument_list|(
name|elem
argument_list|,
name|modifiedRequest
argument_list|)
argument_list|)
expr_stmt|;
name|NodeList
name|nl
init|=
name|elem
operator|.
name|getElementsByTagNameNS
argument_list|(
name|Namespaces
operator|.
name|EXIST_NS
argument_list|,
literal|"cache-control"
argument_list|)
decl_stmt|;
if|if
condition|(
name|nl
operator|.
name|getLength
argument_list|()
operator|>
literal|0
condition|)
block|{
name|elem
operator|=
operator|(
name|Element
operator|)
name|nl
operator|.
name|item
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|String
name|option
init|=
name|elem
operator|.
name|getAttribute
argument_list|(
literal|"cache"
argument_list|)
decl_stmt|;
name|modelView
operator|.
name|setUseCache
argument_list|(
literal|"yes"
operator|.
name|equals
argument_list|(
name|option
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|response
argument_list|(
name|broker
argument_list|,
name|response
argument_list|,
name|outputProperties
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|else if
condition|(
name|result
operator|.
name|getItemCount
argument_list|()
operator|>
literal|1
condition|)
block|{
name|response
argument_list|(
name|broker
argument_list|,
name|response
argument_list|,
name|outputProperties
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
finally|finally
block|{
name|pool
operator|.
name|release
argument_list|(
name|broker
argument_list|)
expr_stmt|;
block|}
comment|// store the original request URI to org.exist.forward.request-uri
name|modifiedRequest
operator|.
name|setAttribute
argument_list|(
name|RQ_ATTR_REQUEST_URI
argument_list|,
name|request
operator|.
name|getRequestURI
argument_list|()
argument_list|)
expr_stmt|;
name|modifiedRequest
operator|.
name|setAttribute
argument_list|(
name|RQ_ATTR_SERVLET_PATH
argument_list|,
name|request
operator|.
name|getServletPath
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|modelView
operator|.
name|useCache
argument_list|()
condition|)
block|{
synchronized|synchronized
init|(
name|urlCache
init|)
block|{
name|urlCache
operator|.
name|put
argument_list|(
name|modifiedRequest
operator|.
name|getHeader
argument_list|(
literal|"Host"
argument_list|)
operator|+
name|request
operator|.
name|getRequestURI
argument_list|()
argument_list|,
name|modelView
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|trace
argument_list|(
literal|"URLRewrite took "
operator|+
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|)
operator|+
literal|"ms."
argument_list|)
expr_stmt|;
name|HttpServletResponse
name|wrappedResponse
init|=
operator|new
name|CachingResponseWrapper
argument_list|(
name|response
argument_list|,
name|modelView
operator|.
name|hasViews
argument_list|()
operator|||
name|modelView
operator|.
name|hasErrorHandlers
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|modelView
operator|.
name|getModel
argument_list|()
operator|==
literal|null
condition|)
name|modelView
operator|.
name|setModel
argument_list|(
operator|new
name|PassThrough
argument_list|(
name|modifiedRequest
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|staticRewrite
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|modelView
operator|.
name|getModel
argument_list|()
operator|.
name|doResolve
argument_list|()
condition|)
name|staticRewrite
operator|.
name|rewriteRequest
argument_list|(
name|modifiedRequest
argument_list|)
expr_stmt|;
else|else
name|modelView
operator|.
name|getModel
argument_list|()
operator|.
name|setAbsolutePath
argument_list|(
name|modifiedRequest
argument_list|)
expr_stmt|;
block|}
name|doRewrite
argument_list|(
name|modelView
operator|.
name|getModel
argument_list|()
argument_list|,
name|modifiedRequest
argument_list|,
name|wrappedResponse
argument_list|,
name|filterChain
argument_list|)
expr_stmt|;
name|int
name|status
init|=
operator|(
operator|(
name|CachingResponseWrapper
operator|)
name|wrappedResponse
operator|)
operator|.
name|getStatus
argument_list|()
decl_stmt|;
if|if
condition|(
name|status
operator|==
name|HttpServletResponse
operator|.
name|SC_NOT_MODIFIED
condition|)
block|{
name|response
operator|.
name|flushBuffer
argument_list|()
expr_stmt|;
block|}
if|else if
condition|(
name|status
operator|<
literal|400
condition|)
block|{
if|if
condition|(
name|modelView
operator|.
name|hasViews
argument_list|()
condition|)
name|applyViews
argument_list|(
name|modelView
operator|.
name|views
argument_list|,
name|response
argument_list|,
name|modifiedRequest
argument_list|,
name|wrappedResponse
argument_list|)
expr_stmt|;
else|else
operator|(
operator|(
name|CachingResponseWrapper
operator|)
name|wrappedResponse
operator|)
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
else|else
block|{
comment|// HTTP response code indicates an error
if|if
condition|(
name|modelView
operator|.
name|hasErrorHandlers
argument_list|()
condition|)
block|{
name|applyViews
argument_list|(
name|modelView
operator|.
name|errorHandlers
argument_list|,
name|response
argument_list|,
name|modifiedRequest
argument_list|,
name|wrappedResponse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|flushError
argument_list|(
name|response
argument_list|,
name|wrappedResponse
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|//            Sequence result;
comment|//            if ((result = (Sequence) request.getAttribute(RQ_ATTR_RESULT)) != null) {
comment|//                writeResults(response, broker, result);
comment|//            }
block|}
catch|catch
parameter_list|(
name|EXistException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"An error occurred while retrieving query results: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|XPathException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"An error occurred while executing the urlrewrite query: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
comment|//        } catch (SAXException e) {
comment|//            throw new ServletException("Error while serializing results: " + e.getMessage(), e);
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"An error occurred: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
specifier|private
name|void
name|applyViews
parameter_list|(
name|List
argument_list|<
name|URLRewrite
argument_list|>
name|views
parameter_list|,
name|HttpServletResponse
name|response
parameter_list|,
name|RequestWrapper
name|modifiedRequest
parameter_list|,
name|HttpServletResponse
name|wrappedResponse
parameter_list|)
throws|throws
name|UnsupportedEncodingException
throws|,
name|IOException
throws|,
name|ServletException
block|{
name|int
name|status
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|views
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|URLRewrite
name|view
init|=
operator|(
name|URLRewrite
operator|)
name|views
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|RequestWrapper
name|wrappedReq
init|=
operator|new
name|RequestWrapper
argument_list|(
name|modifiedRequest
argument_list|)
decl_stmt|;
name|wrappedReq
operator|.
name|setMethod
argument_list|(
literal|"POST"
argument_list|)
expr_stmt|;
name|wrappedReq
operator|.
name|setCharacterEncoding
argument_list|(
name|wrappedResponse
operator|.
name|getCharacterEncoding
argument_list|()
argument_list|)
expr_stmt|;
name|wrappedReq
operator|.
name|setContentType
argument_list|(
name|wrappedResponse
operator|.
name|getContentType
argument_list|()
argument_list|)
expr_stmt|;
name|byte
index|[]
name|data
init|=
operator|(
operator|(
name|CachingResponseWrapper
operator|)
name|wrappedResponse
operator|)
operator|.
name|getData
argument_list|()
decl_stmt|;
if|if
condition|(
name|data
operator|!=
literal|null
condition|)
name|wrappedReq
operator|.
name|setData
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|wrappedResponse
operator|=
operator|new
name|CachingResponseWrapper
argument_list|(
name|response
argument_list|,
name|i
operator|<
name|views
operator|.
name|size
argument_list|()
operator|-
literal|1
argument_list|)
expr_stmt|;
name|doRewrite
argument_list|(
name|view
argument_list|,
name|wrappedReq
argument_list|,
name|wrappedResponse
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|wrappedResponse
operator|.
name|flushBuffer
argument_list|()
expr_stmt|;
comment|// catch errors in the view
name|status
operator|=
operator|(
operator|(
name|CachingResponseWrapper
operator|)
name|wrappedResponse
operator|)
operator|.
name|getStatus
argument_list|()
expr_stmt|;
if|if
condition|(
name|status
operator|>=
literal|400
condition|)
block|{
name|flushError
argument_list|(
name|response
argument_list|,
name|wrappedResponse
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
specifier|private
name|void
name|response
parameter_list|(
name|DBBroker
name|broker
parameter_list|,
name|HttpServletResponse
name|response
parameter_list|,
name|Properties
name|outputProperties
parameter_list|,
name|Sequence
name|resultSequence
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|encoding
init|=
name|outputProperties
operator|.
name|getProperty
argument_list|(
name|OutputKeys
operator|.
name|ENCODING
argument_list|)
decl_stmt|;
name|ServletOutputStream
name|sout
init|=
name|response
operator|.
name|getOutputStream
argument_list|()
decl_stmt|;
name|PrintWriter
name|output
init|=
operator|new
name|PrintWriter
argument_list|(
operator|new
name|OutputStreamWriter
argument_list|(
name|sout
argument_list|,
name|encoding
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|response
operator|.
name|containsHeader
argument_list|(
literal|"Content-Type"
argument_list|)
condition|)
block|{
name|String
name|mimeType
init|=
name|outputProperties
operator|.
name|getProperty
argument_list|(
name|OutputKeys
operator|.
name|MEDIA_TYPE
argument_list|)
decl_stmt|;
if|if
condition|(
name|mimeType
operator|!=
literal|null
condition|)
block|{
name|int
name|semicolon
init|=
name|mimeType
operator|.
name|indexOf
argument_list|(
literal|';'
argument_list|)
decl_stmt|;
if|if
condition|(
name|semicolon
operator|!=
name|Constants
operator|.
name|STRING_NOT_FOUND
condition|)
block|{
name|mimeType
operator|=
name|mimeType
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|semicolon
argument_list|)
expr_stmt|;
block|}
name|response
operator|.
name|setContentType
argument_list|(
name|mimeType
operator|+
literal|"; charset="
operator|+
name|encoding
argument_list|)
expr_stmt|;
block|}
block|}
comment|//        response.addHeader( "pragma", "no-cache" );
comment|//        response.addHeader( "Cache-Control", "no-cache" );
name|Serializer
name|serializer
init|=
name|broker
operator|.
name|getSerializer
argument_list|()
decl_stmt|;
name|serializer
operator|.
name|reset
argument_list|()
expr_stmt|;
name|SerializerPool
name|serializerPool
init|=
name|SerializerPool
operator|.
name|getInstance
argument_list|()
decl_stmt|;
name|SAXSerializer
name|sax
init|=
operator|(
name|SAXSerializer
operator|)
name|serializerPool
operator|.
name|borrowObject
argument_list|(
name|SAXSerializer
operator|.
name|class
argument_list|)
decl_stmt|;
try|try
block|{
name|sax
operator|.
name|setOutput
argument_list|(
name|output
argument_list|,
name|outputProperties
argument_list|)
expr_stmt|;
name|serializer
operator|.
name|setProperties
argument_list|(
name|outputProperties
argument_list|)
expr_stmt|;
name|serializer
operator|.
name|setSAXHandlers
argument_list|(
name|sax
argument_list|,
name|sax
argument_list|)
expr_stmt|;
name|serializer
operator|.
name|toSAX
argument_list|(
name|resultSequence
argument_list|,
literal|1
argument_list|,
name|resultSequence
operator|.
name|getItemCount
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SAXException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|serializerPool
operator|.
name|returnObject
argument_list|(
name|sax
argument_list|)
expr_stmt|;
block|}
name|output
operator|.
name|flush
argument_list|()
expr_stmt|;
name|output
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
specifier|private
name|void
name|flushError
parameter_list|(
name|HttpServletResponse
name|response
parameter_list|,
name|HttpServletResponse
name|wrappedResponse
parameter_list|)
throws|throws
name|IOException
block|{
name|byte
index|[]
name|data
init|=
operator|(
operator|(
name|CachingResponseWrapper
operator|)
name|wrappedResponse
operator|)
operator|.
name|getData
argument_list|()
decl_stmt|;
if|if
condition|(
name|data
operator|!=
literal|null
condition|)
block|{
name|response
operator|.
name|setContentType
argument_list|(
name|wrappedResponse
operator|.
name|getContentType
argument_list|()
argument_list|)
expr_stmt|;
name|response
operator|.
name|setCharacterEncoding
argument_list|(
name|wrappedResponse
operator|.
name|getCharacterEncoding
argument_list|()
argument_list|)
expr_stmt|;
name|response
operator|.
name|getOutputStream
argument_list|()
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|response
operator|.
name|flushBuffer
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|checkCache
parameter_list|(
name|Subject
name|user
parameter_list|)
throws|throws
name|EXistException
block|{
if|if
condition|(
name|checkModified
condition|)
block|{
comment|// check if any of the currently used sources has been updated
comment|// if yes, clear the cache
synchronized|synchronized
init|(
name|urlCache
init|)
block|{
for|for
control|(
name|Source
name|source
range|:
name|sources
operator|.
name|values
argument_list|()
control|)
block|{
if|if
condition|(
name|source
operator|instanceof
name|DBSource
condition|)
block|{
comment|// Check if the XQuery source changed. If yes, clear all caches.
name|DBBroker
name|broker
init|=
literal|null
decl_stmt|;
try|try
block|{
name|broker
operator|=
name|pool
operator|.
name|get
argument_list|(
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|source
operator|.
name|isValid
argument_list|(
name|broker
argument_list|)
operator|!=
name|Source
operator|.
name|VALID
condition|)
block|{
name|clearCaches
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
finally|finally
block|{
name|pool
operator|.
name|release
argument_list|(
name|broker
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|source
operator|.
name|isValid
argument_list|(
operator|(
name|DBBroker
operator|)
literal|null
argument_list|)
operator|!=
name|Source
operator|.
name|VALID
condition|)
block|{
name|clearCaches
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
block|}
comment|/**      * Process a rewrite action. Method checks if the target path is mapped      * to another action in controller-config.xml. If yes, replaces the current action      * with the new action.      *      * @param action      * @param request      * @param response      * @param filterChain      * @throws IOException      * @throws ServletException      */
specifier|protected
name|void
name|doRewrite
parameter_list|(
name|URLRewrite
name|action
parameter_list|,
name|RequestWrapper
name|request
parameter_list|,
name|HttpServletResponse
name|response
parameter_list|,
name|FilterChain
name|filterChain
parameter_list|)
throws|throws
name|IOException
throws|,
name|ServletException
block|{
if|if
condition|(
name|action
operator|.
name|getTarget
argument_list|()
operator|!=
literal|null
operator|&&
operator|!
operator|(
name|action
operator|instanceof
name|Redirect
operator|)
condition|)
block|{
name|String
name|uri
init|=
name|action
operator|.
name|resolve
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|URLRewrite
name|staticRewrite
init|=
name|rewriteConfig
operator|.
name|lookup
argument_list|(
name|uri
argument_list|,
name|request
operator|.
name|getServerName
argument_list|()
argument_list|,
literal|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|staticRewrite
operator|!=
literal|null
condition|)
block|{
name|staticRewrite
operator|.
name|copyFrom
argument_list|(
name|action
argument_list|)
expr_stmt|;
name|action
operator|=
name|staticRewrite
expr_stmt|;
name|RequestWrapper
name|modifiedRequest
init|=
operator|new
name|RequestWrapper
argument_list|(
name|request
argument_list|)
decl_stmt|;
name|modifiedRequest
operator|.
name|setPaths
argument_list|(
name|uri
argument_list|,
name|action
operator|.
name|getPrefix
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|trace
argument_list|(
literal|"Forwarding to : "
operator|+
name|action
operator|.
name|toString
argument_list|()
operator|+
literal|" url: "
operator|+
name|action
operator|.
name|getURI
argument_list|()
argument_list|)
expr_stmt|;
name|request
operator|=
name|modifiedRequest
expr_stmt|;
block|}
block|}
name|action
operator|.
name|prepareRequest
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|action
operator|.
name|doRewrite
argument_list|(
name|request
argument_list|,
name|response
argument_list|,
name|filterChain
argument_list|)
expr_stmt|;
block|}
specifier|protected
name|FilterConfig
name|getConfig
parameter_list|()
block|{
return|return
name|config
return|;
block|}
specifier|protected
name|void
name|clearCaches
parameter_list|()
block|{
synchronized|synchronized
init|(
name|urlCache
init|)
block|{
name|urlCache
operator|.
name|clear
argument_list|()
expr_stmt|;
name|sources
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|URLRewrite
name|parseAction
parameter_list|(
name|HttpServletRequest
name|request
parameter_list|,
name|Element
name|action
parameter_list|)
throws|throws
name|ServletException
block|{
name|URLRewrite
name|rewrite
init|=
literal|null
decl_stmt|;
if|if
condition|(
literal|"forward"
operator|.
name|equals
argument_list|(
name|action
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|rewrite
operator|=
operator|new
name|PathForward
argument_list|(
name|config
argument_list|,
name|action
argument_list|,
name|request
operator|.
name|getRequestURI
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
literal|"redirect"
operator|.
name|equals
argument_list|(
name|action
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|rewrite
operator|=
operator|new
name|Redirect
argument_list|(
name|action
argument_list|,
name|request
operator|.
name|getRequestURI
argument_list|()
argument_list|)
expr_stmt|;
comment|//        } else if ("call".equals(action.getLocalName())) {
comment|//            rewrite = new ModuleCall(action, queryContext, request.getRequestURI());
block|}
return|return
name|rewrite
return|;
block|}
specifier|private
name|void
name|parseViews
parameter_list|(
name|HttpServletRequest
name|request
parameter_list|,
name|Element
name|view
parameter_list|,
name|ModelAndView
name|modelView
parameter_list|)
throws|throws
name|ServletException
block|{
name|Node
name|node
init|=
name|view
operator|.
name|getFirstChild
argument_list|()
decl_stmt|;
while|while
condition|(
name|node
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|node
operator|.
name|getNodeType
argument_list|()
operator|==
name|Node
operator|.
name|ELEMENT_NODE
operator|&&
name|Namespaces
operator|.
name|EXIST_NS
operator|.
name|equals
argument_list|(
name|node
operator|.
name|getNamespaceURI
argument_list|()
argument_list|)
condition|)
block|{
name|URLRewrite
name|urw
init|=
name|parseAction
argument_list|(
name|request
argument_list|,
operator|(
name|Element
operator|)
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|urw
operator|!=
literal|null
condition|)
name|modelView
operator|.
name|addView
argument_list|(
name|urw
argument_list|)
expr_stmt|;
block|}
name|node
operator|=
name|node
operator|.
name|getNextSibling
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|parseErrorHandlers
parameter_list|(
name|HttpServletRequest
name|request
parameter_list|,
name|Element
name|view
parameter_list|,
name|ModelAndView
name|modelView
parameter_list|)
throws|throws
name|ServletException
block|{
name|Node
name|node
init|=
name|view
operator|.
name|getFirstChild
argument_list|()
decl_stmt|;
while|while
condition|(
name|node
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|node
operator|.
name|getNodeType
argument_list|()
operator|==
name|Node
operator|.
name|ELEMENT_NODE
operator|&&
name|Namespaces
operator|.
name|EXIST_NS
operator|.
name|equals
argument_list|(
name|node
operator|.
name|getNamespaceURI
argument_list|()
argument_list|)
condition|)
block|{
name|URLRewrite
name|urw
init|=
name|parseAction
argument_list|(
name|request
argument_list|,
operator|(
name|Element
operator|)
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|urw
operator|!=
literal|null
condition|)
name|modelView
operator|.
name|addErrorHandler
argument_list|(
name|urw
argument_list|)
expr_stmt|;
block|}
name|node
operator|=
name|node
operator|.
name|getNextSibling
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|configure
parameter_list|()
throws|throws
name|ServletException
block|{
if|if
condition|(
name|pool
operator|!=
literal|null
condition|)
return|return;
try|try
block|{
name|Class
argument_list|<
name|?
argument_list|>
name|driver
init|=
name|Class
operator|.
name|forName
argument_list|(
name|DRIVER
argument_list|)
decl_stmt|;
name|Database
name|database
init|=
operator|(
name|Database
operator|)
name|driver
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|database
operator|.
name|setProperty
argument_list|(
literal|"create-database"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
name|DatabaseManager
operator|.
name|registerDatabase
argument_list|(
name|database
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Initialized database"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|String
name|errorMessage
init|=
literal|"Failed to initialize database driver"
decl_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|errorMessage
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ServletException
argument_list|(
name|errorMessage
operator|+
literal|": "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
try|try
block|{
name|pool
operator|=
name|BrokerPool
operator|.
name|getInstance
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|EXistException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"Could not intialize db: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
name|defaultUser
operator|=
name|pool
operator|.
name|getSecurityManager
argument_list|()
operator|.
name|getGuestSubject
argument_list|()
expr_stmt|;
name|String
name|username
init|=
name|config
operator|.
name|getInitParameter
argument_list|(
literal|"user"
argument_list|)
decl_stmt|;
if|if
condition|(
name|username
operator|!=
literal|null
condition|)
block|{
name|String
name|password
init|=
name|config
operator|.
name|getInitParameter
argument_list|(
literal|"password"
argument_list|)
decl_stmt|;
try|try
block|{
name|Subject
name|user
init|=
name|pool
operator|.
name|getSecurityManager
argument_list|()
operator|.
name|authenticate
argument_list|(
name|username
argument_list|,
name|password
argument_list|)
decl_stmt|;
if|if
condition|(
name|user
operator|!=
literal|null
operator|&&
name|user
operator|.
name|isAuthenticated
argument_list|()
condition|)
name|defaultUser
operator|=
name|user
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|AuthenticationException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"User can not be authenticated ("
operator|+
name|username
operator|+
literal|"), using default user."
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
name|void
name|logResult
parameter_list|(
name|DBBroker
name|broker
parameter_list|,
name|Sequence
name|result
parameter_list|)
throws|throws
name|IOException
throws|,
name|SAXException
block|{
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
operator|&&
name|result
operator|.
name|getItemCount
argument_list|()
operator|>
literal|0
condition|)
block|{
name|Serializer
name|serializer
init|=
name|broker
operator|.
name|getSerializer
argument_list|()
decl_stmt|;
name|serializer
operator|.
name|reset
argument_list|()
expr_stmt|;
name|Item
name|item
init|=
name|result
operator|.
name|itemAt
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|Type
operator|.
name|subTypeOf
argument_list|(
name|item
operator|.
name|getType
argument_list|()
argument_list|,
name|Type
operator|.
name|NODE
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
name|serializer
operator|.
name|serialize
argument_list|(
operator|(
name|NodeValue
operator|)
name|item
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|destroy
parameter_list|()
block|{
name|config
operator|=
literal|null
expr_stmt|;
block|}
specifier|private
name|Sequence
name|runQuery
parameter_list|(
name|DBBroker
name|broker
parameter_list|,
name|RequestWrapper
name|request
parameter_list|,
name|HttpServletResponse
name|response
parameter_list|,
name|URLRewrite
name|staticRewrite
parameter_list|,
name|Properties
name|outputProperties
parameter_list|)
throws|throws
name|ServletException
throws|,
name|XPathException
block|{
comment|// Try to find the XQuery
name|SourceInfo
name|sourceInfo
decl_stmt|;
name|String
name|moduleLoadPath
init|=
name|config
operator|.
name|getServletContext
argument_list|()
operator|.
name|getRealPath
argument_list|(
literal|"."
argument_list|)
decl_stmt|;
name|String
name|basePath
init|=
name|staticRewrite
operator|==
literal|null
condition|?
literal|"."
else|:
name|staticRewrite
operator|.
name|getTarget
argument_list|()
decl_stmt|;
if|if
condition|(
name|basePath
operator|==
literal|null
condition|)
name|sourceInfo
operator|=
name|getSource
argument_list|(
name|broker
argument_list|,
name|moduleLoadPath
argument_list|)
expr_stmt|;
else|else
name|sourceInfo
operator|=
name|findSource
argument_list|(
name|request
argument_list|,
name|broker
argument_list|,
name|basePath
argument_list|)
expr_stmt|;
if|if
condition|(
name|sourceInfo
operator|==
literal|null
condition|)
return|return
name|Sequence
operator|.
name|EMPTY_SEQUENCE
return|;
comment|// no controller found
synchronized|synchronized
init|(
name|urlCache
init|)
block|{
name|sources
operator|.
name|put
argument_list|(
name|sourceInfo
operator|.
name|source
operator|.
name|getKey
argument_list|()
argument_list|,
name|sourceInfo
operator|.
name|source
argument_list|)
expr_stmt|;
block|}
name|XQuery
name|xquery
init|=
name|broker
operator|.
name|getXQueryService
argument_list|()
decl_stmt|;
name|XQueryPool
name|xqyPool
init|=
name|xquery
operator|.
name|getXQueryPool
argument_list|()
decl_stmt|;
name|CompiledXQuery
name|compiled
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|compiledCache
condition|)
name|compiled
operator|=
name|xqyPool
operator|.
name|borrowCompiledXQuery
argument_list|(
name|broker
argument_list|,
name|sourceInfo
operator|.
name|source
argument_list|)
expr_stmt|;
name|XQueryContext
name|queryContext
decl_stmt|;
if|if
condition|(
name|compiled
operator|==
literal|null
condition|)
block|{
name|queryContext
operator|=
name|xquery
operator|.
name|newContext
argument_list|(
name|AccessContext
operator|.
name|REST
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|queryContext
operator|=
name|compiled
operator|.
name|getContext
argument_list|()
expr_stmt|;
block|}
comment|// Find correct module load path
name|queryContext
operator|.
name|setModuleLoadPath
argument_list|(
name|sourceInfo
operator|.
name|moduleLoadPath
argument_list|)
expr_stmt|;
name|declareVariables
argument_list|(
name|queryContext
argument_list|,
name|sourceInfo
argument_list|,
name|staticRewrite
argument_list|,
name|basePath
argument_list|,
name|request
argument_list|,
name|response
argument_list|)
expr_stmt|;
if|if
condition|(
name|compiled
operator|==
literal|null
condition|)
block|{
try|try
block|{
name|compiled
operator|=
name|xquery
operator|.
name|compile
argument_list|(
name|queryContext
argument_list|,
name|sourceInfo
operator|.
name|source
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"Failed to read query from "
operator|+
name|query
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|//		This used by controller.xql only ?
comment|//		String xdebug = request.getParameter("XDEBUG_SESSION_START");
comment|//		if (xdebug != null)
comment|//			compiled.getContext().setDebugMode(true);
comment|//      outputProperties.put("base-uri", collectionURI.toString());
try|try
block|{
return|return
name|xquery
operator|.
name|execute
argument_list|(
name|compiled
argument_list|,
literal|null
argument_list|,
name|outputProperties
argument_list|)
return|;
block|}
finally|finally
block|{
name|xqyPool
operator|.
name|returnCompiledXQuery
argument_list|(
name|sourceInfo
operator|.
name|source
argument_list|,
name|compiled
argument_list|)
expr_stmt|;
block|}
block|}
specifier|protected
name|String
name|adjustPathForSourceLookup
parameter_list|(
name|String
name|basePath
parameter_list|,
name|String
name|path
parameter_list|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"request path="
operator|+
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|basePath
operator|.
name|startsWith
argument_list|(
name|XmldbURI
operator|.
name|EMBEDDED_SERVER_URI_PREFIX
argument_list|)
operator|&&
name|path
operator|.
name|startsWith
argument_list|(
name|basePath
operator|.
name|replace
argument_list|(
name|XmldbURI
operator|.
name|EMBEDDED_SERVER_URI_PREFIX
argument_list|,
literal|""
argument_list|)
argument_list|)
condition|)
block|{
name|path
operator|=
name|path
operator|.
name|replace
argument_list|(
name|basePath
operator|.
name|replace
argument_list|(
name|XmldbURI
operator|.
name|EMBEDDED_SERVER_URI_PREFIX
argument_list|,
literal|""
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|path
operator|.
name|startsWith
argument_list|(
literal|"/db/"
argument_list|)
condition|)
block|{
name|path
operator|=
name|path
operator|.
name|substring
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|path
operator|.
name|startsWith
argument_list|(
literal|"/"
argument_list|)
condition|)
block|{
name|path
operator|=
name|path
operator|.
name|substring
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|LOG
operator|.
name|trace
argument_list|(
literal|"adjusted request path="
operator|+
name|path
argument_list|)
expr_stmt|;
return|return
name|path
return|;
block|}
specifier|private
name|SourceInfo
name|findSource
parameter_list|(
name|HttpServletRequest
name|request
parameter_list|,
name|DBBroker
name|broker
parameter_list|,
name|String
name|basePath
parameter_list|)
throws|throws
name|ServletException
block|{
name|String
name|requestURI
init|=
name|request
operator|.
name|getRequestURI
argument_list|()
decl_stmt|;
name|String
name|path
init|=
name|requestURI
operator|.
name|substring
argument_list|(
name|request
operator|.
name|getContextPath
argument_list|()
operator|.
name|length
argument_list|()
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|trace
argument_list|(
literal|"basePath="
operator|+
name|basePath
argument_list|)
expr_stmt|;
name|path
operator|=
name|adjustPathForSourceLookup
argument_list|(
name|basePath
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|String
index|[]
name|components
init|=
name|path
operator|.
name|split
argument_list|(
literal|"/"
argument_list|)
decl_stmt|;
name|SourceInfo
name|sourceInfo
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|basePath
operator|.
name|startsWith
argument_list|(
name|XmldbURI
operator|.
name|XMLDB_URI_PREFIX
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"Looking for controller.xql in the database, starting from: "
operator|+
name|basePath
argument_list|)
expr_stmt|;
try|try
block|{
name|XmldbURI
name|locationUri
init|=
name|XmldbURI
operator|.
name|xmldbUriFor
argument_list|(
name|basePath
argument_list|)
decl_stmt|;
name|Collection
name|collection
init|=
name|broker
operator|.
name|openCollection
argument_list|(
name|locationUri
argument_list|,
name|Lock
operator|.
name|READ_LOCK
argument_list|)
decl_stmt|;
if|if
condition|(
name|collection
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Controller base collection not found: "
operator|+
name|basePath
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|Collection
name|subColl
init|=
name|collection
decl_stmt|;
name|DocumentImpl
name|controllerDoc
init|=
literal|null
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|components
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|DocumentImpl
name|doc
init|=
literal|null
decl_stmt|;
try|try
block|{
if|if
condition|(
name|components
index|[
name|i
index|]
operator|.
name|length
argument_list|()
operator|>
literal|0
operator|&&
name|subColl
operator|.
name|hasChildCollection
argument_list|(
name|XmldbURI
operator|.
name|createInternal
argument_list|(
name|components
index|[
name|i
index|]
argument_list|)
argument_list|)
condition|)
block|{
name|XmldbURI
name|newSubCollURI
init|=
name|subColl
operator|.
name|getURI
argument_list|()
operator|.
name|append
argument_list|(
name|components
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|trace
argument_list|(
literal|"Inspecting sub-collection: "
operator|+
name|newSubCollURI
argument_list|)
expr_stmt|;
name|subColl
operator|=
name|broker
operator|.
name|openCollection
argument_list|(
name|newSubCollURI
argument_list|,
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|subColl
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"Looking for controller.xql in "
operator|+
name|subColl
operator|.
name|getURI
argument_list|()
argument_list|)
expr_stmt|;
name|XmldbURI
name|docUri
init|=
name|subColl
operator|.
name|getURI
argument_list|()
operator|.
name|append
argument_list|(
literal|"controller.xql"
argument_list|)
decl_stmt|;
name|doc
operator|=
name|broker
operator|.
name|getXMLResource
argument_list|(
name|docUri
argument_list|,
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|doc
operator|!=
literal|null
condition|)
name|controllerDoc
operator|=
name|doc
expr_stmt|;
block|}
else|else
break|break;
block|}
else|else
block|{
break|break;
block|}
block|}
catch|catch
parameter_list|(
name|PermissionDeniedException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Permission denied while scanning for XQueryURLRewrite controllers: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Bad collection URI: "
operator|+
name|path
argument_list|)
expr_stmt|;
break|break;
block|}
finally|finally
block|{
if|if
condition|(
name|doc
operator|!=
literal|null
operator|&&
name|controllerDoc
operator|==
literal|null
condition|)
name|doc
operator|.
name|getUpdateLock
argument_list|()
operator|.
name|release
argument_list|(
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|subColl
operator|!=
literal|null
operator|&&
name|subColl
operator|!=
name|collection
condition|)
name|subColl
operator|.
name|getLock
argument_list|()
operator|.
name|release
argument_list|(
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
name|collection
operator|.
name|getLock
argument_list|()
operator|.
name|release
argument_list|(
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|controllerDoc
operator|==
literal|null
condition|)
block|{
try|try
block|{
name|XmldbURI
name|docUri
init|=
name|collection
operator|.
name|getURI
argument_list|()
operator|.
name|append
argument_list|(
literal|"controller.xql"
argument_list|)
decl_stmt|;
name|controllerDoc
operator|=
name|broker
operator|.
name|getXMLResource
argument_list|(
name|docUri
argument_list|,
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PermissionDeniedException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Permission denied while scanning for XQueryURLRewrite controllers: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|controllerDoc
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"XQueryURLRewrite controller could not be found"
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"Found controller file: "
operator|+
name|controllerDoc
operator|.
name|getURI
argument_list|()
argument_list|)
expr_stmt|;
block|}
try|try
block|{
if|if
condition|(
name|controllerDoc
operator|.
name|getResourceType
argument_list|()
operator|!=
name|DocumentImpl
operator|.
name|BINARY_FILE
operator|||
operator|!
name|controllerDoc
operator|.
name|getMetadata
argument_list|()
operator|.
name|getMimeType
argument_list|()
operator|.
name|equals
argument_list|(
literal|"application/xquery"
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"XQuery resource: "
operator|+
name|query
operator|+
literal|" is not an XQuery or "
operator|+
literal|"declares a wrong mime-type"
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|String
name|controllerPath
init|=
name|controllerDoc
operator|.
name|getCollection
argument_list|()
operator|.
name|getURI
argument_list|()
operator|.
name|getRawCollectionPath
argument_list|()
decl_stmt|;
name|sourceInfo
operator|=
operator|new
name|SourceInfo
argument_list|(
operator|new
name|DBSource
argument_list|(
name|broker
argument_list|,
operator|(
name|BinaryDocument
operator|)
name|controllerDoc
argument_list|,
literal|true
argument_list|)
argument_list|,
literal|"xmldb:exist://"
operator|+
name|controllerPath
argument_list|)
expr_stmt|;
name|sourceInfo
operator|.
name|controllerPath
operator|=
name|controllerPath
operator|.
name|substring
argument_list|(
name|locationUri
operator|.
name|getCollectionPath
argument_list|()
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|sourceInfo
return|;
block|}
finally|finally
block|{
if|if
condition|(
name|controllerDoc
operator|!=
literal|null
condition|)
name|controllerDoc
operator|.
name|getUpdateLock
argument_list|()
operator|.
name|release
argument_list|(
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|URISyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Bad URI for base path: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
block|}
else|else
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"Looking for controller.xql in the filesystem, starting from: "
operator|+
name|basePath
argument_list|)
expr_stmt|;
name|String
name|realPath
init|=
name|config
operator|.
name|getServletContext
argument_list|()
operator|.
name|getRealPath
argument_list|(
name|basePath
argument_list|)
decl_stmt|;
name|File
name|baseDir
init|=
operator|new
name|File
argument_list|(
name|realPath
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|baseDir
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Base path for XQueryURLRewrite does not point to a directory"
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|File
name|controllerFile
init|=
literal|null
decl_stmt|;
name|File
name|subDir
init|=
name|baseDir
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|components
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|components
index|[
name|i
index|]
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|subDir
operator|=
operator|new
name|File
argument_list|(
name|subDir
argument_list|,
name|components
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|subDir
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
name|File
name|cf
init|=
operator|new
name|File
argument_list|(
name|subDir
argument_list|,
literal|"controller.xql"
argument_list|)
decl_stmt|;
if|if
condition|(
name|cf
operator|.
name|canRead
argument_list|()
condition|)
name|controllerFile
operator|=
name|cf
expr_stmt|;
block|}
else|else
break|break;
block|}
block|}
if|if
condition|(
name|controllerFile
operator|==
literal|null
condition|)
block|{
name|File
name|cf
init|=
operator|new
name|File
argument_list|(
name|baseDir
argument_list|,
literal|"controller.xql"
argument_list|)
decl_stmt|;
if|if
condition|(
name|cf
operator|.
name|canRead
argument_list|()
condition|)
name|controllerFile
operator|=
name|cf
expr_stmt|;
block|}
if|if
condition|(
name|controllerFile
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"XQueryURLRewrite controller could not be found"
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|trace
argument_list|(
literal|"Found controller file: "
operator|+
name|controllerFile
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|parentPath
init|=
name|controllerFile
operator|.
name|getParentFile
argument_list|()
operator|.
name|getAbsolutePath
argument_list|()
decl_stmt|;
name|sourceInfo
operator|=
operator|new
name|SourceInfo
argument_list|(
operator|new
name|FileSource
argument_list|(
name|controllerFile
argument_list|,
literal|"UTF-8"
argument_list|,
literal|true
argument_list|)
argument_list|,
name|parentPath
argument_list|)
expr_stmt|;
name|sourceInfo
operator|.
name|controllerPath
operator|=
name|parentPath
operator|.
name|substring
argument_list|(
name|baseDir
operator|.
name|getAbsolutePath
argument_list|()
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
comment|// replace windows path separators
name|sourceInfo
operator|.
name|controllerPath
operator|=
name|sourceInfo
operator|.
name|controllerPath
operator|.
name|replace
argument_list|(
literal|'\\'
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
return|return
name|sourceInfo
return|;
block|}
block|}
specifier|private
name|SourceInfo
name|getSource
parameter_list|(
name|DBBroker
name|broker
parameter_list|,
name|String
name|moduleLoadPath
parameter_list|)
throws|throws
name|ServletException
block|{
name|SourceInfo
name|sourceInfo
decl_stmt|;
if|if
condition|(
name|query
operator|.
name|startsWith
argument_list|(
name|XmldbURI
operator|.
name|XMLDB_URI_PREFIX
argument_list|)
condition|)
block|{
comment|// Is the module source stored in the database?
try|try
block|{
name|XmldbURI
name|locationUri
init|=
name|XmldbURI
operator|.
name|xmldbUriFor
argument_list|(
name|query
argument_list|)
decl_stmt|;
name|DocumentImpl
name|sourceDoc
init|=
literal|null
decl_stmt|;
try|try
block|{
name|sourceDoc
operator|=
name|broker
operator|.
name|getXMLResource
argument_list|(
name|locationUri
operator|.
name|toCollectionPathURI
argument_list|()
argument_list|,
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|sourceDoc
operator|==
literal|null
condition|)
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"XQuery resource: "
operator|+
name|query
operator|+
literal|" not found in database"
argument_list|)
throw|;
if|if
condition|(
name|sourceDoc
operator|.
name|getResourceType
argument_list|()
operator|!=
name|DocumentImpl
operator|.
name|BINARY_FILE
operator|||
operator|!
name|sourceDoc
operator|.
name|getMetadata
argument_list|()
operator|.
name|getMimeType
argument_list|()
operator|.
name|equals
argument_list|(
literal|"application/xquery"
argument_list|)
condition|)
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"XQuery resource: "
operator|+
name|query
operator|+
literal|" is not an XQuery or "
operator|+
literal|"declares a wrong mime-type"
argument_list|)
throw|;
name|sourceInfo
operator|=
operator|new
name|SourceInfo
argument_list|(
operator|new
name|DBSource
argument_list|(
name|broker
argument_list|,
operator|(
name|BinaryDocument
operator|)
name|sourceDoc
argument_list|,
literal|true
argument_list|)
argument_list|,
name|locationUri
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PermissionDeniedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"permission denied to read module source from "
operator|+
name|query
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|sourceDoc
operator|!=
literal|null
condition|)
name|sourceDoc
operator|.
name|getUpdateLock
argument_list|()
operator|.
name|release
argument_list|(
name|Lock
operator|.
name|READ_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|URISyntaxException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServletException
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
else|else
block|{
try|try
block|{
name|sourceInfo
operator|=
operator|new
name|SourceInfo
argument_list|(
name|SourceFactory
operator|.
name|getSource
argument_list|(
name|broker
argument_list|,
name|moduleLoadPath
argument_list|,
name|query
argument_list|,
literal|true
argument_list|)
argument_list|,
name|moduleLoadPath
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"IO error while reading XQuery source: "
operator|+
name|query
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|PermissionDeniedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServletException
argument_list|(
literal|"Permission denied while reading XQuery source: "
operator|+
name|query
argument_list|)
throw|;
block|}
block|}
return|return
name|sourceInfo
return|;
block|}
specifier|private
name|void
name|declareVariables
parameter_list|(
name|XQueryContext
name|context
parameter_list|,
name|SourceInfo
name|sourceInfo
parameter_list|,
name|URLRewrite
name|staticRewrite
parameter_list|,
name|String
name|basePath
parameter_list|,
name|RequestWrapper
name|request
parameter_list|,
name|HttpServletResponse
name|response
parameter_list|)
throws|throws
name|XPathException
block|{
name|HttpRequestWrapper
name|reqw
init|=
operator|new
name|HttpRequestWrapper
argument_list|(
name|request
argument_list|,
literal|"UTF-8"
argument_list|,
literal|"UTF-8"
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|HttpResponseWrapper
name|respw
init|=
operator|new
name|HttpResponseWrapper
argument_list|(
name|response
argument_list|)
decl_stmt|;
comment|// context.declareNamespace(RequestModule.PREFIX,
comment|// RequestModule.NAMESPACE_URI);
name|context
operator|.
name|declareVariable
argument_list|(
name|RequestModule
operator|.
name|PREFIX
operator|+
literal|":request"
argument_list|,
name|reqw
argument_list|)
expr_stmt|;
name|context
operator|.
name|declareVariable
argument_list|(
name|ResponseModule
operator|.
name|PREFIX
operator|+
literal|":response"
argument_list|,
name|respw
argument_list|)
expr_stmt|;
name|context
operator|.
name|declareVariable
argument_list|(
name|SessionModule
operator|.
name|PREFIX
operator|+
literal|":session"
argument_list|,
name|reqw
operator|.
name|getSession
argument_list|(
literal|false
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|declareVariable
argument_list|(
literal|"exist:controller"
argument_list|,
name|sourceInfo
operator|.
name|controllerPath
argument_list|)
expr_stmt|;
name|context
operator|.
name|declareVariable
argument_list|(
literal|"exist:root"
argument_list|,
name|basePath
argument_list|)
expr_stmt|;
name|context
operator|.
name|declareVariable
argument_list|(
literal|"exist:context"
argument_list|,
name|request
operator|.
name|getContextPath
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|prefix
init|=
name|staticRewrite
operator|==
literal|null
condition|?
literal|null
else|:
name|staticRewrite
operator|.
name|getPrefix
argument_list|()
decl_stmt|;
name|context
operator|.
name|declareVariable
argument_list|(
literal|"exist:prefix"
argument_list|,
name|prefix
operator|==
literal|null
condition|?
literal|""
else|:
name|prefix
argument_list|)
expr_stmt|;
name|String
name|path
decl_stmt|;
if|if
condition|(
name|sourceInfo
operator|.
name|controllerPath
operator|.
name|length
argument_list|()
operator|>
literal|0
operator|&&
operator|!
name|sourceInfo
operator|.
name|controllerPath
operator|.
name|equals
argument_list|(
literal|"/"
argument_list|)
condition|)
name|path
operator|=
name|request
operator|.
name|getInContextPath
argument_list|()
operator|.
name|substring
argument_list|(
name|sourceInfo
operator|.
name|controllerPath
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
else|else
name|path
operator|=
name|request
operator|.
name|getInContextPath
argument_list|()
expr_stmt|;
name|int
name|p
init|=
name|path
operator|.
name|lastIndexOf
argument_list|(
literal|';'
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
operator|!=
name|Constants
operator|.
name|STRING_NOT_FOUND
condition|)
name|path
operator|=
name|path
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|context
operator|.
name|declareVariable
argument_list|(
literal|"exist:path"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|String
name|resource
init|=
literal|""
decl_stmt|;
name|Matcher
name|nameMatcher
init|=
name|NAME_REGEX
operator|.
name|matcher
argument_list|(
name|path
argument_list|)
decl_stmt|;
if|if
condition|(
name|nameMatcher
operator|.
name|matches
argument_list|()
condition|)
block|{
name|resource
operator|=
name|nameMatcher
operator|.
name|group
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|context
operator|.
name|declareVariable
argument_list|(
literal|"exist:resource"
argument_list|,
name|resource
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|debug
argument_list|(
literal|"\nexist:path = "
operator|+
name|path
operator|+
literal|"\nexist:resource = "
operator|+
name|resource
operator|+
literal|"\nexist:controller = "
operator|+
name|sourceInfo
operator|.
name|controllerPath
argument_list|)
expr_stmt|;
block|}
specifier|private
class|class
name|ModelAndView
block|{
name|URLRewrite
name|rewrite
init|=
literal|null
decl_stmt|;
name|List
argument_list|<
name|URLRewrite
argument_list|>
name|views
init|=
operator|new
name|LinkedList
argument_list|<
name|URLRewrite
argument_list|>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|URLRewrite
argument_list|>
name|errorHandlers
init|=
literal|null
decl_stmt|;
name|boolean
name|useCache
init|=
literal|false
decl_stmt|;
specifier|private
name|ModelAndView
parameter_list|()
block|{
block|}
specifier|public
name|void
name|setModel
parameter_list|(
name|URLRewrite
name|model
parameter_list|)
block|{
name|this
operator|.
name|rewrite
operator|=
name|model
expr_stmt|;
block|}
specifier|public
name|URLRewrite
name|getModel
parameter_list|()
block|{
return|return
name|rewrite
return|;
block|}
specifier|public
name|void
name|addErrorHandler
parameter_list|(
name|URLRewrite
name|handler
parameter_list|)
block|{
if|if
condition|(
name|errorHandlers
operator|==
literal|null
condition|)
name|errorHandlers
operator|=
operator|new
name|LinkedList
argument_list|<
name|URLRewrite
argument_list|>
argument_list|()
expr_stmt|;
name|errorHandlers
operator|.
name|add
argument_list|(
name|handler
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|addView
parameter_list|(
name|URLRewrite
name|view
parameter_list|)
block|{
name|views
operator|.
name|add
argument_list|(
name|view
argument_list|)
expr_stmt|;
block|}
specifier|public
name|boolean
name|hasViews
parameter_list|()
block|{
return|return
name|views
operator|.
name|size
argument_list|()
operator|>
literal|0
return|;
block|}
specifier|public
name|boolean
name|hasErrorHandlers
parameter_list|()
block|{
return|return
name|errorHandlers
operator|!=
literal|null
operator|&&
name|errorHandlers
operator|.
name|size
argument_list|()
operator|>
literal|0
return|;
block|}
specifier|public
name|boolean
name|useCache
parameter_list|()
block|{
return|return
name|useCache
return|;
block|}
specifier|public
name|void
name|setUseCache
parameter_list|(
name|boolean
name|useCache
parameter_list|)
block|{
name|this
operator|.
name|useCache
operator|=
name|useCache
expr_stmt|;
block|}
block|}
specifier|private
specifier|static
class|class
name|SourceInfo
block|{
name|Source
name|source
decl_stmt|;
name|String
name|controllerPath
init|=
literal|""
decl_stmt|;
name|String
name|moduleLoadPath
decl_stmt|;
specifier|private
name|SourceInfo
parameter_list|(
name|Source
name|source
parameter_list|,
name|String
name|moduleLoadPath
parameter_list|)
block|{
name|this
operator|.
name|source
operator|=
name|source
expr_stmt|;
name|this
operator|.
name|moduleLoadPath
operator|=
name|moduleLoadPath
expr_stmt|;
block|}
block|}
specifier|public
specifier|static
class|class
name|RequestWrapper
extends|extends
name|javax
operator|.
name|servlet
operator|.
name|http
operator|.
name|HttpServletRequestWrapper
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|addedParams
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
name|Map
name|attributes
init|=
operator|new
name|HashMap
argument_list|()
decl_stmt|;
name|ServletInputStream
name|sis
init|=
literal|null
decl_stmt|;
name|BufferedReader
name|reader
init|=
literal|null
decl_stmt|;
name|String
name|contentType
init|=
literal|null
decl_stmt|;
name|int
name|contentLength
init|=
literal|0
decl_stmt|;
name|String
name|characterEncoding
init|=
literal|null
decl_stmt|;
name|String
name|method
init|=
literal|null
decl_stmt|;
name|String
name|inContextPath
init|=
literal|null
decl_stmt|;
name|String
name|servletPath
decl_stmt|;
name|String
name|basePath
init|=
literal|null
decl_stmt|;
specifier|private
name|void
name|addNameValue
parameter_list|(
name|String
name|name
parameter_list|,
name|String
name|value
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|map
parameter_list|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|values
init|=
name|map
operator|.
name|get
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|values
operator|==
literal|null
condition|)
block|{
name|values
operator|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
expr_stmt|;
block|}
name|values
operator|.
name|add
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|map
operator|.
name|put
argument_list|(
name|name
argument_list|,
name|values
argument_list|)
expr_stmt|;
block|}
specifier|protected
name|RequestWrapper
parameter_list|(
name|HttpServletRequest
name|request
parameter_list|)
block|{
name|super
argument_list|(
name|request
argument_list|)
expr_stmt|;
comment|// copy parameters
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|String
index|[]
argument_list|>
name|param
range|:
operator|(
name|Set
argument_list|<
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|String
index|[]
argument_list|>
argument_list|>
operator|)
name|request
operator|.
name|getParameterMap
argument_list|()
operator|.
name|entrySet
argument_list|()
control|)
block|{
for|for
control|(
name|String
name|paramValue
range|:
name|param
operator|.
name|getValue
argument_list|()
control|)
block|{
name|addNameValue
argument_list|(
name|param
operator|.
name|getKey
argument_list|()
argument_list|,
name|paramValue
argument_list|,
name|addedParams
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*for(Enumeration<String> e = request.getParameterNames(); e.hasMoreElements(); ) {                  String key = e.nextElement();                 String[] value = request.getParameterValues(key);                 addedParams.put(key, value);             }*/
name|contentType
operator|=
name|request
operator|.
name|getContentType
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getRequestURI
parameter_list|()
block|{
return|return
name|inContextPath
operator|==
literal|null
condition|?
name|super
operator|.
name|getRequestURI
argument_list|()
else|:
name|getContextPath
argument_list|()
operator|+
name|inContextPath
return|;
block|}
specifier|public
name|String
name|getInContextPath
parameter_list|()
block|{
if|if
condition|(
name|inContextPath
operator|==
literal|null
condition|)
return|return
name|getRequestURI
argument_list|()
operator|.
name|substring
argument_list|(
name|getContextPath
argument_list|()
operator|.
name|length
argument_list|()
argument_list|)
return|;
return|return
name|inContextPath
return|;
block|}
specifier|public
name|void
name|setInContextPath
parameter_list|(
name|String
name|path
parameter_list|)
block|{
name|inContextPath
operator|=
name|path
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getMethod
parameter_list|()
block|{
if|if
condition|(
name|method
operator|==
literal|null
condition|)
return|return
name|super
operator|.
name|getMethod
argument_list|()
return|;
return|return
name|method
return|;
block|}
specifier|public
name|void
name|setMethod
parameter_list|(
name|String
name|method
parameter_list|)
block|{
name|this
operator|.
name|method
operator|=
name|method
expr_stmt|;
block|}
comment|/**          * Change the requestURI and the servletPath          *          * @param requestURI the URI of the request without the context path          * @param servletPath the servlet path          */
specifier|public
name|void
name|setPaths
parameter_list|(
name|String
name|requestURI
parameter_list|,
name|String
name|servletPath
parameter_list|)
block|{
name|this
operator|.
name|inContextPath
operator|=
name|requestURI
expr_stmt|;
if|if
condition|(
name|servletPath
operator|==
literal|null
condition|)
name|this
operator|.
name|servletPath
operator|=
name|requestURI
expr_stmt|;
else|else
name|this
operator|.
name|servletPath
operator|=
name|servletPath
expr_stmt|;
block|}
specifier|public
name|void
name|setBasePath
parameter_list|(
name|String
name|base
parameter_list|)
block|{
name|this
operator|.
name|basePath
operator|=
name|base
expr_stmt|;
block|}
specifier|public
name|String
name|getBasePath
parameter_list|()
block|{
return|return
name|basePath
return|;
block|}
comment|/**          * Change the base path of the request, e.g. if the original request pointed          * to /fs/foo/baz, but the request should be forwarded to /foo/baz.          *          * @param base the base path to remove          */
specifier|public
name|void
name|removePathPrefix
parameter_list|(
name|String
name|base
parameter_list|)
block|{
name|setPaths
argument_list|(
name|getInContextPath
argument_list|()
operator|.
name|substring
argument_list|(
name|base
operator|.
name|length
argument_list|()
argument_list|)
argument_list|,
name|servletPath
operator|!=
literal|null
condition|?
name|servletPath
operator|.
name|substring
argument_list|(
name|base
operator|.
name|length
argument_list|()
argument_list|)
else|:
literal|null
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getServletPath
parameter_list|()
block|{
return|return
name|servletPath
operator|==
literal|null
condition|?
name|super
operator|.
name|getServletPath
argument_list|()
else|:
name|servletPath
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getPathInfo
parameter_list|()
block|{
name|String
name|path
init|=
name|getInContextPath
argument_list|()
decl_stmt|;
name|String
name|sp
init|=
name|getServletPath
argument_list|()
decl_stmt|;
if|if
condition|(
name|sp
operator|==
literal|null
condition|)
return|return
literal|null
return|;
if|if
condition|(
name|path
operator|.
name|length
argument_list|()
operator|<
name|sp
operator|.
name|length
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Internal error: servletPath = "
operator|+
name|sp
operator|+
literal|" is longer than path = "
operator|+
name|path
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
return|return
name|path
operator|.
name|length
argument_list|()
operator|==
name|sp
operator|.
name|length
argument_list|()
condition|?
literal|null
else|:
name|path
operator|.
name|substring
argument_list|(
name|sp
operator|.
name|length
argument_list|()
argument_list|)
return|;
block|}
specifier|protected
name|void
name|setData
parameter_list|(
name|byte
index|[]
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
literal|null
condition|)
name|data
operator|=
operator|new
name|byte
index|[
literal|0
index|]
expr_stmt|;
name|contentLength
operator|=
name|data
operator|.
name|length
expr_stmt|;
name|sis
operator|=
operator|new
name|CachingServletInputStream
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|addParameter
parameter_list|(
name|String
name|name
parameter_list|,
name|String
name|value
parameter_list|)
block|{
name|addNameValue
argument_list|(
name|name
argument_list|,
name|value
argument_list|,
name|addedParams
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getParameter
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|paramValues
init|=
name|addedParams
operator|.
name|get
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|paramValues
operator|!=
literal|null
operator|&&
name|paramValues
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
return|return
name|paramValues
operator|.
name|get
argument_list|(
literal|0
argument_list|)
return|;
return|return
literal|null
return|;
block|}
annotation|@
name|Override
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|String
index|[]
argument_list|>
name|getParameterMap
parameter_list|()
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|String
index|[]
argument_list|>
name|parameterMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
index|[]
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Entry
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|param
range|:
name|addedParams
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|values
init|=
name|param
operator|.
name|getValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|values
operator|!=
literal|null
condition|)
block|{
name|parameterMap
operator|.
name|put
argument_list|(
name|param
operator|.
name|getKey
argument_list|()
argument_list|,
name|values
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|values
operator|.
name|size
argument_list|()
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|parameterMap
operator|.
name|put
argument_list|(
name|param
operator|.
name|getKey
argument_list|()
argument_list|,
operator|new
name|String
index|[]
block|{}
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|parameterMap
return|;
block|}
annotation|@
name|Override
specifier|public
name|Enumeration
argument_list|<
name|String
argument_list|>
name|getParameterNames
parameter_list|()
block|{
return|return
name|Collections
operator|.
name|enumeration
argument_list|(
name|addedParams
operator|.
name|keySet
argument_list|()
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
index|[]
name|getParameterValues
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|values
init|=
name|addedParams
operator|.
name|get
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|values
operator|!=
literal|null
condition|)
block|{
return|return
name|values
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|values
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
else|else
block|{
return|return
literal|null
return|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|ServletInputStream
name|getInputStream
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|sis
operator|==
literal|null
condition|)
return|return
name|super
operator|.
name|getInputStream
argument_list|()
return|;
return|return
name|sis
return|;
block|}
annotation|@
name|Override
specifier|public
name|BufferedReader
name|getReader
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|sis
operator|==
literal|null
condition|)
return|return
name|super
operator|.
name|getReader
argument_list|()
return|;
if|if
condition|(
name|reader
operator|==
literal|null
condition|)
name|reader
operator|=
operator|new
name|BufferedReader
argument_list|(
operator|new
name|InputStreamReader
argument_list|(
name|sis
argument_list|,
name|getCharacterEncoding
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|reader
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getContentType
parameter_list|()
block|{
if|if
condition|(
name|contentType
operator|==
literal|null
condition|)
return|return
name|super
operator|.
name|getContentType
argument_list|()
return|;
return|return
name|contentType
return|;
block|}
specifier|protected
name|void
name|setContentType
parameter_list|(
name|String
name|contentType
parameter_list|)
block|{
name|this
operator|.
name|contentType
operator|=
name|contentType
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|int
name|getContentLength
parameter_list|()
block|{
if|if
condition|(
name|sis
operator|==
literal|null
condition|)
return|return
name|super
operator|.
name|getContentLength
argument_list|()
return|;
return|return
name|contentLength
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|setCharacterEncoding
parameter_list|(
name|String
name|encoding
parameter_list|)
throws|throws
name|UnsupportedEncodingException
block|{
name|this
operator|.
name|characterEncoding
operator|=
name|encoding
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getCharacterEncoding
parameter_list|()
block|{
if|if
condition|(
name|characterEncoding
operator|==
literal|null
condition|)
return|return
name|super
operator|.
name|getCharacterEncoding
argument_list|()
return|;
return|return
name|characterEncoding
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getHeader
parameter_list|(
name|String
name|s
parameter_list|)
block|{
if|if
condition|(
name|s
operator|.
name|equals
argument_list|(
literal|"If-Modified-Since"
argument_list|)
condition|)
return|return
literal|null
return|;
return|return
name|super
operator|.
name|getHeader
argument_list|(
name|s
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getDateHeader
parameter_list|(
name|String
name|s
parameter_list|)
block|{
if|if
condition|(
name|s
operator|.
name|equals
argument_list|(
literal|"If-Modified-Since"
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|super
operator|.
name|getDateHeader
argument_list|(
name|s
argument_list|)
return|;
block|}
comment|//        public void setAttribute(String key, Object value) {
comment|//            attributes.put(key, value);
comment|//        }
comment|//
comment|//        public Object getAttribute(String key) {
comment|//            Object value = attributes.get(key);
comment|//            if (value == null)
comment|//                value = super.getAttribute(key);
comment|//            return value;
comment|//        }
comment|//
comment|//        public Enumeration getAttributeNames() {
comment|//            Vector v = new Vector();
comment|//            for (Enumeration e = super.getAttributeNames(); e.hasMoreElements();) {
comment|//                v.add(e.nextElement());
comment|//            }
comment|//            for (Iterator i = attributes.keySet().iterator(); i.hasNext();) {
comment|//                v.add(i.next());
comment|//            }
comment|//            return v.elements();
comment|//        }
block|}
specifier|private
class|class
name|CachingResponseWrapper
extends|extends
name|HttpServletResponseWrapper
block|{
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unused"
argument_list|)
specifier|protected
name|HttpServletResponse
name|origResponse
decl_stmt|;
specifier|protected
name|CachingServletOutputStream
name|sos
init|=
literal|null
decl_stmt|;
specifier|protected
name|PrintWriter
name|writer
init|=
literal|null
decl_stmt|;
specifier|protected
name|int
name|status
init|=
name|HttpServletResponse
operator|.
name|SC_OK
decl_stmt|;
specifier|protected
name|boolean
name|cache
decl_stmt|;
specifier|public
name|CachingResponseWrapper
parameter_list|(
name|HttpServletResponse
name|servletResponse
parameter_list|,
name|boolean
name|cache
parameter_list|)
block|{
name|super
argument_list|(
name|servletResponse
argument_list|)
expr_stmt|;
name|this
operator|.
name|cache
operator|=
name|cache
expr_stmt|;
name|this
operator|.
name|origResponse
operator|=
name|servletResponse
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|PrintWriter
name|getWriter
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|cache
condition|)
return|return
name|super
operator|.
name|getWriter
argument_list|()
return|;
if|if
condition|(
name|sos
operator|!=
literal|null
condition|)
throw|throw
operator|new
name|IOException
argument_list|(
literal|"getWriter cannnot be called after getOutputStream"
argument_list|)
throw|;
name|sos
operator|=
operator|new
name|CachingServletOutputStream
argument_list|()
expr_stmt|;
if|if
condition|(
name|writer
operator|==
literal|null
condition|)
name|writer
operator|=
operator|new
name|PrintWriter
argument_list|(
operator|new
name|OutputStreamWriter
argument_list|(
name|sos
argument_list|,
name|getCharacterEncoding
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|writer
return|;
block|}
annotation|@
name|Override
specifier|public
name|ServletOutputStream
name|getOutputStream
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|cache
condition|)
return|return
name|super
operator|.
name|getOutputStream
argument_list|()
return|;
if|if
condition|(
name|writer
operator|!=
literal|null
condition|)
throw|throw
operator|new
name|IOException
argument_list|(
literal|"getOutputStream cannnot be called after getWriter"
argument_list|)
throw|;
if|if
condition|(
name|sos
operator|==
literal|null
condition|)
name|sos
operator|=
operator|new
name|CachingServletOutputStream
argument_list|()
expr_stmt|;
return|return
name|sos
return|;
block|}
specifier|public
name|byte
index|[]
name|getData
parameter_list|()
block|{
return|return
name|sos
operator|!=
literal|null
condition|?
name|sos
operator|.
name|getData
argument_list|()
else|:
literal|null
return|;
block|}
specifier|public
name|int
name|getStatus
parameter_list|()
block|{
return|return
name|status
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|setStatus
parameter_list|(
name|int
name|i
parameter_list|)
block|{
name|this
operator|.
name|status
operator|=
name|i
expr_stmt|;
name|super
operator|.
name|setStatus
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|setStatus
parameter_list|(
name|int
name|i
parameter_list|,
name|String
name|msg
parameter_list|)
block|{
name|this
operator|.
name|status
operator|=
name|i
expr_stmt|;
name|super
operator|.
name|setStatus
argument_list|(
name|i
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|sendError
parameter_list|(
name|int
name|i
parameter_list|,
name|String
name|msg
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|status
operator|=
name|i
expr_stmt|;
name|super
operator|.
name|sendError
argument_list|(
name|i
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|sendError
parameter_list|(
name|int
name|i
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|status
operator|=
name|i
expr_stmt|;
name|super
operator|.
name|sendError
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|setContentLength
parameter_list|(
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
operator|!
name|cache
condition|)
name|super
operator|.
name|setContentLength
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|flushBuffer
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|cache
condition|)
name|super
operator|.
name|flushBuffer
argument_list|()
expr_stmt|;
block|}
specifier|public
name|void
name|flush
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|sos
operator|!=
literal|null
condition|)
block|{
name|ServletOutputStream
name|out
init|=
name|super
operator|.
name|getOutputStream
argument_list|()
decl_stmt|;
name|out
operator|.
name|write
argument_list|(
name|sos
operator|.
name|getData
argument_list|()
argument_list|)
expr_stmt|;
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
block|}
block|}
specifier|private
class|class
name|CachingServletOutputStream
extends|extends
name|ServletOutputStream
block|{
specifier|protected
name|ByteArrayOutputStream
name|ostream
init|=
operator|new
name|ByteArrayOutputStream
argument_list|(
literal|512
argument_list|)
decl_stmt|;
specifier|protected
name|byte
index|[]
name|getData
parameter_list|()
block|{
return|return
name|ostream
operator|.
name|toByteArray
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|write
parameter_list|(
name|int
name|b
parameter_list|)
throws|throws
name|IOException
block|{
name|ostream
operator|.
name|write
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|write
parameter_list|(
name|byte
name|b
index|[]
parameter_list|)
throws|throws
name|IOException
block|{
name|ostream
operator|.
name|write
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|write
parameter_list|(
name|byte
name|b
index|[]
parameter_list|,
name|int
name|off
parameter_list|,
name|int
name|len
parameter_list|)
throws|throws
name|IOException
block|{
name|ostream
operator|.
name|write
argument_list|(
name|b
argument_list|,
name|off
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
specifier|static
class|class
name|CachingServletInputStream
extends|extends
name|ServletInputStream
block|{
specifier|protected
name|ByteArrayInputStream
name|istream
decl_stmt|;
specifier|public
name|CachingServletInputStream
parameter_list|(
name|byte
index|[]
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
literal|null
condition|)
name|istream
operator|=
operator|new
name|ByteArrayInputStream
argument_list|(
operator|new
name|byte
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
else|else
name|istream
operator|=
operator|new
name|ByteArrayInputStream
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|int
name|read
parameter_list|()
throws|throws
name|IOException
block|{
return|return
name|istream
operator|.
name|read
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|int
name|read
parameter_list|(
name|byte
name|b
index|[]
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|istream
operator|.
name|read
argument_list|(
name|b
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|int
name|read
parameter_list|(
name|byte
name|b
index|[]
parameter_list|,
name|int
name|off
parameter_list|,
name|int
name|len
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|istream
operator|.
name|read
argument_list|(
name|b
argument_list|,
name|off
argument_list|,
name|len
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|int
name|available
parameter_list|()
throws|throws
name|IOException
block|{
return|return
name|istream
operator|.
name|available
argument_list|()
return|;
block|}
block|}
block|}
end_class

end_unit

