begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_package
package|package
name|org
operator|.
name|exist
operator|.
name|repo
package|;
end_package

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|EXistException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|collections
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|collections
operator|.
name|IndexInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|config
operator|.
name|ConfigurationException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|BinaryDocument
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|QName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|memtree
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|Permission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|PermissionDeniedException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|internal
operator|.
name|aider
operator|.
name|GroupAider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|internal
operator|.
name|aider
operator|.
name|UserAider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|xacml
operator|.
name|AccessContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|source
operator|.
name|FileSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|DBBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|lock
operator|.
name|Lock
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|txn
operator|.
name|TransactionManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|txn
operator|.
name|Txn
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|LockException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|MimeTable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|MimeType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|SyntaxException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|serializer
operator|.
name|AttrList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|XmldbURI
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|modules
operator|.
name|expathrepo
operator|.
name|ExpathPackageModule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|util
operator|.
name|DocUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|DateTimeValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Sequence
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Type
import|;
end_import

begin_import
import|import
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|FileSystemStorage
import|;
end_import

begin_import
import|import
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|PackageException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|Packages
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Element
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|Attributes
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|InputSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|SAXException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|*
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Stack
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|jar
operator|.
name|JarEntry
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|jar
operator|.
name|JarFile
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|jar
operator|.
name|JarInputStream
import|;
end_import

begin_comment
comment|/**  * Deploy a .xar package into the database using the information provided  * in expath-pkg.xml and repo.xml.  */
end_comment

begin_class
specifier|public
class|class
name|Deployment
block|{
specifier|private
specifier|final
specifier|static
name|Logger
name|LOG
init|=
name|Logger
operator|.
name|getLogger
argument_list|(
name|Deployment
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|REPO_NAMESPACE
init|=
literal|"http://exist-db.org/xquery/repo"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|QName
name|SETUP_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"setup"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|PRE_SETUP_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"prepare"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|POST_SETUP_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"finish"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|TARGET_COLL_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"target"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|PERMISSIONS_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"permissions"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|CLEANUP_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"cleanup"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|DEPLOYED_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"deployed"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
name|DBBroker
name|broker
decl_stmt|;
specifier|private
name|String
name|user
init|=
literal|null
decl_stmt|;
specifier|private
name|String
name|password
init|=
literal|null
decl_stmt|;
specifier|private
name|String
name|group
init|=
literal|null
decl_stmt|;
specifier|private
name|int
name|perms
init|=
operator|-
literal|1
decl_stmt|;
specifier|private
name|String
name|permsStr
init|=
literal|null
decl_stmt|;
specifier|public
name|Deployment
parameter_list|(
name|DBBroker
name|broker
parameter_list|)
block|{
name|this
operator|.
name|broker
operator|=
name|broker
expr_stmt|;
block|}
specifier|protected
name|File
name|getPackageDir
parameter_list|(
name|String
name|pkgName
parameter_list|,
name|ExistRepository
name|repo
parameter_list|)
throws|throws
name|PackageException
block|{
name|File
name|packageDir
init|=
literal|null
decl_stmt|;
for|for
control|(
name|Packages
name|pp
range|:
name|repo
operator|.
name|getParentRepo
argument_list|()
operator|.
name|listPackages
argument_list|()
control|)
block|{
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|Package
name|pkg
init|=
name|pp
operator|.
name|latest
argument_list|()
decl_stmt|;
if|if
condition|(
name|pkg
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|pkgName
argument_list|)
condition|)
block|{
name|FileSystemStorage
operator|.
name|FileSystemResolver
name|resolver
init|=
operator|(
name|FileSystemStorage
operator|.
name|FileSystemResolver
operator|)
name|pkg
operator|.
name|getResolver
argument_list|()
decl_stmt|;
name|packageDir
operator|=
name|resolver
operator|.
name|resolveResourceAsFile
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|packageDir
return|;
block|}
specifier|protected
name|DocumentImpl
name|getRepoXML
parameter_list|(
name|File
name|packageDir
parameter_list|)
throws|throws
name|PackageException
block|{
comment|// find and parse the repo.xml descriptor
name|File
name|repoFile
init|=
operator|new
name|File
argument_list|(
name|packageDir
argument_list|,
literal|"repo.xml"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|repoFile
operator|.
name|canRead
argument_list|()
condition|)
return|return
literal|null
return|;
try|try
block|{
return|return
name|DocUtils
operator|.
name|parse
argument_list|(
name|broker
operator|.
name|getBrokerPool
argument_list|()
argument_list|,
literal|null
argument_list|,
operator|new
name|FileInputStream
argument_list|(
name|repoFile
argument_list|)
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|XPathException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to parse repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to read repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
specifier|public
name|String
name|undeploy
parameter_list|(
name|String
name|pkgName
parameter_list|,
name|ExistRepository
name|repo
parameter_list|)
throws|throws
name|PackageException
block|{
name|File
name|packageDir
init|=
name|getPackageDir
argument_list|(
name|pkgName
argument_list|,
name|repo
argument_list|)
decl_stmt|;
if|if
condition|(
name|packageDir
operator|==
literal|null
condition|)
comment|// fails silently if package dir is not found?
return|return
literal|null
return|;
name|DocumentImpl
name|repoXML
init|=
name|getRepoXML
argument_list|(
name|packageDir
argument_list|)
decl_stmt|;
name|ElementImpl
name|target
init|=
literal|null
decl_stmt|;
try|try
block|{
name|target
operator|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|TARGET_COLL_ELEMENT
argument_list|)
expr_stmt|;
name|ElementImpl
name|cleanup
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|CLEANUP_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|cleanup
operator|!=
literal|null
condition|)
block|{
name|runQuery
argument_list|(
literal|null
argument_list|,
name|packageDir
argument_list|,
name|cleanup
operator|.
name|getStringValue
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|target
operator|!=
literal|null
condition|)
block|{
name|uninstall
argument_list|(
name|target
argument_list|)
expr_stmt|;
block|}
return|return
name|target
operator|.
name|getStringValue
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|XPathException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error found while processing repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error found while processing repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
specifier|public
name|String
name|deploy
parameter_list|(
name|String
name|pkgName
parameter_list|,
name|ExistRepository
name|repo
parameter_list|,
name|String
name|userTarget
parameter_list|)
throws|throws
name|PackageException
throws|,
name|IOException
block|{
name|File
name|packageDir
init|=
name|getPackageDir
argument_list|(
name|pkgName
argument_list|,
name|repo
argument_list|)
decl_stmt|;
if|if
condition|(
name|packageDir
operator|==
literal|null
condition|)
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Package not found: "
operator|+
name|pkgName
argument_list|)
throw|;
name|DocumentImpl
name|repoXML
init|=
name|getRepoXML
argument_list|(
name|packageDir
argument_list|)
decl_stmt|;
try|try
block|{
comment|// if there's a<setup> element, run the query it points to
name|ElementImpl
name|setup
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|SETUP_ELEMENT
argument_list|)
decl_stmt|;
name|String
name|path
init|=
name|setup
operator|==
literal|null
condition|?
literal|null
else|:
name|setup
operator|.
name|getStringValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|path
operator|!=
literal|null
operator|&&
name|path
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|runQuery
argument_list|(
literal|null
argument_list|,
name|packageDir
argument_list|,
name|path
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
else|else
block|{
comment|// otherwise copy all child directories to the target collection
name|XmldbURI
name|targetCollection
init|=
name|XmldbURI
operator|.
name|ROOT_COLLECTION_URI
decl_stmt|;
if|if
condition|(
name|userTarget
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|targetCollection
operator|=
name|XmldbURI
operator|.
name|create
argument_list|(
name|userTarget
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Bad collection URI: "
operator|+
name|userTarget
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
else|else
block|{
name|ElementImpl
name|target
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|TARGET_COLL_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|target
operator|!=
literal|null
condition|)
block|{
comment|// determine target collection
try|try
block|{
name|targetCollection
operator|=
name|XmldbURI
operator|.
name|create
argument_list|(
name|target
operator|.
name|getStringValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Bad collection URI for<target> element: "
operator|+
name|target
operator|.
name|getStringValue
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
name|ElementImpl
name|permissions
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|PERMISSIONS_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|permissions
operator|!=
literal|null
condition|)
block|{
comment|// get user, group and default permissions
name|user
operator|=
name|permissions
operator|.
name|getAttribute
argument_list|(
literal|"user"
argument_list|)
expr_stmt|;
name|group
operator|=
name|permissions
operator|.
name|getAttribute
argument_list|(
literal|"group"
argument_list|)
expr_stmt|;
name|password
operator|=
name|permissions
operator|.
name|getAttribute
argument_list|(
literal|"password"
argument_list|)
expr_stmt|;
name|String
name|mode
init|=
name|permissions
operator|.
name|getAttribute
argument_list|(
literal|"mode"
argument_list|)
decl_stmt|;
try|try
block|{
name|perms
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|mode
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
name|permsStr
operator|=
name|mode
expr_stmt|;
if|if
condition|(
operator|!
name|permsStr
operator|.
name|matches
argument_list|(
literal|"^[rwx-]{9}"
argument_list|)
condition|)
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Bad format for mode attribute in<permissions>: "
operator|+
name|mode
argument_list|)
throw|;
block|}
block|}
comment|// run the pre-setup query if present
name|ElementImpl
name|preSetup
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|PRE_SETUP_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|preSetup
operator|!=
literal|null
condition|)
block|{
name|path
operator|=
name|preSetup
operator|.
name|getStringValue
argument_list|()
expr_stmt|;
if|if
condition|(
name|path
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
name|runQuery
argument_list|(
name|targetCollection
argument_list|,
name|packageDir
argument_list|,
name|path
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
comment|// any required users and group should have been created by the pre-setup query.
comment|// check for invalid users now.
name|checkUserSettings
argument_list|()
expr_stmt|;
comment|// install
name|scanDirectory
argument_list|(
name|packageDir
argument_list|,
name|targetCollection
argument_list|)
expr_stmt|;
comment|// run the post-setup query if present
name|ElementImpl
name|postSetup
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|POST_SETUP_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|postSetup
operator|!=
literal|null
condition|)
block|{
name|path
operator|=
name|postSetup
operator|.
name|getStringValue
argument_list|()
expr_stmt|;
if|if
condition|(
name|path
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
name|runQuery
argument_list|(
name|targetCollection
argument_list|,
name|packageDir
argument_list|,
name|path
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
name|storeRepoXML
argument_list|(
name|repoXML
argument_list|,
name|targetCollection
argument_list|)
expr_stmt|;
return|return
name|targetCollection
operator|.
name|getCollectionPath
argument_list|()
return|;
block|}
block|}
catch|catch
parameter_list|(
name|XPathException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error found while processing repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
specifier|private
name|void
name|uninstall
parameter_list|(
name|ElementImpl
name|target
parameter_list|)
throws|throws
name|PackageException
block|{
comment|// determine target collection
name|XmldbURI
name|targetCollection
decl_stmt|;
try|try
block|{
name|targetCollection
operator|=
name|XmldbURI
operator|.
name|create
argument_list|(
name|target
operator|.
name|getStringValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Bad collection URI for<target> element: "
operator|+
name|target
operator|.
name|getStringValue
argument_list|()
argument_list|)
throw|;
block|}
name|TransactionManager
name|mgr
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getTransactionManager
argument_list|()
decl_stmt|;
name|Txn
name|txn
init|=
name|mgr
operator|.
name|beginTransaction
argument_list|()
decl_stmt|;
try|try
block|{
name|Collection
name|collection
init|=
name|broker
operator|.
name|getOrCreateCollection
argument_list|(
name|txn
argument_list|,
name|targetCollection
argument_list|)
decl_stmt|;
if|if
condition|(
name|collection
operator|!=
literal|null
condition|)
name|broker
operator|.
name|removeCollection
argument_list|(
name|txn
argument_list|,
name|collection
argument_list|)
expr_stmt|;
name|XmldbURI
name|configCollection
init|=
name|XmldbURI
operator|.
name|CONFIG_COLLECTION_URI
operator|.
name|append
argument_list|(
name|targetCollection
argument_list|)
decl_stmt|;
name|collection
operator|=
name|broker
operator|.
name|getOrCreateCollection
argument_list|(
name|txn
argument_list|,
name|configCollection
argument_list|)
expr_stmt|;
if|if
condition|(
name|collection
operator|!=
literal|null
condition|)
name|broker
operator|.
name|removeCollection
argument_list|(
name|txn
argument_list|,
name|collection
argument_list|)
expr_stmt|;
name|mgr
operator|.
name|commit
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|mgr
operator|.
name|abort
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**      * Store repo.xml into the db. Adds the time of deployment to the descriptor.      *      * @param repoXML      * @param targetCollection      * @throws XPathException      */
specifier|private
name|void
name|storeRepoXML
parameter_list|(
name|DocumentImpl
name|repoXML
parameter_list|,
name|XmldbURI
name|targetCollection
parameter_list|)
throws|throws
name|PackageException
throws|,
name|XPathException
block|{
comment|// Store repo.xml
name|DateTimeValue
name|time
init|=
operator|new
name|DateTimeValue
argument_list|(
operator|new
name|Date
argument_list|()
argument_list|)
decl_stmt|;
name|MemTreeBuilder
name|builder
init|=
operator|new
name|MemTreeBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|startDocument
argument_list|()
expr_stmt|;
name|UpdatingDocumentReceiver
name|receiver
init|=
operator|new
name|UpdatingDocumentReceiver
argument_list|(
name|builder
argument_list|,
name|time
operator|.
name|getStringValue
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|repoXML
operator|.
name|copyTo
argument_list|(
name|broker
argument_list|,
name|receiver
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SAXException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error while updating repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
throw|;
block|}
name|builder
operator|.
name|endDocument
argument_list|()
expr_stmt|;
name|DocumentImpl
name|updatedXML
init|=
name|builder
operator|.
name|getDocument
argument_list|()
decl_stmt|;
name|TransactionManager
name|mgr
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getTransactionManager
argument_list|()
decl_stmt|;
name|Txn
name|txn
init|=
name|mgr
operator|.
name|beginTransaction
argument_list|()
decl_stmt|;
try|try
block|{
name|Collection
name|collection
init|=
name|broker
operator|.
name|getOrCreateCollection
argument_list|(
name|txn
argument_list|,
name|targetCollection
argument_list|)
decl_stmt|;
name|XmldbURI
name|name
init|=
name|XmldbURI
operator|.
name|createInternal
argument_list|(
literal|"repo.xml"
argument_list|)
decl_stmt|;
name|IndexInfo
name|info
init|=
name|collection
operator|.
name|validateXMLResource
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|name
argument_list|,
name|updatedXML
argument_list|)
decl_stmt|;
name|Permission
name|permission
init|=
name|info
operator|.
name|getDocument
argument_list|()
operator|.
name|getPermissions
argument_list|()
decl_stmt|;
name|setPermissions
argument_list|(
literal|false
argument_list|,
name|MimeType
operator|.
name|XML_TYPE
argument_list|,
name|permission
argument_list|)
expr_stmt|;
name|collection
operator|.
name|store
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|info
argument_list|,
name|updatedXML
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|mgr
operator|.
name|commit
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|mgr
operator|.
name|abort
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|checkUserSettings
parameter_list|()
throws|throws
name|PackageException
block|{
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|SecurityManager
name|secman
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getSecurityManager
argument_list|()
decl_stmt|;
try|try
block|{
if|if
condition|(
name|group
operator|!=
literal|null
operator|&&
operator|!
name|secman
operator|.
name|hasGroup
argument_list|(
name|group
argument_list|)
condition|)
block|{
name|GroupAider
name|aider
init|=
operator|new
name|GroupAider
argument_list|(
name|group
argument_list|)
decl_stmt|;
name|secman
operator|.
name|addGroup
argument_list|(
name|aider
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|user
operator|!=
literal|null
operator|&&
operator|!
name|secman
operator|.
name|hasAccount
argument_list|(
name|user
argument_list|)
condition|)
block|{
name|UserAider
name|aider
init|=
operator|new
name|UserAider
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|aider
operator|.
name|setPassword
argument_list|(
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|!=
literal|null
condition|)
name|aider
operator|.
name|addGroup
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|secman
operator|.
name|addAccount
argument_list|(
name|aider
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|ConfigurationException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to create user: "
operator|+
name|user
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|PermissionDeniedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to create user: "
operator|+
name|user
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|EXistException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to create user: "
operator|+
name|user
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
specifier|private
name|Sequence
name|runQuery
parameter_list|(
name|XmldbURI
name|targetCollection
parameter_list|,
name|File
name|tempDir
parameter_list|,
name|String
name|fileName
parameter_list|,
name|boolean
name|preInstall
parameter_list|)
throws|throws
name|PackageException
throws|,
name|IOException
throws|,
name|XPathException
block|{
name|File
name|xquery
init|=
operator|new
name|File
argument_list|(
name|tempDir
argument_list|,
name|fileName
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|xquery
operator|.
name|canRead
argument_list|()
condition|)
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"The XQuery resource specified in the<setup> element was not found"
argument_list|)
throw|;
name|XQuery
name|xqs
init|=
name|broker
operator|.
name|getXQueryService
argument_list|()
decl_stmt|;
name|XQueryContext
name|ctx
init|=
name|xqs
operator|.
name|newContext
argument_list|(
name|AccessContext
operator|.
name|REST
argument_list|)
decl_stmt|;
name|ctx
operator|.
name|declareVariable
argument_list|(
literal|"dir"
argument_list|,
name|tempDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|File
name|home
init|=
name|broker
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getExistHome
argument_list|()
decl_stmt|;
name|ctx
operator|.
name|declareVariable
argument_list|(
literal|"home"
argument_list|,
name|home
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|targetCollection
operator|!=
literal|null
condition|)
block|{
name|ctx
operator|.
name|declareVariable
argument_list|(
literal|"target"
argument_list|,
name|targetCollection
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|ctx
operator|.
name|setModuleLoadPath
argument_list|(
name|XmldbURI
operator|.
name|EMBEDDED_SERVER_URI
operator|+
name|targetCollection
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
name|ctx
operator|.
name|declareVariable
argument_list|(
literal|"target"
argument_list|,
name|Sequence
operator|.
name|EMPTY_SEQUENCE
argument_list|)
expr_stmt|;
if|if
condition|(
name|preInstall
condition|)
comment|// when running pre-setup scripts, base path should point to directory
comment|// because the target collection does not yet exist
name|ctx
operator|.
name|setModuleLoadPath
argument_list|(
name|tempDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|CompiledXQuery
name|compiled
decl_stmt|;
try|try
block|{
name|compiled
operator|=
name|xqs
operator|.
name|compile
argument_list|(
name|ctx
argument_list|,
operator|new
name|FileSource
argument_list|(
name|xquery
argument_list|,
literal|"UTF-8"
argument_list|,
literal|false
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|xqs
operator|.
name|execute
argument_list|(
name|compiled
argument_list|,
literal|null
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|PermissionDeniedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * Scan a directory and import all files and sub directories into the target      * collection.      *      * @param directory      * @param target      */
specifier|private
name|void
name|scanDirectory
parameter_list|(
name|File
name|directory
parameter_list|,
name|XmldbURI
name|target
parameter_list|)
block|{
name|TransactionManager
name|mgr
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getTransactionManager
argument_list|()
decl_stmt|;
name|Txn
name|txn
init|=
name|mgr
operator|.
name|beginTransaction
argument_list|()
decl_stmt|;
name|Collection
name|collection
init|=
literal|null
decl_stmt|;
try|try
block|{
name|collection
operator|=
name|broker
operator|.
name|getOrCreateCollection
argument_list|(
name|txn
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|setPermissions
argument_list|(
literal|true
argument_list|,
literal|null
argument_list|,
name|collection
operator|.
name|getPermissions
argument_list|()
argument_list|)
expr_stmt|;
name|broker
operator|.
name|saveCollection
argument_list|(
name|txn
argument_list|,
name|collection
argument_list|)
expr_stmt|;
name|mgr
operator|.
name|commit
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|mgr
operator|.
name|abort
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
try|try
block|{
comment|// lock the collection while we store the files
comment|// TODO: could be released after each operation
name|collection
operator|.
name|getLock
argument_list|()
operator|.
name|acquire
argument_list|(
name|Lock
operator|.
name|WRITE_LOCK
argument_list|)
expr_stmt|;
name|storeFiles
argument_list|(
name|directory
argument_list|,
name|collection
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|LockException
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|collection
operator|.
name|getLock
argument_list|()
operator|.
name|release
argument_list|(
name|Lock
operator|.
name|WRITE_LOCK
argument_list|)
expr_stmt|;
block|}
comment|// scan sub directories
name|File
index|[]
name|files
init|=
name|directory
operator|.
name|listFiles
argument_list|()
decl_stmt|;
for|for
control|(
name|File
name|file
range|:
name|files
control|)
block|{
if|if
condition|(
name|file
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
name|scanDirectory
argument_list|(
name|file
argument_list|,
name|target
operator|.
name|append
argument_list|(
name|file
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**      * Import all files in the given directory into the target collection      *      * @param directory      * @param targetCollection      */
specifier|private
name|void
name|storeFiles
parameter_list|(
name|File
name|directory
parameter_list|,
name|Collection
name|targetCollection
parameter_list|)
block|{
name|File
index|[]
name|files
init|=
name|directory
operator|.
name|listFiles
argument_list|()
decl_stmt|;
name|MimeTable
name|mimeTab
init|=
name|MimeTable
operator|.
name|getInstance
argument_list|()
decl_stmt|;
name|TransactionManager
name|mgr
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getTransactionManager
argument_list|()
decl_stmt|;
for|for
control|(
name|File
name|file
range|:
name|files
control|)
block|{
if|if
condition|(
operator|!
name|file
operator|.
name|isDirectory
argument_list|()
operator|&&
operator|!
name|file
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"repo.xml"
argument_list|)
condition|)
block|{
name|MimeType
name|mime
init|=
name|mimeTab
operator|.
name|getContentTypeFor
argument_list|(
name|file
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|mime
operator|==
literal|null
condition|)
name|mime
operator|=
name|MimeType
operator|.
name|BINARY_TYPE
expr_stmt|;
name|XmldbURI
name|name
init|=
name|XmldbURI
operator|.
name|create
argument_list|(
name|file
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|Txn
name|txn
init|=
name|mgr
operator|.
name|beginTransaction
argument_list|()
decl_stmt|;
try|try
block|{
if|if
condition|(
name|mime
operator|.
name|isXMLType
argument_list|()
condition|)
block|{
name|InputSource
name|is
init|=
operator|new
name|InputSource
argument_list|(
name|file
operator|.
name|toURI
argument_list|()
operator|.
name|toASCIIString
argument_list|()
argument_list|)
decl_stmt|;
name|IndexInfo
name|info
init|=
name|targetCollection
operator|.
name|validateXMLResource
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|name
argument_list|,
name|is
argument_list|)
decl_stmt|;
name|info
operator|.
name|getDocument
argument_list|()
operator|.
name|getMetadata
argument_list|()
operator|.
name|setMimeType
argument_list|(
name|mime
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|Permission
name|permission
init|=
name|info
operator|.
name|getDocument
argument_list|()
operator|.
name|getPermissions
argument_list|()
decl_stmt|;
name|setPermissions
argument_list|(
literal|false
argument_list|,
name|mime
argument_list|,
name|permission
argument_list|)
expr_stmt|;
name|targetCollection
operator|.
name|store
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|info
argument_list|,
name|is
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|long
name|size
init|=
name|file
operator|.
name|length
argument_list|()
decl_stmt|;
name|FileInputStream
name|is
init|=
operator|new
name|FileInputStream
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|BinaryDocument
name|doc
init|=
name|targetCollection
operator|.
name|addBinaryResource
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|name
argument_list|,
name|is
argument_list|,
name|mime
operator|.
name|getName
argument_list|()
argument_list|,
name|size
argument_list|)
decl_stmt|;
name|is
operator|.
name|close
argument_list|()
expr_stmt|;
name|Permission
name|permission
init|=
name|doc
operator|.
name|getPermissions
argument_list|()
decl_stmt|;
name|setPermissions
argument_list|(
literal|false
argument_list|,
name|mime
argument_list|,
name|permission
argument_list|)
expr_stmt|;
name|doc
operator|.
name|getMetadata
argument_list|()
operator|.
name|setMimeType
argument_list|(
name|mime
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|broker
operator|.
name|storeXMLResource
argument_list|(
name|txn
argument_list|,
name|doc
argument_list|)
expr_stmt|;
block|}
name|mgr
operator|.
name|commit
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|mgr
operator|.
name|abort
argument_list|(
name|txn
argument_list|)
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/**      * Set owner, group and permissions. For XQuery resources, always set the executable flag.      * @param mime      * @param permission      */
specifier|private
name|void
name|setPermissions
parameter_list|(
name|boolean
name|isCollection
parameter_list|,
name|MimeType
name|mime
parameter_list|,
name|Permission
name|permission
parameter_list|)
throws|throws
name|PermissionDeniedException
block|{
if|if
condition|(
name|user
operator|!=
literal|null
condition|)
block|{
name|permission
operator|.
name|setOwner
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|group
operator|!=
literal|null
condition|)
block|{
name|permission
operator|.
name|setGroup
argument_list|(
name|group
argument_list|)
expr_stmt|;
block|}
name|int
name|mode
decl_stmt|;
if|if
condition|(
name|permsStr
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|permission
operator|.
name|setMode
argument_list|(
name|permsStr
argument_list|)
expr_stmt|;
name|mode
operator|=
name|permission
operator|.
name|getMode
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Incorrect permissions string: "
operator|+
name|permsStr
operator|+
literal|". Falling back to default."
argument_list|)
expr_stmt|;
name|mode
operator|=
name|permission
operator|.
name|getMode
argument_list|()
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|perms
operator|>
operator|-
literal|1
condition|)
block|{
name|mode
operator|=
name|perms
expr_stmt|;
block|}
else|else
block|{
name|mode
operator|=
name|permission
operator|.
name|getMode
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|isCollection
operator|||
operator|(
name|mime
operator|!=
literal|null
operator|&&
name|mime
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|MimeType
operator|.
name|XQUERY_TYPE
operator|.
name|getName
argument_list|()
argument_list|)
operator|)
condition|)
block|{
name|mode
operator|=
name|mode
operator||
literal|0111
expr_stmt|;
block|}
name|permission
operator|.
name|setMode
argument_list|(
name|mode
argument_list|)
expr_stmt|;
block|}
specifier|private
name|ElementImpl
name|findElement
parameter_list|(
name|NodeImpl
name|root
parameter_list|,
name|QName
name|qname
parameter_list|)
throws|throws
name|XPathException
block|{
name|InMemoryNodeSet
name|setupNodes
init|=
operator|new
name|InMemoryNodeSet
argument_list|()
decl_stmt|;
name|root
operator|.
name|selectDescendants
argument_list|(
literal|false
argument_list|,
operator|new
name|NameTest
argument_list|(
name|Type
operator|.
name|ELEMENT
argument_list|,
name|qname
argument_list|)
argument_list|,
name|setupNodes
argument_list|)
expr_stmt|;
if|if
condition|(
name|setupNodes
operator|.
name|getItemCount
argument_list|()
operator|==
literal|0
condition|)
return|return
literal|null
return|;
return|return
operator|(
name|ElementImpl
operator|)
name|setupNodes
operator|.
name|itemAt
argument_list|(
literal|0
argument_list|)
return|;
block|}
specifier|public
name|String
name|getNameFromDescriptor
parameter_list|(
name|File
name|xar
parameter_list|)
throws|throws
name|IOException
throws|,
name|PackageException
block|{
name|DocumentImpl
name|doc
init|=
name|getDescriptor
argument_list|(
name|xar
argument_list|)
decl_stmt|;
name|Element
name|root
init|=
name|doc
operator|.
name|getDocumentElement
argument_list|()
decl_stmt|;
return|return
name|root
operator|.
name|getAttribute
argument_list|(
literal|"name"
argument_list|)
return|;
block|}
specifier|public
name|DocumentImpl
name|getDescriptor
parameter_list|(
name|File
name|jar
parameter_list|)
throws|throws
name|IOException
throws|,
name|PackageException
block|{
name|InputStream
name|istream
init|=
operator|new
name|BufferedInputStream
argument_list|(
operator|new
name|FileInputStream
argument_list|(
name|jar
argument_list|)
argument_list|)
decl_stmt|;
name|JarInputStream
name|jis
init|=
operator|new
name|JarInputStream
argument_list|(
name|istream
argument_list|)
decl_stmt|;
name|JarEntry
name|entry
decl_stmt|;
name|DocumentImpl
name|doc
init|=
literal|null
decl_stmt|;
while|while
condition|(
operator|(
name|entry
operator|=
name|jis
operator|.
name|getNextJarEntry
argument_list|()
operator|)
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
operator|!
name|entry
operator|.
name|isDirectory
argument_list|()
operator|&&
name|entry
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"expath-pkg.xml"
argument_list|)
condition|)
block|{
name|ByteArrayOutputStream
name|bos
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|int
name|c
decl_stmt|;
name|byte
index|[]
name|b
init|=
operator|new
name|byte
index|[
literal|4096
index|]
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|jis
operator|.
name|read
argument_list|(
name|b
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|bos
operator|.
name|write
argument_list|(
name|b
argument_list|,
literal|0
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
name|bos
operator|.
name|close
argument_list|()
expr_stmt|;
name|byte
index|[]
name|data
init|=
name|bos
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|ByteArrayInputStream
name|bis
init|=
operator|new
name|ByteArrayInputStream
argument_list|(
name|data
argument_list|)
decl_stmt|;
try|try
block|{
name|doc
operator|=
name|DocUtils
operator|.
name|parse
argument_list|(
name|broker
operator|.
name|getBrokerPool
argument_list|()
argument_list|,
literal|null
argument_list|,
name|bis
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XPathException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error while parsing expath-pkg.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
break|break;
block|}
block|}
name|jis
operator|.
name|close
argument_list|()
expr_stmt|;
return|return
name|doc
return|;
block|}
comment|/**      * Update repo.xml while copying it.      */
specifier|private
class|class
name|UpdatingDocumentReceiver
extends|extends
name|DocumentBuilderReceiver
block|{
specifier|private
name|String
name|time
decl_stmt|;
specifier|private
name|Stack
argument_list|<
name|String
argument_list|>
name|stack
init|=
operator|new
name|Stack
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
specifier|public
name|UpdatingDocumentReceiver
parameter_list|(
name|MemTreeBuilder
name|builder
parameter_list|,
name|String
name|time
parameter_list|)
block|{
name|super
argument_list|(
name|builder
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|this
operator|.
name|time
operator|=
name|time
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|startElement
parameter_list|(
name|QName
name|qname
parameter_list|,
name|AttrList
name|attribs
parameter_list|)
block|{
name|stack
operator|.
name|push
argument_list|(
name|qname
operator|.
name|getLocalName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|qname
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
name|super
operator|.
name|startElement
argument_list|(
name|qname
argument_list|,
name|attribs
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|startElement
parameter_list|(
name|String
name|namespaceURI
parameter_list|,
name|String
name|localName
parameter_list|,
name|String
name|qName
parameter_list|,
name|Attributes
name|attrs
parameter_list|)
throws|throws
name|SAXException
block|{
name|stack
operator|.
name|push
argument_list|(
name|localName
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|localName
argument_list|)
condition|)
name|super
operator|.
name|startElement
argument_list|(
name|namespaceURI
argument_list|,
name|localName
argument_list|,
name|qName
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|endElement
parameter_list|(
name|QName
name|qname
parameter_list|)
throws|throws
name|SAXException
block|{
name|stack
operator|.
name|pop
argument_list|()
expr_stmt|;
if|if
condition|(
literal|"meta"
operator|.
name|equals
argument_list|(
name|qname
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|addDeployTime
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|qname
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
name|super
operator|.
name|endElement
argument_list|(
name|qname
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|endElement
parameter_list|(
name|String
name|uri
parameter_list|,
name|String
name|localName
parameter_list|,
name|String
name|qName
parameter_list|)
throws|throws
name|SAXException
block|{
name|stack
operator|.
name|pop
argument_list|()
expr_stmt|;
if|if
condition|(
literal|"meta"
operator|.
name|equals
argument_list|(
name|localName
argument_list|)
condition|)
block|{
name|addDeployTime
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|localName
argument_list|)
condition|)
name|super
operator|.
name|endElement
argument_list|(
name|uri
argument_list|,
name|localName
argument_list|,
name|qName
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|characters
parameter_list|(
name|char
index|[]
name|ch
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|len
parameter_list|)
throws|throws
name|SAXException
block|{
name|String
name|current
init|=
name|stack
operator|.
name|peek
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|current
operator|.
name|equals
argument_list|(
literal|"deployed"
argument_list|)
condition|)
name|super
operator|.
name|characters
argument_list|(
name|ch
argument_list|,
name|start
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|characters
parameter_list|(
name|CharSequence
name|seq
parameter_list|)
throws|throws
name|SAXException
block|{
name|String
name|current
init|=
name|stack
operator|.
name|peek
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|current
operator|.
name|equals
argument_list|(
literal|"deployed"
argument_list|)
condition|)
name|super
operator|.
name|characters
argument_list|(
name|seq
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|addDeployTime
parameter_list|()
throws|throws
name|SAXException
block|{
name|super
operator|.
name|startElement
argument_list|(
name|DEPLOYED_ELEMENT
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|super
operator|.
name|characters
argument_list|(
name|time
argument_list|)
expr_stmt|;
name|super
operator|.
name|endElement
argument_list|(
name|DEPLOYED_ELEMENT
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

