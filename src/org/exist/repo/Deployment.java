begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  *  eXist Open Source Native XML Database  *  Copyright (C) 2001-12 The eXist Project  *  http://exist-db.org  *  *  This program is free software; you can redistribute it and/or  *  modify it under the terms of the GNU Lesser General Public License  *  as published by the Free Software Foundation; either version 2  *  of the License, or (at your option) any later version.  *  *  This program is distributed in the hope that it will be useful,  *  but WITHOUT ANY WARRANTY; without even the implied warranty of  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  *  GNU Lesser General Public License for more details.  *  *  You should have received a copy of the GNU Lesser General Public  *  License along with this library; if not, write to the Free Software  *  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA  *  *  $Id$  */
end_comment

begin_package
package|package
name|org
operator|.
name|exist
operator|.
name|repo
package|;
end_package

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|FileUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|output
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|EXistException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|collections
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|collections
operator|.
name|IndexInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|config
operator|.
name|ConfigurationException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|BinaryDocument
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|QName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|memtree
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|Permission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|PermissionDeniedException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|internal
operator|.
name|aider
operator|.
name|GroupAider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|internal
operator|.
name|aider
operator|.
name|UserAider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|xacml
operator|.
name|AccessContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|source
operator|.
name|FileSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|DBBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|lock
operator|.
name|Lock
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|txn
operator|.
name|TransactionManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|txn
operator|.
name|Txn
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|LockException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|MimeTable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|MimeType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|SyntaxException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|serializer
operator|.
name|AttrList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xmldb
operator|.
name|XmldbURI
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|util
operator|.
name|DocUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|DateTimeValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Sequence
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|SequenceIterator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Type
import|;
end_import

begin_import
import|import
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|*
import|;
end_import

begin_import
import|import
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|Package
import|;
end_import

begin_import
import|import
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|deps
operator|.
name|DependencyVersion
import|;
end_import

begin_import
import|import
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|tui
operator|.
name|BatchUserInteraction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Element
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|Attributes
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|InputSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|SAXException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|*
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Stack
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|jar
operator|.
name|JarEntry
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|jar
operator|.
name|JarInputStream
import|;
end_import

begin_comment
comment|/**  * Deploy a .xar package into the database using the information provided  * in expath-pkg.xml and repo.xml.  */
end_comment

begin_class
specifier|public
class|class
name|Deployment
block|{
specifier|public
specifier|final
specifier|static
name|String
name|PROPERTY_APP_ROOT
init|=
literal|"repo.root-collection"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|Logger
name|LOG
init|=
name|Logger
operator|.
name|getLogger
argument_list|(
name|Deployment
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|REPO_NAMESPACE
init|=
literal|"http://exist-db.org/xquery/repo"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|String
name|PKG_NAMESPACE
init|=
literal|"http://expath.org/ns/pkg"
decl_stmt|;
specifier|private
specifier|final
specifier|static
name|QName
name|SETUP_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"setup"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|PRE_SETUP_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"prepare"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|POST_SETUP_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"finish"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|TARGET_COLL_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"target"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|PERMISSIONS_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"permissions"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|CLEANUP_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"cleanup"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|DEPLOYED_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"deployed"
argument_list|,
name|REPO_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|QName
name|DEPENDENCY_ELEMENT
init|=
operator|new
name|QName
argument_list|(
literal|"dependency"
argument_list|,
name|PKG_NAMESPACE
argument_list|)
decl_stmt|;
specifier|private
name|DBBroker
name|broker
decl_stmt|;
specifier|private
name|String
name|user
init|=
literal|null
decl_stmt|;
specifier|private
name|String
name|password
init|=
literal|null
decl_stmt|;
specifier|private
name|String
name|group
init|=
literal|null
decl_stmt|;
specifier|private
name|int
name|perms
init|=
operator|-
literal|1
decl_stmt|;
specifier|private
name|String
name|permsStr
init|=
literal|null
decl_stmt|;
specifier|public
name|Deployment
parameter_list|(
name|DBBroker
name|broker
parameter_list|)
block|{
name|this
operator|.
name|broker
operator|=
name|broker
expr_stmt|;
block|}
specifier|protected
name|File
name|getPackageDir
parameter_list|(
name|String
name|pkgName
parameter_list|,
name|ExistRepository
name|repo
parameter_list|)
throws|throws
name|PackageException
block|{
name|File
name|packageDir
init|=
literal|null
decl_stmt|;
for|for
control|(
specifier|final
name|Packages
name|pp
range|:
name|repo
operator|.
name|getParentRepo
argument_list|()
operator|.
name|listPackages
argument_list|()
control|)
block|{
specifier|final
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|Package
name|pkg
init|=
name|pp
operator|.
name|latest
argument_list|()
decl_stmt|;
if|if
condition|(
name|pkg
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|pkgName
argument_list|)
condition|)
block|{
name|packageDir
operator|=
name|getPackageDir
argument_list|(
name|pkg
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|packageDir
return|;
block|}
specifier|protected
name|File
name|getPackageDir
parameter_list|(
name|Package
name|pkg
parameter_list|)
block|{
specifier|final
name|FileSystemStorage
operator|.
name|FileSystemResolver
name|resolver
init|=
operator|(
name|FileSystemStorage
operator|.
name|FileSystemResolver
operator|)
name|pkg
operator|.
name|getResolver
argument_list|()
decl_stmt|;
return|return
name|resolver
operator|.
name|resolveResourceAsFile
argument_list|(
literal|"."
argument_list|)
return|;
block|}
specifier|protected
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|Package
name|getPackage
parameter_list|(
name|String
name|pkgName
parameter_list|,
name|ExistRepository
name|repo
parameter_list|)
throws|throws
name|PackageException
block|{
for|for
control|(
specifier|final
name|Packages
name|pp
range|:
name|repo
operator|.
name|getParentRepo
argument_list|()
operator|.
name|listPackages
argument_list|()
control|)
block|{
specifier|final
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|Package
name|pkg
init|=
name|pp
operator|.
name|latest
argument_list|()
decl_stmt|;
if|if
condition|(
name|pkg
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|pkgName
argument_list|)
condition|)
block|{
return|return
name|pkg
return|;
block|}
block|}
return|return
literal|null
return|;
block|}
specifier|protected
name|DocumentImpl
name|getRepoXML
parameter_list|(
name|File
name|packageDir
parameter_list|)
throws|throws
name|PackageException
block|{
comment|// find and parse the repo.xml descriptor
specifier|final
name|File
name|repoFile
init|=
operator|new
name|File
argument_list|(
name|packageDir
argument_list|,
literal|"repo.xml"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|repoFile
operator|.
name|canRead
argument_list|()
condition|)
block|{
return|return
literal|null
return|;
block|}
try|try
block|{
return|return
name|DocUtils
operator|.
name|parse
argument_list|(
name|broker
operator|.
name|getBrokerPool
argument_list|()
argument_list|,
literal|null
argument_list|,
operator|new
name|FileInputStream
argument_list|(
name|repoFile
argument_list|)
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
specifier|final
name|XPathException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to parse repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
specifier|final
name|FileNotFoundException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to read repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
specifier|public
name|String
name|installAndDeploy
parameter_list|(
name|File
name|xar
parameter_list|,
name|PackageLoader
name|loader
parameter_list|)
throws|throws
name|PackageException
throws|,
name|IOException
block|{
return|return
name|installAndDeploy
argument_list|(
name|xar
argument_list|,
name|loader
argument_list|,
literal|true
argument_list|)
return|;
block|}
comment|/**      * Install and deploy a give xar archive. Dependencies are installed from      * the PackageLoader.      *      * @param xar the .xar file to install      * @param loader package loader to use      * @param enforceDeps when set to true, the method will throw an exception if a dependency could not be resolved      *                    or an older version of the required dependency is installed and needs to be replaced.      */
specifier|public
name|String
name|installAndDeploy
parameter_list|(
name|File
name|xar
parameter_list|,
name|PackageLoader
name|loader
parameter_list|,
name|boolean
name|enforceDeps
parameter_list|)
throws|throws
name|PackageException
throws|,
name|IOException
block|{
specifier|final
name|DocumentImpl
name|document
init|=
name|getDescriptor
argument_list|(
name|xar
argument_list|)
decl_stmt|;
specifier|final
name|ElementImpl
name|root
init|=
operator|(
name|ElementImpl
operator|)
name|document
operator|.
name|getDocumentElement
argument_list|()
decl_stmt|;
specifier|final
name|String
name|name
init|=
name|root
operator|.
name|getAttribute
argument_list|(
literal|"name"
argument_list|)
decl_stmt|;
specifier|final
name|String
name|pkgVersion
init|=
name|root
operator|.
name|getAttribute
argument_list|(
literal|"version"
argument_list|)
decl_stmt|;
specifier|final
name|ExistRepository
name|repo
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getExpathRepo
argument_list|()
decl_stmt|;
specifier|final
name|Packages
name|packages
init|=
name|repo
operator|.
name|getParentRepo
argument_list|()
operator|.
name|getPackages
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|packages
operator|!=
literal|null
operator|&&
operator|(
operator|!
name|enforceDeps
operator|||
name|pkgVersion
operator|.
name|equals
argument_list|(
name|packages
operator|.
name|latest
argument_list|()
operator|.
name|getVersion
argument_list|()
argument_list|)
operator|)
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Application package "
operator|+
name|name
operator|+
literal|" already installed. Skipping."
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|InMemoryNodeSet
name|deps
decl_stmt|;
try|try
block|{
name|deps
operator|=
name|findElements
argument_list|(
name|root
argument_list|,
name|DEPENDENCY_ELEMENT
argument_list|)
expr_stmt|;
for|for
control|(
specifier|final
name|SequenceIterator
name|i
init|=
name|deps
operator|.
name|iterate
argument_list|()
init|;
name|i
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
specifier|final
name|Element
name|dependency
init|=
operator|(
name|Element
operator|)
name|i
operator|.
name|nextItem
argument_list|()
decl_stmt|;
specifier|final
name|String
name|pkgName
init|=
name|dependency
operator|.
name|getAttribute
argument_list|(
literal|"package"
argument_list|)
decl_stmt|;
specifier|final
name|String
name|versionStr
init|=
name|dependency
operator|.
name|getAttribute
argument_list|(
literal|"version"
argument_list|)
decl_stmt|;
specifier|final
name|String
name|semVer
init|=
name|dependency
operator|.
name|getAttribute
argument_list|(
literal|"semver"
argument_list|)
decl_stmt|;
specifier|final
name|String
name|semVerMin
init|=
name|dependency
operator|.
name|getAttribute
argument_list|(
literal|"semver-min"
argument_list|)
decl_stmt|;
specifier|final
name|String
name|semVerMax
init|=
name|dependency
operator|.
name|getAttribute
argument_list|(
literal|"semver-max"
argument_list|)
decl_stmt|;
name|PackageLoader
operator|.
name|Version
name|version
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|semVer
operator|!=
literal|null
condition|)
block|{
name|version
operator|=
operator|new
name|PackageLoader
operator|.
name|Version
argument_list|(
name|semVer
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|semVerMax
operator|!=
literal|null
operator|||
name|semVerMin
operator|!=
literal|null
condition|)
block|{
name|version
operator|=
operator|new
name|PackageLoader
operator|.
name|Version
argument_list|(
name|semVerMin
argument_list|,
name|semVerMax
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|pkgVersion
operator|!=
literal|null
condition|)
block|{
name|version
operator|=
operator|new
name|PackageLoader
operator|.
name|Version
argument_list|(
name|versionStr
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pkgName
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Package "
operator|+
name|name
operator|+
literal|" depends on "
operator|+
name|pkgName
argument_list|)
expr_stmt|;
if|if
condition|(
name|repo
operator|.
name|getParentRepo
argument_list|()
operator|.
name|getPackages
argument_list|(
name|pkgName
argument_list|)
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Package "
operator|+
name|pkgName
operator|+
literal|" already installed"
argument_list|)
expr_stmt|;
name|boolean
name|isInstalled
init|=
literal|false
decl_stmt|;
name|Packages
name|pkgs
init|=
name|repo
operator|.
name|getParentRepo
argument_list|()
operator|.
name|getPackages
argument_list|(
name|pkgName
argument_list|)
decl_stmt|;
comment|// check if installed package matches required version
if|if
condition|(
name|pkgs
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|version
operator|!=
literal|null
condition|)
block|{
name|Package
name|latest
init|=
name|pkgs
operator|.
name|latest
argument_list|()
decl_stmt|;
name|DependencyVersion
name|depVersion
init|=
name|version
operator|.
name|getDependencyVersion
argument_list|()
decl_stmt|;
if|if
condition|(
name|depVersion
operator|.
name|isCompatible
argument_list|(
name|latest
operator|.
name|getVersion
argument_list|()
argument_list|)
condition|)
block|{
name|isInstalled
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Package "
operator|+
name|pkgName
operator|+
literal|" needs to be upgraded"
argument_list|)
expr_stmt|;
if|if
condition|(
name|enforceDeps
condition|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Package requires version "
operator|+
name|version
operator|.
name|toString
argument_list|()
operator|+
literal|" of package "
operator|+
name|pkgName
operator|+
literal|". Installed version is "
operator|+
name|latest
operator|.
name|getVersion
argument_list|()
operator|+
literal|". Please upgrade!"
argument_list|)
throw|;
block|}
block|}
block|}
else|else
block|{
name|isInstalled
operator|=
literal|true
expr_stmt|;
block|}
if|if
condition|(
name|isInstalled
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Package "
operator|+
name|pkgName
operator|+
literal|" already installed"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|isInstalled
operator|&&
name|loader
operator|!=
literal|null
condition|)
block|{
specifier|final
name|File
name|depFile
init|=
name|loader
operator|.
name|load
argument_list|(
name|pkgName
argument_list|,
name|version
argument_list|)
decl_stmt|;
if|if
condition|(
name|depFile
operator|!=
literal|null
condition|)
block|{
name|installAndDeploy
argument_list|(
name|depFile
argument_list|,
name|loader
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|enforceDeps
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Missing dependency: package "
operator|+
name|pkgName
operator|+
literal|" could not be resolved. This error "
operator|+
literal|"is not fatal, but the package may not work as expected"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Missing dependency: package "
operator|+
name|pkgName
operator|+
literal|" could not be resolved."
argument_list|)
throw|;
block|}
block|}
block|}
block|}
block|}
block|}
block|}
catch|catch
parameter_list|(
specifier|final
name|XPathException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Invalid descriptor found in "
operator|+
name|xar
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
throw|;
block|}
comment|// installing the xar into the expath repo
name|LOG
operator|.
name|info
argument_list|(
literal|"Installing package "
operator|+
name|xar
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|UserInteractionStrategy
name|interact
init|=
operator|new
name|BatchUserInteraction
argument_list|()
decl_stmt|;
specifier|final
name|org
operator|.
name|expath
operator|.
name|pkg
operator|.
name|repo
operator|.
name|Package
name|pkg
init|=
name|repo
operator|.
name|getParentRepo
argument_list|()
operator|.
name|installPackage
argument_list|(
name|xar
argument_list|,
literal|true
argument_list|,
name|interact
argument_list|)
decl_stmt|;
specifier|final
name|ExistPkgInfo
name|info
init|=
operator|(
name|ExistPkgInfo
operator|)
name|pkg
operator|.
name|getInfo
argument_list|(
literal|"exist"
argument_list|)
decl_stmt|;
if|if
condition|(
name|info
operator|!=
literal|null
operator|&&
operator|!
name|info
operator|.
name|getJars
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ClasspathHelper
operator|.
name|updateClasspath
argument_list|(
name|broker
operator|.
name|getBrokerPool
argument_list|()
argument_list|,
name|pkg
argument_list|)
expr_stmt|;
block|}
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getXQueryPool
argument_list|()
operator|.
name|clear
argument_list|()
expr_stmt|;
specifier|final
name|String
name|pkgName
init|=
name|pkg
operator|.
name|getName
argument_list|()
decl_stmt|;
comment|// signal status
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|reportStatus
argument_list|(
literal|"Installing app: "
operator|+
name|pkg
operator|.
name|getAbbrev
argument_list|()
argument_list|)
expr_stmt|;
name|repo
operator|.
name|reportAction
argument_list|(
name|ExistRepository
operator|.
name|Action
operator|.
name|INSTALL
argument_list|,
name|pkg
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Deploying package "
operator|+
name|pkgName
argument_list|)
expr_stmt|;
return|return
name|deploy
argument_list|(
name|pkgName
argument_list|,
name|repo
argument_list|,
literal|null
argument_list|)
return|;
block|}
specifier|public
name|String
name|undeploy
parameter_list|(
name|String
name|pkgName
parameter_list|,
name|ExistRepository
name|repo
parameter_list|)
throws|throws
name|PackageException
block|{
specifier|final
name|File
name|packageDir
init|=
name|getPackageDir
argument_list|(
name|pkgName
argument_list|,
name|repo
argument_list|)
decl_stmt|;
if|if
condition|(
name|packageDir
operator|==
literal|null
condition|)
comment|// fails silently if package dir is not found?
block|{
return|return
literal|null
return|;
block|}
specifier|final
name|DocumentImpl
name|repoXML
init|=
name|getRepoXML
argument_list|(
name|packageDir
argument_list|)
decl_stmt|;
specifier|final
name|Package
name|pkg
init|=
name|getPackage
argument_list|(
name|pkgName
argument_list|,
name|repo
argument_list|)
decl_stmt|;
if|if
condition|(
name|repoXML
operator|!=
literal|null
condition|)
block|{
name|ElementImpl
name|target
init|=
literal|null
decl_stmt|;
try|try
block|{
name|target
operator|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|TARGET_COLL_ELEMENT
argument_list|)
expr_stmt|;
specifier|final
name|ElementImpl
name|cleanup
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|CLEANUP_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|cleanup
operator|!=
literal|null
condition|)
block|{
name|runQuery
argument_list|(
literal|null
argument_list|,
name|packageDir
argument_list|,
name|cleanup
operator|.
name|getStringValue
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
name|uninstall
argument_list|(
name|pkg
argument_list|,
name|target
argument_list|)
expr_stmt|;
return|return
name|target
operator|==
literal|null
condition|?
literal|null
else|:
name|target
operator|.
name|getStringValue
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
specifier|final
name|XPathException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error found while processing repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
specifier|final
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error found while processing repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
else|else
block|{
comment|// we still may need to remove the copy of the package from /db/system/repo
name|uninstall
argument_list|(
name|pkg
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
specifier|public
name|String
name|deploy
parameter_list|(
name|String
name|pkgName
parameter_list|,
name|ExistRepository
name|repo
parameter_list|,
name|String
name|userTarget
parameter_list|)
throws|throws
name|PackageException
throws|,
name|IOException
block|{
specifier|final
name|File
name|packageDir
init|=
name|getPackageDir
argument_list|(
name|pkgName
argument_list|,
name|repo
argument_list|)
decl_stmt|;
if|if
condition|(
name|packageDir
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Package not found: "
operator|+
name|pkgName
argument_list|)
throw|;
block|}
specifier|final
name|DocumentImpl
name|repoXML
init|=
name|getRepoXML
argument_list|(
name|packageDir
argument_list|)
decl_stmt|;
if|if
condition|(
name|repoXML
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
try|try
block|{
comment|// if there's a<setup> element, run the query it points to
specifier|final
name|ElementImpl
name|setup
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|SETUP_ELEMENT
argument_list|)
decl_stmt|;
name|String
name|path
init|=
name|setup
operator|==
literal|null
condition|?
literal|null
else|:
name|setup
operator|.
name|getStringValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|path
operator|!=
literal|null
operator|&&
name|path
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|runQuery
argument_list|(
literal|null
argument_list|,
name|packageDir
argument_list|,
name|path
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
else|else
block|{
comment|// otherwise copy all child directories to the target collection
name|XmldbURI
name|targetCollection
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|userTarget
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|targetCollection
operator|=
name|XmldbURI
operator|.
name|create
argument_list|(
name|userTarget
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Bad collection URI: "
operator|+
name|userTarget
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
else|else
block|{
specifier|final
name|ElementImpl
name|target
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|TARGET_COLL_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|target
operator|!=
literal|null
condition|)
block|{
comment|// determine target collection
try|try
block|{
name|targetCollection
operator|=
name|XmldbURI
operator|.
name|create
argument_list|(
name|getTargetCollection
argument_list|(
name|target
operator|.
name|getStringValue
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Bad collection URI for<target> element: "
operator|+
name|target
operator|.
name|getStringValue
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
if|if
condition|(
name|targetCollection
operator|==
literal|null
condition|)
block|{
comment|// no target means: package does not need to be deployed into database
comment|// however, we need to preserve a copy for backup purposes
specifier|final
name|Package
name|pkg
init|=
name|getPackage
argument_list|(
name|pkgName
argument_list|,
name|repo
argument_list|)
decl_stmt|;
specifier|final
name|String
name|pkgColl
init|=
name|pkg
operator|.
name|getAbbrev
argument_list|()
operator|+
literal|"-"
operator|+
name|pkg
operator|.
name|getVersion
argument_list|()
decl_stmt|;
name|targetCollection
operator|=
name|XmldbURI
operator|.
name|SYSTEM
operator|.
name|append
argument_list|(
literal|"repo/"
operator|+
name|pkgColl
argument_list|)
expr_stmt|;
block|}
specifier|final
name|ElementImpl
name|permissions
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|PERMISSIONS_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|permissions
operator|!=
literal|null
condition|)
block|{
comment|// get user, group and default permissions
name|user
operator|=
name|permissions
operator|.
name|getAttribute
argument_list|(
literal|"user"
argument_list|)
expr_stmt|;
name|group
operator|=
name|permissions
operator|.
name|getAttribute
argument_list|(
literal|"group"
argument_list|)
expr_stmt|;
name|password
operator|=
name|permissions
operator|.
name|getAttribute
argument_list|(
literal|"password"
argument_list|)
expr_stmt|;
name|String
name|mode
init|=
name|permissions
operator|.
name|getAttribute
argument_list|(
literal|"mode"
argument_list|)
decl_stmt|;
try|try
block|{
name|perms
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|mode
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|NumberFormatException
name|e
parameter_list|)
block|{
name|permsStr
operator|=
name|mode
expr_stmt|;
if|if
condition|(
operator|!
name|permsStr
operator|.
name|matches
argument_list|(
literal|"^[rwx-]{9}"
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Bad format for mode attribute in<permissions>: "
operator|+
name|mode
argument_list|)
throw|;
block|}
block|}
block|}
comment|// run the pre-setup query if present
specifier|final
name|ElementImpl
name|preSetup
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|PRE_SETUP_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|preSetup
operator|!=
literal|null
condition|)
block|{
name|path
operator|=
name|preSetup
operator|.
name|getStringValue
argument_list|()
expr_stmt|;
if|if
condition|(
name|path
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|runQuery
argument_list|(
name|targetCollection
argument_list|,
name|packageDir
argument_list|,
name|path
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
comment|// any required users and group should have been created by the pre-setup query.
comment|// check for invalid users now.
name|checkUserSettings
argument_list|()
expr_stmt|;
comment|// install
name|scanDirectory
argument_list|(
name|packageDir
argument_list|,
name|targetCollection
argument_list|,
literal|true
argument_list|)
expr_stmt|;
comment|// run the post-setup query if present
specifier|final
name|ElementImpl
name|postSetup
init|=
name|findElement
argument_list|(
name|repoXML
argument_list|,
name|POST_SETUP_ELEMENT
argument_list|)
decl_stmt|;
if|if
condition|(
name|postSetup
operator|!=
literal|null
condition|)
block|{
name|path
operator|=
name|postSetup
operator|.
name|getStringValue
argument_list|()
expr_stmt|;
if|if
condition|(
name|path
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|runQuery
argument_list|(
name|targetCollection
argument_list|,
name|packageDir
argument_list|,
name|path
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
name|storeRepoXML
argument_list|(
name|repoXML
argument_list|,
name|targetCollection
argument_list|)
expr_stmt|;
comment|// TODO: it should be save to clean up the file system after a package
comment|// has been deployed. Might be enabled after 2.0
comment|//cleanup(pkgName, repo);
return|return
name|targetCollection
operator|.
name|getCollectionPath
argument_list|()
return|;
block|}
block|}
catch|catch
parameter_list|(
specifier|final
name|XPathException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error found while processing repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * After deployment, clean up the package directory and remove all files which have been      * stored into the db. They are not needed anymore. Only preserve the descriptors and the      * contents directory.      *      * @param pkgName      * @param repo      * @throws PackageException      */
specifier|private
name|void
name|cleanup
parameter_list|(
name|String
name|pkgName
parameter_list|,
name|ExistRepository
name|repo
parameter_list|)
throws|throws
name|PackageException
block|{
specifier|final
name|Package
name|pkg
init|=
name|getPackage
argument_list|(
name|pkgName
argument_list|,
name|repo
argument_list|)
decl_stmt|;
specifier|final
name|String
name|abbrev
init|=
name|pkg
operator|.
name|getAbbrev
argument_list|()
decl_stmt|;
specifier|final
name|File
name|packageDir
init|=
name|getPackageDir
argument_list|(
name|pkg
argument_list|)
decl_stmt|;
if|if
condition|(
name|packageDir
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Cleanup: package dir for package "
operator|+
name|pkgName
operator|+
literal|" not found"
argument_list|)
throw|;
block|}
name|File
index|[]
name|filesToDelete
init|=
name|packageDir
operator|.
name|listFiles
argument_list|(
operator|new
name|FileFilter
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|boolean
name|accept
parameter_list|(
name|File
name|file
parameter_list|)
block|{
name|String
name|name
init|=
name|file
operator|.
name|getName
argument_list|()
decl_stmt|;
if|if
condition|(
name|file
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
return|return
operator|!
operator|(
name|name
operator|.
name|equals
argument_list|(
name|abbrev
argument_list|)
operator|||
name|name
operator|.
name|equals
argument_list|(
literal|"content"
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|!
operator|(
name|name
operator|.
name|equals
argument_list|(
literal|"expath-pkg.xml"
argument_list|)
operator|||
name|name
operator|.
name|equals
argument_list|(
literal|"repo.xml"
argument_list|)
operator|||
literal|"exist.xml"
operator|.
name|equals
argument_list|(
name|name
argument_list|)
operator|||
name|name
operator|.
name|startsWith
argument_list|(
literal|"icon"
argument_list|)
operator|)
return|;
block|}
block|}
block|}
argument_list|)
decl_stmt|;
for|for
control|(
specifier|final
name|File
name|fileToDelete
range|:
name|filesToDelete
control|)
block|{
try|try
block|{
name|FileUtils
operator|.
name|forceDelete
argument_list|(
name|fileToDelete
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Cleanup: failed to delete file "
operator|+
name|fileToDelete
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|" in package "
operator|+
name|pkgName
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
name|String
name|getTargetCollection
parameter_list|(
name|String
name|targetFromRepo
parameter_list|)
block|{
specifier|final
name|String
name|appRoot
init|=
operator|(
name|String
operator|)
name|broker
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getProperty
argument_list|(
name|PROPERTY_APP_ROOT
argument_list|)
decl_stmt|;
if|if
condition|(
name|appRoot
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|targetFromRepo
operator|.
name|startsWith
argument_list|(
literal|"/db/"
argument_list|)
condition|)
block|{
name|targetFromRepo
operator|=
name|targetFromRepo
operator|.
name|substring
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
return|return
name|appRoot
operator|+
name|targetFromRepo
return|;
block|}
if|if
condition|(
name|targetFromRepo
operator|.
name|startsWith
argument_list|(
literal|"/db"
argument_list|)
condition|)
block|{
return|return
name|targetFromRepo
return|;
block|}
else|else
block|{
return|return
literal|"/db/"
operator|+
name|targetFromRepo
return|;
block|}
block|}
comment|/**      * Delete the target collection of the package. If there's no repo.xml descriptor,      * target will be null.      *      * @param pkg      * @param target      * @throws PackageException      */
specifier|private
name|void
name|uninstall
parameter_list|(
name|Package
name|pkg
parameter_list|,
name|ElementImpl
name|target
parameter_list|)
throws|throws
name|PackageException
block|{
comment|// determine target collection
name|XmldbURI
name|targetCollection
decl_stmt|;
if|if
condition|(
name|target
operator|==
literal|null
condition|)
block|{
specifier|final
name|String
name|pkgColl
init|=
name|pkg
operator|.
name|getAbbrev
argument_list|()
operator|+
literal|"-"
operator|+
name|pkg
operator|.
name|getVersion
argument_list|()
decl_stmt|;
name|targetCollection
operator|=
name|XmldbURI
operator|.
name|SYSTEM
operator|.
name|append
argument_list|(
literal|"repo/"
operator|+
name|pkgColl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
try|try
block|{
name|targetCollection
operator|=
name|XmldbURI
operator|.
name|create
argument_list|(
name|getTargetCollection
argument_list|(
name|target
operator|.
name|getStringValue
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Bad collection URI for<target> element: "
operator|+
name|target
operator|.
name|getStringValue
argument_list|()
argument_list|)
throw|;
block|}
block|}
specifier|final
name|TransactionManager
name|mgr
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getTransactionManager
argument_list|()
decl_stmt|;
specifier|final
name|Txn
name|txn
init|=
name|mgr
operator|.
name|beginTransaction
argument_list|()
decl_stmt|;
try|try
block|{
name|Collection
name|collection
init|=
name|broker
operator|.
name|getOrCreateCollection
argument_list|(
name|txn
argument_list|,
name|targetCollection
argument_list|)
decl_stmt|;
if|if
condition|(
name|collection
operator|!=
literal|null
condition|)
block|{
name|broker
operator|.
name|removeCollection
argument_list|(
name|txn
argument_list|,
name|collection
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|target
operator|!=
literal|null
condition|)
block|{
specifier|final
name|XmldbURI
name|configCollection
init|=
name|XmldbURI
operator|.
name|CONFIG_COLLECTION_URI
operator|.
name|append
argument_list|(
name|targetCollection
argument_list|)
decl_stmt|;
name|collection
operator|=
name|broker
operator|.
name|getOrCreateCollection
argument_list|(
name|txn
argument_list|,
name|configCollection
argument_list|)
expr_stmt|;
if|if
condition|(
name|collection
operator|!=
literal|null
condition|)
block|{
name|broker
operator|.
name|removeCollection
argument_list|(
name|txn
argument_list|,
name|collection
argument_list|)
expr_stmt|;
block|}
block|}
name|mgr
operator|.
name|commit
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Exception occurred while removing package."
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|mgr
operator|.
name|abort
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|mgr
operator|.
name|close
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**      * Store repo.xml into the db. Adds the time of deployment to the descriptor.      *      * @param repoXML      * @param targetCollection      * @throws XPathException      */
specifier|private
name|void
name|storeRepoXML
parameter_list|(
name|DocumentImpl
name|repoXML
parameter_list|,
name|XmldbURI
name|targetCollection
parameter_list|)
throws|throws
name|PackageException
throws|,
name|XPathException
block|{
comment|// Store repo.xml
specifier|final
name|DateTimeValue
name|time
init|=
operator|new
name|DateTimeValue
argument_list|(
operator|new
name|Date
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|MemTreeBuilder
name|builder
init|=
operator|new
name|MemTreeBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|startDocument
argument_list|()
expr_stmt|;
specifier|final
name|UpdatingDocumentReceiver
name|receiver
init|=
operator|new
name|UpdatingDocumentReceiver
argument_list|(
name|builder
argument_list|,
name|time
operator|.
name|getStringValue
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|repoXML
operator|.
name|copyTo
argument_list|(
name|broker
argument_list|,
name|receiver
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|SAXException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error while updating repo.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
throw|;
block|}
name|builder
operator|.
name|endDocument
argument_list|()
expr_stmt|;
specifier|final
name|DocumentImpl
name|updatedXML
init|=
name|builder
operator|.
name|getDocument
argument_list|()
decl_stmt|;
specifier|final
name|TransactionManager
name|mgr
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getTransactionManager
argument_list|()
decl_stmt|;
specifier|final
name|Txn
name|txn
init|=
name|mgr
operator|.
name|beginTransaction
argument_list|()
decl_stmt|;
try|try
block|{
specifier|final
name|Collection
name|collection
init|=
name|broker
operator|.
name|getOrCreateCollection
argument_list|(
name|txn
argument_list|,
name|targetCollection
argument_list|)
decl_stmt|;
specifier|final
name|XmldbURI
name|name
init|=
name|XmldbURI
operator|.
name|createInternal
argument_list|(
literal|"repo.xml"
argument_list|)
decl_stmt|;
specifier|final
name|IndexInfo
name|info
init|=
name|collection
operator|.
name|validateXMLResource
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|name
argument_list|,
name|updatedXML
argument_list|)
decl_stmt|;
specifier|final
name|Permission
name|permission
init|=
name|info
operator|.
name|getDocument
argument_list|()
operator|.
name|getPermissions
argument_list|()
decl_stmt|;
name|setPermissions
argument_list|(
literal|false
argument_list|,
name|MimeType
operator|.
name|XML_TYPE
argument_list|,
name|permission
argument_list|)
expr_stmt|;
name|collection
operator|.
name|store
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|info
argument_list|,
name|updatedXML
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|mgr
operator|.
name|commit
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|Exception
name|e
parameter_list|)
block|{
name|mgr
operator|.
name|abort
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|mgr
operator|.
name|close
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|checkUserSettings
parameter_list|()
throws|throws
name|PackageException
block|{
specifier|final
name|org
operator|.
name|exist
operator|.
name|security
operator|.
name|SecurityManager
name|secman
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getSecurityManager
argument_list|()
decl_stmt|;
try|try
block|{
if|if
condition|(
name|group
operator|!=
literal|null
operator|&&
operator|!
name|secman
operator|.
name|hasGroup
argument_list|(
name|group
argument_list|)
condition|)
block|{
specifier|final
name|GroupAider
name|aider
init|=
operator|new
name|GroupAider
argument_list|(
name|group
argument_list|)
decl_stmt|;
name|secman
operator|.
name|addGroup
argument_list|(
name|aider
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|user
operator|!=
literal|null
operator|&&
operator|!
name|secman
operator|.
name|hasAccount
argument_list|(
name|user
argument_list|)
condition|)
block|{
specifier|final
name|UserAider
name|aider
init|=
operator|new
name|UserAider
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|aider
operator|.
name|setPassword
argument_list|(
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|!=
literal|null
condition|)
block|{
name|aider
operator|.
name|addGroup
argument_list|(
name|group
argument_list|)
expr_stmt|;
block|}
name|secman
operator|.
name|addAccount
argument_list|(
name|aider
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
specifier|final
name|ConfigurationException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to create user: "
operator|+
name|user
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
specifier|final
name|PermissionDeniedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to create user: "
operator|+
name|user
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
specifier|final
name|EXistException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Failed to create user: "
operator|+
name|user
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
specifier|private
name|Sequence
name|runQuery
parameter_list|(
name|XmldbURI
name|targetCollection
parameter_list|,
name|File
name|tempDir
parameter_list|,
name|String
name|fileName
parameter_list|,
name|boolean
name|preInstall
parameter_list|)
throws|throws
name|PackageException
throws|,
name|IOException
throws|,
name|XPathException
block|{
specifier|final
name|File
name|xquery
init|=
operator|new
name|File
argument_list|(
name|tempDir
argument_list|,
name|fileName
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|xquery
operator|.
name|canRead
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"The XQuery resource specified in the<setup> element was not found"
argument_list|)
expr_stmt|;
return|return
name|Sequence
operator|.
name|EMPTY_SEQUENCE
return|;
block|}
specifier|final
name|XQuery
name|xqs
init|=
name|broker
operator|.
name|getXQueryService
argument_list|()
decl_stmt|;
specifier|final
name|XQueryContext
name|ctx
init|=
name|xqs
operator|.
name|newContext
argument_list|(
name|AccessContext
operator|.
name|REST
argument_list|)
decl_stmt|;
name|ctx
operator|.
name|declareVariable
argument_list|(
literal|"dir"
argument_list|,
name|tempDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|File
name|home
init|=
name|broker
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getExistHome
argument_list|()
decl_stmt|;
name|ctx
operator|.
name|declareVariable
argument_list|(
literal|"home"
argument_list|,
name|home
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|targetCollection
operator|!=
literal|null
condition|)
block|{
name|ctx
operator|.
name|declareVariable
argument_list|(
literal|"target"
argument_list|,
name|targetCollection
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|ctx
operator|.
name|setModuleLoadPath
argument_list|(
name|XmldbURI
operator|.
name|EMBEDDED_SERVER_URI
operator|+
name|targetCollection
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ctx
operator|.
name|declareVariable
argument_list|(
literal|"target"
argument_list|,
name|Sequence
operator|.
name|EMPTY_SEQUENCE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|preInstall
condition|)
comment|// when running pre-setup scripts, base path should point to directory
comment|// because the target collection does not yet exist
block|{
name|ctx
operator|.
name|setModuleLoadPath
argument_list|(
name|tempDir
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|CompiledXQuery
name|compiled
decl_stmt|;
try|try
block|{
name|compiled
operator|=
name|xqs
operator|.
name|compile
argument_list|(
name|ctx
argument_list|,
operator|new
name|FileSource
argument_list|(
name|xquery
argument_list|,
literal|"UTF-8"
argument_list|,
literal|false
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|xqs
operator|.
name|execute
argument_list|(
name|compiled
argument_list|,
literal|null
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
specifier|final
name|PermissionDeniedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * Scan a directory and import all files and sub directories into the target      * collection.      *      * @param directory      * @param target      */
specifier|private
name|void
name|scanDirectory
parameter_list|(
name|File
name|directory
parameter_list|,
name|XmldbURI
name|target
parameter_list|,
name|boolean
name|inRootDir
parameter_list|)
block|{
specifier|final
name|TransactionManager
name|mgr
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getTransactionManager
argument_list|()
decl_stmt|;
specifier|final
name|Txn
name|txn
init|=
name|mgr
operator|.
name|beginTransaction
argument_list|()
decl_stmt|;
name|Collection
name|collection
init|=
literal|null
decl_stmt|;
try|try
block|{
name|collection
operator|=
name|broker
operator|.
name|getOrCreateCollection
argument_list|(
name|txn
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|setPermissions
argument_list|(
literal|true
argument_list|,
literal|null
argument_list|,
name|collection
operator|.
name|getPermissions
argument_list|()
argument_list|)
expr_stmt|;
name|broker
operator|.
name|saveCollection
argument_list|(
name|txn
argument_list|,
name|collection
argument_list|)
expr_stmt|;
name|mgr
operator|.
name|commit
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|Exception
name|e
parameter_list|)
block|{
name|mgr
operator|.
name|abort
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|mgr
operator|.
name|close
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
try|try
block|{
comment|// lock the collection while we store the files
comment|// TODO: could be released after each operation
name|collection
operator|.
name|getLock
argument_list|()
operator|.
name|acquire
argument_list|(
name|Lock
operator|.
name|WRITE_LOCK
argument_list|)
expr_stmt|;
name|storeFiles
argument_list|(
name|directory
argument_list|,
name|collection
argument_list|,
name|inRootDir
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|LockException
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|collection
operator|.
name|getLock
argument_list|()
operator|.
name|release
argument_list|(
name|Lock
operator|.
name|WRITE_LOCK
argument_list|)
expr_stmt|;
block|}
comment|// scan sub directories
specifier|final
name|File
index|[]
name|files
init|=
name|directory
operator|.
name|listFiles
argument_list|()
decl_stmt|;
for|for
control|(
specifier|final
name|File
name|file
range|:
name|files
control|)
block|{
if|if
condition|(
name|file
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
name|scanDirectory
argument_list|(
name|file
argument_list|,
name|target
operator|.
name|append
argument_list|(
name|file
operator|.
name|getName
argument_list|()
argument_list|)
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**      * Import all files in the given directory into the target collection      *      * @param directory      * @param targetCollection      */
specifier|private
name|void
name|storeFiles
parameter_list|(
name|File
name|directory
parameter_list|,
name|Collection
name|targetCollection
parameter_list|,
name|boolean
name|inRootDir
parameter_list|)
block|{
specifier|final
name|File
index|[]
name|files
init|=
name|directory
operator|.
name|listFiles
argument_list|()
decl_stmt|;
specifier|final
name|MimeTable
name|mimeTab
init|=
name|MimeTable
operator|.
name|getInstance
argument_list|()
decl_stmt|;
specifier|final
name|TransactionManager
name|mgr
init|=
name|broker
operator|.
name|getBrokerPool
argument_list|()
operator|.
name|getTransactionManager
argument_list|()
decl_stmt|;
for|for
control|(
specifier|final
name|File
name|file
range|:
name|files
control|)
block|{
if|if
condition|(
name|inRootDir
operator|&&
literal|"repo.xml"
operator|.
name|equals
argument_list|(
name|file
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
operator|!
name|file
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
name|MimeType
name|mime
init|=
name|mimeTab
operator|.
name|getContentTypeFor
argument_list|(
name|file
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|mime
operator|==
literal|null
condition|)
block|{
name|mime
operator|=
name|MimeType
operator|.
name|BINARY_TYPE
expr_stmt|;
block|}
specifier|final
name|XmldbURI
name|name
init|=
name|XmldbURI
operator|.
name|create
argument_list|(
name|file
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|Txn
name|txn
init|=
name|mgr
operator|.
name|beginTransaction
argument_list|()
decl_stmt|;
try|try
block|{
if|if
condition|(
name|mime
operator|.
name|isXMLType
argument_list|()
condition|)
block|{
specifier|final
name|InputSource
name|is
init|=
operator|new
name|InputSource
argument_list|(
name|file
operator|.
name|toURI
argument_list|()
operator|.
name|toASCIIString
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|IndexInfo
name|info
init|=
name|targetCollection
operator|.
name|validateXMLResource
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|name
argument_list|,
name|is
argument_list|)
decl_stmt|;
name|info
operator|.
name|getDocument
argument_list|()
operator|.
name|getMetadata
argument_list|()
operator|.
name|setMimeType
argument_list|(
name|mime
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|Permission
name|permission
init|=
name|info
operator|.
name|getDocument
argument_list|()
operator|.
name|getPermissions
argument_list|()
decl_stmt|;
name|setPermissions
argument_list|(
literal|false
argument_list|,
name|mime
argument_list|,
name|permission
argument_list|)
expr_stmt|;
name|targetCollection
operator|.
name|store
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|info
argument_list|,
name|is
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|final
name|long
name|size
init|=
name|file
operator|.
name|length
argument_list|()
decl_stmt|;
specifier|final
name|FileInputStream
name|is
init|=
operator|new
name|FileInputStream
argument_list|(
name|file
argument_list|)
decl_stmt|;
specifier|final
name|BinaryDocument
name|doc
init|=
name|targetCollection
operator|.
name|addBinaryResource
argument_list|(
name|txn
argument_list|,
name|broker
argument_list|,
name|name
argument_list|,
name|is
argument_list|,
name|mime
operator|.
name|getName
argument_list|()
argument_list|,
name|size
argument_list|)
decl_stmt|;
name|is
operator|.
name|close
argument_list|()
expr_stmt|;
specifier|final
name|Permission
name|permission
init|=
name|doc
operator|.
name|getPermissions
argument_list|()
decl_stmt|;
name|setPermissions
argument_list|(
literal|false
argument_list|,
name|mime
argument_list|,
name|permission
argument_list|)
expr_stmt|;
name|doc
operator|.
name|getMetadata
argument_list|()
operator|.
name|setMimeType
argument_list|(
name|mime
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|broker
operator|.
name|storeXMLResource
argument_list|(
name|txn
argument_list|,
name|doc
argument_list|)
expr_stmt|;
block|}
name|mgr
operator|.
name|commit
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|Exception
name|e
parameter_list|)
block|{
name|mgr
operator|.
name|abort
argument_list|(
name|txn
argument_list|)
expr_stmt|;
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|mgr
operator|.
name|close
argument_list|(
name|txn
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/**      * Set owner, group and permissions. For XQuery resources, always set the executable flag.      * @param mime      * @param permission      */
specifier|private
name|void
name|setPermissions
parameter_list|(
name|boolean
name|isCollection
parameter_list|,
name|MimeType
name|mime
parameter_list|,
name|Permission
name|permission
parameter_list|)
throws|throws
name|PermissionDeniedException
block|{
if|if
condition|(
name|user
operator|!=
literal|null
condition|)
block|{
name|permission
operator|.
name|setOwner
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|group
operator|!=
literal|null
condition|)
block|{
name|permission
operator|.
name|setGroup
argument_list|(
name|group
argument_list|)
expr_stmt|;
block|}
name|int
name|mode
decl_stmt|;
if|if
condition|(
name|permsStr
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|permission
operator|.
name|setMode
argument_list|(
name|permsStr
argument_list|)
expr_stmt|;
name|mode
operator|=
name|permission
operator|.
name|getMode
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|SyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Incorrect permissions string: "
operator|+
name|permsStr
operator|+
literal|". Falling back to default."
argument_list|)
expr_stmt|;
name|mode
operator|=
name|permission
operator|.
name|getMode
argument_list|()
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|perms
operator|>
operator|-
literal|1
condition|)
block|{
name|mode
operator|=
name|perms
expr_stmt|;
block|}
else|else
block|{
name|mode
operator|=
name|permission
operator|.
name|getMode
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|isCollection
operator|||
operator|(
name|mime
operator|!=
literal|null
operator|&&
name|mime
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|MimeType
operator|.
name|XQUERY_TYPE
operator|.
name|getName
argument_list|()
argument_list|)
operator|)
condition|)
block|{
name|mode
operator|=
name|mode
operator||
literal|0111
expr_stmt|;
block|}
name|permission
operator|.
name|setMode
argument_list|(
name|mode
argument_list|)
expr_stmt|;
block|}
specifier|private
name|ElementImpl
name|findElement
parameter_list|(
name|NodeImpl
name|root
parameter_list|,
name|QName
name|qname
parameter_list|)
throws|throws
name|XPathException
block|{
specifier|final
name|InMemoryNodeSet
name|setupNodes
init|=
operator|new
name|InMemoryNodeSet
argument_list|()
decl_stmt|;
name|root
operator|.
name|selectDescendants
argument_list|(
literal|false
argument_list|,
operator|new
name|NameTest
argument_list|(
name|Type
operator|.
name|ELEMENT
argument_list|,
name|qname
argument_list|)
argument_list|,
name|setupNodes
argument_list|)
expr_stmt|;
if|if
condition|(
name|setupNodes
operator|.
name|getItemCount
argument_list|()
operator|==
literal|0
condition|)
block|{
return|return
literal|null
return|;
block|}
return|return
operator|(
name|ElementImpl
operator|)
name|setupNodes
operator|.
name|itemAt
argument_list|(
literal|0
argument_list|)
return|;
block|}
specifier|private
name|InMemoryNodeSet
name|findElements
parameter_list|(
name|NodeImpl
name|root
parameter_list|,
name|QName
name|qname
parameter_list|)
throws|throws
name|XPathException
block|{
specifier|final
name|InMemoryNodeSet
name|setupNodes
init|=
operator|new
name|InMemoryNodeSet
argument_list|()
decl_stmt|;
name|root
operator|.
name|selectDescendants
argument_list|(
literal|false
argument_list|,
operator|new
name|NameTest
argument_list|(
name|Type
operator|.
name|ELEMENT
argument_list|,
name|qname
argument_list|)
argument_list|,
name|setupNodes
argument_list|)
expr_stmt|;
return|return
name|setupNodes
return|;
block|}
specifier|public
name|String
name|getNameFromDescriptor
parameter_list|(
name|File
name|xar
parameter_list|)
throws|throws
name|IOException
throws|,
name|PackageException
block|{
specifier|final
name|DocumentImpl
name|doc
init|=
name|getDescriptor
argument_list|(
name|xar
argument_list|)
decl_stmt|;
specifier|final
name|Element
name|root
init|=
name|doc
operator|.
name|getDocumentElement
argument_list|()
decl_stmt|;
return|return
name|root
operator|.
name|getAttribute
argument_list|(
literal|"name"
argument_list|)
return|;
block|}
specifier|public
name|DocumentImpl
name|getDescriptor
parameter_list|(
name|File
name|jar
parameter_list|)
throws|throws
name|IOException
throws|,
name|PackageException
block|{
specifier|final
name|InputStream
name|istream
init|=
operator|new
name|BufferedInputStream
argument_list|(
operator|new
name|FileInputStream
argument_list|(
name|jar
argument_list|)
argument_list|)
decl_stmt|;
specifier|final
name|JarInputStream
name|jis
init|=
operator|new
name|JarInputStream
argument_list|(
name|istream
argument_list|)
decl_stmt|;
name|JarEntry
name|entry
decl_stmt|;
name|DocumentImpl
name|doc
init|=
literal|null
decl_stmt|;
while|while
condition|(
operator|(
name|entry
operator|=
name|jis
operator|.
name|getNextJarEntry
argument_list|()
operator|)
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
operator|!
name|entry
operator|.
name|isDirectory
argument_list|()
operator|&&
literal|"expath-pkg.xml"
operator|.
name|equals
argument_list|(
name|entry
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
specifier|final
name|ByteArrayOutputStream
name|bos
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|int
name|c
decl_stmt|;
specifier|final
name|byte
index|[]
name|b
init|=
operator|new
name|byte
index|[
literal|4096
index|]
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|jis
operator|.
name|read
argument_list|(
name|b
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|bos
operator|.
name|write
argument_list|(
name|b
argument_list|,
literal|0
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
name|bos
operator|.
name|close
argument_list|()
expr_stmt|;
specifier|final
name|byte
index|[]
name|data
init|=
name|bos
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
specifier|final
name|ByteArrayInputStream
name|bis
init|=
operator|new
name|ByteArrayInputStream
argument_list|(
name|data
argument_list|)
decl_stmt|;
try|try
block|{
name|doc
operator|=
name|DocUtils
operator|.
name|parse
argument_list|(
name|broker
operator|.
name|getBrokerPool
argument_list|()
argument_list|,
literal|null
argument_list|,
name|bis
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
specifier|final
name|XPathException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|PackageException
argument_list|(
literal|"Error while parsing expath-pkg.xml: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
break|break;
block|}
block|}
name|jis
operator|.
name|close
argument_list|()
expr_stmt|;
return|return
name|doc
return|;
block|}
comment|/**      * Update repo.xml while copying it.      */
specifier|private
class|class
name|UpdatingDocumentReceiver
extends|extends
name|DocumentBuilderReceiver
block|{
specifier|private
name|String
name|time
decl_stmt|;
specifier|private
name|Stack
argument_list|<
name|String
argument_list|>
name|stack
init|=
operator|new
name|Stack
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
specifier|public
name|UpdatingDocumentReceiver
parameter_list|(
name|MemTreeBuilder
name|builder
parameter_list|,
name|String
name|time
parameter_list|)
block|{
name|super
argument_list|(
name|builder
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|this
operator|.
name|time
operator|=
name|time
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|startElement
parameter_list|(
name|QName
name|qname
parameter_list|,
name|AttrList
name|attribs
parameter_list|)
block|{
name|stack
operator|.
name|push
argument_list|(
name|qname
operator|.
name|getLocalName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|qname
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|super
operator|.
name|startElement
argument_list|(
name|qname
argument_list|,
name|attribs
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|startElement
parameter_list|(
name|String
name|namespaceURI
parameter_list|,
name|String
name|localName
parameter_list|,
name|String
name|qName
parameter_list|,
name|Attributes
name|attrs
parameter_list|)
throws|throws
name|SAXException
block|{
name|stack
operator|.
name|push
argument_list|(
name|localName
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|localName
argument_list|)
condition|)
block|{
name|super
operator|.
name|startElement
argument_list|(
name|namespaceURI
argument_list|,
name|localName
argument_list|,
name|qName
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|endElement
parameter_list|(
name|QName
name|qname
parameter_list|)
throws|throws
name|SAXException
block|{
name|stack
operator|.
name|pop
argument_list|()
expr_stmt|;
if|if
condition|(
literal|"meta"
operator|.
name|equals
argument_list|(
name|qname
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|addDeployTime
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|qname
operator|.
name|getLocalName
argument_list|()
argument_list|)
condition|)
block|{
name|super
operator|.
name|endElement
argument_list|(
name|qname
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|endElement
parameter_list|(
name|String
name|uri
parameter_list|,
name|String
name|localName
parameter_list|,
name|String
name|qName
parameter_list|)
throws|throws
name|SAXException
block|{
name|stack
operator|.
name|pop
argument_list|()
expr_stmt|;
if|if
condition|(
literal|"meta"
operator|.
name|equals
argument_list|(
name|localName
argument_list|)
condition|)
block|{
name|addDeployTime
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|localName
argument_list|)
condition|)
block|{
name|super
operator|.
name|endElement
argument_list|(
name|uri
argument_list|,
name|localName
argument_list|,
name|qName
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|characters
parameter_list|(
name|char
index|[]
name|ch
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|len
parameter_list|)
throws|throws
name|SAXException
block|{
specifier|final
name|String
name|current
init|=
name|stack
operator|.
name|peek
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|current
argument_list|)
condition|)
block|{
name|super
operator|.
name|characters
argument_list|(
name|ch
argument_list|,
name|start
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|characters
parameter_list|(
name|CharSequence
name|seq
parameter_list|)
throws|throws
name|SAXException
block|{
specifier|final
name|String
name|current
init|=
name|stack
operator|.
name|peek
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
literal|"deployed"
operator|.
name|equals
argument_list|(
name|current
argument_list|)
condition|)
block|{
name|super
operator|.
name|characters
argument_list|(
name|seq
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|addDeployTime
parameter_list|()
throws|throws
name|SAXException
block|{
name|super
operator|.
name|startElement
argument_list|(
name|DEPLOYED_ELEMENT
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|super
operator|.
name|characters
argument_list|(
name|time
argument_list|)
expr_stmt|;
name|super
operator|.
name|endElement
argument_list|(
name|DEPLOYED_ELEMENT
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

