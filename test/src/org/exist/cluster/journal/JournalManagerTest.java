begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|//$Id$
end_comment

begin_package
package|package
name|org
operator|.
name|exist
operator|.
name|cluster
operator|.
name|journal
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|junit
operator|.
name|framework
operator|.
name|TestCase
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|cluster
operator|.
name|ClusterEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|cluster
operator|.
name|CreateCollectionClusterEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|cluster
operator|.
name|RemoveClusterEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|cluster
operator|.
name|StoreClusterEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|storage
operator|.
name|DBBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|Configuration
import|;
end_import

begin_comment
comment|/**  */
end_comment

begin_class
specifier|public
class|class
name|JournalManagerTest
extends|extends
name|TestCase
block|{
name|Configuration
name|configuration
decl_stmt|;
specifier|protected
name|void
name|setUp
parameter_list|()
block|{
try|try
block|{
name|configuration
operator|=
operator|new
name|Configuration
argument_list|(
literal|"conf.xml"
argument_list|,
name|System
operator|.
name|getProperty
argument_list|(
literal|"exist.home"
argument_list|,
literal|"."
argument_list|)
argument_list|)
expr_stmt|;
name|File
name|existDir
init|=
operator|new
name|File
argument_list|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"exist.home"
argument_list|,
literal|"."
argument_list|)
argument_list|)
decl_stmt|;
name|File
name|temp
init|=
operator|new
name|File
argument_list|(
name|existDir
argument_list|,
literal|"test"
argument_list|)
decl_stmt|;
name|String
index|[]
name|files
init|=
name|temp
operator|.
name|list
argument_list|()
decl_stmt|;
if|if
condition|(
name|files
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|files
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|String
name|fName
init|=
name|files
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|fName
operator|.
name|indexOf
argument_list|(
literal|"jbx"
argument_list|)
operator|>
literal|0
condition|)
block|{
name|File
name|f
init|=
operator|new
name|File
argument_list|(
name|temp
argument_list|,
name|fName
argument_list|)
decl_stmt|;
name|f
operator|.
name|delete
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
name|fail
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|testWriteEventJournal
parameter_list|()
block|{
name|saveEvent
argument_list|(
operator|new
name|JournalManager
argument_list|(
name|configuration
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|testWriteRead
parameter_list|()
block|{
name|JournalManager
name|journal
init|=
operator|new
name|JournalManager
argument_list|(
name|configuration
argument_list|)
decl_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ClusterEvent
name|ev
init|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|0
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|testMultiShuffleWriteRead
parameter_list|()
block|{
name|JournalManager
name|journal
init|=
operator|new
name|JournalManager
argument_list|(
name|configuration
argument_list|)
decl_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test1"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test2"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test3"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ClusterEvent
name|ev
init|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|0
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|3
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test3"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|2
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test2"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|testMultiShuffleWriteReadMultiEvents
parameter_list|()
block|{
name|JournalManager
name|journal
init|=
operator|new
name|JournalManager
argument_list|(
name|configuration
argument_list|)
decl_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test1"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test2"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test3"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ClusterEvent
name|r
init|=
operator|new
name|RemoveClusterEvent
argument_list|(
literal|"doc"
argument_list|,
literal|"collection"
argument_list|)
decl_stmt|;
name|r
operator|.
name|setId
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|ClusterEvent
name|ev
init|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|0
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|3
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test3"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|2
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test2"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|RemoveClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|4
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong docNAme value"
argument_list|,
literal|"doc"
argument_list|,
operator|(
operator|(
name|RemoveClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getDocumentName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"collection"
argument_list|,
operator|(
operator|(
name|RemoveClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|testMultiShuffleWriteReadStoreDocument
parameter_list|()
block|{
name|JournalManager
name|journal
init|=
operator|new
name|JournalManager
argument_list|(
name|configuration
argument_list|)
decl_stmt|;
name|String
name|content
init|=
name|getExternalXML
argument_list|()
decl_stmt|;
name|StoreClusterEvent
name|s
init|=
operator|new
name|StoreClusterEvent
argument_list|(
name|content
argument_list|,
literal|"name"
argument_list|,
literal|"docu"
argument_list|)
decl_stmt|;
name|s
operator|.
name|setId
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test4"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test2"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test3"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|s
operator|=
operator|new
name|StoreClusterEvent
argument_list|(
name|content
argument_list|,
literal|"name2"
argument_list|,
literal|"docu2"
argument_list|)
expr_stmt|;
name|s
operator|.
name|setId
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|ClusterEvent
name|ev
init|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|0
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test3"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class "
operator|+
name|ev
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|,
name|ev
operator|instanceof
name|StoreClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|3
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
literal|"docu2"
argument_list|,
operator|(
operator|(
name|StoreClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getDocumentName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"name2"
argument_list|,
operator|(
operator|(
name|StoreClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|2
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test2"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|4
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test4"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|testMultiShuffleWriteReadWithQueue
parameter_list|()
block|{
name|JournalManager
name|journal
init|=
operator|new
name|JournalManager
argument_list|(
name|configuration
argument_list|)
decl_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test1"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test3"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test2"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ClusterEvent
name|ev
init|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|0
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|3
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test3"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|2
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test2"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|testMultiShuffleWriteReadWithRotation
parameter_list|()
block|{
name|JournalManager
name|journal
init|=
operator|new
name|JournalManager
argument_list|(
name|configuration
argument_list|)
decl_stmt|;
name|String
name|content
init|=
name|getExternalXML
argument_list|()
decl_stmt|;
name|StoreClusterEvent
name|s
init|=
operator|new
name|StoreClusterEvent
argument_list|(
name|content
argument_list|,
literal|"name"
argument_list|,
literal|"docu"
argument_list|)
decl_stmt|;
name|s
operator|.
name|setId
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test4"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test2"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test3"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|s
operator|=
operator|new
name|StoreClusterEvent
argument_list|(
name|content
argument_list|,
literal|"name2"
argument_list|,
literal|"docu2"
argument_list|)
expr_stmt|;
name|s
operator|.
name|setId
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
operator|new
name|StoreClusterEvent
argument_list|(
name|content
argument_list|,
literal|"name3"
argument_list|,
literal|"docu3"
argument_list|)
expr_stmt|;
name|s
operator|.
name|setId
argument_list|(
name|JournalIdGenerator
operator|.
name|MAX_STORED_INDEX
operator|-
literal|100
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
operator|new
name|StoreClusterEvent
argument_list|(
name|content
argument_list|,
literal|"name4"
argument_list|,
literal|"docu4"
argument_list|)
expr_stmt|;
name|s
operator|.
name|setId
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|s
operator|.
name|setCounter
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|ClusterEvent
name|ev
init|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|0
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test3"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class "
operator|+
name|ev
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|,
name|ev
operator|instanceof
name|StoreClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|3
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
literal|"docu2"
argument_list|,
operator|(
operator|(
name|StoreClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getDocumentName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"name2"
argument_list|,
operator|(
operator|(
name|StoreClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|StoreClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|2
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
literal|"docu4"
argument_list|,
operator|(
operator|(
name|StoreClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getDocumentName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"name4"
argument_list|,
operator|(
operator|(
name|StoreClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong counter"
argument_list|,
literal|2
argument_list|,
name|ev
operator|.
name|getCounter
argument_list|()
argument_list|)
expr_stmt|;
name|ev
operator|=
name|readEvent
argument_list|(
name|journal
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|4
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test4"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong lastIdSaved"
argument_list|,
literal|2
argument_list|,
name|journal
operator|.
name|getLastIdSaved
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong maxIdSaved"
argument_list|,
literal|2
argument_list|,
name|journal
operator|.
name|getMaxIdSaved
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong counter"
argument_list|,
literal|2
argument_list|,
name|journal
operator|.
name|getCounter
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|testRetrieveEvents
parameter_list|()
block|{
name|JournalManager
name|journal
init|=
operator|new
name|JournalManager
argument_list|(
name|configuration
argument_list|)
decl_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test1"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test2"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test3"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ArrayList
argument_list|<
name|ClusterEvent
argument_list|>
name|events
init|=
name|journal
operator|.
name|getNextEvents
argument_list|(
operator|new
name|int
index|[]
block|{
literal|0
block|,
literal|0
block|,
literal|1
block|}
argument_list|,
operator|new
name|int
index|[]
block|{
literal|3
block|,
literal|3
block|,
literal|1
block|}
argument_list|,
operator|new
name|Integer
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
literal|"Wrong null events"
argument_list|,
name|events
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong event size"
argument_list|,
literal|1
argument_list|,
name|events
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|int
name|idR
init|=
name|events
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|getId
argument_list|()
decl_stmt|;
name|events
operator|=
name|journal
operator|.
name|getNextEvents
argument_list|(
operator|new
name|int
index|[]
block|{
literal|0
block|,
literal|0
block|,
literal|1
block|}
argument_list|,
operator|new
name|int
index|[]
block|{
literal|3
block|,
literal|3
block|,
literal|1
block|}
argument_list|,
operator|new
name|Integer
argument_list|(
name|idR
argument_list|)
argument_list|)
expr_stmt|;
name|assertNotNull
argument_list|(
literal|"Wrong null events"
argument_list|,
name|events
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong event size"
argument_list|,
literal|4
argument_list|,
name|events
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|ClusterEvent
name|ev
init|=
name|events
operator|.
name|get
argument_list|(
literal|2
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
literal|"Wrong event class"
argument_list|,
name|ev
operator|instanceof
name|CreateCollectionClusterEvent
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong id"
argument_list|,
literal|2
argument_list|,
name|ev
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong parent value"
argument_list|,
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"Wrong collectionName value"
argument_list|,
literal|"test2"
argument_list|,
operator|(
operator|(
name|CreateCollectionClusterEvent
operator|)
name|ev
operator|)
operator|.
name|getCollectionName
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|testRotation
parameter_list|()
block|{
comment|//TODO: aggiungere test sulla rotazione....... opportuno creare una classe a parte di test.
block|}
specifier|private
name|void
name|saveEvent
parameter_list|(
name|JournalManager
name|journal
parameter_list|,
name|int
name|idTest
parameter_list|)
block|{
name|saveEvent
argument_list|(
name|journal
argument_list|,
literal|"test"
argument_list|,
name|idTest
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|saveEvent
parameter_list|(
name|JournalManager
name|journal
parameter_list|,
name|String
name|collectionName
parameter_list|,
name|int
name|idTest
parameter_list|)
block|{
name|CreateCollectionClusterEvent
name|ev
init|=
operator|new
name|CreateCollectionClusterEvent
argument_list|(
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/test"
argument_list|,
name|collectionName
argument_list|)
decl_stmt|;
name|ev
operator|.
name|setId
argument_list|(
name|idTest
argument_list|)
expr_stmt|;
name|saveEvent
argument_list|(
name|journal
argument_list|,
name|ev
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|saveEvent
parameter_list|(
name|JournalManager
name|journal
parameter_list|,
name|ClusterEvent
name|ev
parameter_list|)
block|{
try|try
block|{
name|journal
operator|.
name|enqueEvent
argument_list|(
name|ev
argument_list|)
expr_stmt|;
name|journal
operator|.
name|squeueEvent
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|fail
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|ClusterEvent
name|readEvent
parameter_list|(
name|JournalManager
name|journal
parameter_list|,
name|int
name|i
parameter_list|)
block|{
return|return
name|journal
operator|.
name|read
argument_list|(
name|i
argument_list|)
return|;
block|}
specifier|private
name|String
name|getExternalXML
parameter_list|()
block|{
return|return
literal|"<?xml version=\"1.0\"?>\n"
operator|+
literal|"\n"
operator|+
literal|"<!--    This build file sets up the example XML files provided in\n"
operator|+
literal|"        the distribution.\n"
operator|+
literal|"\n"
operator|+
literal|"        Call it with \n"
operator|+
literal|"        \n"
operator|+
literal|"        build.sh -f example-setup.xml\n"
operator|+
literal|"\n"
operator|+
literal|"        or\n"
operator|+
literal|"\n"
operator|+
literal|"        build.bat -f example-setup.xml\n"
operator|+
literal|"-->\n"
operator|+
literal|"<project basedir=\".\" default=\"store\" name=\"exist-ant-tasks\">\n"
operator|+
literal|"\n"
operator|+
literal|"\t<path id=\"classpath.core\">\n"
operator|+
literal|"\t\t<fileset dir=\"lib/core\">\n"
operator|+
literal|"\t\t\t<include name=\"*.jar\"/>\n"
operator|+
literal|"\t\t</fileset>\n"
operator|+
literal|"<pathelement path=\"exist.jar\"/>\n"
operator|+
literal|"<pathelement path=\"exist-optional.jar\"/>\n"
operator|+
literal|"\t</path>\n"
operator|+
literal|"\n"
operator|+
literal|"\t<typedef resource=\"org/exist/ant/antlib.xml\"\n"
operator|+
literal|"\t\turi=\"http://exist-db.org/ant\">\n"
operator|+
literal|"\t\t<classpath refid=\"classpath.core\"/>\n"
operator|+
literal|"\t</typedef>\n"
operator|+
literal|"\t\n"
operator|+
literal|"\t<target name=\"store\" xmlns:xmldb=\"http://exist-db.org/ant\">\n"
operator|+
literal|"<xmldb:store uri=\"xmldb:exist://localhost:8080/exist/xmlrpc"
operator|+
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/shakespeare/plays\"\n"
operator|+
literal|"\t\t\tcreatecollection=\"true\">\n"
operator|+
literal|"<fileset dir=\"samples/shakespeare\"> \n"
operator|+
literal|"<include name=\"*.xml\"/>\n"
operator|+
literal|"<include name=\"*.xsl\"/>\n"
operator|+
literal|"</fileset>\n"
operator|+
literal|"\t\t</xmldb:store>\n"
operator|+
literal|"\n"
operator|+
literal|"<xmldb:store uri=\"xmldb:exist://localhost:8080/exist/xmlrpc/"
operator|+
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/shakespeare/plays\"\n"
operator|+
literal|"\t\t\ttype=\"binary\">\n"
operator|+
literal|"\t\t\t<fileset dir=\"samples/shakespeare\">\n"
operator|+
literal|"\t\t\t\t<include name=\"*.css\"/>\n"
operator|+
literal|"\t\t\t</fileset>\n"
operator|+
literal|"\t\t</xmldb:store>\n"
operator|+
literal|"\t\t\n"
operator|+
literal|"<xmldb:store uri=\"xmldb:exist://localhost:8080/exist/xmlrpc/"
operator|+
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/library\"\n"
operator|+
literal|"\t\t\tcreatecollection=\"true\">\n"
operator|+
literal|"\t\t\t<fileset dir=\"samples\" includes=\"biblio.rdf\"/>\n"
operator|+
literal|"\t\t</xmldb:store>\n"
operator|+
literal|"\n"
operator|+
literal|"<xmldb:store uri=\"xmldb:exist://localhost:8080/exist/xmlrpc"
operator|+
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/xinclude\"\n"
operator|+
literal|"\t\t\tcreatecollection=\"true\">\n"
operator|+
literal|"\t\t\t<fileset dir=\"samples/xinclude\" includes=\"**.xml\"/>\n"
operator|+
literal|"</xmldb:store>\n"
operator|+
literal|"\n"
operator|+
literal|"<xmldb:store uri=\"xmldb:exist://localhost:8080/exist/xmlrpc"
operator|+
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"\">\n"
operator|+
literal|"<fileset dir=\"samples\" includes=\"examples.xml\"/>\n"
operator|+
literal|"</xmldb:store>\n"
operator|+
literal|"\n"
operator|+
literal|"\t\t<xmldb:store uri=\"xmldb:exist://localhost:8080/exist/xmlrpc"
operator|+
name|DBBroker
operator|.
name|ROOT_COLLECTION
operator|+
literal|"/mods\">\n"
operator|+
literal|"<fileset dir=\"mods\" includes=\"**.xml\"/>\n"
operator|+
literal|"</xmldb:store>\n"
operator|+
literal|"\t</target>\n"
operator|+
literal|"</project>"
return|;
block|}
block|}
end_class

end_unit

