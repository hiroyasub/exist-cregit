begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  *  eXist Mail Module Extension SendEmailFunction  *  Copyright (C) 2006 Adam Retter<adam.retter@devon.gov.uk>  *  www.adamretter.co.uk  *    *  This program is free software; you can redistribute it and/or  *  modify it under the terms of the GNU Lesser General Public License  *  as published by the Free Software Foundation; either version 2  *  of the License, or (at your option) any later version.  *  *  This program is distributed in the hope that it will be useful,  *  but WITHOUT ANY WARRANTY; without even the implied warranty of  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  *  GNU Lesser General Public License for more details.  *  *  You should have received a copy of the GNU Lesser General Public License  *  along with this program; if not, write to the Free Software Foundation  *  Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.  *    *  $Id: SendEmailFunction.java,v 1.12 2006/03/01 13:52:00 deliriumsky Exp $  */
end_comment

begin_package
package|package
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|modules
operator|.
name|mail
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStreamWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|PrintWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|StringWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|Socket
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Calendar
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Properties
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TimeZone
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Vector
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|dom
operator|.
name|DOMSource
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|stream
operator|.
name|StreamResult
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|Transformer
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|TransformerException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|TransformerFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|dom
operator|.
name|QName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|BasicFunction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|Cardinality
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|FunctionSignature
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|XPathException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|XQueryContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|functions
operator|.
name|system
operator|.
name|GetVersion
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|NodeValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Sequence
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|SequenceType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|BooleanValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|xquery
operator|.
name|value
operator|.
name|Type
import|;
end_import

begin_comment
comment|//send-email specific imports
end_comment

begin_import
import|import
name|org
operator|.
name|exist
operator|.
name|util
operator|.
name|Base64Encoder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Element
import|;
end_import

begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Node
import|;
end_import

begin_comment
comment|/**  * eXist Mail Module Extension SendEmailFunction  *   * The email sending functionality of the eXist Mail Module Extension that  * allows email to be sent from XQuery using either SMTP or Sendmail.    *   * @author Adam Retter<adam.retter@devon.gov.uk>  * @author Robert Walpole<robert.walpole@devon.gov.uk>  * @author Andrzej Taramina<andrzej@chaeron.com>  * @serial 2009-03-12  * @version 1.3  *  * @see org.exist.xquery.BasicFunction#BasicFunction(org.exist.xquery.XQueryContext, org.exist.xquery.FunctionSignature)  */
end_comment

begin_class
specifier|public
class|class
name|SendEmailFunction
extends|extends
name|BasicFunction
block|{
comment|// This function has been deprecated, in favour of using the JavaMail version.
specifier|private
name|String
name|charset
decl_stmt|;
specifier|public
specifier|final
specifier|static
name|FunctionSignature
name|deprecated
init|=
operator|new
name|FunctionSignature
argument_list|(
operator|new
name|QName
argument_list|(
literal|"send-email"
argument_list|,
name|MailModule
operator|.
name|NAMESPACE_URI
argument_list|,
name|MailModule
operator|.
name|PREFIX
argument_list|)
argument_list|,
literal|"Sends an email $a through the SMTP Server $b, or if $b is () tries to use the local sendmail program. $a is the email in the following format<mail><from/><reply-to/><to/><cc/><bcc/><subject/><message><text/><xhtml/></message><attachment filename=\"\" mimetype=\"\">xs:base64Binary</attachment></mail>. $c defines the charset value used in the \"Content-Type\" message header (Defaults to UTF-8)"
argument_list|,
operator|new
name|SequenceType
index|[]
block|{
operator|new
name|SequenceType
argument_list|(
name|Type
operator|.
name|NODE
argument_list|,
name|Cardinality
operator|.
name|EXACTLY_ONE
argument_list|)
block|,
operator|new
name|SequenceType
argument_list|(
name|Type
operator|.
name|STRING
argument_list|,
name|Cardinality
operator|.
name|ZERO_OR_ONE
argument_list|)
block|,
operator|new
name|SequenceType
argument_list|(
name|Type
operator|.
name|STRING
argument_list|,
name|Cardinality
operator|.
name|ZERO_OR_ONE
argument_list|)
block|}
argument_list|,
operator|new
name|SequenceType
argument_list|(
name|Type
operator|.
name|BOOLEAN
argument_list|,
name|Cardinality
operator|.
name|EXACTLY_ONE
argument_list|)
argument_list|,
literal|"Deprecated. Use the new JavaMail-based send function instead. This function will be removed at some point in the future."
argument_list|)
decl_stmt|;
comment|/** 	 * SendEmail Constructor 	 *  	 * @param context	The Context of the calling XQuery 	 */
specifier|public
name|SendEmailFunction
parameter_list|(
name|XQueryContext
name|context
parameter_list|)
block|{
name|super
argument_list|(
name|context
argument_list|,
name|deprecated
argument_list|)
expr_stmt|;
block|}
comment|/** 	 * evaluate the call to the xquery send-email function, 	 * it is really the main entry point of this class 	 *  	 * @param args		arguments from the send-email() function call 	 * @param contextSequence	the Context Sequence to operate on (not used here internally!) 	 * @return		A sequence representing the result of the send-email() function call 	 *  	 * @see org.exist.xquery.BasicFunction#eval(org.exist.xquery.value.Sequence[], org.exist.xquery.value.Sequence) 	 */
specifier|public
name|Sequence
name|eval
parameter_list|(
name|Sequence
index|[]
name|args
parameter_list|,
name|Sequence
name|contextSequence
parameter_list|)
throws|throws
name|XPathException
block|{
try|try
block|{
comment|//get the charset parameter, default to UTF-8
if|if
condition|(
operator|!
name|args
index|[
literal|2
index|]
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|charset
operator|=
name|args
index|[
literal|2
index|]
operator|.
name|getStringValue
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|charset
operator|=
literal|"UTF-8"
expr_stmt|;
block|}
comment|//Parse the XML<mail> into a mail Object
name|Mail
name|theMail
init|=
name|ParseMailXML
argument_list|(
operator|(
operator|(
name|NodeValue
operator|)
name|args
index|[
literal|0
index|]
operator|.
name|itemAt
argument_list|(
literal|0
argument_list|)
operator|)
operator|.
name|getNode
argument_list|()
argument_list|)
decl_stmt|;
comment|//Send email with Sendmail or SMTP?
if|if
condition|(
operator|!
name|args
index|[
literal|1
index|]
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|//SMTP
if|if
condition|(
name|SendSMTP
argument_list|(
name|theMail
argument_list|,
name|args
index|[
literal|1
index|]
operator|.
name|getStringValue
argument_list|()
argument_list|)
condition|)
block|{
return|return
operator|(
name|BooleanValue
operator|.
name|TRUE
operator|)
return|;
block|}
block|}
else|else
block|{
comment|//Sendmail
if|if
condition|(
name|SendSendmail
argument_list|(
name|theMail
argument_list|)
condition|)
block|{
return|return
operator|(
name|BooleanValue
operator|.
name|TRUE
operator|)
return|;
block|}
block|}
comment|//Failed to send email
return|return
operator|(
name|BooleanValue
operator|.
name|FALSE
operator|)
return|;
block|}
catch|catch
parameter_list|(
name|TransformerException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|XPathException
argument_list|(
name|this
argument_list|,
literal|"Could not Transform XHTML Message Body: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|/** 	 * Sends an email using the Operating Systems sendmail application 	 *  	 * @param aMail		A mail object representing the email to send 	 * @return		boolean value of true of false indicating success or failure to send email 	 */
specifier|private
name|boolean
name|SendSendmail
parameter_list|(
name|Mail
name|aMail
parameter_list|)
block|{
try|try
block|{
comment|//Create a vector of all Recipients, should include to, cc and bcc recipient
name|Vector
name|allrecipients
init|=
operator|new
name|Vector
argument_list|()
decl_stmt|;
name|allrecipients
operator|.
name|addAll
argument_list|(
name|aMail
operator|.
name|getTo
argument_list|()
argument_list|)
expr_stmt|;
name|allrecipients
operator|.
name|addAll
argument_list|(
name|aMail
operator|.
name|getCC
argument_list|()
argument_list|)
expr_stmt|;
name|allrecipients
operator|.
name|addAll
argument_list|(
name|aMail
operator|.
name|getBCC
argument_list|()
argument_list|)
expr_stmt|;
comment|//Get a string of all recipients email addresses
name|String
name|recipients
init|=
literal|""
decl_stmt|;
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|allrecipients
operator|.
name|size
argument_list|()
condition|;
name|x
operator|++
control|)
block|{
comment|//Check format of to address does it include a name as well as the email address?
if|if
condition|(
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
operator|.
name|indexOf
argument_list|(
literal|"<"
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|//yes, just add the email address
name|recipients
operator|+=
literal|" "
operator|+
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
operator|.
name|substring
argument_list|(
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
operator|.
name|indexOf
argument_list|(
literal|"<"
argument_list|)
operator|+
literal|1
argument_list|,
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
operator|.
name|indexOf
argument_list|(
literal|">"
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|//add the email address
name|recipients
operator|+=
literal|" "
operator|+
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
expr_stmt|;
block|}
block|}
comment|//Create a sendmail Process
name|Process
name|p
init|=
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|exec
argument_list|(
literal|"/usr/sbin/sendmail"
operator|+
name|recipients
argument_list|)
decl_stmt|;
comment|//Get a Buffered Print Writer to the Processes stdOut
name|PrintWriter
name|out
init|=
operator|new
name|PrintWriter
argument_list|(
operator|new
name|OutputStreamWriter
argument_list|(
name|p
operator|.
name|getOutputStream
argument_list|()
argument_list|,
name|charset
argument_list|)
argument_list|)
decl_stmt|;
comment|//Send the Message
name|WriteMessage
argument_list|(
name|out
argument_list|,
name|aMail
argument_list|)
expr_stmt|;
comment|//Close the stdOut
name|out
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|e
argument_list|)
expr_stmt|;
return|return
operator|(
literal|false
operator|)
return|;
block|}
comment|//Message Sent Succesfully
name|LOG
operator|.
name|info
argument_list|(
literal|"send-email() message sent using Sendmail "
operator|+
operator|new
name|Date
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|(
literal|true
operator|)
return|;
block|}
comment|/** 	 * Sends an email using SMTP 	 *  	 * @param aMail		A mail object representing the email to send 	 * @param SMTPServer	The SMTP Server to send the email through 	 * @return		boolean value of true of false indicating success or failure to send email 	 */
specifier|private
name|boolean
name|SendSMTP
parameter_list|(
name|Mail
name|aMail
parameter_list|,
name|String
name|SMTPServer
parameter_list|)
block|{
specifier|final
name|int
name|TCP_PROTOCOL_SMTP
init|=
literal|25
decl_stmt|;
comment|//SMTP Protocol
name|String
name|SMTPResult
init|=
literal|""
decl_stmt|;
comment|//Holds the server Result code when an SMTP Command is executed
try|try
block|{
comment|//Create a Socket and connect to the SMTP Server
name|Socket
name|smtpSock
init|=
operator|new
name|Socket
argument_list|(
name|SMTPServer
argument_list|,
name|TCP_PROTOCOL_SMTP
argument_list|)
decl_stmt|;
comment|//Create a Buffered Reader for the Socket
name|BufferedReader
name|in
init|=
operator|new
name|BufferedReader
argument_list|(
operator|new
name|InputStreamReader
argument_list|(
name|smtpSock
operator|.
name|getInputStream
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
comment|//Create an Output Writer for the Socket
name|PrintWriter
name|out
init|=
operator|new
name|PrintWriter
argument_list|(
operator|new
name|OutputStreamWriter
argument_list|(
name|smtpSock
operator|.
name|getOutputStream
argument_list|()
argument_list|,
name|charset
argument_list|)
argument_list|)
decl_stmt|;
comment|//First line sent to us from the SMTP server should be "220 blah blah", 220 indicates okay
name|SMTPResult
operator|=
name|in
operator|.
name|readLine
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|SMTPResult
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|3
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|"220"
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error - SMTP Server not ready!"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|false
operator|)
return|;
block|}
comment|//Say "HELO"
name|out
operator|.
name|println
argument_list|(
literal|"HELO "
operator|+
name|InetAddress
operator|.
name|getLocalHost
argument_list|()
operator|.
name|getHostName
argument_list|()
argument_list|)
expr_stmt|;
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
comment|//get "HELLO" response, should be "250 blah blah"
name|SMTPResult
operator|=
name|in
operator|.
name|readLine
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|SMTPResult
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|3
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|"250"
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error - SMTP HELO Failed: "
operator|+
name|SMTPResult
argument_list|)
expr_stmt|;
return|return
operator|(
literal|false
operator|)
return|;
block|}
comment|//Send "MAIL FROM:"
comment|//Check format of from address does it include a name as well as the email address?
if|if
condition|(
name|aMail
operator|.
name|getFrom
argument_list|()
operator|.
name|indexOf
argument_list|(
literal|"<"
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|//yes, just send the email address
name|out
operator|.
name|println
argument_list|(
literal|"MAIL FROM: "
operator|+
name|aMail
operator|.
name|getFrom
argument_list|()
operator|.
name|substring
argument_list|(
name|aMail
operator|.
name|getFrom
argument_list|()
operator|.
name|indexOf
argument_list|(
literal|"<"
argument_list|)
operator|+
literal|1
argument_list|,
name|aMail
operator|.
name|getFrom
argument_list|()
operator|.
name|indexOf
argument_list|(
literal|">"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|//no, doesnt include a name so send the email address
name|out
operator|.
name|println
argument_list|(
literal|"MAIL FROM: "
operator|+
name|aMail
operator|.
name|getFrom
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
comment|//Get "MAIL FROM:" response
name|SMTPResult
operator|=
name|in
operator|.
name|readLine
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|SMTPResult
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|3
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|"250"
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error - SMTP MAIL FROM failed: "
operator|+
name|SMTPResult
argument_list|)
expr_stmt|;
return|return
operator|(
literal|false
operator|)
return|;
block|}
comment|//RCPT TO should be issued for each to, cc and bcc recipient
name|Vector
name|allrecipients
init|=
operator|new
name|Vector
argument_list|()
decl_stmt|;
name|allrecipients
operator|.
name|addAll
argument_list|(
name|aMail
operator|.
name|getTo
argument_list|()
argument_list|)
expr_stmt|;
name|allrecipients
operator|.
name|addAll
argument_list|(
name|aMail
operator|.
name|getCC
argument_list|()
argument_list|)
expr_stmt|;
name|allrecipients
operator|.
name|addAll
argument_list|(
name|aMail
operator|.
name|getBCC
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|allrecipients
operator|.
name|size
argument_list|()
condition|;
name|x
operator|++
control|)
block|{
comment|//Send "RCPT TO:"
comment|//Check format of to address does it include a name as well as the email address?
if|if
condition|(
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
operator|.
name|indexOf
argument_list|(
literal|"<"
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|//yes, just send the email address
name|out
operator|.
name|println
argument_list|(
literal|"RCPT TO: "
operator|+
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
operator|.
name|substring
argument_list|(
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
operator|.
name|indexOf
argument_list|(
literal|"<"
argument_list|)
operator|+
literal|1
argument_list|,
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
operator|.
name|indexOf
argument_list|(
literal|">"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|out
operator|.
name|println
argument_list|(
literal|"RCPT TO: "
operator|+
operator|(
operator|(
name|String
operator|)
name|allrecipients
operator|.
name|elementAt
argument_list|(
name|x
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
comment|//Get "RCPT TO:" response
name|SMTPResult
operator|=
name|in
operator|.
name|readLine
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|SMTPResult
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|3
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|"250"
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error - SMTP RCPT TO failed: "
operator|+
name|SMTPResult
argument_list|)
expr_stmt|;
block|}
block|}
comment|//SEND "DATA"
name|out
operator|.
name|println
argument_list|(
literal|"DATA"
argument_list|)
expr_stmt|;
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
comment|//Get "DATA" response, should be "354 blah blah"
name|SMTPResult
operator|=
name|in
operator|.
name|readLine
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|SMTPResult
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|3
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|"354"
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error - SMTP DATA failed: "
operator|+
name|SMTPResult
argument_list|)
expr_stmt|;
return|return
operator|(
literal|false
operator|)
return|;
block|}
comment|//Send the Message
name|WriteMessage
argument_list|(
name|out
argument_list|,
name|aMail
argument_list|)
expr_stmt|;
comment|//Get end message response, should be "250 blah blah"
name|SMTPResult
operator|=
name|in
operator|.
name|readLine
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|SMTPResult
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
literal|3
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|"250"
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error - Message not accepted: "
operator|+
name|SMTPResult
argument_list|)
expr_stmt|;
return|return
operator|(
literal|false
operator|)
return|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|e
argument_list|)
expr_stmt|;
return|return
operator|(
literal|false
operator|)
return|;
block|}
comment|//Message Sent Succesfully
name|LOG
operator|.
name|info
argument_list|(
literal|"send-email() message sent using SMTP "
operator|+
operator|new
name|Date
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|(
literal|true
operator|)
return|;
block|}
comment|/** 	 * Writes an email payload (Headers + Body) from a mail object 	 *  	 * @param out		A PrintWriter to receive the email 	 * @param aMail		A mail object representing the email to write out		 	 */
specifier|private
name|void
name|WriteMessage
parameter_list|(
name|PrintWriter
name|out
parameter_list|,
name|Mail
name|aMail
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|Version
init|=
name|eXistVersion
argument_list|()
decl_stmt|;
comment|//Version of eXist
name|String
name|MultipartBoundary
init|=
literal|"eXist.multipart."
operator|+
name|Version
decl_stmt|;
comment|//Multipart Boundary
comment|//write the message headers
name|out
operator|.
name|println
argument_list|(
literal|"From: "
operator|+
name|encode64Address
argument_list|(
name|aMail
operator|.
name|getFrom
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|aMail
operator|.
name|getReplyTo
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"Reply-To: "
operator|+
name|encode64Address
argument_list|(
name|aMail
operator|.
name|getReplyTo
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|aMail
operator|.
name|countTo
argument_list|()
condition|;
name|x
operator|++
control|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"To: "
operator|+
name|encode64Address
argument_list|(
name|aMail
operator|.
name|getTo
argument_list|(
name|x
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|aMail
operator|.
name|countCC
argument_list|()
condition|;
name|x
operator|++
control|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"CC: "
operator|+
name|encode64Address
argument_list|(
name|aMail
operator|.
name|getCC
argument_list|(
name|x
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|aMail
operator|.
name|countBCC
argument_list|()
condition|;
name|x
operator|++
control|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"BCC: "
operator|+
name|encode64Address
argument_list|(
name|aMail
operator|.
name|getBCC
argument_list|(
name|x
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|out
operator|.
name|println
argument_list|(
literal|"Date: "
operator|+
name|getDateRFC822
argument_list|()
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Subject: "
operator|+
name|encode64
argument_list|(
name|aMail
operator|.
name|getSubject
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"X-Mailer: eXist "
operator|+
name|Version
operator|+
literal|" util:send-email()"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"MIME-Version: 1.0"
argument_list|)
expr_stmt|;
name|boolean
name|multipartAlternative
init|=
literal|false
decl_stmt|;
name|String
name|multipartBoundary
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|aMail
operator|.
name|attachmentIterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
comment|// we have an attachment as well as text and/or html so we need a multipart/mixed message
name|multipartBoundary
operator|=
name|MultipartBoundary
expr_stmt|;
block|}
if|else if
condition|(
operator|!
name|aMail
operator|.
name|getText
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
operator|!
name|aMail
operator|.
name|getXHTML
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
comment|// we have text and html so we need a multipart/alternative message and no attachment
name|multipartAlternative
operator|=
literal|true
expr_stmt|;
name|multipartBoundary
operator|=
name|MultipartBoundary
operator|+
literal|"_alt"
expr_stmt|;
block|}
else|else
block|{
comment|// we have either text or html and no attachment this message is not multipart
block|}
comment|//content type
if|if
condition|(
name|multipartBoundary
operator|!=
literal|null
condition|)
block|{
comment|//multipart message
name|out
operator|.
name|println
argument_list|(
literal|"Content-Type: "
operator|+
operator|(
name|multipartAlternative
condition|?
literal|"multipart/alternative"
else|:
literal|"multipart/mixed"
operator|)
operator|+
literal|"; boundary=\""
operator|+
name|multipartBoundary
operator|+
literal|"\";"
argument_list|)
expr_stmt|;
comment|//Mime warning
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Error your mail client is not MIME Compatible"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|multipartBoundary
argument_list|)
expr_stmt|;
block|}
comment|// TODO - need to put out a multipart/mixed boundary here when HTML, text and attachment present
if|if
condition|(
operator|!
name|aMail
operator|.
name|getText
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
operator|!
name|aMail
operator|.
name|getXHTML
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
name|aMail
operator|.
name|attachmentIterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"Content-Type: multipart/alternative; boundary=\""
operator|+
name|MultipartBoundary
operator|+
literal|"_alt\";"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|MultipartBoundary
operator|+
literal|"_alt"
argument_list|)
expr_stmt|;
block|}
comment|//text email
if|if
condition|(
operator|!
name|aMail
operator|.
name|getText
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"Content-Type: text/plain; charset="
operator|+
name|charset
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Content-Transfer-Encoding: 8bit"
argument_list|)
expr_stmt|;
comment|//now send the txt message
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
name|aMail
operator|.
name|getText
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|multipartBoundary
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
operator|!
name|aMail
operator|.
name|getXHTML
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|||
name|aMail
operator|.
name|attachmentIterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|aMail
operator|.
name|getText
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
operator|!
name|aMail
operator|.
name|getXHTML
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
name|aMail
operator|.
name|attachmentIterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|MultipartBoundary
operator|+
literal|"_alt"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|multipartBoundary
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|aMail
operator|.
name|getText
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
operator|!
name|aMail
operator|.
name|getXHTML
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
name|aMail
operator|.
name|attachmentIterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|MultipartBoundary
operator|+
literal|"_alt--"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|multipartBoundary
operator|+
literal|"--"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|//HTML email
if|if
condition|(
operator|!
name|aMail
operator|.
name|getXHTML
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"Content-Type: text/html; charset="
operator|+
name|charset
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Content-Transfer-Encoding: 8bit"
argument_list|)
expr_stmt|;
comment|//now send the html message
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\" \"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd\">"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
name|aMail
operator|.
name|getXHTML
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|multipartBoundary
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|aMail
operator|.
name|attachmentIterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|aMail
operator|.
name|getText
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
operator|!
name|aMail
operator|.
name|getXHTML
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
name|aMail
operator|.
name|attachmentIterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|MultipartBoundary
operator|+
literal|"_alt--"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|multipartBoundary
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|multipartBoundary
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|aMail
operator|.
name|getText
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
operator|!
name|aMail
operator|.
name|getXHTML
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
operator|&&
name|aMail
operator|.
name|attachmentIterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|MultipartBoundary
operator|+
literal|"_alt--"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|multipartBoundary
operator|+
literal|"--"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|//attachments
if|if
condition|(
name|aMail
operator|.
name|attachmentIterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
for|for
control|(
name|Iterator
name|itAttachment
init|=
name|aMail
operator|.
name|attachmentIterator
argument_list|()
init|;
name|itAttachment
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|MailAttachment
name|ma
init|=
operator|(
name|MailAttachment
operator|)
name|itAttachment
operator|.
name|next
argument_list|()
decl_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Content-Type: "
operator|+
name|ma
operator|.
name|getMimeType
argument_list|()
operator|+
literal|"; name=\""
operator|+
name|ma
operator|.
name|getFilename
argument_list|()
operator|+
literal|"\""
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Content-Transfer-Encoding: base64"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Content-Description: "
operator|+
name|ma
operator|.
name|getFilename
argument_list|()
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Content-Disposition: attachment; filname=\""
operator|+
name|ma
operator|.
name|getFilename
argument_list|()
operator|+
literal|"\""
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
name|ma
operator|.
name|getData
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|itAttachment
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|multipartBoundary
argument_list|)
expr_stmt|;
block|}
block|}
comment|//Emd multipart message
name|out
operator|.
name|println
argument_list|(
literal|"--"
operator|+
name|multipartBoundary
operator|+
literal|"--"
argument_list|)
expr_stmt|;
block|}
comment|//end the message,<cr><lf>.<cr><lf>
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
comment|/** 	 * Get's the version of eXist we are running 	 * The eXist version is used as part of the multipart separator 	 *  	 * @return		The eXist Version 	 */
specifier|private
name|String
name|eXistVersion
parameter_list|()
throws|throws
name|IOException
block|{
name|Properties
name|sysProperties
init|=
operator|new
name|Properties
argument_list|()
decl_stmt|;
name|sysProperties
operator|.
name|load
argument_list|(
name|GetVersion
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
operator|.
name|getResourceAsStream
argument_list|(
literal|"org/exist/system.properties"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|String
operator|)
name|sysProperties
operator|.
name|getProperty
argument_list|(
literal|"product-version"
argument_list|,
literal|"unknown version"
argument_list|)
operator|)
return|;
block|}
comment|/** 	 * Constructs a mail Object from an XML representation of an email 	 *  	 * The XML email Representation is expected to look something like this 	 *  	 *<mail> 	 *<from></from> 	 *<reply-to></reply-to> 	 *<to></to> 	 *<cc></cc> 	 *<bcc></bcc> 	 *<subject></subject> 	 *<message> 	 *<text></text> 	 *<xhtml></xhtml> 	 *</message> 	 *</mail> 	 *  	 * @param message	The XML mail Node 	 * @return		A mail Object representing the XML mail Node 	 */
specifier|private
name|Mail
name|ParseMailXML
parameter_list|(
name|Node
name|message
parameter_list|)
throws|throws
name|TransformerException
block|{
comment|//New mail Object
name|Mail
name|theMail
init|=
operator|new
name|Mail
argument_list|()
decl_stmt|;
comment|//Make sure that message has a Mail node
if|if
condition|(
name|message
operator|.
name|getNodeType
argument_list|()
operator|==
name|Node
operator|.
name|ELEMENT_NODE
operator|&&
name|message
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"mail"
argument_list|)
condition|)
block|{
comment|//Get the First Child
name|Node
name|child
init|=
name|message
operator|.
name|getFirstChild
argument_list|()
decl_stmt|;
while|while
condition|(
name|child
operator|!=
literal|null
condition|)
block|{
comment|//Parse each of the child nodes
if|if
condition|(
name|child
operator|.
name|getNodeType
argument_list|()
operator|==
name|Node
operator|.
name|ELEMENT_NODE
operator|&&
name|child
operator|.
name|hasChildNodes
argument_list|()
condition|)
block|{
if|if
condition|(
name|child
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"from"
argument_list|)
condition|)
block|{
name|theMail
operator|.
name|setFrom
argument_list|(
name|child
operator|.
name|getFirstChild
argument_list|()
operator|.
name|getNodeValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|child
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"reply-to"
argument_list|)
condition|)
block|{
name|theMail
operator|.
name|setReplyTo
argument_list|(
name|child
operator|.
name|getFirstChild
argument_list|()
operator|.
name|getNodeValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|child
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"to"
argument_list|)
condition|)
block|{
name|theMail
operator|.
name|addTo
argument_list|(
name|child
operator|.
name|getFirstChild
argument_list|()
operator|.
name|getNodeValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|child
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"cc"
argument_list|)
condition|)
block|{
name|theMail
operator|.
name|addCC
argument_list|(
name|child
operator|.
name|getFirstChild
argument_list|()
operator|.
name|getNodeValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|child
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"bcc"
argument_list|)
condition|)
block|{
name|theMail
operator|.
name|addBCC
argument_list|(
name|child
operator|.
name|getFirstChild
argument_list|()
operator|.
name|getNodeValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|child
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"subject"
argument_list|)
condition|)
block|{
name|theMail
operator|.
name|setSubject
argument_list|(
name|child
operator|.
name|getFirstChild
argument_list|()
operator|.
name|getNodeValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|child
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"message"
argument_list|)
condition|)
block|{
comment|//If the message node, then parse the child text and xhtml nodes
name|Node
name|bodyPart
init|=
name|child
operator|.
name|getFirstChild
argument_list|()
decl_stmt|;
while|while
condition|(
name|bodyPart
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|bodyPart
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"text"
argument_list|)
condition|)
block|{
name|theMail
operator|.
name|setText
argument_list|(
name|bodyPart
operator|.
name|getFirstChild
argument_list|()
operator|.
name|getNodeValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|bodyPart
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"xhtml"
argument_list|)
condition|)
block|{
comment|//Convert everything inside<xhtml></xhtml> to text
name|TransformerFactory
name|transFactory
init|=
name|TransformerFactory
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|Transformer
name|transformer
init|=
name|transFactory
operator|.
name|newTransformer
argument_list|()
decl_stmt|;
name|DOMSource
name|source
init|=
operator|new
name|DOMSource
argument_list|(
name|bodyPart
operator|.
name|getFirstChild
argument_list|()
argument_list|)
decl_stmt|;
name|StringWriter
name|strWriter
init|=
operator|new
name|StringWriter
argument_list|()
decl_stmt|;
name|StreamResult
name|result
init|=
operator|new
name|StreamResult
argument_list|(
name|strWriter
argument_list|)
decl_stmt|;
name|transformer
operator|.
name|transform
argument_list|(
name|source
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|theMail
operator|.
name|setXHTML
argument_list|(
name|strWriter
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|//next body part
name|bodyPart
operator|=
name|bodyPart
operator|.
name|getNextSibling
argument_list|()
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|child
operator|.
name|getLocalName
argument_list|()
operator|.
name|equals
argument_list|(
literal|"attachment"
argument_list|)
condition|)
block|{
name|Element
name|attachment
init|=
operator|(
name|Element
operator|)
name|child
decl_stmt|;
name|MailAttachment
name|ma
init|=
operator|new
name|MailAttachment
argument_list|(
name|attachment
operator|.
name|getAttribute
argument_list|(
literal|"filename"
argument_list|)
argument_list|,
name|attachment
operator|.
name|getAttribute
argument_list|(
literal|"mimetype"
argument_list|)
argument_list|,
name|attachment
operator|.
name|getFirstChild
argument_list|()
operator|.
name|getNodeValue
argument_list|()
argument_list|)
decl_stmt|;
name|theMail
operator|.
name|addAttachment
argument_list|(
name|ma
argument_list|)
expr_stmt|;
block|}
block|}
comment|//next node
name|child
operator|=
name|child
operator|.
name|getNextSibling
argument_list|()
expr_stmt|;
block|}
block|}
comment|//Return the mail object
return|return
operator|(
name|theMail
operator|)
return|;
block|}
comment|/** 	 * Returns the current date and time in an RFC822 format, suitable for an email Date Header 	 *  	 * @return		RFC822 formated date and time as a String 	 */
specifier|private
name|String
name|getDateRFC822
parameter_list|()
block|{
name|String
name|dateString
init|=
operator|new
name|String
argument_list|()
decl_stmt|;
name|Calendar
name|rightNow
init|=
name|Calendar
operator|.
name|getInstance
argument_list|()
decl_stmt|;
comment|//Day of the week
switch|switch
condition|(
name|rightNow
operator|.
name|get
argument_list|(
name|Calendar
operator|.
name|DAY_OF_WEEK
argument_list|)
condition|)
block|{
case|case
name|Calendar
operator|.
name|MONDAY
case|:
block|{
name|dateString
operator|=
literal|"Mon"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|TUESDAY
case|:
block|{
name|dateString
operator|=
literal|"Tue"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|WEDNESDAY
case|:
block|{
name|dateString
operator|=
literal|"Wed"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|THURSDAY
case|:
block|{
name|dateString
operator|=
literal|"Thu"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|FRIDAY
case|:
block|{
name|dateString
operator|=
literal|"Fri"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|SATURDAY
case|:
block|{
name|dateString
operator|=
literal|"Sat"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|SUNDAY
case|:
block|{
name|dateString
operator|=
literal|"Sun"
expr_stmt|;
break|break;
block|}
block|}
name|dateString
operator|+=
literal|", "
expr_stmt|;
comment|//Date
name|dateString
operator|+=
name|rightNow
operator|.
name|get
argument_list|(
name|Calendar
operator|.
name|DAY_OF_MONTH
argument_list|)
expr_stmt|;
name|dateString
operator|+=
literal|" "
expr_stmt|;
comment|//Month
switch|switch
condition|(
name|rightNow
operator|.
name|get
argument_list|(
name|Calendar
operator|.
name|MONTH
argument_list|)
condition|)
block|{
case|case
name|Calendar
operator|.
name|JANUARY
case|:
block|{
name|dateString
operator|+=
literal|"Jan"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|FEBRUARY
case|:
block|{
name|dateString
operator|+=
literal|"Feb"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|MARCH
case|:
block|{
name|dateString
operator|+=
literal|"Mar"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|APRIL
case|:
block|{
name|dateString
operator|+=
literal|"Apr"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|MAY
case|:
block|{
name|dateString
operator|+=
literal|"May"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|JUNE
case|:
block|{
name|dateString
operator|+=
literal|"Jun"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|JULY
case|:
block|{
name|dateString
operator|+=
literal|"Jul"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|AUGUST
case|:
block|{
name|dateString
operator|+=
literal|"Aug"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|SEPTEMBER
case|:
block|{
name|dateString
operator|+=
literal|"Sep"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|OCTOBER
case|:
block|{
name|dateString
operator|+=
literal|"Oct"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|NOVEMBER
case|:
block|{
name|dateString
operator|+=
literal|"Nov"
expr_stmt|;
break|break;
block|}
case|case
name|Calendar
operator|.
name|DECEMBER
case|:
block|{
name|dateString
operator|+=
literal|"Dec"
expr_stmt|;
break|break;
block|}
block|}
name|dateString
operator|+=
literal|" "
expr_stmt|;
comment|//Year
name|dateString
operator|+=
name|rightNow
operator|.
name|get
argument_list|(
name|Calendar
operator|.
name|YEAR
argument_list|)
expr_stmt|;
name|dateString
operator|+=
literal|" "
expr_stmt|;
comment|//Time
name|String
name|tHour
init|=
name|Integer
operator|.
name|toString
argument_list|(
name|rightNow
operator|.
name|get
argument_list|(
name|Calendar
operator|.
name|HOUR_OF_DAY
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|tHour
operator|.
name|length
argument_list|()
operator|==
literal|1
condition|)
block|{
name|tHour
operator|=
literal|"0"
operator|+
name|tHour
expr_stmt|;
block|}
name|String
name|tMinute
init|=
name|Integer
operator|.
name|toString
argument_list|(
name|rightNow
operator|.
name|get
argument_list|(
name|Calendar
operator|.
name|MINUTE
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|tMinute
operator|.
name|length
argument_list|()
operator|==
literal|1
condition|)
block|{
name|tMinute
operator|=
literal|"0"
operator|+
name|tMinute
expr_stmt|;
block|}
name|String
name|tSecond
init|=
name|Integer
operator|.
name|toString
argument_list|(
name|rightNow
operator|.
name|get
argument_list|(
name|Calendar
operator|.
name|SECOND
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|tSecond
operator|.
name|length
argument_list|()
operator|==
literal|1
condition|)
block|{
name|tSecond
operator|=
literal|"0"
operator|+
name|tSecond
expr_stmt|;
block|}
name|dateString
operator|+=
name|tHour
operator|+
literal|":"
operator|+
name|tMinute
operator|+
literal|":"
operator|+
name|tSecond
operator|+
literal|" "
expr_stmt|;
comment|//TimeZone Correction
name|String
name|tzSign
init|=
operator|new
name|String
argument_list|()
decl_stmt|;
name|String
name|tzHours
init|=
operator|new
name|String
argument_list|()
decl_stmt|;
name|String
name|tzMinutes
init|=
operator|new
name|String
argument_list|()
decl_stmt|;
name|TimeZone
name|thisTZ
init|=
name|TimeZone
operator|.
name|getDefault
argument_list|()
decl_stmt|;
name|int
name|TZOffset
init|=
name|thisTZ
operator|.
name|getOffset
argument_list|(
name|rightNow
operator|.
name|get
argument_list|(
name|Calendar
operator|.
name|DATE
argument_list|)
argument_list|)
decl_stmt|;
comment|//get timezone offset in milliseconds
name|TZOffset
operator|=
operator|(
name|TZOffset
operator|/
literal|1000
operator|)
expr_stmt|;
comment|//convert to seconds
name|TZOffset
operator|=
operator|(
name|TZOffset
operator|/
literal|60
operator|)
expr_stmt|;
comment|//convert to minutes
comment|//Sign
if|if
condition|(
name|TZOffset
operator|>
literal|1
condition|)
block|{
name|tzSign
operator|=
literal|"+"
expr_stmt|;
block|}
else|else
block|{
name|tzSign
operator|=
literal|"-"
expr_stmt|;
block|}
comment|//Calc Hours and Minutes?
if|if
condition|(
name|TZOffset
operator|>=
literal|60
operator|||
name|TZOffset
operator|<=
operator|-
literal|60
condition|)
block|{
comment|//Minutes and Hours
name|tzHours
operator|+=
operator|(
name|TZOffset
operator|/
literal|60
operator|)
expr_stmt|;
comment|//hours
if|if
condition|(
name|tzHours
operator|.
name|length
argument_list|()
operator|==
literal|1
condition|)
comment|// do we need to prepend a 0
block|{
name|tzHours
operator|=
literal|"0"
operator|+
name|tzHours
expr_stmt|;
block|}
name|tzMinutes
operator|+=
operator|(
name|TZOffset
operator|%
literal|60
operator|)
expr_stmt|;
comment|//minutes
if|if
condition|(
name|tzMinutes
operator|.
name|length
argument_list|()
operator|==
literal|1
condition|)
comment|// do we need to prepend a 0
block|{
name|tzMinutes
operator|=
literal|"0"
operator|+
name|tzMinutes
expr_stmt|;
block|}
block|}
else|else
block|{
comment|//Just Minutes
name|tzHours
operator|=
literal|"00"
expr_stmt|;
name|tzMinutes
operator|+=
name|TZOffset
expr_stmt|;
if|if
condition|(
name|tzMinutes
operator|.
name|length
argument_list|()
operator|==
literal|1
condition|)
comment|// do we need to prepend a 0
block|{
name|tzMinutes
operator|=
literal|"0"
operator|+
name|tzMinutes
expr_stmt|;
block|}
block|}
name|dateString
operator|+=
name|tzSign
operator|+
name|tzHours
operator|+
name|tzMinutes
expr_stmt|;
return|return
operator|(
name|dateString
operator|)
return|;
block|}
comment|/** 	 * Base64 Encodes a string (used for message subject) 	 *  	 * @param str	The String to encode 	 * @return		The encoded String 	 */
specifier|private
name|String
name|encode64
parameter_list|(
name|String
name|str
parameter_list|)
throws|throws
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
block|{
name|Base64Encoder
name|enc
init|=
operator|new
name|Base64Encoder
argument_list|()
decl_stmt|;
name|enc
operator|.
name|translate
argument_list|(
name|str
operator|.
name|getBytes
argument_list|(
name|charset
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|result
init|=
operator|new
name|String
argument_list|(
name|enc
operator|.
name|getCharArray
argument_list|()
argument_list|)
decl_stmt|;
name|result
operator|=
name|result
operator|.
name|replaceAll
argument_list|(
literal|"\n"
argument_list|,
literal|"?=\n =?"
operator|+
name|charset
operator|+
literal|"?B?"
argument_list|)
expr_stmt|;
name|result
operator|=
literal|"=?"
operator|+
name|charset
operator|+
literal|"?B?"
operator|+
name|result
operator|+
literal|"?="
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/** 	 * Base64 Encodes an email address 	 *  	 * @param str	The email address as a String to encode 	 * @return		The encoded email address String 	 */
specifier|private
name|String
name|encode64Address
parameter_list|(
name|String
name|str
parameter_list|)
throws|throws
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
block|{
name|String
name|result
decl_stmt|;
name|int
name|idx
init|=
name|str
operator|.
name|indexOf
argument_list|(
literal|"<"
argument_list|)
decl_stmt|;
if|if
condition|(
name|idx
operator|!=
operator|-
literal|1
condition|)
block|{
name|result
operator|=
name|encode64
argument_list|(
name|str
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|idx
argument_list|)
argument_list|)
operator|+
literal|" "
operator|+
name|str
operator|.
name|substring
argument_list|(
name|idx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|str
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/** 	 * A simple data class to represent an email 	 * attachment. Just has private 	 * members and some get methods. 	 *  	 * @version 1.2 	 */
specifier|private
class|class
name|MailAttachment
block|{
specifier|private
name|String
name|filename
decl_stmt|;
specifier|private
name|String
name|mimeType
decl_stmt|;
specifier|private
name|String
name|data
decl_stmt|;
specifier|public
name|MailAttachment
parameter_list|(
name|String
name|filename
parameter_list|,
name|String
name|mimeType
parameter_list|,
name|String
name|data
parameter_list|)
block|{
name|this
operator|.
name|filename
operator|=
name|filename
expr_stmt|;
name|this
operator|.
name|mimeType
operator|=
name|mimeType
expr_stmt|;
name|this
operator|.
name|data
operator|=
name|data
expr_stmt|;
block|}
specifier|public
name|String
name|getData
parameter_list|()
block|{
return|return
name|data
return|;
block|}
specifier|public
name|String
name|getFilename
parameter_list|()
block|{
return|return
name|filename
return|;
block|}
specifier|public
name|String
name|getMimeType
parameter_list|()
block|{
return|return
name|mimeType
return|;
block|}
block|}
comment|/** 	 * A simple data class to represent an email 	 * doesnt do anything fancy just has private 	 * members and get and set methods 	 *  	 * @version 1.2 	 */
specifier|private
class|class
name|Mail
block|{
specifier|private
name|String
name|from
init|=
literal|""
decl_stmt|;
comment|//Who is the mail from
specifier|private
name|String
name|replyTo
init|=
literal|null
decl_stmt|;
comment|//Who should you reply to
specifier|private
name|Vector
name|to
init|=
operator|new
name|Vector
argument_list|()
decl_stmt|;
comment|//Who is the mail going to
specifier|private
name|Vector
name|cc
init|=
operator|new
name|Vector
argument_list|()
decl_stmt|;
comment|//Carbon Copy to
specifier|private
name|Vector
name|bcc
init|=
operator|new
name|Vector
argument_list|()
decl_stmt|;
comment|//Blind Carbon Copy to
specifier|private
name|String
name|subject
init|=
literal|""
decl_stmt|;
comment|//Subject of the mail
specifier|private
name|String
name|text
init|=
literal|""
decl_stmt|;
comment|//Body text of the mail
specifier|private
name|String
name|xhtml
init|=
literal|""
decl_stmt|;
comment|//Body XHTML of the mail
specifier|private
name|Vector
name|attachment
init|=
operator|new
name|Vector
argument_list|()
decl_stmt|;
comment|//Any attachments
comment|//From
specifier|public
name|void
name|setFrom
parameter_list|(
name|String
name|from
parameter_list|)
block|{
name|this
operator|.
name|from
operator|=
name|from
expr_stmt|;
block|}
specifier|public
name|String
name|getFrom
parameter_list|()
block|{
return|return
operator|(
name|this
operator|.
name|from
operator|)
return|;
block|}
comment|//reply-to
specifier|public
name|void
name|setReplyTo
parameter_list|(
name|String
name|replyTo
parameter_list|)
block|{
name|this
operator|.
name|replyTo
operator|=
name|replyTo
expr_stmt|;
block|}
specifier|public
name|String
name|getReplyTo
parameter_list|()
block|{
return|return
name|replyTo
return|;
block|}
comment|//To
specifier|public
name|void
name|addTo
parameter_list|(
name|String
name|to
parameter_list|)
block|{
name|this
operator|.
name|to
operator|.
name|addElement
argument_list|(
name|to
argument_list|)
expr_stmt|;
block|}
specifier|public
name|int
name|countTo
parameter_list|()
block|{
return|return
operator|(
name|to
operator|.
name|size
argument_list|()
operator|)
return|;
block|}
specifier|public
name|String
name|getTo
parameter_list|(
name|int
name|index
parameter_list|)
block|{
return|return
operator|(
operator|(
name|String
operator|)
name|to
operator|.
name|elementAt
argument_list|(
name|index
argument_list|)
operator|)
return|;
block|}
specifier|public
name|Collection
name|getTo
parameter_list|()
block|{
return|return
operator|(
name|to
operator|)
return|;
block|}
comment|//CC
specifier|public
name|void
name|addCC
parameter_list|(
name|String
name|cc
parameter_list|)
block|{
name|this
operator|.
name|cc
operator|.
name|addElement
argument_list|(
name|cc
argument_list|)
expr_stmt|;
block|}
specifier|public
name|int
name|countCC
parameter_list|()
block|{
return|return
operator|(
name|cc
operator|.
name|size
argument_list|()
operator|)
return|;
block|}
specifier|public
name|String
name|getCC
parameter_list|(
name|int
name|index
parameter_list|)
block|{
return|return
operator|(
operator|(
name|String
operator|)
name|cc
operator|.
name|elementAt
argument_list|(
name|index
argument_list|)
operator|)
return|;
block|}
specifier|public
name|Collection
name|getCC
parameter_list|()
block|{
return|return
operator|(
name|cc
operator|)
return|;
block|}
comment|//BCC
specifier|public
name|void
name|addBCC
parameter_list|(
name|String
name|bcc
parameter_list|)
block|{
name|this
operator|.
name|bcc
operator|.
name|addElement
argument_list|(
name|bcc
argument_list|)
expr_stmt|;
block|}
specifier|public
name|int
name|countBCC
parameter_list|()
block|{
return|return
operator|(
name|bcc
operator|.
name|size
argument_list|()
operator|)
return|;
block|}
specifier|public
name|String
name|getBCC
parameter_list|(
name|int
name|index
parameter_list|)
block|{
return|return
operator|(
operator|(
name|String
operator|)
name|bcc
operator|.
name|elementAt
argument_list|(
name|index
argument_list|)
operator|)
return|;
block|}
specifier|public
name|Collection
name|getBCC
parameter_list|()
block|{
return|return
operator|(
name|bcc
operator|)
return|;
block|}
comment|//Subject
specifier|public
name|void
name|setSubject
parameter_list|(
name|String
name|subject
parameter_list|)
block|{
name|this
operator|.
name|subject
operator|=
name|subject
expr_stmt|;
block|}
specifier|public
name|String
name|getSubject
parameter_list|()
block|{
return|return
operator|(
name|subject
operator|)
return|;
block|}
comment|//text
specifier|public
name|void
name|setText
parameter_list|(
name|String
name|text
parameter_list|)
block|{
name|this
operator|.
name|text
operator|=
name|text
expr_stmt|;
block|}
specifier|public
name|String
name|getText
parameter_list|()
block|{
return|return
operator|(
name|text
operator|)
return|;
block|}
comment|//xhtml
specifier|public
name|void
name|setXHTML
parameter_list|(
name|String
name|xhtml
parameter_list|)
block|{
name|this
operator|.
name|xhtml
operator|=
name|xhtml
expr_stmt|;
block|}
specifier|public
name|String
name|getXHTML
parameter_list|()
block|{
return|return
operator|(
name|xhtml
operator|)
return|;
block|}
specifier|public
name|void
name|addAttachment
parameter_list|(
name|MailAttachment
name|ma
parameter_list|)
block|{
name|attachment
operator|.
name|add
argument_list|(
name|ma
argument_list|)
expr_stmt|;
block|}
specifier|public
name|Iterator
name|attachmentIterator
parameter_list|()
block|{
return|return
name|attachment
operator|.
name|iterator
argument_list|()
return|;
block|}
block|}
block|}
end_class

end_unit

