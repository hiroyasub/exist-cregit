begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_package
package|package
name|org
operator|.
name|exist
operator|.
name|irc
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|*
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|StringTokenizer
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Matcher
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|ServletOutputStream
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|http
operator|.
name|HttpServletResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jibble
operator|.
name|pircbot
operator|.
name|*
import|;
end_import

begin_class
specifier|public
class|class
name|IRCSession
extends|extends
name|PircBot
block|{
specifier|private
specifier|static
specifier|final
name|int
name|PING_PERIOD
init|=
literal|20000
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|int
name|TIMEOUT
init|=
literal|240000
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|EV_MESSAGE
init|=
literal|"message"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|EV_NOTICE
init|=
literal|"notice"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|EV_JOIN
init|=
literal|"join"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|EV_PART
init|=
literal|"part"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|EV_USERS_LIST
init|=
literal|"users"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|EV_PING
init|=
literal|"ping"
decl_stmt|;
specifier|private
specifier|static
name|char
index|[]
name|CHUNK
init|=
operator|new
name|char
index|[
literal|8192
index|]
decl_stmt|;
static|static
block|{
name|Arrays
operator|.
name|fill
argument_list|(
name|CHUNK
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
block|}
comment|// server and channel settings
specifier|private
name|String
name|server
decl_stmt|;
specifier|private
name|String
name|channel
decl_stmt|;
specifier|private
name|String
name|sessionId
decl_stmt|;
specifier|private
name|HttpServletResponse
name|response
init|=
literal|null
decl_stmt|;
specifier|private
name|Writer
name|responseWriter
init|=
literal|null
decl_stmt|;
specifier|private
name|StringWriter
name|writer
init|=
operator|new
name|StringWriter
argument_list|()
decl_stmt|;
specifier|private
name|boolean
name|fillChunks
init|=
literal|false
decl_stmt|;
specifier|private
name|boolean
name|disconnect
init|=
literal|false
decl_stmt|;
specifier|private
name|long
name|lastPing
decl_stmt|;
specifier|private
name|boolean
name|isRunning
init|=
literal|false
decl_stmt|;
specifier|private
name|Pattern
name|cmdRegex
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"^/\\s*(\\w+)\\s+(.*)$"
argument_list|)
decl_stmt|;
specifier|private
name|Matcher
name|matcher
init|=
name|cmdRegex
operator|.
name|matcher
argument_list|(
literal|""
argument_list|)
decl_stmt|;
specifier|public
name|IRCSession
parameter_list|(
name|String
name|server
parameter_list|,
name|String
name|channel
parameter_list|,
name|String
name|nick
parameter_list|,
name|boolean
name|modProxyHack
parameter_list|)
throws|throws
name|IOException
throws|,
name|NickAlreadyInUseException
throws|,
name|IrcException
block|{
name|super
argument_list|()
expr_stmt|;
name|this
operator|.
name|server
operator|=
name|server
expr_stmt|;
name|this
operator|.
name|channel
operator|=
name|channel
expr_stmt|;
name|this
operator|.
name|sessionId
operator|=
name|Integer
operator|.
name|toString
argument_list|(
name|hashCode
argument_list|()
argument_list|)
expr_stmt|;
name|this
operator|.
name|fillChunks
operator|=
name|modProxyHack
expr_stmt|;
name|this
operator|.
name|setVersion
argument_list|(
literal|"XIRCProxy 0.1"
argument_list|)
expr_stmt|;
name|this
operator|.
name|setLogin
argument_list|(
literal|"XIRCProxy"
argument_list|)
expr_stmt|;
name|this
operator|.
name|setName
argument_list|(
name|nick
argument_list|)
expr_stmt|;
name|this
operator|.
name|setVerbose
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|this
operator|.
name|setEncoding
argument_list|(
literal|"UTF-8"
argument_list|)
expr_stmt|;
name|connect
argument_list|()
expr_stmt|;
block|}
specifier|protected
name|void
name|connect
parameter_list|()
throws|throws
name|IOException
throws|,
name|IrcException
throws|,
name|NickAlreadyInUseException
block|{
name|log
argument_list|(
literal|"Connecting to "
operator|+
name|server
argument_list|)
expr_stmt|;
name|connect
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|log
argument_list|(
literal|"Join channel: "
operator|+
name|channel
argument_list|)
expr_stmt|;
name|joinChannel
argument_list|(
name|channel
argument_list|)
expr_stmt|;
block|}
specifier|public
name|String
name|getSessionId
parameter_list|()
block|{
return|return
name|sessionId
return|;
block|}
specifier|public
name|boolean
name|started
parameter_list|()
block|{
return|return
name|isRunning
return|;
block|}
specifier|public
name|void
name|run
parameter_list|(
name|HttpServletResponse
name|servletResponse
parameter_list|)
block|{
name|setResponseObject
argument_list|(
name|servletResponse
argument_list|)
expr_stmt|;
name|log
argument_list|(
literal|"Listening to chat events ..."
argument_list|)
expr_stmt|;
name|disconnect
operator|=
literal|false
expr_stmt|;
name|lastPing
operator|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
expr_stmt|;
name|isRunning
operator|=
literal|true
expr_stmt|;
while|while
condition|(
operator|!
name|disconnect
condition|)
block|{
synchronized|synchronized
init|(
name|this
init|)
block|{
try|try
block|{
name|wait
argument_list|(
name|PING_PERIOD
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
block|}
block|}
if|if
condition|(
operator|!
name|disconnect
condition|)
block|{
name|long
name|now
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
if|if
condition|(
name|now
operator|-
name|lastPing
operator|>
name|TIMEOUT
condition|)
block|{
name|log
argument_list|(
literal|"No response from client, disconnecting user "
operator|+
name|getNick
argument_list|()
operator|+
literal|" from channel "
operator|+
name|channel
operator|+
literal|" ..."
argument_list|)
expr_stmt|;
name|partChannel
argument_list|(
name|channel
argument_list|,
literal|"Connection Timed Out"
argument_list|)
expr_stmt|;
name|quitServer
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|pingClient
argument_list|()
expr_stmt|;
block|}
block|}
block|}
name|isRunning
operator|=
literal|false
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
name|log
argument_list|(
literal|"Exiting ..."
argument_list|)
expr_stmt|;
synchronized|synchronized
init|(
name|this
init|)
block|{
name|notifyAll
argument_list|()
expr_stmt|;
block|}
block|}
specifier|public
specifier|synchronized
name|void
name|closeTunnel
parameter_list|()
block|{
name|disconnect
operator|=
literal|true
expr_stmt|;
name|notifyAll
argument_list|()
expr_stmt|;
try|try
block|{
name|wait
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
block|}
block|}
specifier|public
specifier|synchronized
name|boolean
name|setResponseObject
parameter_list|(
name|HttpServletResponse
name|servletResponse
parameter_list|)
block|{
name|this
operator|.
name|response
operator|=
name|servletResponse
expr_stmt|;
name|response
operator|.
name|setContentType
argument_list|(
literal|"text/html"
argument_list|)
expr_stmt|;
name|response
operator|.
name|setBufferSize
argument_list|(
literal|64
argument_list|)
expr_stmt|;
try|try
block|{
name|ServletOutputStream
name|os
init|=
name|response
operator|.
name|getOutputStream
argument_list|()
decl_stmt|;
name|responseWriter
operator|=
operator|new
name|PrintWriter
argument_list|(
operator|new
name|OutputStreamWriter
argument_list|(
name|os
argument_list|,
literal|"UTF-8"
argument_list|)
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|responseWriter
operator|.
name|write
argument_list|(
literal|"<html><head>"
argument_list|)
expr_stmt|;
name|responseWriter
operator|.
name|write
argument_list|(
literal|"<title>IRCProxy</title>"
argument_list|)
expr_stmt|;
name|responseWriter
operator|.
name|write
argument_list|(
literal|"<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />"
argument_list|)
expr_stmt|;
name|responseWriter
operator|.
name|write
argument_list|(
literal|"</head><body>"
argument_list|)
expr_stmt|;
name|writeEvent
argument_list|(
literal|"Connection to proxy opened."
argument_list|,
name|EV_NOTICE
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|log
argument_list|(
literal|"Exception while opening push stream: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
return|return
literal|false
return|;
block|}
specifier|public
name|void
name|quit
parameter_list|()
block|{
name|quit
argument_list|(
literal|"Client Quit"
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|quit
parameter_list|(
name|String
name|partMessage
parameter_list|)
block|{
name|partChannel
argument_list|(
name|channel
argument_list|,
name|partMessage
argument_list|)
expr_stmt|;
name|quitServer
argument_list|()
expr_stmt|;
block|}
specifier|public
specifier|synchronized
name|void
name|send
parameter_list|(
name|String
name|message
parameter_list|)
block|{
name|matcher
operator|.
name|reset
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|matcher
operator|.
name|find
argument_list|()
condition|)
block|{
name|String
name|cmd
init|=
name|matcher
operator|.
name|group
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|message
operator|=
name|matcher
operator|.
name|group
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|processCommand
argument_list|(
name|cmd
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sendMessage
argument_list|(
name|channel
argument_list|,
name|message
argument_list|)
expr_stmt|;
name|writeMessage
argument_list|(
name|getNick
argument_list|()
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
specifier|synchronized
name|void
name|attemptReconnect
parameter_list|()
throws|throws
name|IOException
throws|,
name|IrcException
block|{
name|log
argument_list|(
literal|"Reconnecting ..."
argument_list|)
expr_stmt|;
name|disconnect
operator|=
literal|true
expr_stmt|;
name|lastPing
operator|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
expr_stmt|;
name|writer
operator|=
operator|new
name|StringWriter
argument_list|()
expr_stmt|;
name|notifyAll
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|isConnected
argument_list|()
condition|)
block|{
name|connect
argument_list|()
expr_stmt|;
block|}
block|}
specifier|protected
name|void
name|onConnect
parameter_list|()
block|{
name|writeEvent
argument_list|(
literal|"Connected to server "
operator|+
name|this
operator|.
name|server
operator|+
literal|"."
argument_list|,
name|EV_NOTICE
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
block|}
specifier|protected
specifier|synchronized
name|void
name|onDisconnect
parameter_list|()
block|{
name|disconnect
operator|=
literal|true
expr_stmt|;
name|notifyAll
argument_list|()
expr_stmt|;
block|}
specifier|protected
name|void
name|onMessage
parameter_list|(
name|String
name|channel
parameter_list|,
name|String
name|sender
parameter_list|,
name|String
name|login
parameter_list|,
name|String
name|hostname
parameter_list|,
name|String
name|message
parameter_list|)
block|{
name|log
argument_list|(
literal|"Message from "
operator|+
name|sender
argument_list|)
expr_stmt|;
name|writeMessage
argument_list|(
name|sender
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
specifier|protected
name|void
name|onJoin
parameter_list|(
name|String
name|channel
parameter_list|,
name|String
name|sender
parameter_list|,
name|String
name|login
parameter_list|,
name|String
name|hostname
parameter_list|)
block|{
try|try
block|{
name|writer
operator|.
name|write
argument_list|(
literal|"<script language=\"JavaScript\" type=\"text/javascript\">"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|jsCall
argument_list|(
literal|"dispatchEvent"
argument_list|,
operator|new
name|String
index|[]
block|{
name|EV_JOIN
block|,
name|sender
block|,
name|sender
operator|+
literal|" ["
operator|+
name|hostname
operator|+
literal|"] has joined "
operator|+
name|channel
block|}
argument_list|)
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"</script>\n\n"
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
name|closeConnection
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|protected
name|void
name|onPart
parameter_list|(
name|String
name|channel
parameter_list|,
name|String
name|sender
parameter_list|,
name|String
name|login
parameter_list|,
name|String
name|hostname
parameter_list|)
block|{
try|try
block|{
name|writer
operator|.
name|write
argument_list|(
literal|"<script language=\"JavaScript\" type=\"text/javascript\">"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|jsCall
argument_list|(
literal|"dispatchEvent"
argument_list|,
operator|new
name|String
index|[]
block|{
name|EV_PART
block|,
name|sender
block|,
name|sender
operator|+
literal|" ["
operator|+
name|hostname
operator|+
literal|"] has left "
operator|+
name|channel
block|}
argument_list|)
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"</script>\n\n"
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
name|closeConnection
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|protected
name|void
name|onQuit
parameter_list|(
name|String
name|sourceNick
parameter_list|,
name|String
name|sourceLogin
parameter_list|,
name|String
name|sourceHostname
parameter_list|,
name|String
name|reason
parameter_list|)
block|{
try|try
block|{
name|writer
operator|.
name|write
argument_list|(
literal|"<script language=\"JavaScript\" type=\"text/javascript\">"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|jsCall
argument_list|(
literal|"dispatchEvent"
argument_list|,
operator|new
name|String
index|[]
block|{
name|EV_PART
block|,
name|sourceNick
block|,
name|sourceNick
operator|+
literal|" ["
operator|+
name|sourceLogin
operator|+
literal|'@'
operator|+
name|sourceHostname
operator|+
literal|"] has quit: \""
operator|+
name|reason
operator|+
literal|'"'
block|}
argument_list|)
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"</script>\n\n"
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
name|closeConnection
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|protected
name|void
name|onNotice
parameter_list|(
name|String
name|sourceNick
parameter_list|,
name|String
name|sourceLogin
parameter_list|,
name|String
name|sourceHostname
parameter_list|,
name|String
name|target
parameter_list|,
name|String
name|notice
parameter_list|)
block|{
name|writeEvent
argument_list|(
literal|"Notice from "
operator|+
name|sourceNick
operator|+
literal|" ["
operator|+
name|sourceHostname
operator|+
literal|"] to "
operator|+
name|target
operator|+
literal|": "
operator|+
name|notice
argument_list|,
name|EV_NOTICE
argument_list|)
expr_stmt|;
block|}
specifier|protected
name|void
name|onUserList
parameter_list|(
name|String
name|channel
parameter_list|,
name|User
index|[]
name|users
parameter_list|)
block|{
name|String
name|args
index|[]
init|=
operator|new
name|String
index|[
name|users
operator|.
name|length
operator|+
literal|1
index|]
decl_stmt|;
name|args
index|[
literal|0
index|]
operator|=
name|EV_USERS_LIST
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|users
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|args
index|[
name|i
operator|+
literal|1
index|]
operator|=
name|users
index|[
name|i
index|]
operator|.
name|getNick
argument_list|()
expr_stmt|;
block|}
try|try
block|{
name|writer
operator|.
name|write
argument_list|(
literal|"<script language=\"JavaScript\" type=\"text/javascript\">"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|jsCall
argument_list|(
literal|"dispatchEvent"
argument_list|,
name|args
argument_list|)
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"</script>\n\n"
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
name|closeConnection
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|protected
name|void
name|onServerResponse
parameter_list|(
name|int
name|i
parameter_list|,
name|String
name|string
parameter_list|)
block|{
if|if
condition|(
name|i
operator|==
name|ReplyConstants
operator|.
name|RPL_MOTDSTART
operator|||
name|i
operator|==
name|ReplyConstants
operator|.
name|RPL_MOTD
operator|||
name|i
operator|==
name|ReplyConstants
operator|.
name|RPL_ENDOFMOTD
condition|)
block|{
name|writeEvent
argument_list|(
name|string
argument_list|,
name|EV_NOTICE
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|pingResponse
parameter_list|()
block|{
name|log
argument_list|(
literal|"Received ping reponse ..."
argument_list|)
expr_stmt|;
name|lastPing
operator|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
expr_stmt|;
block|}
specifier|private
name|void
name|pingClient
parameter_list|()
block|{
name|String
name|js
init|=
name|jsCall
argument_list|(
literal|"dispatchEvent"
argument_list|,
operator|new
name|String
index|[]
block|{
name|EV_PING
block|}
argument_list|)
decl_stmt|;
name|writeLine
argument_list|(
name|js
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|writeMessage
parameter_list|(
name|String
name|sender
parameter_list|,
name|String
name|message
parameter_list|)
block|{
name|String
name|js
init|=
name|jsCall
argument_list|(
literal|"dispatchEvent"
argument_list|,
operator|new
name|String
index|[]
block|{
name|EV_MESSAGE
block|,
name|sender
block|,
name|message
block|}
argument_list|)
decl_stmt|;
name|writeLine
argument_list|(
name|js
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|writeEvent
parameter_list|(
name|String
name|message
parameter_list|,
name|String
name|cls
parameter_list|)
block|{
name|String
name|js
init|=
name|jsCall
argument_list|(
literal|"dispatchEvent"
argument_list|,
operator|new
name|String
index|[]
block|{
name|cls
block|,
name|message
block|}
argument_list|)
decl_stmt|;
name|writeLine
argument_list|(
name|js
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|writeLine
parameter_list|(
name|String
name|data
parameter_list|)
block|{
try|try
block|{
name|writer
operator|.
name|write
argument_list|(
literal|"<script language=\"JavaScript\" type=\"text/javascript\">"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"</script>\n\n"
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
name|closeConnection
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|String
name|jsCall
parameter_list|(
name|String
name|func
parameter_list|,
name|String
index|[]
name|params
parameter_list|)
block|{
name|StringBuffer
name|buf
init|=
operator|new
name|StringBuffer
argument_list|()
decl_stmt|;
name|buf
operator|.
name|append
argument_list|(
literal|"top."
argument_list|)
operator|.
name|append
argument_list|(
name|func
argument_list|)
operator|.
name|append
argument_list|(
literal|"('"
argument_list|)
expr_stmt|;
name|buf
operator|.
name|append
argument_list|(
name|sessionId
argument_list|)
expr_stmt|;
name|buf
operator|.
name|append
argument_list|(
literal|'\''
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|params
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|buf
operator|.
name|append
argument_list|(
literal|", '"
argument_list|)
expr_stmt|;
name|buf
operator|.
name|append
argument_list|(
name|escape
argument_list|(
name|params
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|.
name|append
argument_list|(
literal|'\''
argument_list|)
expr_stmt|;
block|}
name|buf
operator|.
name|append
argument_list|(
literal|");"
argument_list|)
expr_stmt|;
return|return
name|buf
operator|.
name|toString
argument_list|()
return|;
block|}
specifier|private
name|void
name|flush
parameter_list|()
block|{
if|if
condition|(
name|response
operator|==
literal|null
condition|)
return|return;
name|String
name|data
init|=
name|writer
operator|.
name|toString
argument_list|()
decl_stmt|;
name|writer
operator|=
operator|new
name|StringWriter
argument_list|()
expr_stmt|;
try|try
block|{
if|if
condition|(
name|data
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|responseWriter
operator|.
name|write
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|fillChunks
condition|)
name|responseWriter
operator|.
name|write
argument_list|(
name|CHUNK
argument_list|)
expr_stmt|;
block|}
name|responseWriter
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|log
argument_list|(
literal|"Exception while flushing servlet output: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|outputStreamClosed
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|outputStreamClosed
parameter_list|()
block|{
name|log
argument_list|(
literal|"HttpServletResponse closed."
argument_list|)
expr_stmt|;
name|response
operator|=
literal|null
expr_stmt|;
name|responseWriter
operator|=
literal|null
expr_stmt|;
block|}
specifier|private
name|void
name|closeConnection
parameter_list|(
name|String
name|message
parameter_list|)
block|{
if|if
condition|(
name|writer
operator|!=
literal|null
condition|)
block|{
name|writer
operator|.
name|write
argument_list|(
literal|"<h1>Error</h1>"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"<p>Error found: "
operator|+
name|message
operator|+
literal|"</p>"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|write
argument_list|(
literal|"<p>Closing connection.</p>"
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
block|}
name|partChannel
argument_list|(
name|channel
argument_list|)
expr_stmt|;
name|quitServer
argument_list|()
expr_stmt|;
block|}
specifier|private
name|String
name|escape
parameter_list|(
name|String
name|in
parameter_list|)
block|{
name|StringBuffer
name|buf
init|=
operator|new
name|StringBuffer
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|in
operator|.
name|length
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|char
name|ch
init|=
name|in
operator|.
name|charAt
argument_list|(
name|i
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'\\'
case|:
break|break;
case|case
literal|'"'
case|:
case|case
literal|'\''
case|:
name|buf
operator|.
name|append
argument_list|(
literal|"&quot;"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'<'
case|:
name|buf
operator|.
name|append
argument_list|(
literal|"&lt;"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'>'
case|:
name|buf
operator|.
name|append
argument_list|(
literal|"&gt;"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'&'
case|:
name|buf
operator|.
name|append
argument_list|(
literal|"&amp;"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|buf
operator|.
name|append
argument_list|(
name|ch
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
name|buf
operator|.
name|toString
argument_list|()
return|;
block|}
specifier|private
name|void
name|processCommand
parameter_list|(
name|String
name|command
parameter_list|,
name|String
name|message
parameter_list|)
block|{
if|if
condition|(
literal|"MSG"
operator|.
name|equalsIgnoreCase
argument_list|(
name|command
argument_list|)
condition|)
block|{
name|String
name|target
init|=
operator|new
name|StringTokenizer
argument_list|(
name|message
argument_list|)
operator|.
name|nextToken
argument_list|()
decl_stmt|;
name|sendMessage
argument_list|(
name|target
argument_list|,
name|message
operator|.
name|substring
argument_list|(
name|target
operator|.
name|length
argument_list|()
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
literal|"QUIT"
operator|.
name|equalsIgnoreCase
argument_list|(
name|command
argument_list|)
condition|)
block|{
name|writeMessage
argument_list|(
name|getNick
argument_list|()
argument_list|,
literal|"QUIT: "
operator|+
name|message
argument_list|)
expr_stmt|;
name|quit
argument_list|(
name|message
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
literal|"NICK"
operator|.
name|equalsIgnoreCase
argument_list|(
name|command
argument_list|)
condition|)
block|{
name|writeMessage
argument_list|(
name|getNick
argument_list|()
argument_list|,
literal|"Trying to change nick to "
operator|+
name|message
argument_list|)
expr_stmt|;
name|changeNick
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|send
argument_list|(
literal|"/list"
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|args
parameter_list|)
block|{
name|Pattern
name|cmdRegex
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"^/\\s*(\\w+)\\s+(.*)$"
argument_list|)
decl_stmt|;
name|Matcher
name|matcher
init|=
name|cmdRegex
operator|.
name|matcher
argument_list|(
literal|""
argument_list|)
decl_stmt|;
name|matcher
operator|.
name|reset
argument_list|(
literal|"/quit abcdefg"
argument_list|)
expr_stmt|;
if|if
condition|(
name|matcher
operator|.
name|find
argument_list|()
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Command: "
operator|+
name|matcher
operator|.
name|group
argument_list|(
literal|1
argument_list|)
operator|+
literal|" - "
operator|+
name|matcher
operator|.
name|group
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Nothing"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

