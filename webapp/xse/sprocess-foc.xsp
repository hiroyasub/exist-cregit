<?xml version="1.0" encoding="iso-8859-1"?>
<!-- 
Copyright J.M. Vanel 2003 - under GNU public licence 
jmvanel@free.fr 
Worldwide Botanical Knowledge Base 
http://wwbota.free.fr/
$Header$
-->

<!-- XSP page for processing a query through XML-RPC calls.
         This xsp page takes the parameters received from query.xml and
     sends a query request to the eXist server. If parameter
         "summarize" is set, a short summary of the query execution
         is shown first.
-->
<xsp:page language="java"
  xmlns:xsp="http://apache.org/xsp"
  xmlns:xsp-request="http://apache.org/xsp/request/2.0"
  xmlns:xsp-session="http://apache.org/xsp/session/2.0"
  xmlns:ci="http://apache.org/cocoon/include/1.0"
  xmlns:xmldb="http://exist-db.org/xmldb/1.0"
>
<!-- jmv -->
<xsp:structure>
<xsp:include>wwbota.xmldb.core.Query</xsp:include>
<xsp:include> javax.xml.parsers.* </xsp:include>
</xsp:structure>

    <document>
        <!-- include header -->
        <ci:include src="foc-header.xml"/>
       
        <!-- include sidebar -->
        <ci:include src="foc-sidebar.xml"/>
       
        <body>
            <section title="Query results">
      
            <xsp:logic>
            // get start and count parameters
            String pstart = <xsp-request:get-parameter name="start" as="string"/>;
            String pcount = <xsp-request:get-parameter name="count" as="string"/>;
            String resultId = <xsp-request:get-parameter name="id" as="string"/>;
            if(pstart == null) pstart = "1";
            if(pcount == null) pcount = "10";
            int start = Integer.parseInt(pstart);
            int count = Integer.parseInt(pcount);
            int hits = 0;
            
            String query = <xsp-request:get-parameter name="query" as="string"/>;
            String squery = <xsp-request:get-parameter name="squery" as="string"/>;
            String cname = <xsp-request:get-parameter name="collection" as="string"/>;
            String psummarize = <xsp-request:get-parameter name="summarize" as="string"/>;
            boolean summarize = (psummarize == null) ? false : true;
            
            // jmv <![CDATA[
            StringBuffer comment = new StringBuffer();
            Query q = null;
            if ( squery != null && ! squery.equals("") ) {
              q = wwbota.xmldb.core.Database.createQuery();

              // current FOC document specific: absolute XPath to a document unit (i.e. atomic piece of information retrieved from the database, here in WWBKB a document unit is a taxon) <<<<<<<<
              // q.setXPathPrefix("/flora/table/tr");
              q.setXPathPrefix("/flora/t:taxon");
              q.setRubricXPath("t:taxon / *");

// OK:
              // q.setXPathPrefix("//SCENE");
              // q.setRubricXPath("SCENE/*");
/*********
try {
            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
            //factory.setValidating(true);
            DocumentBuilder builder = factory.newDocumentBuilder();
            // ???????? org.w3c.dom.Document doc = builder.parse("xse.xconf");
        } catch (Exception e) {
           // System.out.println("Exception : " + e);
        }
********/
              q.setPlainQuery( squery, comment);
              query = q.getXPath();

              // put current query in session if necessary:
              Vector queries = (Vector)session.getAttribute("queries");
              if (queries == null) queries = new Vector(10,5);
              String lastQuery = "";
              if ( queries.size() > 0 ) {
                lastQuery = ((Query)queries.lastElement()).getPlainQuery();
              }
              if ( ! q.getPlainQuery().equals(lastQuery) )
                queries.add(q);
              session.setAttribute("queries", queries);
            }
            if ( squery == null ) squery = "";
            // ]]>

            // add document(*) to query if missing
            if(!(query.startsWith("document(") || query.startsWith("collection(")) ||
                 query.startsWith("xcollection(")) {
                if(cname == null || cname.equals("all documents"))
                    query = "document(*)" + query;
                else
                    query = "collection('" + cname + "')" + query;
            }
            
            <!-- print current query -->
            <span>XPath Query:
              <tt><xsp:expr>query</xsp:expr></tt>
            </span>
            <br />
            <!-- jmv : add comment to the response page -->
            <xsp:logic>if ( ! comment.toString().equals("") ) {
            <span>Comment about your query:
              You have asked for a taxon containing 
              <xsp:expr>q.getExplanation()</xsp:expr>.
              <xsp:expr>comment.toString()</xsp:expr>
            </span>
            }
            </xsp:logic>

	<!-- <div> cname: <xsp:expr>cname</xsp:expr> </div> -->

        <!-- connect to the server -->
        <xmldb:driver class="org.exist.xmldb.DatabaseImpl"/>
        <!--<xmldb:driver class="org.exist.xmldb.DatabaseImpl"/>-->

        if ( query != null &amp;&amp; ! query.equals("") ) {
        <xmldb:collection uri="xmldb:exist:///db" user="guest" password="guest">
            <xmldb:execute encoding="ISO-8859-1">
                <xmldb:xpath>query</xmldb:xpath>
                
                    <xsp:logic>
                        hits = <xmldb:get-hit-count/>;
                        <!-- print a summary of hits per document -->                     
                        <p>Found <xmldb:get-hit-count/> hits in
                        <xmldb:get-query-time/> ms.</p>
                                
                         if(hits &gt; 0) {
                            if(summarize) {
                                <section title="Summary of hits">
                               
                                <p>The table below shows which documents
                                matched your query.  Click on a document's
                                name to view the actual results.</p>
                                
                                <!-- display hits per document -->
                                <table width="90%" border="0" cellspacing="0" align="center">
                                    <xsp:logic>
                                        String docLink = response.encodeURL(request.getRequestURI()) + "?count=" + count +
                                            "&amp;query=" + URLEncoder.encode(query) +
                                            "&amp;squery=" + URLEncoder.encode(squery);
                                        <xmldb:result-summary>
                                            <table bgcolor="#0B88E8" cellspacing="0" cellpadding="0" 
                                                   border="0" width="100%">
                                                <tr style="border: 1px solid black">
                                                    <th align="left" colspan="3">
                                                        <font color="#FFFFFF"><xmldb:collection-name/></font>
                                                    </th>
                                                </tr>
                                                <xmldb:documents>
                                                    <tr bgcolor="#D0DFEC">
                                                        <xsp:logic>
                                                            String collectionName = <xmldb:collection-name/>;
                                                            String docName = collectionName + '/' + <xmldb:document-name/>;
                                                            String newQuery = docLink + "&amp;doc=" + docName +
                                                              "&amp;collection=" + URLEncoder.encode(cname);
                                                            <td width="5%"></td>
                                                            <td>
                            <link>
                                                                    <xsp:attribute name="href"><xsp:expr>newQuery</xsp:expr></xsp:attribute>
                                                                    <xsp:expr>docName</xsp:expr>
                                                                </link>
                                                            </td>
                                                            <td align="right"><xmldb:document-hit-count/></td>
                                                        </xsp:logic>
                                                    </tr>
                                                </xmldb:documents>
                                            </table>
                                        </xmldb:result-summary>
                                    </xsp:logic>
                                </table>
                                
                                </section>
                            } else {
                                // display the actual results
                                String doc = request.getParameter("doc");
                                if(doc != null) {
                                    hits = 
                                        <xmldb:get-hit-count>
                                            <xmldb:document>doc.substring(doc.lastIndexOf('/') + 1)</xmldb:document>
                                            <xmldb:collection>doc.substring(0, doc.lastIndexOf('/'))</xmldb:collection>
                                        </xmldb:get-hit-count>;
                                }
                                // generate links for previous/next and summary page
                                String temp = response.encodeURL(request.getRequestURI()) + '?';
                                if(doc != null)
                                    temp = temp + "doc=" + doc + "&amp;";
                                // String queryString = URLEncoder.encode(request.getParameter("query")); // jmv
                                String queryString = query; // jmv
                                String prev = temp + "count=" +
                                    count + "&amp;start=" + (start - count) +
                                    "&amp;collection=" +URLEncoder.encode(cname) +
                                    "&amp;squery=" + URLEncoder.encode(squery) +
                                    "&amp;query=" + URLEncoder.encode(queryString);
                                String next = temp + "count=" +
                                    count + "&amp;start=" + (start + count) +
                                    "&amp;collection=" +URLEncoder.encode(cname) +
                                    "&amp;squery=" + URLEncoder.encode(squery) +
                                    "&amp;query=" + URLEncoder.encode(queryString);
                                String summary = request.getRequestURI() +
                                    "?query=" + URLEncoder.encode(queryString) +
                                    "&amp;squery=" + URLEncoder.encode(squery) +
                                    "&amp;collection=" +URLEncoder.encode(cname) +
                                    "&amp;summarize=true";
                                String newQuery = "squery-foc.xsp?collection=" + URLEncoder.encode(cname);
                                /*?query=" + URLEncoder.encode(queryString) +
                                "&amp;squery=" + URLEncoder.encode(squery)*/

                                <table width="100%" cellspacing="0" cellpadding="5" bgcolor="#0B88E8">
                    
                                    <!-- top link menu -->
                                    <tr>
                                        <xsp:logic>
                                            if(start &gt; 1) {
                                                <td width="25%" align="left">
                                                    <link style="font-weight: bold; color: white">
                                                        <xsp:attribute name="href"><xsp:expr>prev</xsp:expr></xsp:attribute>
                                                        &lt;&lt; previous page
                                                    </link>
                                                </td>
                                            } else {
                                                <td width="25%"></td>
                                            }
                                            <td width="25%" align="center">
                                                <link style="font-weight: bold; color: white">
                                                    <xsp:attribute name="href"><xsp:expr>newQuery</xsp:expr></xsp:attribute>
                                                    new query
                                                </link>
                                            </td>
                                            <td width="25%" align="center">
                                                <link style="font-weight: bold; color: white">
                                                    <xsp:attribute name="href"><xsp:expr>summary</xsp:expr></xsp:attribute>
                                                    summary
                                                </link>
                                            </td>
                                            if(start + count &lt; hits) {
                                                <td width="25%" align="right">
                                                    <link style="font-weight: bold; color: white">
                                                        <xsp:attribute name="href"><xsp:expr>next</xsp:expr></xsp:attribute>
                                                        next page &gt;&gt;
                                                    </link>
                                                </td>
                                            } else {
                                                <td width="25%"></td>
                                            }
                                        </xsp:logic>
                                    </tr>    
                                    <!-- display the hits in pretty printed XML -->
                                    <xsp:logic>
                                        int pos = 0;
                                        if(doc != null) {
                                            <xmldb:results>
                                                <xmldb:position>start</xmldb:position>
                                                <xmldb:count>count</xmldb:count>
                                                <xmldb:document>doc.substring(doc.lastIndexOf('/') + 1)</xmldb:document>
                                                <xmldb:collection>doc.substring(0, doc.lastIndexOf('/'))</xmldb:collection>
                                                <tr>
                                                    <td colspan="4">
                                                        <xsp:logic>
                                                            if(++pos % 2 == 0) {
                                                                <!-- <xsp:attribute name="bgcolor">#9FB4EC</xsp:attribute> -->
                                                                <xsp:attribute name="style"> background-color: rgb(244, 255, 255); </xsp:attribute>
                                                            } else {
                                                                <xsp:attribute name="bgcolor">#D0DFEC</xsp:attribute>
                                                            }
                                                        </xsp:logic>
                                                
                                                        <xml-source>
                                                            <xmldb:get-xml as="xml"/>
                                                        </xml-source>
                                                    </td>
                                                </tr>
                                                <xmldb:error>
                                                    <p><xmldb:get-error/></p>
                                                </xmldb:error>
                                            </xmldb:results>
                                        } else {
                                            <xmldb:results>
                                                <xmldb:position>start</xmldb:position>
                                                <xmldb:count>count</xmldb:count>
                                                <tr>
                                                    <td colspan="4">
                                                        <xsp:logic>
                                                            if(++pos % 2 == 0) {
                                                                <xsp:attribute name="style"> background-color: rgb(244, 255, 255); </xsp:attribute>
                                                            } else {
                                                                <xsp:attribute name="bgcolor">#D0DFEC</xsp:attribute>
                                                            }
                                                        </xsp:logic>
                                                
                                                        <xml-source>
                                                            <xmldb:get-xml as="xml"/>
                                                        </xml-source>
                                                    </td>
                                                </tr>
                                                <xmldb:error>
                                                    <p><xmldb:get-error/></p>
                                                </xmldb:error>
                                            </xmldb:results>
                                        }
                                    </xsp:logic>
                                    <!-- bottom link menu -->
                                    <tr>
                                        <xsp:logic>
                                            if(start &gt; 1) {
                                                <td width="25%" align="left">
                                                    <link style="font-weight: bold; color: white">
                                                        <xsp:attribute name="href"><xsp:expr>prev</xsp:expr></xsp:attribute>
                                                        &lt;&lt; previous page
                                                    </link>
                                                </td>
                                            } else {
                                                <td width="25%"></td>
                                            }
                                            <td width="25%" align="center">
                                                <link style="font-weight: bold; color: white">
                                                    <xsp:attribute name="href"><xsp:expr>newQuery</xsp:expr></xsp:attribute>
                                                    new query
                                                </link>
                                            </td>
                                            <td width="25%" align="center">
                                                <link style="font-weight: bold; color: white">
                                                    <xsp:attribute name="href"><xsp:expr>summary</xsp:expr></xsp:attribute>
                                                    summary
                                                </link>
                                            </td>
                                            if(start + count &lt; hits) {
                                                <td width="25%" align="right">
                                                    <link style="font-weight: bold; color: white">
                                                        <xsp:attribute name="href"><xsp:expr>next</xsp:expr></xsp:attribute>
                                                        next page &gt;&gt;
                                                    </link>
                                                </td>
                                            } else {
                                                <td width="25%"></td>
                                            }
                                        </xsp:logic>
                                    </tr>
                            </table>
                        }
                    } else {
                        <p>Nothing found for your query.</p>
                        String newQuery =
                            "squery-foc.xsp?query=" + URLEncoder.encode(query) +
                                 "&amp;squery=" + URLEncoder.encode(squery) +
                                 "&amp;collection=" +URLEncoder.encode(cname);
                        <p>
                        <!-- jmv: <a href="squery.xsp">&lt;&lt; back</a> -->
                        <link style="font-weight: bold;">
                            <xsp:attribute name="href"><xsp:expr>newQuery</xsp:expr></xsp:attribute>
                            &lt;&lt; back
                        </link>
                        </p>
                    }
                </xsp:logic>

                <xmldb:error>
                    <p>An error occurred while executing query:</p>
                    <p><tt><xmldb:get-error/></tt></p>
                    <p><xmldb:get-error-description/></p>
                </xmldb:error>
            </xmldb:execute>
            
            <xmldb:error>
                <p><tt><xmldb:get-error/></tt></p>
            </xmldb:error>
        </xmldb:collection>
      }
    </xsp:logic>
        
    </section>
</body>
    
</document>

</xsp:page>
