<?xml version="1.0" encoding="UTF-8"?>

<!--<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN" "docbookx.dtd">-->

<book xmlns:ci="http://apache.org/cocoon/include/1.0">
  <bookinfo>
    <graphic fileref="logo.jpg"/>
    <title>Open Source XML Database</title>
    <author> 
      <firstname>Wolfgang M.</firstname>
      <surname>Meier</surname>
      <affiliation>
        <address format="linespecific">
          <email>meier@ifs.tu-darmstadt.de</email>
        </address>
      </affiliation>
    </author>
  </bookinfo>
  
  <ci:include src="sidebar.xml"/>
  
  <chapter>
    <title>How-Tos</title>

	<section>
		<title>Integrating eXist into an existing Cocoon installation</title>
		
		<para>eXist comes with its own pre-installed Cocoon. However, integrating
		eXist into an already running Cocoon is not very difficult. For the 
		following, I downloaded the Cocoon 2.1 development version from the Apache
		CVS and installed it as a web-application in Tomcat.</para>
		
		<para>The following paragraphs assume that you have already set up a web application
		    based on Cocoon, i.e. you have created a web application folder and installed the 
		    required Cocoon files.</para>
		    
		<para>You should first create a directory <filename>WEB-INF/data</filename>
		in the folder of your Cocoon-enabled web-application, which will later contain
		the database files created by eXist. Next, copy the <filename>conf.xml</filename>
		configuration file from eXist into <filename>WEB-INF</filename>. Additionally, you have to
		copy a number of jar-files from eXist into the <filename>WEB-INF/lib</filename>
		directory:</para>
		
		<unorderedlist>
			<listitem><para>exist.jar</para></listitem>
			<listitem><para>lib/antlr.jar</para></listitem>
			<listitem><para>lib/axis.jar</para></listitem>
			<listitem><para>lib/clutil.jar</para></listitem>
			<listitem><para>lib/getopt.jar</para></listitem>
			<listitem><para>lib/jaxrpc.jar</para></listitem>
			<listitem><para>lib/libreadline-java.jar</para></listitem>
			<listitem><para>lib/log4j.jar</para></listitem>
			<listitem><para>lib/trove.jar</para></listitem>
			<listitem><para>lib/tt-bytecode.jar</para></listitem>
			<listitem><para>lib/wsdl4j.jar</para></listitem>
			<listitem><para>lib/xmldb.jar</para></listitem>
			<listitem><para>lib/xmlrpc-1.1.jar</para></listitem>
		</unorderedlist>
		
		<para>If you want WebDAV access you'll also need:</para>
		
		<unorderedlist>
			<listitem><para>jakarta-tomcat-4.0.3/webapps/exist/WEB-INF/lib/dom4j.jar</para></listitem>
			<listitem><para>jakarta-tomcat-4.0.3/webapps/exist/WEB-INF/lib/xincon.jar</para></listitem>
			<listitem><para>jakarta-tomcat-4.0.3/webapps/exist/WEB-INF/lib/catalina-util.jar</para></listitem>
		</unorderedlist>

		<para>Next step: edit the file <filename>web.xml</filename> in your
		<filename>WEB-INF</filename> directory. From the <filename>web.xml</filename>
		file that comes with eXist (directory 
		<filename>eXist-0.8.1/jakarta-tomcat-4.0.3/webapps/exist/WEB-INF</filename>)
		copy the servlet definitions for the RpcServlet, DatabaseAdminServlet,
		AxisServlet, AdminServlet and (optionally) the xincon servlet into your
		own <filename>web.xml</filename>. Additionally, copy all the servlet-mapping
		sections for these servlets. Please note that order is important in the web.xml
		file: the block with &lt;servlet&gt; sections should always precede the &lt;servlet-mapping&gt;
		sections.</para>
		
		<para>An example <filename>web.xml</filename> file is shown below:</para>
		
		<example>
			<title>web.xml example (Cocoon CVS version 2.1 and eXist CVS version)</title>
			
			<screen><![CDATA[
<?xml version="1.0" encoding="ISO-8859-1"?>

<!--
  This is the web-app configurations that allow Cocoon to work under
  Apache Tomcat. Please, follow the installation section of the
  documentation for more information about installing Cocoon on Tomcat
-->

<!DOCTYPE web-app
    PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application 2.2//EN"
    "http://java.sun.com/j2ee/dtds/web-app_2_2.dtd">

<web-app>
  <display-name>eXist Server</display-name>
  <description>eXist Server Setup</description>

  <!-- Servlets required by eXist -->
  
  <!-- RpcServlet provides XML-RPC access to eXist -->
  <servlet>
    <servlet-name>org.exist.xmlrpc.RpcServlet</servlet-name>
    <servlet-class>org.exist.xmlrpc.RpcServlet</servlet-class>
  </servlet>
  
  <!-- DatabaseAdminServlet: used to start/stop the database. -->
  <servlet>
    <servlet-name>org.exist.DatabaseAdminServlet</servlet-name>
    <servlet-class>org.exist.DatabaseAdminServlet</servlet-class>
    
    <!-- where to find eXist's configuration file
         relative to basedir
    -->
    <init-param>
        <param-name>configuration</param-name>
        <param-value>conf.xml</param-value>
    </init-param>

    <!-- eXist's home directory. All file names in 
         the configuration file will be relative to this
	 directory.
    -->
    <init-param>
        <param-name>basedir</param-name>
        <param-value>WEB-INF/</param-value>
    </init-param>

    <init-param>
        <param-name>start</param-name>
        <param-value>true</param-value>
    </init-param>
    
    <load-on-startup>2</load-on-startup>

  </servlet>
  
  <!-- configure the Axis servlet. Axis provides eXist's
  web-services via SOAP -->
  <servlet>
    <servlet-name>AxisServlet</servlet-name>
    <display-name>Apache-Axis Servlet</display-name>
    <servlet-class>
        org.apache.axis.transport.http.AxisServlet
    </servlet-class>
  </servlet>

  <servlet>
    <servlet-name>AdminServlet</servlet-name>
    <display-name>Axis Admin Servlet</display-name>
    <servlet-class>
        org.apache.axis.transport.http.AdminServlet
    </servlet-class>
    <load-on-startup>100</load-on-startup>
  </servlet>
  
  <!-- xincon: Provides Webdav for eXist -->
	<servlet>
		<servlet-name>xincon</servlet-name>
		<servlet-class>xincon.WebdavServlet</servlet-class>
		<init-param>
			<param-name>dbroot</param-name>
			<param-value>xmldb:exist:///db</param-value>
		</init-param>
		
		<!-- log4j parameters -->
		<init-param>
			<param-name>log4j-priority</param-name>
			<param-value>DEBUG</param-value>
		</init-param>
		<init-param>
			<param-name>log4j-layout</param-name>
			<param-value>%-5p [%M] %m%n</param-value>
		</init-param>
		<!-- end log4j parameters -->
		
        <!-- load this servlet first to avoid conflicts with
             eXist's log-configuration -->
        <load-on-startup>1</load-on-startup>
	</servlet>

  <!-- Configure Cocoon2 -->
  
  <servlet>
    <servlet-name>Cocoon2</servlet-name>
    <display-name>Cocoon2</display-name>
    <description>The main Cocoon2 servlet</description>

	<!-- I'm skipping Cocoon configuration here ... -->
  </servlet>

  <servlet-mapping>
    <servlet-name>org.exist.xmlrpc.RpcServlet</servlet-name>
    <url-pattern>/xmlrpc</url-pattern>
  </servlet-mapping>
  
  <servlet-mapping>
    <servlet-name>org.exist.DatabaseAdminServlet</servlet-name>
    <url-pattern>/admin</url-pattern>
  </servlet-mapping>
  
    <servlet-mapping>
		<servlet-name>xincon</servlet-name>
		<url-pattern>/webdav/*</url-pattern>
	</servlet-mapping>
    
  <!-- Axis servlets -->
  <servlet-mapping>
    <servlet-name>AxisServlet</servlet-name>
    <url-pattern>servlet/AxisServlet</url-pattern>
  </servlet-mapping>

  <servlet-mapping>
    <servlet-name>AxisServlet</servlet-name>
    <url-pattern>*.jws</url-pattern>
  </servlet-mapping>

  <servlet-mapping>
    <servlet-name>AxisServlet</servlet-name>
    <url-pattern>/services/*</url-pattern>
  </servlet-mapping>

  <servlet-mapping>
    <servlet-name>AdminServlet</servlet-name>
    <url-pattern>servlet/AdminServlet</url-pattern>
  </servlet-mapping>

  <!--
    Cocoon handles all the URL space assigned to the webapp using its sitemap.
    It is recommended to leave it unchanged. Under some circumstances though
    (like integration with proprietary webapps or servlets) you might have
    to change this parameter.
  -->
  <servlet-mapping>
    <servlet-name>Cocoon2</servlet-name>
    <url-pattern>/</url-pattern>
  </servlet-mapping>
  
</web-app>]]>			
			</screen>
		</example>
		
		<para>Finally, to use the XML:DB taglib included with eXist, you should define
		it as a built-in logicsheet in the configuration of Cocoon. Add the following 
		to <filename>WEB-INF/cocoon.xconf</filename>:</para>
		
		<example>
			<title>Adding a new built-in logicsheet to cocoon.xconf</title>
			
			<screen><![CDATA[
<target-language name="java">
        <!-- Defines the XSP Core logicsheet for the Java language -->
        <parameter name="core-logicsheet" value="resource://org/apache/cocoon/components/language/markup/xsp/java/xsp.xsl"/>

		<!-- Insert the following section: -->
		<builtin-logicsheet>
            <parameter name="prefix" value="xmldb"/>
            <parameter name="uri" value="http://exist-db.org/xmldb/1.0"/>
            <parameter name="href" value="resource://org/exist/xmldb.xsl"/>
        </builtin-logicsheet>
        
        <!-- ... more builtin-logicsheets ... -->
</target-language>
]]>
			</screen>
		</example>

		<para>If you want to access eXist through Cocoon's XML:DB pseudo protocol,
		don't forget to add eXist's XML:DB driver to the corresponding &lt;component-instance&gt;
		section. The section should like this:</para>
		
		<example>
			<title>Adding eXist's XML:DB driver</title>
			<screen><![CDATA[
<!-- xmldb pseudo protocol -->
<component-instance class="org.apache.cocoon.components.source.impl.SourceFactoryWrapper" name="xmldb">
    <source-factory class="org.apache.cocoon.components.source.XMLDBSourceFactory">
        <!-- Xindice driver -->
        <driver class="org.apache.xindice.client.xmldb.DatabaseImpl" type="xindice"/>
        <!-- Add here other XML:DB compliant databases drivers -->
        <driver class="org.exist.xmldb.DatabaseImpl" type="exist"/>
    </source-factory>
</component-instance>]]>
			</screen>
		</example>
		
		<para>You should now be able to restart your servlet-engine. You may check
		if eXist is running by browsing to http://your-host:8080/your-app/admin</para>
	</section>
	
	<section>
        <title>Getting up and running with Jetty</title>
        
        <para>contributed by <emphasis>Michael I. Angermann</emphasis></para>
        
		<para>Besides Tomcat, eXist runs very well on
		<ulink href="http://jetty.mortbay.org/jetty/">Jetty</ulink>.
		Jetty is a 100% Java HTTP Server and Servlet Container.</para>

		<para>To get <filename>jetty-4.1.1.zip</filename> up and running with 
		<filename>eXist-0.8.1.zip</filename></para>

		<para>Make a directory called <filename>exist</filename> in 
		<filename>c:\jetty\demo\webapps</filename></para>

		<para>Unpack <filename>eXist-0.8.1.war.zip</filename> into 
		<filename>c:\jetty\demo\webapps\exist</filename></para>

		<para>From <ulink href="http://hsqldb.sourceforge.net">
		http://hsqldb.sourceforge.net</ulink>
		add <filename>hsqldb.jar</filename> to 
		<filename>c:\jetty\demo\webapps\exist\WEB-INF\lib</filename>.</para>

		<para>Put these files in <filename>c:\jetty\lib</filename>:</para>

		<unorderedlist>
			<listitem><para>tools.jar</para></listitem>
			<listitem><para>xalan.jar</para></listitem>
			<listitem><para>xercesImpl.jar</para></listitem>
			<listitem><para>xml-apis.jar</para></listitem>
		</unorderedlist>
		
		<note>
			<para><filename>tools.jar</filename> comes from the jdk 
			release under <filename>c:\jdk\lib</filename></para></note>

		<note>
			<para>
				<filename>xalan.jar</filename>, <filename>xercesImpl.jar</filename>,
				<filename>xml-apis.jar</filename> comes from
				<ulink href="http://xml.apache.org">http://xml.apache.org</ulink>.
				Xalan Java Version 2.4.0 (<filename>xalan-j_2_4_0-bin.zip</filename>,
				dated Sept. 03, 2002).
			</para>
		</note>

		<para>Modify the following (2) files:</para>
		
		<unorderedlist>
			<listitem><para><filename>c:\jetty\build.xml</filename></para></listitem>
			<listitem><para><filename>c:\jetty\etc\demo.xml</filename></para></listitem>
		</unorderedlist>
		
		<para>Add these lines in to build.xml</para>

		<example>
			<title>Added lines in build.xml</title>
			
			<screen><![CDATA[
<property name="xerces.jar"     
value="${lib}/xercesImpl.jar"/>

<property name="xmlapis.jar"     
value="${lib}/xml-apis.jar"/>

<property name="xalan.jar"      
value="${lib}/xalan.jar"/>

<property name="tools.jar"      
value="${lib}/tools.jar"/>

<!-- Modify the classpath id with the following
pathelements -->

<path id="classpath">
  <pathelement location="${jetty1.2.jar}" />
  <pathelement location="${jasper.jar}" />
  <pathelement location="${servlet.jar}" />

  <!--  add in these lines     -->

  <pathelement location="${tools.jar}" />
  <pathelement location="${xalan.jar}" />
  <pathelement location="${xmlapis.jar}" />
  <pathelement location="${xerces.jar}" />
  <path refid="extpath" />
</path>			
			]]></screen>
		</example>

		<para>Add the following lines to demo.xml:</para>

		<example>
			<title>Added lines in demo.xml</title>
			
			<screen><![CDATA[
<Call name="addWebApplication">
 <Arg>/exist/*</Arg>
 <Arg><SystemProperty name="jetty.home"
      default="."/>/demo/webapps/exist/</Arg>
 <Arg><SystemProperty name="jetty.home"
      default="."/>/etc/webdefault.xml</Arg>
 <Arg type="boolean">false</Arg> <!-- if true,
      expand war in temp dir -->
</Call>			
			]]></screen>
		</example>

		<para>To bring up jetty and exist type</para>
		
		<synopsis>ant demo</synopsis>

		<para>Type into your browser</para>
		
		<synopsis>http://localhost:8080/exist/index.xml</synopsis>

	</section>
</chapter>

</book>
