<?xml version="1.0" encoding="UTF-8"?>

<!-- XSP page for processing a query

	 This xsp page takes the parameters received from xquery.xsp and
     sends a query request to the eXist server. If parameter
	 "summarize" is set, a short summary of the query execution
	 is shown first.
-->
<xsp:page
  xmlns:xmldb="http://exist-db.org/xmldb/1.0"
  xmlns:xsp="http://apache.org/xsp"
  >

    <document>
        <!-- include header -->
        <ci:include xmlns:ci="http://apache.org/cocoon/include/1.0" src="context://header.xml"/>
       
        <!-- include sidebar -->
        <ci:include xmlns:ci="http://apache.org/cocoon/include/1.0" src="sidebar.xml"/>
       
        <body>
            <section title="Query results">
      
            <xsp:logic>
            // get start and count parameters
            String pstart = request.getParameter("start");
            String pcount = request.getParameter("count");
            String resultId = request.getParameter("id");
            if(pstart == null) pstart = "1";
            if(pcount == null) pcount = "10";
            int start = Integer.parseInt(pstart);
            int count = Integer.parseInt(pcount);
            int hits = 0;
            
            //String query = new String(request.getParameter("query").getBytes("ISO-8859-1"), "UTF-8");
            String query = request.getParameter("query");
            String cname = request.getParameter("collection");
            String psummarize = request.getParameter("summarize");
            boolean summarize = (psummarize == null) ? false : true;
            
            // add document(*) to query if missing
            if(!(query.startsWith("document(") || query.startsWith("collection(")) ||
                 query.startsWith("xcollection(")) {
                if(cname == null || cname.equals("all documents"))
                    query = "document(*)" + query;
                else
                    query = "collection('" + cname + "')" + query;
            }
            
            <!-- print current query -->
            <p>Query:</p>
        
            <dl>
                <dt></dt>
                <dd><xsp:expr>query</xsp:expr></dd>
            </dl>
            <p></p>
            
        <!-- connect to the server -->
        <xmldb:driver class="org.exist.xmldb.DatabaseImpl"/>
        <!--<xmldb:driver class="org.exist.xmldb.DatabaseImpl"/>-->

        <xmldb:collection uri="xmldb:exist:///db" user="guest" password="guest">
            <xmldb:execute>
                <xmldb:xpath>query</xmldb:xpath>
                
                    <xsp:logic>
                        hits = <xmldb:get-hit-count/>;
                        if(hits &gt; 0) {
                            if(summarize) {
                                <section title="Summary of hits">
                                
                                <!-- print a summary of hits per document -->                     
                                <p>Found <xmldb:get-hit-count/> hits in
                                <xmldb:get-query-time/> ms.</p>
                                
                                <p>The table below shows which documents
                                matched your query.  Click on a document's
                                name to view the actual results.</p>
                                
                                <!-- display hits per document -->
                                <table width="90%" border="0" cellspacing="0" align="center">
                                    <xsp:logic>
                                        String docLink = response.encodeURL(request.getRequestURI()) + "?count=" +
                                            count + "&amp;query=" + URLEncoder.encode(query);
                                        <xmldb:result-summary>
                                            <table bgcolor="#0B88E8" cellspacing="0" cellpadding="0" 
                                                   border="0" width="100%">
                                                <tr style="border: 1px solid black">
                                                    <th align="left" colspan="3">
                                                        <font color="#FFFFFF"><xmldb:collection-name/></font>
                                                    </th>
                                                </tr>
                                                <xmldb:documents>
                                                    <tr bgcolor="#D0DFEC">
                                                        <xsp:logic>
                                                            String collectionName = <xmldb:collection-name/>;
                                                            String docName = collectionName + '/' + <xmldb:document-name/>;
                                                            String newQuery = docLink + "&amp;doc=" +
                                                                docName;
                                                            <td width="5%"></td>
                                                            <td>
                                                                <link>
                                                                    <xsp:attribute name="href"><xsp:expr>newQuery</xsp:expr></xsp:attribute>
                                                                    <xsp:expr>docName</xsp:expr>
                                                                </link>
                                                            </td>
                                                            <td align="right"><xmldb:document-hit-count/></td>
                                                        </xsp:logic>
                                                    </tr>
                                                </xmldb:documents>
                                            </table>
                                        </xmldb:result-summary>
                                    </xsp:logic>
                                </table>
                                
                                </section>
                            } else {
                                // display the actual results
                                String doc = request.getParameter("doc");
                                if(doc != null) {
                                    hits = 
                                        <xmldb:get-hit-count>
                                            <xmldb:document>doc.substring(doc.lastIndexOf('/') + 1)</xmldb:document>
                                            <xmldb:collection>doc.substring(0, doc.lastIndexOf('/'))</xmldb:collection>
                                        </xmldb:get-hit-count>;
                                }
                                // generate links for previous/next and summary page
                                String temp = response.encodeURL(request.getRequestURI()) + '?';
                                if(doc != null)
                                    temp = temp + "doc=" + doc + "&amp;";
                                String prev = temp + "count=" +
                                    count + "&amp;start=" + (start - count) +
                                    "&amp;query=" + URLEncoder.encode(request.getParameter("query"));
                                String next = temp + "count=" +
                                    count + "&amp;start=" + (start + count) +
                                    "&amp;query=" + URLEncoder.encode(request.getParameter("query"));
                                String summary = request.getRequestURI() +
                                    "?query=" + URLEncoder.encode(request.getParameter("query")) +
                                    "&amp;summarize=true";
                                String newQuery = "xquery.xsp?query=" + 
                                    URLEncoder.encode(request.getParameter("query"));
                                
                                <table width="100%" cellspacing="0" cellpadding="5" bgcolor="#0B88E8">
                    
                                    <!-- top link menu -->
                                    <tr>
                                        <xsp:logic>
                                            if(start &gt; 1) {
                                                <td width="25%" align="left">
                                                    <link style="font-weight: bold; color: white">
                                                        <xsp:attribute name="href"><xsp:expr>prev</xsp:expr></xsp:attribute>
                                                        &lt;&lt; previous page
                                                    </link>
                                                </td>
                                            } else {
                                                <td width="25%"></td>
                                            }
                                            <td width="25%" align="center">
                                                <link style="font-weight: bold; color: white">
                                                    <xsp:attribute name="href"><xsp:expr>newQuery</xsp:expr></xsp:attribute>
                                                    new query
                                                </link>
                                            </td>
                                            <td width="25%" align="center">
                                                <link style="font-weight: bold; color: white">
                                                    <xsp:attribute name="href"><xsp:expr>summary</xsp:expr></xsp:attribute>
                                                    summary
                                                </link>
                                            </td>
                                            if(start + count &lt; hits) {
                                                <td width="25%" align="right">
                                                    <link style="font-weight: bold; color: white">
                                                        <xsp:attribute name="href"><xsp:expr>next</xsp:expr></xsp:attribute>
                                                        next page &gt;&gt;
                                                    </link>
                                                </td>
                                            } else {
                                                <td width="25%"></td>
                                            }
                                        </xsp:logic>
                                    </tr>    
                                    <!-- display the hits in pretty printed XML -->
                                    <xsp:logic>
                                        int pos = 0;
                                        if(doc != null) {
                                            <xmldb:results>
                                                <xmldb:position>start</xmldb:position>
                                                <xmldb:count>count</xmldb:count>
                                                <xmldb:document>doc.substring(doc.lastIndexOf('/') + 1)</xmldb:document>
                                                <xmldb:collection>doc.substring(0, doc.lastIndexOf('/'))</xmldb:collection>
                                                <tr>
                                                    <td colspan="4">
                                                        <xsp:logic>
                                                            if(++pos % 2 == 0) {
                                                                <xsp:attribute name="bgcolor">#9FB4EC</xsp:attribute>
                                                            } else {
                                                                <xsp:attribute name="bgcolor">#D0DFEC</xsp:attribute>
                                                            }
                                                        </xsp:logic>
                                                
                                                        <xml-source>
                                                            <xmldb:get-xml as="xml"/>
                                                        </xml-source>
                                                    </td>
                                                </tr>
                                                <xmldb:error>
                                                    <p><xmldb:get-error/></p>
                                                </xmldb:error>
                                            </xmldb:results>
                                        } else {
                                            <xmldb:results>
                                                <xmldb:position>start</xmldb:position>
                                                <xmldb:count>count</xmldb:count>
                                                <tr>
                                                    <td colspan="4">
                                                        <xsp:logic>
                                                            if(++pos % 2 == 0) {
                                                                <xsp:attribute name="bgcolor">#CACACA</xsp:attribute>
                                                            } else {
                                                                <xsp:attribute name="bgcolor">#9999CC</xsp:attribute>
                                                            }
                                                        </xsp:logic>
                                                
                                                        <xml-source>
                                                            <xmldb:get-xml as="xml"/>
                                                        </xml-source>
                                                    </td>
                                                </tr>
                                                <xmldb:error>
                                                    <p><xmldb:get-error/></p>
                                                </xmldb:error>
                                            </xmldb:results>
                                        }
                                    </xsp:logic>
                                    <!-- bottom link menu -->
                                    <tr>
                                        <xsp:logic>
                                            if(start &gt; 1) {
                                                <td width="25%" align="left">
                                                    <link style="font-weight: bold; color: white">
                                                        <xsp:attribute name="href"><xsp:expr>prev</xsp:expr></xsp:attribute>
                                                        &lt;&lt; previous page
                                                    </link>
                                                </td>
                                            } else {
                                                <td width="25%"></td>
                                            }
                                            <td width="25%" align="center">
                                                <link style="font-weight: bold; color: white">
                                                    <xsp:attribute name="href"><xsp:expr>newQuery</xsp:expr></xsp:attribute>
                                                    new query
                                                </link>
                                            </td>
                                            <td width="25%" align="center">
                                                <link style="font-weight: bold; color: white">
                                                    <xsp:attribute name="href"><xsp:expr>summary</xsp:expr></xsp:attribute>
                                                    summary
                                                </link>
                                            </td>
                                            if(start + count &lt; hits) {
                                                <td width="25%" align="right">
                                                    <link style="font-weight: bold; color: white">
                                                        <xsp:attribute name="href"><xsp:expr>next</xsp:expr></xsp:attribute>
                                                        next page &gt;&gt;
                                                    </link>
                                                </td>
                                            } else {
                                                <td width="25%"></td>
                                            }
                                        </xsp:logic>
                                    </tr>
                            </table>
                        }
                    } else {
                        <p>Nothing found for your query.</p>
                        <p><a href="xquery.xsp">&lt;&lt; back</a></p>
                    }
                </xsp:logic>
                
                <xmldb:error>
                    <p>An error occurred while executing query:</p>
                    <p><tt><xmldb:get-error/></tt></p>
                    <p><xmldb:get-error-description/></p>
                </xmldb:error>
            </xmldb:execute>
            
            <xmldb:error>
                <p><tt><xmldb:get-error/></tt></p>
            </xmldb:error>
        </xmldb:collection>
    </xsp:logic>
        
    </section>
</body>
    
</document>

</xsp:page>
  
  
